<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.7.0"/>
    <title>pyRTX.core.utils_rt API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../core.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;pyRTX.core</a>


            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#parallelize">parallelize</a>
            </li>
            <li>
                    <a class="function" href="#chunker">chunker</a>
            </li>
            <li>
                    <a class="function" href="#pxform_convert">pxform_convert</a>
            </li>
            <li>
                    <a class="function" href="#block_normalize">block_normalize</a>
            </li>
            <li>
                    <a class="function" href="#block_dot">block_dot</a>
            </li>
            <li>
                    <a class="function" href="#pixel_plane">pixel_plane</a>
            </li>
            <li>
                    <a class="function" href="#fast_vector_build">fast_vector_build</a>
            </li>
            <li>
                    <a class="function" href="#pixel_plane_opt">pixel_plane_opt</a>
            </li>
            <li>
                    <a class="function" href="#reflected">reflected</a>
            </li>
            <li>
                    <a class="function" href="#get_orthogonal">get_orthogonal</a>
            </li>
            <li>
                    <a class="function" href="#sample_lambert_dist">sample_lambert_dist</a>
            </li>
            <li>
                    <a class="function" href="#diffuse">diffuse</a>
            </li>
            <li>
                    <a class="function" href="#compute_secondary_bounce">compute_secondary_bounce</a>
            </li>
            <li>
                    <a class="function" href="#save_for_visualization">save_for_visualization</a>
            </li>
            <li>
                    <a class="function" href="#exportEXAC">exportEXAC</a>
            </li>
            <li>
                    <a class="function" href="#Embree3_init_geometry">Embree3_init_geometry</a>
            </li>
            <li>
                    <a class="function" href="#Embree3_init_rayhit">Embree3_init_rayhit</a>
            </li>
            <li>
                    <a class="function" href="#Embree3_dump_solution">Embree3_dump_solution</a>
            </li>
            <li>
                    <a class="function" href="#cgal_init_geometry">cgal_init_geometry</a>
            </li>
            <li>
                    <a class="function" href="#get_centroids">get_centroids</a>
            </li>
            <li>
                    <a class="function" href="#get_cross_products">get_cross_products</a>
            </li>
            <li>
                    <a class="function" href="#get_face_areas">get_face_areas</a>
            </li>
            <li>
                    <a class="function" href="#get_surface_normals">get_surface_normals</a>
            </li>
            <li>
                    <a class="function" href="#get_surface_normals_and_face_areas">get_surface_normals_and_face_areas</a>
            </li>
            <li>
                    <a class="class" href="#ShapeModel">ShapeModel</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#TrimeshShapeModel">TrimeshShapeModel</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#TrimeshShapeModel.__init__">TrimeshShapeModel</a>
                        </li>
                        <li>
                                <a class="variable" href="#TrimeshShapeModel.dtype">dtype</a>
                        </li>
                        <li>
                                <a class="variable" href="#TrimeshShapeModel.V">V</a>
                        </li>
                        <li>
                                <a class="variable" href="#TrimeshShapeModel.F">F</a>
                        </li>
                        <li>
                                <a class="variable" href="#TrimeshShapeModel.P">P</a>
                        </li>
                        <li>
                                <a class="variable" href="#TrimeshShapeModel.N">N</a>
                        </li>
                        <li>
                                <a class="variable" href="#TrimeshShapeModel.A">A</a>
                        </li>
                        <li>
                                <a class="variable" href="#TrimeshShapeModel.num_faces">num_faces</a>
                        </li>
                        <li>
                                <a class="variable" href="#TrimeshShapeModel.num_verts">num_verts</a>
                        </li>
                        <li>
                                <a class="function" href="#TrimeshShapeModel.intersect1">intersect1</a>
                        </li>
                        <li>
                                <a class="function" href="#TrimeshShapeModel.intersect1_2d_with_coords">intersect1_2d_with_coords</a>
                        </li>
                        <li>
                                <a class="function" href="#TrimeshShapeModel.intersect1_2d">intersect1_2d</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#CgalTrimeshShapeModel">CgalTrimeshShapeModel</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#EmbreeTrimeshShapeModel">EmbreeTrimeshShapeModel</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="variable" href="#trimesh_shape_models">trimesh_shape_models</a>
            </li>
            <li>
                    <a class="function" href="#RTXkernel">RTXkernel</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../../pyRTX.html">pyRTX</a><wbr>.<a href="./../core.html">core</a><wbr>.utils_rt    </h1>

                
                        <input id="mod-utils_rt-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-utils_rt-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="c1">##################################</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a><span class="c1"># Utilities for ray tracing (part of pyRTX module)</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="c1"># </span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="c1"># Developed by: Gael Cascioli 2021</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">import</span> <span class="nn">trimesh</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABC</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">import</span> <span class="nn">pickle</span> <span class="k">as</span> <span class="nn">pkl</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">import</span> <span class="nn">multiprocessing</span> <span class="k">as</span> <span class="nn">mproc</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span> <span class="nn">pyRTX.defaults</span> <span class="kn">import</span> <span class="n">dFloat</span><span class="p">,</span> <span class="n">dInt</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a><span class="kn">from</span> <span class="nn">pyRTX</span> <span class="kn">import</span> <span class="n">EMBREE_AVAILABLE</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="k">if</span> <span class="n">EMBREE_AVAILABLE</span><span class="p">:</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a>    <span class="kn">import</span> <span class="nn">embree</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a>    
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a><span class="k">else</span><span class="p">:</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a>    <span class="c1"># Provide fallback or informative error</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a>    <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a>            <span class="s2">&quot;Embree is not available. This feature requires Embree.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a>            <span class="s2">&quot;Please install it by running: python install_deps.py</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>            <span class="s2">&quot;On Linux, the environment should be configured automatically.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a>            <span class="s2">&quot;On other platforms, you may need to manually source embree-vars.sh&quot;</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a>        <span class="p">)</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a><span class="k">try</span><span class="p">:</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>        <span class="kn">from</span> <span class="nn">aabb</span> <span class="kn">import</span> <span class="n">AABB</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a><span class="k">except</span><span class="p">:</span> 
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>        <span class="k">pass</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a><span class="c1"># except ImportError:</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a><span class="c1">#	print(&quot;&quot;&quot;Could not import Embree3 library. \n Be sure that: </span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="c1">#		\n 1) Embree3 is installed\n 2) you activated embree variables (source /path/to/lib/embree-vars.sh)&quot;&quot;&quot;)</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="c1"># No more imports after here</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="c1"># ___________________________________________________________</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="c1">############################################################</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="c1"># Define general utils</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="c1">###########################################################</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="k">def</span> <span class="nf">parallelize</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">chunks</span><span class="p">):</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Define a general parallelization framework to speedup computations</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">            Parameters</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">            ----------</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">            iterator : array_like</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">                the array-like object over which to parallelize</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">            function : function handle</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">                the function that must be called by each subprocess. The function should be of the form y = f(iterator)</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">            chunks : int</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">                number of parallel workers</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">           Returns</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a><span class="sd">           -------</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a><span class="sd">           result : array_like</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a><span class="sd">                the result of the parallelized computation</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>    <span class="k">with</span> <span class="n">mproc</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">iterator</span><span class="p">)</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>    <span class="k">return</span> <span class="n">result</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a><span class="k">def</span> <span class="nf">chunker</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">chunks</span><span class="p">):</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">    Divide an iterator or array into approximately equal-sized chunks for</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="sd">    parallel processing.</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">    </span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">    Parameters</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a><span class="sd">    ----------</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a><span class="sd">    iterator : array_like</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a><span class="sd">        The array-like object to divide into chunks.</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a><span class="sd">    chunks : int</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a><span class="sd">        Number of chunks to create.</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a><span class="sd">    </span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a><span class="sd">    Returns</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a><span class="sd">    -------</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a><span class="sd">    result : list of arrays</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a><span class="sd">        List containing the chunked arrays. Chunks will be approximately equal</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a><span class="sd">        in size, with the last chunk potentially being smaller.</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a><span class="sd">    </span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a><span class="sd">    Notes</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a><span class="sd">    -----</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a><span class="sd">    Uses numpy.array_split which handles uneven divisions automatically.</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">chunks</span><span class="p">)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a><span class="k">def</span> <span class="nf">pxform_convert</span><span class="p">(</span><span class="n">pxform</span><span class="p">):</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a><span class="sd">    Convert a SPICE-generated rotation matrix (pxform) to the 4x4 homogeneous</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a><span class="sd">    transformation matrix format required by trimesh.</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a><span class="sd">    </span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a><span class="sd">    Parameters</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a><span class="sd">    ----------</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a><span class="sd">    pxform : array_like, shape (3, 3)</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a><span class="sd">        The 3x3 rotation matrix from SPICE (obtained via spiceypy.pxform).</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a><span class="sd">    </span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a><span class="sd">    Returns</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a><span class="sd">    -------</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a><span class="sd">    result : ndarray, shape (4, 4)</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a><span class="sd">        The 4x4 homogeneous transformation matrix with the rotation in the</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a><span class="sd">        upper-left 3x3 block, zeros in the translation column, and [0,0,0,0]</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a><span class="sd">        in the bottom row.</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a><span class="sd">    </span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a><span class="sd">    Notes</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a><span class="sd">    -----</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a><span class="sd">    Trimesh uses 4x4 homogeneous transformation matrices for geometric operations.</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a><span class="sd">    This function adds the necessary padding to convert a pure rotation matrix.</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>    <span class="n">pxform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pxform</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pxform</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pxform</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dFloat</span><span class="p">)</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pxform</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a>    <span class="n">mv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dFloat</span><span class="p">)</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>    <span class="k">return</span> <span class="n">p</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a><span class="k">def</span> <span class="nf">block_normalize</span><span class="p">(</span><span class="n">V</span><span class="p">):</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a><span class="sd">    Compute unit vectors for a block of vectors efficiently using vectorized</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a><span class="sd">    operations.</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a><span class="sd">    </span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a><span class="sd">    Parameters</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a><span class="sd">    ----------</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a><span class="sd">    V : ndarray, shape (N, 3) or (3,)</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a><span class="sd">        Array of vectors to normalize. Can be a single vector or multiple vectors.</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a><span class="sd">    </span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a><span class="sd">    Returns</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="sd">    -------</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a><span class="sd">    result : ndarray, same shape as V</span>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">        The normalized vectors (unit vectors with magnitude 1).</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">    </span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a><span class="sd">    Notes</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">    -----</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">    Uses vectorized numpy operations for efficiency with large arrays. Handles</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">    both single vectors and arrays of vectors automatically.</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a>    <span class="k">if</span> <span class="n">V</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a>        <span class="k">return</span> <span class="n">V</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">V</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a>        <span class="k">return</span> <span class="n">V</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="k">def</span> <span class="nf">block_dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">    Perform element-wise dot product between corresponding vectors in two arrays.</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a><span class="sd">    </span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a><span class="sd">    Parameters</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a><span class="sd">    ----------</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a><span class="sd">    a : ndarray, shape (N, m)</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a><span class="sd">        First array of vectors.</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd">    b : ndarray, shape (N, m)</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a><span class="sd">        Second array of vectors (must have same shape as a).</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a><span class="sd">    </span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a><span class="sd">    Returns</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a><span class="sd">    -------</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a><span class="sd">    result : ndarray, shape (N,)</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a><span class="sd">        Array containing the dot product of each pair of corresponding vectors.</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a><span class="sd">        result[i] = a[i]  b[i]</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a><span class="sd">    </span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a><span class="sd">    Notes</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">    -----</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">    This is more efficient than using a loop for computing many dot products.</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">    Equivalent to np.einsum(&#39;ij,ij-&gt;i&#39;, a, b) but more readable.</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="k">def</span> <span class="nf">pixel_plane</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ray_spacing</span><span class="o">=</span><span class="mf">.1</span><span class="p">):</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">    Generate a rectangular pixel array (grid of rays) for ray tracing, as defined</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a><span class="sd">    in Li et al., 2018. This is the explicit implementation showing the full</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="sd">    algorithm.</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a><span class="sd">    </span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="sd">    This function creates a planar grid of ray origins and directions pointing</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a><span class="sd">    toward a specified direction in 3D space, useful for simulating parallel</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a><span class="sd">    light sources like the Sun.</span>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a><span class="sd">    </span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a><span class="sd">    Parameters</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a><span class="sd">    ----------</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a><span class="sd">    d0 : float</span>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a><span class="sd">        Distance of the pixel plane from the origin (in meters). This defines</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a><span class="sd">        how far the ray origins are from the coordinate system origin.</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a><span class="sd">    lon : float</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a><span class="sd">        Longitude of the pixel plane&#39;s center direction (in radians). Defines</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a><span class="sd">        the azimuthal angle in spherical coordinates.</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a><span class="sd">    lat : float</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a><span class="sd">        Latitude of the pixel plane&#39;s center direction (in radians). Defines</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a><span class="sd">        the elevation angle in spherical coordinates.</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a><span class="sd">    width : float, default=1</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a><span class="sd">        Width of the plane (in meters). The plane extends width/2 in the</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a><span class="sd">        horizontal direction.</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a><span class="sd">    height : float, default=1</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a><span class="sd">        Height of the plane (in meters). The plane extends height/2 in the</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a><span class="sd">        vertical direction.</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a><span class="sd">    ray_spacing : float, default=0.1</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a><span class="sd">        Spacing between adjacent rays (in meters). Smaller values create denser</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a><span class="sd">        ray grids but increase computation time.</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a><span class="sd">    </span>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a><span class="sd">    Returns</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a><span class="sd">    -------</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a><span class="sd">    locs : ndarray, shape (N, 3)</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a><span class="sd">        Ray origin positions in 3D space. N = (width/ray_spacing + 1)  </span>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a><span class="sd">        (height/ray_spacing + 1).</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a><span class="sd">    dirs : ndarray, shape (N, 3)</span>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a><span class="sd">        Ray direction unit vectors. All rays point toward the origin (or away</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a><span class="sd">        from the direction specified by lon/lat).</span>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a><span class="sd">    </span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a><span class="sd">    Notes</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a><span class="sd">    -----</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a><span class="sd">    The pixel plane is oriented perpendicular to the direction vector defined</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a><span class="sd">    by (lon, lat) and positioned at distance d0 from the origin. This creates</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a><span class="sd">    a uniform grid of parallel rays suitable for simulating distant light sources.</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a><span class="sd">    </span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a><span class="sd">    For performance-critical applications, use pixel_plane_opt instead.</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a><span class="sd">    </span>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a><span class="sd">    References</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a><span class="sd">    ----------</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a><span class="sd">    Li et al., 2018 - Solar radiation pressure modeling methodology</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>    <span class="n">w2</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>    <span class="n">h2</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>    <span class="c1"># Build the direction vector</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">d0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="o">-</span><span class="n">d0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="o">-</span><span class="n">d0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)])</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>    <span class="c1"># Build the transformation matrix</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>    <span class="n">R1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>                   <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>                  <span class="p">)</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>    <span class="n">R2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">)],</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>                   <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">)]])</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>    <span class="n">R</span> <span class="o">=</span> <span class="n">R1</span> <span class="o">@</span> <span class="n">R2</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>    <span class="c1"># Build the pixel matrix</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>    <span class="n">basic_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(((</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">ray_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">ray_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>    <span class="n">basic_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">basic_coords</span><span class="p">)</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">w2</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">ray_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">h2</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">ray_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>            <span class="n">basic_coords</span><span class="p">[</span><span class="n">counter</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">R</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span> <span class="o">-</span> <span class="n">x0</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>            <span class="n">basic_dirs</span><span class="p">[</span><span class="n">counter</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>    <span class="c1"># Return the output in the shape required by trimesh</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>    <span class="k">return</span> <span class="n">basic_coords</span><span class="p">,</span> <span class="n">basic_dirs</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a><span class="k">def</span> <span class="nf">fast_vector_build</span><span class="p">(</span><span class="n">linsp1</span><span class="p">,</span> <span class="n">linsp2</span><span class="p">,</span> <span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span><span class="p">):</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a><span class="sd">    Efficiently build a pixel array coordinate grid using Numba&#39;s JIT compilation</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a><span class="sd">    for performance.</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a><span class="sd">    </span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a><span class="sd">    Parameters</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a><span class="sd">    ----------</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a><span class="sd">    linsp1 : ndarray, shape (dim1,)</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a><span class="sd">        Linear space defining positions along the first dimension (typically width).</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a><span class="sd">    linsp2 : ndarray, shape (dim2,)</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a><span class="sd">        Linear space defining positions along the second dimension (typically height).</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a><span class="sd">    dim1 : int</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a><span class="sd">        Number of points in the first dimension.</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a><span class="sd">    dim2 : int</span>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a><span class="sd">        Number of points in the second dimension.</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a><span class="sd">    </span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a><span class="sd">    Returns</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a><span class="sd">    -------</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a><span class="sd">    result : ndarray, shape (dim1  dim2, 3)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a><span class="sd">        Array of 3D coordinates forming a rectangular grid in the y-z plane</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a><span class="sd">        (x=0 for all points). The grid is built by nested iteration over linsp1</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a><span class="sd">        and linsp2.</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a><span class="sd">    </span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a><span class="sd">    Notes</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a><span class="sd">    -----</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a><span class="sd">    This function is JIT-compiled with Numba for significant performance improvement</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a><span class="sd">    over pure Python loops. Used internally by pixel_plane_opt.</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>    <span class="n">basic_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim1</span> <span class="o">*</span> <span class="n">dim2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">linsp1</span><span class="p">:</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">linsp2</span><span class="p">:</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>            <span class="n">basic_coords</span><span class="p">[</span><span class="n">counter</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>    <span class="k">return</span> <span class="n">basic_coords</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a><span class="k">def</span> <span class="nf">pixel_plane_opt</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ray_spacing</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">packets</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a><span class="sd">    Generate a rectangular pixel array for ray tracing - optimized version with</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a><span class="sd">    optional ray packet subdivision.</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a><span class="sd">    </span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a><span class="sd">    This is a performance-optimized implementation of pixel_plane that uses</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a><span class="sd">    vectorized operations and Numba JIT compilation. It also supports dividing</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a><span class="sd">    the rays into packets to avoid segmentation faults with very large ray counts.</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a><span class="sd">    </span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a><span class="sd">    Parameters</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a><span class="sd">    ----------</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a><span class="sd">    d0 : float</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a><span class="sd">        Distance of the pixel plane from the origin (in meters).</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a><span class="sd">    lon : float</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a><span class="sd">        Longitude of the pixel plane&#39;s center direction (in radians).</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a><span class="sd">    lat : float</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a><span class="sd">        Latitude of the pixel plane&#39;s center direction (in radians).</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a><span class="sd">    width : float, default=1</span>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a><span class="sd">        Width of the plane (in meters).</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a><span class="sd">    height : float, default=1</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a><span class="sd">        Height of the plane (in meters).</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a><span class="sd">    ray_spacing : float, default=0.1</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a><span class="sd">        Spacing between adjacent rays (in meters). Determines ray grid density.</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a><span class="sd">    packets : int, default=1</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a><span class="sd">        Number of ray packets to subdivide the rays into. Use values &gt; 1 to</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a><span class="sd">        avoid segmentation faults or memory issues with very large numbers of</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a><span class="sd">        rays (typically &gt; 10^6). Each packet is processed separately by the</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a><span class="sd">        ray tracer.</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a><span class="sd">    </span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a><span class="sd">    Returns</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a><span class="sd">    -------</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a><span class="sd">    locs : ndarray or list of ndarrays</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a><span class="sd">        Ray origin positions. If packets=1, returns single array of shape (N, 3).</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a><span class="sd">        If packets&gt;1, returns list of arrays, each containing a subset of rays.</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a><span class="sd">    dirs : ndarray or list of ndarrays</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a><span class="sd">        Ray direction unit vectors. Same structure as locs.</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a><span class="sd">    </span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a><span class="sd">    Notes</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a><span class="sd">    -----</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a><span class="sd">    This is the recommended function for pixel plane generation due to its</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a><span class="sd">    performance optimizations. Use packets &gt; 1 when dealing with very dense</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a><span class="sd">    ray grids (small ray_spacing values).</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a><span class="sd">    </span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a><span class="sd">    The function uses Numba JIT compilation via fast_vector_build for efficient</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a><span class="sd">    coordinate grid generation.</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>    <span class="n">w2</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>    <span class="n">h2</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>    <span class="c1"># Build the direction vector</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">d0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="o">-</span><span class="n">d0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="o">-</span><span class="n">d0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)])</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>    <span class="n">x0_unit</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>    <span class="c1"># Build the transformation matrix</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>    <span class="n">R1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>                   <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>                  <span class="p">)</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>    <span class="n">R2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">)],</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>                   <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">)]])</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>    <span class="n">R</span> <span class="o">=</span> <span class="n">R1</span> <span class="o">@</span> <span class="n">R2</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>    <span class="c1"># Build the pixel matrix</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>    <span class="n">dim1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">ray_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>    <span class="n">dim2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">ray_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>    <span class="n">basic_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim1</span> <span class="o">*</span> <span class="n">dim2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>    <span class="n">basic_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">basic_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x0_unit</span><span class="p">)</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>    <span class="n">linsp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">w2</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">dim1</span><span class="p">)</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>    <span class="n">linsp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">h2</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">dim2</span><span class="p">)</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>    <span class="n">basic_coords</span> <span class="o">=</span> <span class="n">fast_vector_build</span><span class="p">(</span><span class="n">linsp1</span><span class="p">,</span> <span class="n">linsp2</span><span class="p">,</span> <span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span><span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>    <span class="n">basic_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">basic_coords</span><span class="p">),</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>    <span class="n">basic_coords</span> <span class="o">-=</span> <span class="n">x0</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>    <span class="c1"># Return the output in the shape required by trimesh</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">packets</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>        <span class="n">basic_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">basic_coords</span><span class="p">,</span> <span class="n">packets</span><span class="p">)</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>        <span class="n">basic_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">basic_dirs</span><span class="p">,</span> <span class="n">packets</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>    <span class="k">return</span> <span class="n">basic_coords</span><span class="p">,</span> <span class="n">basic_dirs</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a><span class="k">def</span> <span class="nf">reflected</span><span class="p">(</span><span class="n">incoming</span><span class="p">,</span> <span class="n">normal</span><span class="p">):</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a><span class="sd">    Compute reflected ray directions given incoming rays and surface normals.</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a><span class="sd">    Uses the law of reflection: r = i - 2(in)n</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a><span class="sd">    </span>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a><span class="sd">    This is a vectorized implementation using numpy.einsum for efficient</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a><span class="sd">    computation of many reflections simultaneously.</span>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a><span class="sd">    </span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a><span class="sd">    Parameters</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a><span class="sd">    ----------</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a><span class="sd">    incoming : ndarray, shape (N, 3)</span>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a><span class="sd">        Incoming ray direction vectors (do not need to be normalized).</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a><span class="sd">    normal : ndarray, shape (N, 3)</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a><span class="sd">        Surface normal vectors at reflection points (should be unit vectors).</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a><span class="sd">    </span>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a><span class="sd">    Returns</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a><span class="sd">    -------</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a><span class="sd">    reflected : ndarray, shape (N, 3)</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a><span class="sd">        Reflected ray direction vectors. These are NOT normalized - maintain</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a><span class="sd">        the same magnitude as the incoming vectors.</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a><span class="sd">    </span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a><span class="sd">    Notes</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a><span class="sd">    -----</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a><span class="sd">    The reflection formula used is: r = i - 2(in)n, where:</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a><span class="sd">    - i is the incoming direction</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a><span class="sd">    - n is the surface normal</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a><span class="sd">    - r is the reflected direction</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a><span class="sd">    </span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a><span class="sd">    This formula gives the specular (mirror-like) reflection direction.</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a><span class="sd">    Uses np.einsum for efficient vectorized dot product computation.</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>    <span class="k">return</span> <span class="n">incoming</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">normal</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;i&#39;</span><span class="p">,</span> <span class="n">incoming</span><span class="p">,</span> <span class="n">normal</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a><span class="k">def</span> <span class="nf">get_orthogonal</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a><span class="sd">    Generate a unit vector orthogonal to the input vector using randomization.</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a><span class="sd">    </span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a><span class="sd">    Parameters</span>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a><span class="sd">    ----------</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a><span class="sd">    v : ndarray, shape (3,)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a><span class="sd">        Input vector to which the result should be orthogonal.</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a><span class="sd">    </span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a><span class="sd">    Returns</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a><span class="sd">    -------</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a><span class="sd">    x : ndarray, shape (3,)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a><span class="sd">        Unit vector orthogonal to v (x  v = 0 and ||x|| = 1).</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a><span class="sd">    </span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a><span class="sd">    Notes</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a><span class="sd">    -----</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a><span class="sd">    Uses a random vector projection method: generates a random 3D vector,</span>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a><span class="sd">    projects out the component parallel to v, and normalizes. This is used</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a><span class="sd">    internally for constructing local coordinate systems on surface normals.</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a><span class="sd">    </span>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a><span class="sd">    JIT-compiled with Numba for performance.</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>    <span class="n">x</span> <span class="o">-=</span> <span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>    <span class="k">return</span> <span class="n">x</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a><span class="k">def</span> <span class="nf">sample_lambert_dist</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a><span class="sd">    Generate a cloud of direction vectors following the Lambert cosine</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a><span class="sd">    distribution (also known as Lambertian distribution or cosine-weighted</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a><span class="sd">    hemisphere sampling).</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a><span class="sd">    </span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a><span class="sd">    The Lambert distribution models ideal diffuse reflection where the</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a><span class="sd">    probability of a ray being reflected in a given direction is proportional</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a><span class="sd">    to the cosine of the angle between that direction and the surface normal.</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a><span class="sd">    This is physically accurate for perfectly diffuse (Lambertian) surfaces.</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a><span class="sd">    </span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a><span class="sd">    Parameters</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a><span class="sd">    ----------</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a><span class="sd">    normal : ndarray, shape (3,)</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a><span class="sd">        Surface normal vector defining the hemisphere orientation (should be</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">        a unit vector).</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a><span class="sd">    num : int, default=100</span>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="sd">        Number of sample directions to generate.</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a><span class="sd">    </span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a><span class="sd">    Returns</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="sd">    -------</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">    v : ndarray, shape (num, 3)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="sd">        Array of sampled direction vectors distributed according to Lambert&#39;s</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">        cosine law. All vectors point into the hemisphere defined by the normal.</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a><span class="sd">    </span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a><span class="sd">    Notes</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a><span class="sd">    -----</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a><span class="sd">    The sampling uses spherical coordinates with:</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a><span class="sd">    -  (polar angle): sampled as  = arccos() where  ~ U(0,1)</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="sd">    -  (azimuthal angle): sampled uniformly as  ~ U(0, 2)</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="sd">    </span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">    This ensures that the probability density is proportional to cos(), which</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">    is characteristic of ideal diffuse reflection (Lambert&#39;s cosine law).</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a><span class="sd">    </span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a><span class="sd">    JIT-compiled with Numba for performance. Used for modeling diffuse</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a><span class="sd">    reflection in ray tracing.</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a><span class="sd">    </span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a><span class="sd">    References</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a><span class="sd">    ----------</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a><span class="sd">    Lambert&#39;s Cosine Law: I = I cos() where  is the angle from the normal</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a>    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">num</span><span class="p">)))</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a>    <span class="n">cos_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a>    <span class="n">sin_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>    <span class="n">psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">sin_theta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">sin_theta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">cos_theta</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>    <span class="n">t1</span> <span class="o">=</span> <span class="n">get_orthogonal</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>    <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">t2</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">normal</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>    <span class="k">return</span> <span class="n">v</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a><span class="k">def</span> <span class="nf">_core_diffuse</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">diffuse_directions</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">normals</span><span class="p">):</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>        <span class="n">diff_dirs</span> <span class="o">=</span> <span class="n">sample_lambert_dist</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>        <span class="n">diffuse_directions</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">num</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_dirs</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>    <span class="k">return</span> <span class="n">diffuse_directions</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a><span class="k">def</span> <span class="nf">diffuse</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a><span class="sd">    Compute multiple diffuse reflection directions for an array of surface</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a><span class="sd">    normals by sampling the Lambert cosine distribution.</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a><span class="sd">    </span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a><span class="sd">    For each input normal, generates num diffusely reflected ray directions</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a><span class="sd">    following Lambert&#39;s cosine law. This models realistic diffuse scattering</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a><span class="sd">    from rough surfaces.</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a><span class="sd">    </span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a><span class="sd">    Parameters</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a><span class="sd">    ----------</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a><span class="sd">    normals : ndarray, shape (N, 3)</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a><span class="sd">        Array of surface normal unit vectors at reflection points.</span>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a><span class="sd">    num : int, default=10</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a><span class="sd">        Number of diffuse samples to generate for each normal. Higher values</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a><span class="sd">        give more accurate diffuse reflection modeling but increase computation.</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a><span class="sd">    </span>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a><span class="sd">    Returns</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a><span class="sd">    -------</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a><span class="sd">    diffuse_directions : ndarray, shape (N  num, 3)</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a><span class="sd">        Array of sampled diffuse direction vectors. For each of the N input</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a><span class="sd">        normals, generates num directions, resulting in Nnum total directions.</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a><span class="sd">        Directions are ordered so that directions [inum : (i+1)num] correspond</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a><span class="sd">        to normal i.</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a><span class="sd">    </span>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a><span class="sd">    Notes</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a><span class="sd">    -----</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a><span class="sd">    This function is used to model non-specular (rough) surface reflections.</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a><span class="sd">    Each diffuse direction is randomly sampled from the hemisphere above the</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a><span class="sd">    surface, weighted by the cosine of the angle from the normal (Lambert&#39;s law).</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a><span class="sd">    </span>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a><span class="sd">    The returned array can be fed directly into the ray tracer to simulate</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a><span class="sd">    secondary illumination from diffuse reflections.</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a><span class="sd">    </span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a><span class="sd">    Example</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a><span class="sd">    -------</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a><span class="sd">    &gt;&gt;&gt; normals = np.array([[0, 0, 1], [0, 1, 0]])  # Two normals</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a><span class="sd">    &gt;&gt;&gt; dirs = diffuse(normals, num=5)  # 5 samples each</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a><span class="sd">    &gt;&gt;&gt; dirs.shape</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a><span class="sd">    (10, 3)  # 2 normals  5 samples = 10 directions</span>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>    <span class="n">diffuse_directions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">normals</span><span class="p">):</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>        <span class="n">diff_dirs</span> <span class="o">=</span> <span class="n">sample_lambert_dist</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>        <span class="n">diffuse_directions</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">num</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_dirs</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>    <span class="k">return</span> <span class="n">diffuse_directions</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a><span class="c1"># return _core_diffuse(normals, diffuse_directions, num)</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a><span class="k">def</span> <span class="nf">compute_secondary_bounce</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">index_tri</span><span class="p">,</span> <span class="n">mesh_obj</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">,</span> <span class="n">index_ray</span><span class="p">,</span> <span class="n">diffusion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>                             <span class="n">num_diffuse</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a><span class="sd">    Prepare ray origins and directions for subsequent ray tracing bounces by</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a><span class="sd">    computing specular and optionally diffuse reflection directions.</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a><span class="sd">    </span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a><span class="sd">    This function takes the results of a ray-surface intersection and computes</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a><span class="sd">    the reflected rays needed for the next bounce iteration in multi-bounce</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a><span class="sd">    ray tracing.</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a><span class="sd">    </span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a><span class="sd">    Parameters</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a><span class="sd">    ----------</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a><span class="sd">    location : ndarray, shape (N_hits, 3)</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a><span class="sd">        3D coordinates of ray-surface intersection points.</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a><span class="sd">    index_tri : ndarray, shape (N_hits,)</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a><span class="sd">        Indices of the mesh faces (triangles) that were intersected by rays.</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a><span class="sd">    mesh_obj : trimesh.Trimesh</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a><span class="sd">        The mesh object containing geometry information (vertices, faces, normals).</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a><span class="sd">    ray_directions : ndarray, shape (N_rays, 3)</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a><span class="sd">        Direction vectors of the incident rays (before intersection).</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a><span class="sd">    index_ray : ndarray, shape (N_hits,)</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a><span class="sd">        Indices of the rays that successfully intersected the mesh. Used to</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a><span class="sd">        map from the original ray array to the subset that hit surfaces.</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a><span class="sd">    diffusion : bool, default=False</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a><span class="sd">        If True, compute diffuse reflection directions in addition to specular</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a><span class="sd">        reflections. Used for modeling rough surface scattering.</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a><span class="sd">    num_diffuse : int or None, default=None</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a><span class="sd">        Number of diffuse samples per intersection point. Required if</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a><span class="sd">        diffusion=True, ignored otherwise.</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a><span class="sd">    </span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a><span class="sd">    Returns</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a><span class="sd">    -------</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a><span class="sd">    location : ndarray, shape (N_hits, 3)</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a><span class="sd">        Same as input location (pass-through for convenience).</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a><span class="sd">    reflect_dirs : ndarray, shape (N_hits, 3)</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a><span class="sd">        Specularly reflected ray directions for each intersection point.</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a><span class="sd">        Computed using the law of reflection with surface normals.</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a><span class="sd">    diffuse_dirs : ndarray, shape (N_hits  num_diffuse, 3) or int</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a><span class="sd">        If diffusion=True: array of diffusely reflected directions sampled</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a><span class="sd">        from Lambert distribution for each intersection point.</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a><span class="sd">        If diffusion=False: returns -1 (dummy value for consistent return signature).</span>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a><span class="sd">    </span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a><span class="sd">    Notes</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a><span class="sd">    -----</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a><span class="sd">    This function is typically called iteratively in multi-bounce ray tracing:</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a><span class="sd">    1. First bounce: rays from source hit surface</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a><span class="sd">    2. Compute secondary bounces from intersection points</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a><span class="sd">    3. Trace secondary rays</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a><span class="sd">    4. Repeat for N bounces</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a><span class="sd">    </span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a><span class="sd">    The specular reflections follow the law of reflection, while diffuse</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a><span class="sd">    reflections sample the Lambert cosine distribution, providing physically</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a><span class="sd">    accurate modeling of both mirror-like and rough surfaces.</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>    <span class="n">reflect_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>    <span class="n">normals</span> <span class="o">=</span> <span class="n">mesh_obj</span><span class="o">.</span><span class="n">face_normals</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>    <span class="n">reflect_dirs</span> <span class="o">=</span> <span class="n">reflected</span><span class="p">(</span><span class="n">ray_directions</span><span class="p">[</span><span class="n">index_ray</span><span class="p">],</span> <span class="n">normals</span><span class="p">[</span><span class="n">index_tri</span><span class="p">])</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>    <span class="k">if</span> <span class="n">diffusion</span><span class="p">:</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>        <span class="n">diffuse_dirs</span> <span class="o">=</span> <span class="n">diffuse</span><span class="p">(</span><span class="n">normals</span><span class="p">[</span><span class="n">index_tri</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="n">num_diffuse</span><span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>        <span class="n">diffuse_dirs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Dummy variable for return values management</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>    <span class="k">return</span> <span class="n">location</span><span class="p">,</span> <span class="n">reflect_dirs</span><span class="p">,</span> <span class="n">diffuse_dirs</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a><span class="c1">####################################################################################################</span>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a><span class="c1"># Saving utilities</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a><span class="k">def</span> <span class="nf">save_for_visualization</span><span class="p">(</span><span class="n">outputFilePath</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">index_tri</span><span class="p">,</span> <span class="n">diffusion_pack</span><span class="p">):</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a><span class="sd">    Save ray tracing results to a pickled dictionary for post-processing and</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a><span class="sd">    visualization.</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a><span class="sd">    </span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a><span class="sd">    Creates a standardized output format that can be loaded by visualization</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a><span class="sd">    scripts (see visual_utils module) for analyzing ray tracing results,</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a><span class="sd">    creating visualizations, and debugging ray path geometries.</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a><span class="sd">    </span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a><span class="sd">    Parameters</span>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a><span class="sd">    ----------</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a><span class="sd">    outputFilePath : str</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a><span class="sd">        Path to output file. Should end with &#39;.pkl&#39; extension. Parent directory</span>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a><span class="sd">        must exist.</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a><span class="sd">    mesh : trimesh.Trimesh</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a><span class="sd">        The mesh object that was ray-traced. Contains geometry (vertices, faces,</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a><span class="sd">        normals) for visualization.</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a><span class="sd">    ray_origins : list of ndarrays</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a><span class="sd">        List containing ray origin arrays for each bounce. Each element is an</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a><span class="sd">        array of shape (N_rays_i, 3) where i is the bounce number.</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a><span class="sd">    ray_directions : list of ndarrays</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a><span class="sd">        List containing ray direction arrays for each bounce. Same structure</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a><span class="sd">        as ray_origins.</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a><span class="sd">    location : list of ndarrays</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a><span class="sd">        List containing intersection point coordinates for each bounce. Each</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a><span class="sd">        element is shape (N_hits_i, 3).</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a><span class="sd">    index_tri : list of ndarrays</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a><span class="sd">        List containing indices of intersected triangles for each bounce.</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a><span class="sd">        Each element is shape (N_hits_i,).</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a><span class="sd">    diffusion_pack : list or None</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a><span class="sd">        Diffuse ray tracing data if computed, otherwise None. Contains:</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a><span class="sd">        [index_tri_diffusion, index_ray_diffusion, ray_directions_diffusion,</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a><span class="sd">         location_diffusion] for visualization of diffuse scattering.</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a><span class="sd">    </span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a><span class="sd">    Returns</span>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a><span class="sd">    -------</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a><span class="sd">    None</span>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a><span class="sd">        Data is written to file at outputFilePath.</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a><span class="sd">    </span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a><span class="sd">    Notes</span>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a><span class="sd">    -----</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a><span class="sd">    The output file contains a dictionary with keys:</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a><span class="sd">    - &#39;mesh&#39;: trimesh.Trimesh object</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a><span class="sd">    - &#39;ray_origins&#39;: list of origin arrays per bounce</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a><span class="sd">    - &#39;ray_directions&#39;: list of direction arrays per bounce  </span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a><span class="sd">    - &#39;locations&#39;: list of intersection point arrays per bounce</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a><span class="sd">    - &#39;index_tri&#39;: list of triangle index arrays per bounce</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a><span class="sd">    - &#39;diffusion_pack&#39;: diffuse ray data or None</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a><span class="sd">    </span>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a><span class="sd">    This standardized format allows visualization scripts to recreate the full</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a><span class="sd">    ray tracing geometry including multiple bounces and diffuse scattering.</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a><span class="sd">    </span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a><span class="sd">    The file is saved using pickle protocol 4 for Python 3 compatibility.</span>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>    <span class="n">outdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mesh&#39;</span><span class="p">:</span> <span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;ray_origins&#39;</span><span class="p">:</span> <span class="n">ray_origins</span><span class="p">,</span> <span class="s1">&#39;ray_directions&#39;</span><span class="p">:</span> <span class="n">ray_directions</span><span class="p">,</span> <span class="s1">&#39;locations&#39;</span><span class="p">:</span> <span class="n">location</span><span class="p">,</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>               <span class="s1">&#39;index_tri&#39;</span><span class="p">:</span> <span class="n">index_tri</span><span class="p">,</span> <span class="s1">&#39;diffusion_pack&#39;</span><span class="p">:</span> <span class="n">diffusion_pack</span><span class="p">}</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outputFilePath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>        <span class="n">pkl</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">outdict</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a><span class="k">def</span> <span class="nf">exportEXAC</span><span class="p">(</span><span class="n">satelliteID</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">tstep</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">outFileName</span><span class="p">):</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a><span class="sd">    Export acceleration data to GEODYN EXAC (External Accelerations) file format.</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a><span class="sd">    </span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a><span class="sd">    GEODYN is NASA&#39;s precision orbit determination software. The EXAC format is</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a><span class="sd">    a Fortran-formatted binary file used to provide time-varying external</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a><span class="sd">    accelerations (such as solar radiation pressure) to the orbit propagator.</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a><span class="sd">    </span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a><span class="sd">    Parameters</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a><span class="sd">    ----------</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a><span class="sd">    satelliteID : int</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a><span class="sd">        Satellite identifier code used in GEODYN processing.</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a><span class="sd">    data : ndarray, shape (N, 3)</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a><span class="sd">        Acceleration data to be written, in km/s. Each row is [ax, ay, az]</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a><span class="sd">        at one time step.</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a><span class="sd">    tstep : int or float</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a><span class="sd">        Time step between data records in seconds (e.g., 60 for 1-minute data).</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a><span class="sd">    startTime : datetime.datetime</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a><span class="sd">        Start time of the data series. Must include date and time information</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a><span class="sd">        down to microseconds.</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a><span class="sd">    endTime : datetime.datetime</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="sd">        End time of the data series. Must be consistent with len(data) and tstep.</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="sd">    outFileName : str</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a><span class="sd">        Path to output EXAC file. Typically uses .exac or .bin extension.</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a><span class="sd">    </span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a><span class="sd">    Returns</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a><span class="sd">    -------</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a><span class="sd">    None</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="sd">        Data is written to binary file at outFileName.</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a><span class="sd">    </span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a><span class="sd">    Notes</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a><span class="sd">    -----</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="sd">    EXAC File Structure:</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="sd">    - Master header record: Control parameters and file type identifier</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a><span class="sd">    - Satellite-specific header: Satellite ID, time step, start/end times</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a><span class="sd">    - Data records: Time stamp + 3D acceleration vector + padding zeros</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a><span class="sd">    </span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a><span class="sd">    Time Format:</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a><span class="sd">    - Stored as YYMMDDHHMMSS (year-month-day-hour-minute-second-microsecond)</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a><span class="sd">    - Year uses 2-digit format (YY)</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a><span class="sd">    </span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a><span class="sd">    Coordinate System:</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a><span class="sd">    - Accelerations should be in the same reference frame as the GEODYN</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a><span class="sd">      orbit integration (typically J2000 or ICRF)</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a><span class="sd">    </span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a><span class="sd">    Units:</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a><span class="sd">    - Accelerations: km/s</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a><span class="sd">    - Time step: seconds</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a><span class="sd">    </span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a><span class="sd">    This format is used for high-precision orbit determination where external</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a><span class="sd">    non-gravitational forces (solar pressure, atmospheric drag, etc.) need to</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a><span class="sd">    be accurately modeled.</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a><span class="sd">    </span>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a><span class="sd">    Requires scipy.io.FortranFile for binary I/O operations.</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>    <span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">FortranFile</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>    <span class="kn">import</span> <span class="nn">datetime</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>    <span class="n">satid</span> <span class="o">=</span> <span class="n">satelliteID</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>    <span class="n">date0</span> <span class="o">=</span> <span class="n">startTime</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>    <span class="n">date1</span> <span class="o">=</span> <span class="n">endTime</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>    <span class="n">dt</span> <span class="o">=</span> <span class="n">tstep</span>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>    <span class="n">deltatime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>    <span class="n">outfile</span> <span class="o">=</span> <span class="n">FortranFile</span><span class="p">(</span><span class="n">outFileName</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>    <span class="c1"># General Header</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>    <span class="n">masterhdr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">6666666.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>    <span class="n">outfile</span><span class="o">.</span><span class="n">write_record</span><span class="p">(</span><span class="n">masterhdr</span><span class="p">)</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>    <span class="c1"># Satellite specific header</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>    <span class="n">sathdr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">7777777.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">satid</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">date0</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">date0</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)),</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>                       <span class="nb">float</span><span class="p">(</span><span class="n">date1</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">date1</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)),</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>    <span class="n">outfile</span><span class="o">.</span><span class="n">write_record</span><span class="p">(</span><span class="n">sathdr</span><span class="p">)</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>    <span class="c1"># Data records</span>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>    <span class="n">date</span> <span class="o">=</span> <span class="n">date0</span> <span class="o">-</span> <span class="n">deltatime</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>    <span class="k">for</span> <span class="n">d_elem</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>        <span class="n">date</span> <span class="o">=</span> <span class="n">date</span> <span class="o">+</span> <span class="n">deltatime</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>        <span class="n">datarec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>            <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)),</span> <span class="n">d_elem</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d_elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d_elem</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>             <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>        <span class="n">outfile</span><span class="o">.</span><span class="n">write_record</span><span class="p">(</span><span class="n">datarec</span><span class="p">)</span>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a><span class="c1">#####################################################################################################</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a><span class="c1"># Define utils specific to Embree3 implementation</span>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a><span class="c1"># (Provided by Sam Potter)</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a><span class="k">def</span> <span class="nf">Embree3_init_geometry</span><span class="p">(</span><span class="n">mesh_obj</span><span class="p">):</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a><span class="sd">    Initialize mesh geometry for ray tracing using the Embree 3 ray tracing kernel.</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a><span class="sd">    </span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a><span class="sd">    Converts a trimesh mesh object into an EmbreeTrimeshShapeModel that can be</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a><span class="sd">    efficiently ray-traced using Intel&#39;s Embree library. Precomputes surface</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a><span class="sd">    normals and face areas for performance.</span>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a><span class="sd">    </span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a><span class="sd">    Parameters</span>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a><span class="sd">    ----------</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a><span class="sd">    mesh_obj : trimesh.Trimesh</span>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a><span class="sd">        Input mesh object containing vertices and faces. Must be a valid</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a><span class="sd">        triangular mesh.</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a><span class="sd">    </span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a><span class="sd">    Returns</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a><span class="sd">    -------</span>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a><span class="sd">    scene : EmbreeTrimeshShapeModel</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a><span class="sd">        Shape model object containing:</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a><span class="sd">        - V: vertex coordinates array</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a><span class="sd">        - F: face index array</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a><span class="sd">        - N: face normal vectors</span>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a><span class="sd">        - A: face areas</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a><span class="sd">        - scene: Embree scene object for ray tracing</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a><span class="sd">    </span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a><span class="sd">    Notes</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a><span class="sd">    -----</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a><span class="sd">    This function performs initial geometry setup required by Embree:</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a><span class="sd">    1. Extracts vertices (V) and faces (F) from mesh</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a><span class="sd">    2. Computes face normals (N) and areas (A)</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a><span class="sd">    3. Creates Embree device, geometry, and scene objects</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a><span class="sd">    4. Loads vertex and index buffers into Embree</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a><span class="sd">    </span>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a><span class="sd">    The returned object can be used with Embree&#39;s ray intersection functions</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a><span class="sd">    for high-performance ray tracing. Embree uses hardware-accelerated BVH</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a><span class="sd">    (Bounding Volume Hierarchy) structures for fast ray-triangle intersections.</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a><span class="sd">    </span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a><span class="sd">    NOTE: The Embree 3 wrapper functions were developed by Sam Potter</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a><span class="sd">    (https://github.com/sampotter/python-embree)</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a><span class="sd">    </span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a><span class="sd">    See Also</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a><span class="sd">    --------</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a><span class="sd">    EmbreeTrimeshShapeModel : The shape model class</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a><span class="sd">    RTXkernel : Main ray tracing interface</span>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh_obj</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh_obj</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>    <span class="c1"># P = get_centroids(V, F)</span>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>    <span class="n">N</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">get_surface_normals_and_face_areas</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>    <span class="k">return</span> <span class="n">EmbreeTrimeshShapeModel</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">)</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a><span class="k">def</span> <span class="nf">Embree3_init_rayhit</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">):</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a><span class="sd">    Initialize Embree 3 RayHit data structure for ray tracing queries.</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a><span class="sd">    </span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a><span class="sd">    Creates and configures an Embree RayHit1M object that stores ray information</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a><span class="sd">    (origins, directions, parameters) and will be populated with hit information</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a><span class="sd">    (intersection distances, geometry IDs) by the ray tracer.</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a><span class="sd">    </span>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a><span class="sd">    Parameters</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a><span class="sd">    ----------</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a><span class="sd">    ray_origins : ndarray, shape (N, 3)</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a><span class="sd">        Starting positions of rays in 3D space.</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a><span class="sd">    ray_directions : ndarray, shape (N, 3)</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a><span class="sd">        Direction vectors of rays (do not need to be normalized; Embree handles</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a><span class="sd">        this internally).</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a><span class="sd">    </span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a><span class="sd">    Returns</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a><span class="sd">    -------</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a><span class="sd">    rayhit : embree.RayHit1M</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a><span class="sd">        Initialized RayHit structure containing:</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a><span class="sd">        - org: ray origin coordinates (set from ray_origins)</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a><span class="sd">        - dir: ray direction vectors (set from ray_directions)</span>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a><span class="sd">        - tnear: minimum ray parameter (set to 0.0 to trace from origin)</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a><span class="sd">        - tfar: maximum ray parameter (set to infinity for unbounded rays)</span>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a><span class="sd">        - prim_id: primitive (triangle) ID (initialized to INVALID, filled by tracer)</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a><span class="sd">        - geom_id: geometry ID (initialized to INVALID, filled by tracer)</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a><span class="sd">    </span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a><span class="sd">    Notes</span>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a><span class="sd">    -----</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a><span class="sd">    The RayHit1M structure supports tracing multiple rays simultaneously (the &quot;1M&quot;</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a><span class="sd">    indicates &quot;1 Million&quot; rays capability). After calling Embree&#39;s intersect</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a><span class="sd">    function, the structure will contain:</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a><span class="sd">    - Updated tnear/tfar values indicating intersection distances</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a><span class="sd">    - prim_id: index of intersected triangle (-1 if no hit)</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a><span class="sd">    - geom_id: geometry identifier (-1 if no hit)</span>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a><span class="sd">    - uv: barycentric coordinates of intersection point within triangle</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a><span class="sd">    </span>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a><span class="sd">    The tnear parameter is set to 0.0 rather than a small epsilon to avoid</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a><span class="sd">    missing intersections, but this may cause numerical issues with very close</span>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a><span class="sd">    surfaces. Adjust if needed for specific applications.</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>    <span class="n">nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Number of tracked rays</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>    <span class="n">rayhit</span> <span class="o">=</span> <span class="n">embree</span><span class="o">.</span><span class="n">RayHit1M</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>    <span class="c1"># Initialize the ray structure</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>    <span class="c1"># rayhit.tnear[:] = 0.001 #Avoid numerical problems</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>    <span class="n">rayhit</span><span class="o">.</span><span class="n">tnear</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.00</span>  <span class="c1"># Avoid numerical problems</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a>    <span class="n">rayhit</span><span class="o">.</span><span class="n">tfar</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a>    <span class="n">rayhit</span><span class="o">.</span><span class="n">prim_id</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">embree</span><span class="o">.</span><span class="n">INVALID_GEOMETRY_ID</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>    <span class="n">rayhit</span><span class="o">.</span><span class="n">geom_id</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">embree</span><span class="o">.</span><span class="n">INVALID_GEOMETRY_ID</span>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a>    <span class="n">rayhit</span><span class="o">.</span><span class="n">org</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ray_origins</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a>    <span class="n">rayhit</span><span class="o">.</span><span class="n">dir</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ray_directions</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a>    <span class="k">return</span> <span class="n">rayhit</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a><span class="k">def</span> <span class="nf">Embree3_dump_solution</span><span class="p">(</span><span class="n">rayhit</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a><span class="sd">    Extract and process ray-surface intersection results from Embree RayHit structure.</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">    </span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a><span class="sd">    After Embree&#39;s ray tracing kernel completes, this function extracts the</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a><span class="sd">    intersection data and converts it into standard numpy arrays. It computes</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a><span class="sd">    actual 3D intersection point coordinates from barycentric coordinates.</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a><span class="sd">    </span>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a><span class="sd">    Parameters</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a><span class="sd">    ----------</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a><span class="sd">    rayhit : embree.RayHit1M</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a><span class="sd">        RayHit structure populated by Embree&#39;s intersect function, containing</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a><span class="sd">        primitive IDs, geometry IDs, barycentric coordinates, etc.</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a><span class="sd">    V : ndarray, shape (N_vertices, 3)</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a><span class="sd">        Vertex coordinates of the mesh.</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a><span class="sd">    F : ndarray, shape (N_faces, 3)</span>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a><span class="sd">        Face indices of the mesh (each row contains indices of 3 vertices</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a><span class="sd">        forming a triangle).</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a><span class="sd">    </span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a><span class="sd">    Returns</span>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a><span class="sd">    -------</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a><span class="sd">    hits : ndarray, shape (N_hits,) or int</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a><span class="sd">        Indices of triangles that were intersected. Returns -1 if no hits.</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a><span class="sd">    nhits : int</span>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a><span class="sd">        Number of rays that intersected the mesh. Returns -1 if no hits.</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a><span class="sd">    idh : ndarray, shape (N_hits,) or int</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a><span class="sd">        Indices of rays that successfully hit the mesh (mapping from original</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a><span class="sd">        ray array to hit subset). Returns -1 if no hits.</span>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a><span class="sd">    Ph : ndarray, shape (N_hits, 3) or int</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a><span class="sd">        3D coordinates of intersection points computed from barycentric</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a><span class="sd">        coordinates. Returns -1 if no hits.</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a><span class="sd">    </span>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a><span class="sd">    Notes</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a><span class="sd">    -----</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a><span class="sd">    The function identifies valid hits by checking if prim_id != INVALID_GEOMETRY_ID.</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a><span class="sd">    </span>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a><span class="sd">    For valid hits, intersection points are computed using barycentric interpolation:</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a><span class="sd">        Ph = v1 + (v2 - v1) * u + (v3 - v1) * v</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a><span class="sd">    where:</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a><span class="sd">    - v1, v2, v3 are the triangle vertices</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a><span class="sd">    - u, v are barycentric coordinates from rayhit.uv</span>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a><span class="sd">    - Ph is the 3D intersection point</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a><span class="sd">    </span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a><span class="sd">    If no intersections occurred (nhits=0), all return values are -1 to indicate</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a><span class="sd">    no valid data.</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>    <span class="n">ishit</span> <span class="o">=</span> <span class="n">rayhit</span><span class="o">.</span><span class="n">prim_id</span> <span class="o">!=</span> <span class="n">embree</span><span class="o">.</span><span class="n">INVALID_GEOMETRY_ID</span>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>    <span class="n">idh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ishit</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>    <span class="n">hits</span> <span class="o">=</span> <span class="n">rayhit</span><span class="o">.</span><span class="n">prim_id</span><span class="p">[</span><span class="n">idh</span><span class="p">]</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>    <span class="n">nhits</span> <span class="o">=</span> <span class="n">hits</span><span class="o">.</span><span class="n">size</span>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>    <span class="k">if</span> <span class="n">nhits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="n">F</span><span class="p">[</span><span class="n">hits</span><span class="p">]]</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>        <span class="n">v1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>        <span class="n">v2</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>        <span class="n">v3</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>        <span class="n">u</span> <span class="o">=</span> <span class="n">rayhit</span><span class="o">.</span><span class="n">uv</span><span class="p">[</span><span class="n">idh</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>        <span class="n">v</span> <span class="o">=</span> <span class="n">rayhit</span><span class="o">.</span><span class="n">uv</span><span class="p">[</span><span class="n">idh</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>        <span class="n">Ph</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">+</span> <span class="p">(</span><span class="n">v2</span> <span class="o">-</span> <span class="n">v1</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v3</span> <span class="o">-</span> <span class="n">v1</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>        <span class="k">return</span> <span class="n">hits</span><span class="p">,</span> <span class="n">nhits</span><span class="p">,</span> <span class="n">idh</span><span class="p">,</span> <span class="n">Ph</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a><span class="c1"># Define utils specific to CGAL implementation</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a><span class="c1"># (from python-flux)</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a><span class="k">def</span> <span class="nf">cgal_init_geometry</span><span class="p">(</span><span class="n">mesh_obj</span><span class="p">):</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a><span class="sd">    Initialize mesh geometry for ray tracing using the CGAL (Computational Geometry</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a><span class="sd">    Algorithms Library) ray tracing kernel.</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a><span class="sd">    </span>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a><span class="sd">    Converts a trimesh mesh object into a CgalTrimeshShapeModel that uses CGAL&#39;s</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a><span class="sd">    AABB (Axis-Aligned Bounding Box) tree for efficient ray-triangle intersections.</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a><span class="sd">    </span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a><span class="sd">    Parameters</span>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a><span class="sd">    ----------</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a><span class="sd">    mesh_obj : trimesh.Trimesh</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a><span class="sd">        Input mesh object containing vertices and faces.</span>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a><span class="sd">    </span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a><span class="sd">    Returns</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a><span class="sd">    -------</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a><span class="sd">    CgalTrimeshShapeModel : shape model object</span>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a><span class="sd">        Shape model configured for CGAL ray tracing, containing:</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a><span class="sd">        - V: vertex coordinates</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a><span class="sd">        - F: face indices</span>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a><span class="sd">        - N: face normals</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a><span class="sd">        - A: face areas</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a><span class="sd">        - aabb: CGAL AABB tree structure for fast queries</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a><span class="sd">    </span>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a><span class="sd">    Notes</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a><span class="sd">    -----</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a><span class="sd">    CGAL is a C++ library providing robust geometric algorithms. The AABB tree</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a><span class="sd">    structure enables efficient ray tracing through hierarchical spatial subdivision.</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a><span class="sd">    </span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a><span class="sd">    This function is adapted from python-flux. CGAL may be more robust than</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a><span class="sd">    Embree for certain edge cases (nearly degenerate triangles, numerical precision</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a><span class="sd">    issues) but is typically slower for large numbers of rays.</span>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a><span class="sd">    </span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a><span class="sd">    See Also</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a><span class="sd">    --------</span>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a><span class="sd">    CgalTrimeshShapeModel : The CGAL-based shape model class</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a><span class="sd">    RTXkernel : Main ray tracing interface that can use CGAL kernel</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh_obj</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh_obj</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>    <span class="n">N</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">get_surface_normals_and_face_areas</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>    <span class="k">return</span> <span class="n">CgalTrimeshShapeModel</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">)</span>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a><span class="c1">######################### from python-flux.src.flux.shape.py</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a><span class="k">def</span> <span class="nf">get_centroids</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a><span class="sd">    Compute the geometric centroids of all triangular faces in a mesh.</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a><span class="sd">    </span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a><span class="sd">    The centroid of a triangle is the arithmetic mean of its three vertices,</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a><span class="sd">    representing the triangle&#39;s center of mass (assuming uniform density).</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a><span class="sd">    </span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a><span class="sd">    Parameters</span>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a><span class="sd">    ----------</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a><span class="sd">    V : ndarray, shape (N_vertices, 3)</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="sd">        Vertex coordinates of the mesh.</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a><span class="sd">    F : ndarray, shape (N_faces, 3)</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a><span class="sd">        Face indices. Each row contains three vertex indices forming a triangle.</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="sd">    </span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">    Returns</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a><span class="sd">    -------</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a><span class="sd">    P : ndarray, shape (N_faces, 3)</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a><span class="sd">        Centroid coordinates for each face. P[i] = (V[F[i][0]] + V[F[i][1]] +</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a><span class="sd">        V[F[i][2]]) / 3</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a><span class="sd">    </span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">    Notes</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">    -----</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a><span class="sd">    Uses vectorized numpy operations: V[F] creates shape (N_faces, 3, 3) array</span>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="sd">    where V[F][i] is the 33 matrix of vertices for face i. Taking mean along</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a><span class="sd">    axis=1 computes centroids efficiently for all faces simultaneously.</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>    <span class="k">return</span> <span class="n">V</span><span class="p">[</span><span class="n">F</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a><span class="k">def</span> <span class="nf">get_cross_products</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a><span class="sd">    Compute cross products of edge vectors for all triangular faces in a mesh.</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a><span class="sd">    </span>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a><span class="sd">    For each triangle, computes the cross product of two edge vectors. The</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a><span class="sd">    magnitude of this cross product equals twice the triangle&#39;s area, and its</span>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a><span class="sd">    direction is perpendicular to the triangle plane (unnormalized normal).</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a><span class="sd">    </span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a><span class="sd">    Parameters</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a><span class="sd">    ----------</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a><span class="sd">    V : ndarray, shape (N_vertices, 3)</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a><span class="sd">        Vertex coordinates of the mesh.</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a><span class="sd">    F : ndarray, shape (N_faces, 3)</span>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a><span class="sd">        Face indices. Each row contains three vertex indices [v0, v1, v2].</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a><span class="sd">    </span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a><span class="sd">    Returns</span>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a><span class="sd">    -------</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a><span class="sd">    C : ndarray, shape (N_faces, 3)</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a><span class="sd">        Cross product vectors for each face. C[i] = (v1 - v0)  (v2 - v0)</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a><span class="sd">        where v0, v1, v2 are the vertices of triangle i.</span>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a><span class="sd">    </span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a><span class="sd">    Notes</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a><span class="sd">    -----</span>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a><span class="sd">    Used internally by get_face_areas and get_surface_normals for efficient</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a><span class="sd">    vectorized computation of geometric properties.</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>    <span class="n">V0</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="n">F</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">F</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">V0</span><span class="p">,</span> <span class="n">V</span><span class="p">[</span><span class="n">F</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">V0</span><span class="p">)</span>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>    <span class="k">return</span> <span class="n">C</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a><span class="k">def</span> <span class="nf">get_face_areas</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a><span class="sd">    Compute the areas of all triangular faces in a mesh.</span>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a><span class="sd">    </span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a><span class="sd">    Parameters</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a><span class="sd">    ----------</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a><span class="sd">    V : ndarray, shape (N_vertices, 3)</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a><span class="sd">        Vertex coordinates of the mesh.</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a><span class="sd">    F : ndarray, shape (N_faces, 3)</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a><span class="sd">        Face indices.</span>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a><span class="sd">    </span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a><span class="sd">    Returns</span>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a><span class="sd">    -------</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a><span class="sd">    A : ndarray, shape (N_faces,)</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a><span class="sd">        Area of each face in the same units as V (e.g., if V is in meters,</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a><span class="sd">        areas are in square meters).</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a><span class="sd">    </span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>    <span class="n">C</span> <span class="o">=</span> <span class="n">get_cross_products</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>    <span class="n">C_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>    <span class="n">A</span> <span class="o">=</span> <span class="n">C_norms</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>    <span class="k">return</span> <span class="n">A</span>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a><span class="k">def</span> <span class="nf">get_surface_normals</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a><span class="sd">    Compute outward-pointing unit normal vectors for all triangular faces.</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a><span class="sd">    </span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a><span class="sd">    Parameters</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a><span class="sd">    ----------</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a><span class="sd">    V : ndarray, shape (N_vertices, 3)</span>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a><span class="sd">        Vertex coordinates of the mesh.</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a><span class="sd">    F : ndarray, shape (N_faces, 3)</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a><span class="sd">        Face indices.</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a><span class="sd">    </span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a><span class="sd">    Returns</span>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a><span class="sd">    -------</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a><span class="sd">    N : ndarray, shape (N_faces, 3)</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a><span class="sd">        Unit normal vectors perpendicular to each face. Direction follows</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a><span class="sd">        right-hand rule with respect to vertex ordering in F.</span>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a><span class="sd">    </span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a><span class="sd"> </span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>    <span class="n">C</span> <span class="o">=</span> <span class="n">get_cross_products</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>    <span class="n">C_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>    <span class="n">N</span> <span class="o">=</span> <span class="n">C</span> <span class="o">/</span> <span class="n">C_norms</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>    <span class="k">return</span> <span class="n">N</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a><span class="k">def</span> <span class="nf">get_surface_normals_and_face_areas</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a><span class="sd">    Efficiently compute both surface normals and face areas simultaneously.</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a><span class="sd">    </span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a><span class="sd">    This is more efficient than calling get_surface_normals and get_face_areas</span>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a><span class="sd">    separately because it computes the cross products only once.</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a><span class="sd">    </span>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a><span class="sd">    Parameters</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a><span class="sd">    ----------</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a><span class="sd">    V : ndarray, shape (N_vertices, 3)</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a><span class="sd">        Vertex coordinates of the mesh.</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a><span class="sd">    F : ndarray, shape (N_faces, 3)</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a><span class="sd">        Face indices.</span>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a><span class="sd">    </span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a><span class="sd">    Returns</span>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a><span class="sd">    -------</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a><span class="sd">    N : ndarray, shape (N_faces, 3)</span>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a><span class="sd">        Unit normal vectors for each face.</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a><span class="sd">    A : ndarray, shape (N_faces,)</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a><span class="sd">        Area of each face.</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a><span class="sd">    </span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a><span class="sd">    Notes</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a><span class="sd">    -----</span>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a><span class="sd">    Computation steps:</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a><span class="sd">    1. Compute cross products C = (v1 - v0)  (v2 - v0)</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a><span class="sd">    2. Compute magnitudes ||C||</span>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a><span class="sd">    3. Normals: N = C / ||C||</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a><span class="sd">    4. Areas: A = ||C|| / 2</span>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a><span class="sd">    </span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a><span class="sd">    This is the recommended function when both quantities are needed, as it</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a><span class="sd">    avoids redundant cross product calculations.</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a>    <span class="n">C</span> <span class="o">=</span> <span class="n">get_cross_products</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a>    <span class="n">C_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a>    <span class="n">N</span> <span class="o">=</span> <span class="n">C</span> <span class="o">/</span> <span class="n">C_norms</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a>    <span class="n">A</span> <span class="o">=</span> <span class="n">C_norms</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a>    <span class="k">return</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a><span class="k">class</span> <span class="nc">ShapeModel</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>    <span class="k">pass</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a><span class="k">class</span> <span class="nc">TrimeshShapeModel</span><span class="p">(</span><span class="n">ShapeModel</span><span class="p">):</span>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A shape model consisting of a single triangle mesh.&quot;&quot;&quot;</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a triangle mesh shape model. No assumption is made about</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a><span class="sd">        the way vertices or faces are stored when building the shape</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a><span class="sd">        model except that V[F] yields the faces of the mesh. Vertices</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a><span class="sd">        may be repeated or not.</span>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a><span class="sd">        Parameters</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a><span class="sd">        ----------</span>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a><span class="sd">        V : array_like</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a><span class="sd">            An array with shape (num_verts, 3) whose rows correspond to the</span>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a><span class="sd">            vertices of the triangle mesh</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a><span class="sd">        F : array_like</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a><span class="sd">            An array with shape (num_faces, 3) whose rows index the faces</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a><span class="sd">            of the triangle mesh (i.e., V[F] returns an array with shape</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a><span class="sd">            (num_faces, 3, 3) such that V[F][i] is a 3x3 matrix whose rows</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a><span class="sd">            are the vertices of the ith face.</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a><span class="sd">        N : array_like, optional</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a><span class="sd">            An array with shape (num_faces, 3) consisting of the triangle</span>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a><span class="sd">            mesh face normals. Can be passed to specify the face normals.</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a><span class="sd">            Otherwise, the face normals will be computed from the cross products</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a><span class="sd">            of the face edges (i.e. np.cross(vi1 - vi0, vi2 - vi0) normalized).</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a><span class="sd">        P : array_like, optional</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a><span class="sd">            An array with shape (num_faces, 3) consisting of the triangle</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a><span class="sd">            centroids. Can be optionally passed to avoid recomputing.</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a><span class="sd">        A : array_like, optional</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a><span class="sd">            An array of shape (num_faces,) containing the triangle areas. Can</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a><span class="sd">            be optionally passed to avoid recomputing.</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">TrimeshShapeModel</span><span class="p">:</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;tried to instantiate TrimeshShapeModel directly&quot;</span><span class="p">)</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">V</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">F</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>        <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">A</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>            <span class="n">N</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">get_surface_normals_and_face_areas</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>        <span class="k">elif</span> <span class="n">A</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>            <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>                    <span class="s1">&#39;must pass same number of surface normals as faces (got &#39;</span> <span class="o">+</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>                    <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> faces and </span><span class="si">%d</span><span class="s1"> normals&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>                <span class="p">)</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>            <span class="n">A</span> <span class="o">=</span> <span class="n">get_face_areas</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>        <span class="k">elif</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="n">get_surface_normals</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">get_centroids</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">N</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">A</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_make_scene</span><span class="p">()</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a>    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">))</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>        <span class="k">return</span> <span class="s1">&#39;a TrimeshShapeModel with </span><span class="si">%d</span><span class="s1"> vertices and </span><span class="si">%d</span><span class="s1"> faces&#39;</span> <span class="o">%</span> <span class="p">(</span>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_verts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_faces</span><span class="p">)</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a>    <span class="nd">@property</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a>    <span class="k">def</span> <span class="nf">num_faces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a>    <span class="nd">@property</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a>    <span class="k">def</span> <span class="nf">num_verts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a>    <span class="k">def</span> <span class="nf">intersect1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Trace a single ray starting from `x` and in the direction `d`.  If</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a><span class="sd">        there is a hit, return the index (`i`) of the hit and a</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a><span class="sd">        parameter `t` such that the hit point is given by `x(t) = x +</span>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a><span class="sd">        t*d`.</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intersect1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>    <span class="k">def</span> <span class="nf">intersect1_2d_with_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Trace a single ray starting from `X` and in the direction `D`.  If</span>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a><span class="sd">        there is a hit, return the index (`i`) of the hit and the coordinates of</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a><span class="sd">        the centroid of the hit triangle `X(t) = X + t*D`.</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intersect1_2d_with_coords</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a>    <span class="k">def</span> <span class="nf">intersect1_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Trace a single ray starting from `X` and in the direction `D`.  If</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a><span class="sd">        there is a hit, return the index (`i`).</span>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>        <span class="n">fint</span><span class="p">,</span> <span class="n">xta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersect1_2d_with_coords</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a>        <span class="k">return</span> <span class="n">fint</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a><span class="k">class</span> <span class="nc">CgalTrimeshShapeModel</span><span class="p">(</span><span class="n">TrimeshShapeModel</span><span class="p">):</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>    <span class="k">def</span> <span class="nf">_make_scene</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aabb</span> <span class="o">=</span> <span class="n">AABB</span><span class="o">.</span><span class="n">from_trimesh</span><span class="p">(</span>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uintp</span><span class="p">))</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>    <span class="k">def</span> <span class="nf">_intersect1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aabb</span><span class="o">.</span><span class="n">intersect1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>    <span class="k">def</span> <span class="nf">_intersect1_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aabb</span><span class="o">.</span><span class="n">intersect1_2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>    <span class="k">def</span> <span class="nf">_intersect1_2d_with_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aabb</span><span class="o">.</span><span class="n">intersect1_2d_with_coords</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a><span class="k">class</span> <span class="nc">EmbreeTrimeshShapeModel</span><span class="p">(</span><span class="n">TrimeshShapeModel</span><span class="p">):</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>    <span class="k">def</span> <span class="nf">_make_scene</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Set up an Embree scene. This function allocates some memory that</span>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a><span class="sd">        Embree manages, and loads vertices and index lists for the</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a><span class="sd">        faces. In Embree parlance, this function creates a &quot;device&quot;,</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a><span class="sd">        which manages a &quot;scene&quot;, which has one &quot;geometry&quot; in it, which</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a><span class="sd">        is our mesh.</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">embree</span><span class="o">.</span><span class="n">Device</span><span class="p">()</span>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>        <span class="n">geometry</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">make_geometry</span><span class="p">(</span><span class="n">embree</span><span class="o">.</span><span class="n">GeometryType</span><span class="o">.</span><span class="n">Triangle</span><span class="p">)</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>        <span class="c1"># geometry.set_build_quality(embree.BuildQuality.High)</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>        <span class="n">scene</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">make_scene</span><span class="p">()</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>        <span class="c1"># scene.set_build_quality(embree.BuildQuality.High)</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span><span class="n">embree</span><span class="o">.</span><span class="n">SceneFlags</span><span class="o">.</span><span class="n">Robust</span><span class="p">)</span>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>        <span class="n">vertex_buffer</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">set_new_buffer</span><span class="p">(</span>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>            <span class="n">embree</span><span class="o">.</span><span class="n">BufferType</span><span class="o">.</span><span class="n">Vertex</span><span class="p">,</span>  <span class="c1"># buf_type</span>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a>            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># slot</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a>            <span class="n">embree</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">Float3</span><span class="p">,</span>  <span class="c1"># fmt</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>            <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span>  <span class="c1"># byte_stride</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># item_count</span>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>        <span class="p">)</span>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a>        <span class="n">vertex_buffer</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[:]</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a>        <span class="c1">#</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a>        <span class="n">index_buffer</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">set_new_buffer</span><span class="p">(</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a>            <span class="n">embree</span><span class="o">.</span><span class="n">BufferType</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span>  <span class="c1"># buf_type</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># slot</span>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a>            <span class="n">embree</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">Uint3</span><span class="p">,</span>  <span class="c1"># fmt</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a>            <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;uint32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span>  <span class="c1"># byte_stride,</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a>        <span class="p">)</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a>        <span class="n">index_buffer</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">[:]</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a>        <span class="n">geometry</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">attach_geometry</span><span class="p">(</span><span class="n">geometry</span><span class="p">)</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>        <span class="n">geometry</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>        <span class="c1"># This is the only variable we need to retain a reference to</span>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>        <span class="c1"># (I think)</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scene</span> <span class="o">=</span> <span class="n">scene</span>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>        <span class="n">device</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>    <span class="k">def</span> <span class="nf">_intersect1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;intersect1 no implemented for EmbreeTrimeshShapeModel&#39;</span><span class="p">)</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a><span class="n">trimesh_shape_models</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>    <span class="n">CgalTrimeshShapeModel</span><span class="p">,</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>    <span class="n">EmbreeTrimeshShapeModel</span>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a><span class="p">]</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a><span class="c1"># Main definition of the kernel wrapper</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a><span class="c1"># -----------------------------------------------------------------------------------------------------#</span>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a><span class="k">def</span> <span class="nf">RTXkernel</span><span class="p">(</span><span class="n">mesh_obj</span><span class="p">,</span> <span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">,</span> <span class="n">bounces</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;Embree3&#39;</span><span class="p">,</span> <span class="n">diffusion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_diffuse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>              <span class="n">errorMsg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a><span class="sd">    Main ray tracing kernel wrapper supporting multiple ray tracing backends and</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a><span class="sd">    multi-bounce simulations.</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a><span class="sd">    </span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a><span class="sd">    This is the primary interface for performing ray tracing operations in pyRTX.</span>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a><span class="sd">    It supports various ray tracing kernels (Embree, CGAL, Native), multiple</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a><span class="sd">    reflection bounces, and optional diffuse scattering for realistic radiation</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a><span class="sd">    momentum exchange calculatons.</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a><span class="sd">    </span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a><span class="sd">    Parameters</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a><span class="sd">    ----------</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a><span class="sd">    mesh_obj : trimesh.Trimesh</span>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a><span class="sd">        The mesh geometry to ray trace against. Must be a valid triangular mesh.</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a><span class="sd">    ray_origins : ndarray, shape (N_rays, 3)</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a><span class="sd">        Starting positions of rays in 3D space (in same coordinate system as mesh).</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a><span class="sd">    ray_directions : ndarray, shape (N_rays, 3)</span>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a><span class="sd">        Direction vectors of rays. Do not need to be normalized.</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a><span class="sd">    bounces : int, default=1</span>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a><span class="sd">        Number of reflection bounces to simulate. bounces=1 means direct</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a><span class="sd">        illumination only, bounces=2 includes one reflection, etc.</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a><span class="sd">    kernel : str, default=&#39;Embree&#39;</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a><span class="sd">        Ray tracing backend to use:</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a><span class="sd">        - &#39;Embree3&#39;: Intel Embree library (fastest, recommended)</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a><span class="sd">        - &#39;Embree&#39; : Intel Embree library (Version 2, slower than 3)</span>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a><span class="sd">        - &#39;CGAL&#39;: CGAL AABB tree implementation (robust, slower)</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a><span class="sd">        - &#39;Native&#39;: Pure Python implementation (very slow, for reference only)</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a><span class="sd">    diffusion : bool, default=False</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a><span class="sd">        If True, compute diffuse (Lambertian) reflections in addition to</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a><span class="sd">        specular reflections. Only applied to the first bounce. Enables</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a><span class="sd">        realistic modeling of rough surfaces.</span>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a><span class="sd">    num_diffuse : int or None, default=None</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a><span class="sd">        Number of diffuse samples per intersection point. Required if</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a><span class="sd">        diffusion=True. Typical values: 10-100 depending on accuracy needs.</span>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a><span class="sd">    errorMsg : bool, default=True</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a><span class="sd">        If True, print warning messages when no intersections are found for</span>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a><span class="sd">        a bounce. Set to False to suppress warnings in batch processing.</span>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a><span class="sd">    </span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a><span class="sd">    Returns</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a><span class="sd">    -------</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a><span class="sd">    index_tri_container : list of ndarrays</span>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a><span class="sd">        List containing triangle indices for each bounce. Each element is an</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a><span class="sd">        array of shape (N_hits_i,) containing indices of faces hit at bounce i.</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a><span class="sd">        Length equals number of computed bounces ( bounces parameter).</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a><span class="sd">    index_ray_container : list of ndarrays</span>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a><span class="sd">        List containing ray indices for each bounce. index_ray_container[i]</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a><span class="sd">        maps from the original ray array to rays that hit at bounce i.</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a><span class="sd">    locations_container : list of ndarrays</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a><span class="sd">        List of intersection point coordinates for each bounce. Each element</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a><span class="sd">        has shape (N_hits_i, 3).</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a><span class="sd">    ray_origins_container : list of ndarrays</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a><span class="sd">        List of ray origin positions for each bounce. Note that</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a><span class="sd">        ray_origins_container[0] equals the input ray_origins parameter.</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a><span class="sd">    ray_directions_container : list of ndarrays</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a><span class="sd">        List of ray direction vectors for each bounce. Element [0] contains</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a><span class="sd">        input directions, subsequent elements contain reflected directions.</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a><span class="sd">    diffusion_pack : list or None</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a><span class="sd">        If diffusion=True, contains diffuse ray tracing results:</span>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a><span class="sd">        [index_tri_diffusion, index_ray_diffusion, ray_directions_diffusion,</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a><span class="sd">         location_diffusion]. If diffusion=False, returns None.</span>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a><span class="sd">    </span>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a><span class="sd">    Notes</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a><span class="sd">    -----</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a><span class="sd">    Algorithm Overview:</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a><span class="sd">    1. Initialize ray tracing kernel (Embree, CGAL, or Native)</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a><span class="sd">    2. For each bounce:</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a><span class="sd">       a. Add small offset to ray origins (avoids self-intersection)</span>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a><span class="sd">       b. Trace rays to find intersections</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a><span class="sd">       c. If no hits found, terminate and return results up to current bounce</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a><span class="sd">       d. Compute specular reflection directions for next bounce</span>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a><span class="sd">       e. If diffusion enabled and bounce==1, also compute diffuse reflections</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a><span class="sd">    3. Return accumulated results for all bounces</span>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a><span class="sd">    </span>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a><span class="sd">    Performance Notes:</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a><span class="sd">    - Embree is typically 10-100 faster than Native for large meshes</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a><span class="sd">    - CGAL offers good robustness for edge cases but slower than Embree</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a><span class="sd">    - Diffusion increases computation by factor of num_diffuse</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a><span class="sd">    - Memory usage scales linearly with bounces and num_diffuse</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a><span class="sd">    </span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a><span class="sd">    Kernel-Specific Details:</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a><span class="sd">    - Embree/Embree3: Uses BVH acceleration, highly optimized for x86 CPUs</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a><span class="sd">    - CGAL: Uses AABB tree, more robust numerical handling</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a><span class="sd">    - Native: Pure Python/Trimesh, no special acceleration</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a><span class="sd">    </span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a><span class="sd">    The 1e-3 offset added to ray origins prevents numerical precision issues</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a><span class="sd">    where a reflected ray might re-intersect the same surface it just bounced</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a><span class="sd">    from (self-intersection artifact).</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a><span class="sd">    </span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a><span class="sd">    Examples</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a><span class="sd">    --------</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a><span class="sd">    &gt;&gt;&gt; # Simple direct illumination</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a><span class="sd">    &gt;&gt;&gt; results = RTXkernel(mesh, origins, directions, bounces=1, kernel=&#39;Embree&#39;)</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a><span class="sd">    &gt;&gt;&gt; hits, ray_ids, locations, _, _, _ = results</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a><span class="sd">    &gt;&gt;&gt; </span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a><span class="sd">    &gt;&gt;&gt; # Multi-bounce with diffuse scattering</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a><span class="sd">    &gt;&gt;&gt; results = RTXkernel(mesh, origins, directions, bounces=3, </span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a><span class="sd">    ...                     kernel=&#39;Embree&#39;, diffusion=True, num_diffuse=50)</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a><span class="sd">    &gt;&gt;&gt; hits, ray_ids, locs, origins, dirs, diffuse_data = results</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a><span class="sd">    </span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a><span class="sd">    See Also</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a><span class="sd">    --------</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a><span class="sd">    pixel_plane_opt : Generate ray grids for illumination sources</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a><span class="sd">    compute_secondary_bounce : Compute reflection directions</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a><span class="sd">    diffuse : Generate diffuse reflection samples</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a>    <span class="n">ray_origins_container</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a>    <span class="n">ray_directions_container</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a>    <span class="n">locations_container</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a>    <span class="n">index_tri_container</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a>    <span class="n">index_ray_container</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a>    <span class="c1"># Set variables for diffusion computation</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a>    <span class="n">diffusion_directions</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a>    <span class="n">diffusion_pack</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a>    <span class="n">diffusion_control</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a>    <span class="c1"># Select the kernel</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a>    <span class="k">if</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Embree&#39;</span><span class="p">,</span> <span class="s1">&#39;Native&#39;</span><span class="p">]:</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bounces</span><span class="p">):</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a>            <span class="n">ray_origins_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">)</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>            <span class="k">if</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s1">&#39;Embree&#39;</span><span class="p">:</span>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>                <span class="n">intersector</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">ray_pyembree</span><span class="o">.</span><span class="n">RayMeshIntersector</span><span class="p">(</span><span class="n">mesh_obj</span><span class="p">)</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>            <span class="k">elif</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s1">&#39;Native&#39;</span><span class="p">:</span>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>                <span class="n">intersector</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">ray_triangle</span><span class="o">.</span><span class="n">RayMeshIntersector</span><span class="p">(</span><span class="n">mesh_obj</span><span class="p">)</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>            <span class="c1"># Avoid numerical problems</span>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>            <span class="n">ray_origins</span> <span class="o">=</span> <span class="n">ray_origins</span> <span class="o">+</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">ray_directions</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>            <span class="c1"># If computing bounce number 1 and the diffusion computation has been requested</span>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>            <span class="c1"># do a separate raytracing also for the diffused rays</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>            <span class="c1"># and pack results in the variable: diffusion pack</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">diffusion</span><span class="p">:</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>                <span class="n">ray_origins_diffusion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">,</span> <span class="n">num_diffuse</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># this should be correct</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>                <span class="n">ray_directions_diffusion</span> <span class="o">=</span> <span class="n">diffuse_directions</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>                <span class="n">index_tri_diffusion</span><span class="p">,</span> <span class="n">index_ray_diffusion</span><span class="p">,</span> <span class="n">location_diffusion</span> <span class="o">=</span> <span class="n">intersector</span><span class="o">.</span><span class="n">intersects_id</span><span class="p">(</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>                    <span class="n">ray_origins</span><span class="o">=</span><span class="n">ray_origins_diffusion</span><span class="p">,</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>                    <span class="n">ray_directions</span><span class="o">=</span><span class="n">ray_directions_diffusion</span><span class="p">,</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>                    <span class="n">multiple_hits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>                    <span class="n">return_locations</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>                <span class="n">diffusion_pack</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_tri_diffusion</span><span class="p">,</span> <span class="n">index_ray_diffusion</span><span class="p">,</span> <span class="n">ray_directions_diffusion</span><span class="p">,</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>                                  <span class="n">location_diffusion</span><span class="p">]</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>            <span class="c1"># Main Raytracer</span>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>            <span class="n">index_tri</span><span class="p">,</span> <span class="n">index_ray</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="n">intersector</span><span class="o">.</span><span class="n">intersects_id</span><span class="p">(</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>                <span class="n">ray_origins</span><span class="o">=</span><span class="n">ray_origins</span><span class="p">,</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>                <span class="n">ray_directions</span><span class="o">=</span><span class="n">ray_directions</span><span class="p">,</span>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>                <span class="n">multiple_hits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>                <span class="n">return_locations</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>            <span class="c1"># Get the number of hits</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>            <span class="n">n_hits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_tri</span><span class="p">)</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>            <span class="c1"># Manage the possibility of no hits</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>            <span class="k">if</span> <span class="n">n_hits</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">errorMsg</span><span class="p">:</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No intersections found for bounce </span><span class="si">{}</span><span class="s1">. Results provided up to bounce </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>                <span class="k">break</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>                <span class="n">locations_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>                <span class="n">index_tri_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_tri</span><span class="p">)</span>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>                <span class="n">index_ray_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_ray</span><span class="p">)</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>                <span class="n">ray_directions_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_directions</span><span class="p">)</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">bounces</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>                    <span class="c1"># If at bounce number 1 compute the diffused directions:</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>                    <span class="k">if</span> <span class="n">diffusion</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>                        <span class="n">diffusion_control</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>                    <span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">,</span> <span class="n">diffuse_directions</span> <span class="o">=</span> <span class="n">compute_secondary_bounce</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">index_tri</span><span class="p">,</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>                                                                                               <span class="n">mesh_obj</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">,</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>                                                                                               <span class="n">index_ray</span><span class="p">,</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>                                                                                               <span class="n">diffusion</span><span class="o">=</span><span class="n">diffusion_control</span><span class="p">,</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>                                                                                               <span class="n">num_diffuse</span><span class="o">=</span><span class="n">num_diffuse</span><span class="p">)</span>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>                    <span class="c1"># Set back to false the diffusion computation control flag</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>                    <span class="n">diffusion_control</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>    <span class="k">elif</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s1">&#39;Embree3&#39;</span><span class="p">:</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>        <span class="c1"># Initialize the geometry</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>        <span class="n">shape_model</span> <span class="o">=</span> <span class="n">Embree3_init_geometry</span><span class="p">(</span><span class="n">mesh_obj</span><span class="p">)</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">embree</span><span class="o">.</span><span class="n">IntersectContext</span><span class="p">()</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bounces</span><span class="p">):</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>            <span class="n">ray_origins_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">)</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>            <span class="c1"># Initialize the rayhit object</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>            <span class="n">ray_origins</span> <span class="o">=</span> <span class="n">ray_origins</span> <span class="o">+</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">ray_directions</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>            <span class="n">rayhit</span> <span class="o">=</span> <span class="n">Embree3_init_rayhit</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">)</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>            <span class="c1"># Run the intersector</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>            <span class="n">shape_model</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">intersect1M</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">rayhit</span><span class="p">)</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>            <span class="c1"># Post-process the results</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>            <span class="n">index_tri</span><span class="p">,</span> <span class="n">n_hits</span><span class="p">,</span> <span class="n">index_ray</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="n">Embree3_dump_solution</span><span class="p">(</span><span class="n">rayhit</span><span class="p">,</span> <span class="n">shape_model</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">shape_model</span><span class="o">.</span><span class="n">F</span><span class="p">)</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>            <span class="c1"># embree.Device().release()</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>            <span class="c1"># Handle: not bounces found</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>            <span class="k">if</span> <span class="n">n_hits</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No intersections found for bounce </span><span class="si">{}</span><span class="s1">. Results provided up to bounce </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>                <span class="k">break</span>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>            <span class="c1"># Otherwise append results and proceed with next bounce</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>                <span class="n">locations_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>                <span class="n">index_tri_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_tri</span><span class="p">)</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>                <span class="n">index_ray_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_ray</span><span class="p">)</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>                <span class="n">ray_directions_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_directions</span><span class="p">)</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">bounces</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>                    <span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_secondary_bounce</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">index_tri</span><span class="p">,</span> <span class="n">mesh_obj</span><span class="p">,</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>                                                                              <span class="n">ray_directions</span><span class="p">,</span> <span class="n">index_ray</span><span class="p">)</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>        <span class="c1"># # release memory</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>        <span class="c1"># scene.release()</span>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>        <span class="n">shape_model</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>    <span class="k">elif</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s1">&#39;CGAL&#39;</span><span class="p">:</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>        <span class="c1"># Initialize the geometry</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>        <span class="n">shape_model</span> <span class="o">=</span> <span class="n">cgal_init_geometry</span><span class="p">(</span><span class="n">mesh_obj</span><span class="p">)</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bounces</span><span class="p">):</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>            <span class="n">ray_origins_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">)</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>            <span class="c1"># Initialize the rayhit object</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>            <span class="c1"># ray_origins = ray_origins + 1e-3 * ray_directions</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>            <span class="n">index_tri</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="n">shape_model</span><span class="o">.</span><span class="n">intersect1_2d_with_coords</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">)</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>            <span class="n">index_ray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">))</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>            <span class="n">n_hits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index_tri</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>            <span class="n">index_ray</span> <span class="o">=</span> <span class="n">index_ray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index_tri</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>            <span class="n">location</span> <span class="o">=</span> <span class="n">location</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index_tri</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>            <span class="n">index_tri</span> <span class="o">=</span> <span class="n">index_tri</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index_tri</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>            <span class="c1"># print(index_tri, n_hits, index_ray, location)</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>            <span class="c1"># Handle: not bounces found</span>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>            <span class="k">if</span> <span class="n">n_hits</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No intersections found for bounce </span><span class="si">{}</span><span class="s1">. Results provided up to bounce </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>                <span class="k">break</span>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>            <span class="c1"># Otherwise append results and proceed with next bounce</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>                <span class="n">locations_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>                <span class="n">index_tri_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_tri</span><span class="p">)</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>                <span class="n">index_ray_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_ray</span><span class="p">)</span>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>                <span class="n">ray_directions_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_directions</span><span class="p">)</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">bounces</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>                    <span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_secondary_bounce</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">index_tri</span><span class="p">,</span> <span class="n">mesh_obj</span><span class="p">,</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>                                                                              <span class="n">ray_directions</span><span class="p">,</span> <span class="n">index_ray</span><span class="p">)</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Recognized kernel&#39;</span><span class="p">)</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>    <span class="c1"># Manage output variables</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>    <span class="k">if</span> <span class="n">diffusion</span><span class="p">:</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>        <span class="k">return</span> <span class="n">index_tri_container</span><span class="p">,</span> <span class="n">index_ray_container</span><span class="p">,</span> <span class="n">locations_container</span><span class="p">,</span> <span class="n">ray_origins_container</span><span class="p">,</span> <span class="n">ray_directions_container</span><span class="p">,</span> <span class="n">diffusion_pack</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>        <span class="k">return</span> <span class="n">index_tri_container</span><span class="p">,</span> <span class="n">index_ray_container</span><span class="p">,</span> <span class="n">locations_container</span><span class="p">,</span> <span class="n">ray_origins_container</span><span class="p">,</span> <span class="n">ray_directions_container</span><span class="p">,</span> <span class="kc">None</span>
</span></pre></div>


            </section>
                <section id="parallelize">
                            <input id="parallelize-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">parallelize</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">iterator</span>, </span><span class="param"><span class="n">function</span>, </span><span class="param"><span class="n">chunks</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="parallelize-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#parallelize"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="parallelize-48"><a href="#parallelize-48"><span class="linenos">48</span></a><span class="k">def</span> <span class="nf">parallelize</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">chunks</span><span class="p">):</span>
</span><span id="parallelize-49"><a href="#parallelize-49"><span class="linenos">49</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Define a general parallelization framework to speedup computations</span>
</span><span id="parallelize-50"><a href="#parallelize-50"><span class="linenos">50</span></a><span class="sd">            Parameters</span>
</span><span id="parallelize-51"><a href="#parallelize-51"><span class="linenos">51</span></a><span class="sd">            ----------</span>
</span><span id="parallelize-52"><a href="#parallelize-52"><span class="linenos">52</span></a><span class="sd">            iterator : array_like</span>
</span><span id="parallelize-53"><a href="#parallelize-53"><span class="linenos">53</span></a><span class="sd">                the array-like object over which to parallelize</span>
</span><span id="parallelize-54"><a href="#parallelize-54"><span class="linenos">54</span></a><span class="sd">            function : function handle</span>
</span><span id="parallelize-55"><a href="#parallelize-55"><span class="linenos">55</span></a><span class="sd">                the function that must be called by each subprocess. The function should be of the form y = f(iterator)</span>
</span><span id="parallelize-56"><a href="#parallelize-56"><span class="linenos">56</span></a><span class="sd">            chunks : int</span>
</span><span id="parallelize-57"><a href="#parallelize-57"><span class="linenos">57</span></a><span class="sd">                number of parallel workers</span>
</span><span id="parallelize-58"><a href="#parallelize-58"><span class="linenos">58</span></a><span class="sd">           Returns</span>
</span><span id="parallelize-59"><a href="#parallelize-59"><span class="linenos">59</span></a><span class="sd">           -------</span>
</span><span id="parallelize-60"><a href="#parallelize-60"><span class="linenos">60</span></a><span class="sd">           result : array_like</span>
</span><span id="parallelize-61"><a href="#parallelize-61"><span class="linenos">61</span></a><span class="sd">                the result of the parallelized computation</span>
</span><span id="parallelize-62"><a href="#parallelize-62"><span class="linenos">62</span></a><span class="sd">            &quot;&quot;&quot;</span>
</span><span id="parallelize-63"><a href="#parallelize-63"><span class="linenos">63</span></a>
</span><span id="parallelize-64"><a href="#parallelize-64"><span class="linenos">64</span></a>    <span class="k">with</span> <span class="n">mproc</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="k">as</span> <span class="n">p</span><span class="p">:</span>
</span><span id="parallelize-65"><a href="#parallelize-65"><span class="linenos">65</span></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">iterator</span><span class="p">)</span>
</span><span id="parallelize-66"><a href="#parallelize-66"><span class="linenos">66</span></a>
</span><span id="parallelize-67"><a href="#parallelize-67"><span class="linenos">67</span></a>    <span class="k">return</span> <span class="n">result</span>
</span></pre></div>


            <div class="docstring"><p>Define a general parallelization framework to speedup computations
 Parameters</p>

<hr />

<p>iterator : array_like
     the array-like object over which to parallelize
 function : function handle
     the function that must be called by each subprocess. The function should be of the form y = f(iterator)
 chunks : int
     number of parallel workers</p>

<h2 id="returns">Returns</h2>

<p>result : array_like
     the result of the parallelized computation</p>
</div>


                </section>
                <section id="chunker">
                            <input id="chunker-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">chunker</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">iterator</span>, </span><span class="param"><span class="n">chunks</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="chunker-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#chunker"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="chunker-70"><a href="#chunker-70"><span class="linenos">70</span></a><span class="k">def</span> <span class="nf">chunker</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">chunks</span><span class="p">):</span>
</span><span id="chunker-71"><a href="#chunker-71"><span class="linenos">71</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="chunker-72"><a href="#chunker-72"><span class="linenos">72</span></a><span class="sd">    Divide an iterator or array into approximately equal-sized chunks for</span>
</span><span id="chunker-73"><a href="#chunker-73"><span class="linenos">73</span></a><span class="sd">    parallel processing.</span>
</span><span id="chunker-74"><a href="#chunker-74"><span class="linenos">74</span></a><span class="sd">    </span>
</span><span id="chunker-75"><a href="#chunker-75"><span class="linenos">75</span></a><span class="sd">    Parameters</span>
</span><span id="chunker-76"><a href="#chunker-76"><span class="linenos">76</span></a><span class="sd">    ----------</span>
</span><span id="chunker-77"><a href="#chunker-77"><span class="linenos">77</span></a><span class="sd">    iterator : array_like</span>
</span><span id="chunker-78"><a href="#chunker-78"><span class="linenos">78</span></a><span class="sd">        The array-like object to divide into chunks.</span>
</span><span id="chunker-79"><a href="#chunker-79"><span class="linenos">79</span></a><span class="sd">    chunks : int</span>
</span><span id="chunker-80"><a href="#chunker-80"><span class="linenos">80</span></a><span class="sd">        Number of chunks to create.</span>
</span><span id="chunker-81"><a href="#chunker-81"><span class="linenos">81</span></a><span class="sd">    </span>
</span><span id="chunker-82"><a href="#chunker-82"><span class="linenos">82</span></a><span class="sd">    Returns</span>
</span><span id="chunker-83"><a href="#chunker-83"><span class="linenos">83</span></a><span class="sd">    -------</span>
</span><span id="chunker-84"><a href="#chunker-84"><span class="linenos">84</span></a><span class="sd">    result : list of arrays</span>
</span><span id="chunker-85"><a href="#chunker-85"><span class="linenos">85</span></a><span class="sd">        List containing the chunked arrays. Chunks will be approximately equal</span>
</span><span id="chunker-86"><a href="#chunker-86"><span class="linenos">86</span></a><span class="sd">        in size, with the last chunk potentially being smaller.</span>
</span><span id="chunker-87"><a href="#chunker-87"><span class="linenos">87</span></a><span class="sd">    </span>
</span><span id="chunker-88"><a href="#chunker-88"><span class="linenos">88</span></a><span class="sd">    Notes</span>
</span><span id="chunker-89"><a href="#chunker-89"><span class="linenos">89</span></a><span class="sd">    -----</span>
</span><span id="chunker-90"><a href="#chunker-90"><span class="linenos">90</span></a><span class="sd">    Uses numpy.array_split which handles uneven divisions automatically.</span>
</span><span id="chunker-91"><a href="#chunker-91"><span class="linenos">91</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="chunker-92"><a href="#chunker-92"><span class="linenos">92</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">iterator</span><span class="p">,</span> <span class="n">chunks</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Divide an iterator or array into approximately equal-sized chunks for
parallel processing.</p>

<h2 id="parameters">Parameters</h2>

<p>iterator : array_like
    The array-like object to divide into chunks.
chunks : int
    Number of chunks to create.</p>

<h2 id="returns">Returns</h2>

<p>result : list of arrays
    List containing the chunked arrays. Chunks will be approximately equal
    in size, with the last chunk potentially being smaller.</p>

<h2 id="notes">Notes</h2>

<p>Uses numpy.array_split which handles uneven divisions automatically.</p>
</div>


                </section>
                <section id="pxform_convert">
                            <input id="pxform_convert-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pxform_convert</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">pxform</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="pxform_convert-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pxform_convert"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pxform_convert-95"><a href="#pxform_convert-95"><span class="linenos"> 95</span></a><span class="k">def</span> <span class="nf">pxform_convert</span><span class="p">(</span><span class="n">pxform</span><span class="p">):</span>
</span><span id="pxform_convert-96"><a href="#pxform_convert-96"><span class="linenos"> 96</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="pxform_convert-97"><a href="#pxform_convert-97"><span class="linenos"> 97</span></a><span class="sd">    Convert a SPICE-generated rotation matrix (pxform) to the 4x4 homogeneous</span>
</span><span id="pxform_convert-98"><a href="#pxform_convert-98"><span class="linenos"> 98</span></a><span class="sd">    transformation matrix format required by trimesh.</span>
</span><span id="pxform_convert-99"><a href="#pxform_convert-99"><span class="linenos"> 99</span></a><span class="sd">    </span>
</span><span id="pxform_convert-100"><a href="#pxform_convert-100"><span class="linenos">100</span></a><span class="sd">    Parameters</span>
</span><span id="pxform_convert-101"><a href="#pxform_convert-101"><span class="linenos">101</span></a><span class="sd">    ----------</span>
</span><span id="pxform_convert-102"><a href="#pxform_convert-102"><span class="linenos">102</span></a><span class="sd">    pxform : array_like, shape (3, 3)</span>
</span><span id="pxform_convert-103"><a href="#pxform_convert-103"><span class="linenos">103</span></a><span class="sd">        The 3x3 rotation matrix from SPICE (obtained via spiceypy.pxform).</span>
</span><span id="pxform_convert-104"><a href="#pxform_convert-104"><span class="linenos">104</span></a><span class="sd">    </span>
</span><span id="pxform_convert-105"><a href="#pxform_convert-105"><span class="linenos">105</span></a><span class="sd">    Returns</span>
</span><span id="pxform_convert-106"><a href="#pxform_convert-106"><span class="linenos">106</span></a><span class="sd">    -------</span>
</span><span id="pxform_convert-107"><a href="#pxform_convert-107"><span class="linenos">107</span></a><span class="sd">    result : ndarray, shape (4, 4)</span>
</span><span id="pxform_convert-108"><a href="#pxform_convert-108"><span class="linenos">108</span></a><span class="sd">        The 4x4 homogeneous transformation matrix with the rotation in the</span>
</span><span id="pxform_convert-109"><a href="#pxform_convert-109"><span class="linenos">109</span></a><span class="sd">        upper-left 3x3 block, zeros in the translation column, and [0,0,0,0]</span>
</span><span id="pxform_convert-110"><a href="#pxform_convert-110"><span class="linenos">110</span></a><span class="sd">        in the bottom row.</span>
</span><span id="pxform_convert-111"><a href="#pxform_convert-111"><span class="linenos">111</span></a><span class="sd">    </span>
</span><span id="pxform_convert-112"><a href="#pxform_convert-112"><span class="linenos">112</span></a><span class="sd">    Notes</span>
</span><span id="pxform_convert-113"><a href="#pxform_convert-113"><span class="linenos">113</span></a><span class="sd">    -----</span>
</span><span id="pxform_convert-114"><a href="#pxform_convert-114"><span class="linenos">114</span></a><span class="sd">    Trimesh uses 4x4 homogeneous transformation matrices for geometric operations.</span>
</span><span id="pxform_convert-115"><a href="#pxform_convert-115"><span class="linenos">115</span></a><span class="sd">    This function adds the necessary padding to convert a pure rotation matrix.</span>
</span><span id="pxform_convert-116"><a href="#pxform_convert-116"><span class="linenos">116</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="pxform_convert-117"><a href="#pxform_convert-117"><span class="linenos">117</span></a>    <span class="n">pxform</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pxform</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pxform</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pxform</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dFloat</span><span class="p">)</span>
</span><span id="pxform_convert-118"><a href="#pxform_convert-118"><span class="linenos">118</span></a>
</span><span id="pxform_convert-119"><a href="#pxform_convert-119"><span class="linenos">119</span></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pxform</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="pxform_convert-120"><a href="#pxform_convert-120"><span class="linenos">120</span></a>
</span><span id="pxform_convert-121"><a href="#pxform_convert-121"><span class="linenos">121</span></a>    <span class="n">mv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dFloat</span><span class="p">)</span>
</span><span id="pxform_convert-122"><a href="#pxform_convert-122"><span class="linenos">122</span></a>    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="pxform_convert-123"><a href="#pxform_convert-123"><span class="linenos">123</span></a>    <span class="k">return</span> <span class="n">p</span>
</span></pre></div>


            <div class="docstring"><p>Convert a SPICE-generated rotation matrix (pxform) to the 4x4 homogeneous
transformation matrix format required by trimesh.</p>

<h2 id="parameters">Parameters</h2>

<p>pxform : array_like, shape (3, 3)
    The 3x3 rotation matrix from SPICE (obtained via spiceypy.pxform).</p>

<h2 id="returns">Returns</h2>

<p>result : ndarray, shape (4, 4)
    The 4x4 homogeneous transformation matrix with the rotation in the
    upper-left 3x3 block, zeros in the translation column, and [0,0,0,0]
    in the bottom row.</p>

<h2 id="notes">Notes</h2>

<p>Trimesh uses 4x4 homogeneous transformation matrices for geometric operations.
This function adds the necessary padding to convert a pure rotation matrix.</p>
</div>


                </section>
                <section id="block_normalize">
                            <input id="block_normalize-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">block_normalize</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">V</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="block_normalize-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#block_normalize"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="block_normalize-126"><a href="#block_normalize-126"><span class="linenos">126</span></a><span class="k">def</span> <span class="nf">block_normalize</span><span class="p">(</span><span class="n">V</span><span class="p">):</span>
</span><span id="block_normalize-127"><a href="#block_normalize-127"><span class="linenos">127</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="block_normalize-128"><a href="#block_normalize-128"><span class="linenos">128</span></a><span class="sd">    Compute unit vectors for a block of vectors efficiently using vectorized</span>
</span><span id="block_normalize-129"><a href="#block_normalize-129"><span class="linenos">129</span></a><span class="sd">    operations.</span>
</span><span id="block_normalize-130"><a href="#block_normalize-130"><span class="linenos">130</span></a><span class="sd">    </span>
</span><span id="block_normalize-131"><a href="#block_normalize-131"><span class="linenos">131</span></a><span class="sd">    Parameters</span>
</span><span id="block_normalize-132"><a href="#block_normalize-132"><span class="linenos">132</span></a><span class="sd">    ----------</span>
</span><span id="block_normalize-133"><a href="#block_normalize-133"><span class="linenos">133</span></a><span class="sd">    V : ndarray, shape (N, 3) or (3,)</span>
</span><span id="block_normalize-134"><a href="#block_normalize-134"><span class="linenos">134</span></a><span class="sd">        Array of vectors to normalize. Can be a single vector or multiple vectors.</span>
</span><span id="block_normalize-135"><a href="#block_normalize-135"><span class="linenos">135</span></a><span class="sd">    </span>
</span><span id="block_normalize-136"><a href="#block_normalize-136"><span class="linenos">136</span></a><span class="sd">    Returns</span>
</span><span id="block_normalize-137"><a href="#block_normalize-137"><span class="linenos">137</span></a><span class="sd">    -------</span>
</span><span id="block_normalize-138"><a href="#block_normalize-138"><span class="linenos">138</span></a><span class="sd">    result : ndarray, same shape as V</span>
</span><span id="block_normalize-139"><a href="#block_normalize-139"><span class="linenos">139</span></a><span class="sd">        The normalized vectors (unit vectors with magnitude 1).</span>
</span><span id="block_normalize-140"><a href="#block_normalize-140"><span class="linenos">140</span></a><span class="sd">    </span>
</span><span id="block_normalize-141"><a href="#block_normalize-141"><span class="linenos">141</span></a><span class="sd">    Notes</span>
</span><span id="block_normalize-142"><a href="#block_normalize-142"><span class="linenos">142</span></a><span class="sd">    -----</span>
</span><span id="block_normalize-143"><a href="#block_normalize-143"><span class="linenos">143</span></a><span class="sd">    Uses vectorized numpy operations for efficiency with large arrays. Handles</span>
</span><span id="block_normalize-144"><a href="#block_normalize-144"><span class="linenos">144</span></a><span class="sd">    both single vectors and arrays of vectors automatically.</span>
</span><span id="block_normalize-145"><a href="#block_normalize-145"><span class="linenos">145</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="block_normalize-146"><a href="#block_normalize-146"><span class="linenos">146</span></a>
</span><span id="block_normalize-147"><a href="#block_normalize-147"><span class="linenos">147</span></a>    <span class="k">if</span> <span class="n">V</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="block_normalize-148"><a href="#block_normalize-148"><span class="linenos">148</span></a>        <span class="k">return</span> <span class="n">V</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">V</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="block_normalize-149"><a href="#block_normalize-149"><span class="linenos">149</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="block_normalize-150"><a href="#block_normalize-150"><span class="linenos">150</span></a>        <span class="k">return</span> <span class="n">V</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">V</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute unit vectors for a block of vectors efficiently using vectorized
operations.</p>

<h2 id="parameters">Parameters</h2>

<p>V : ndarray, shape (N, 3) or (3,)
    Array of vectors to normalize. Can be a single vector or multiple vectors.</p>

<h2 id="returns">Returns</h2>

<p>result : ndarray, same shape as V
    The normalized vectors (unit vectors with magnitude 1).</p>

<h2 id="notes">Notes</h2>

<p>Uses vectorized numpy operations for efficiency with large arrays. Handles
both single vectors and arrays of vectors automatically.</p>
</div>


                </section>
                <section id="block_dot">
                            <input id="block_dot-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">block_dot</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">a</span>, </span><span class="param"><span class="n">b</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="block_dot-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#block_dot"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="block_dot-153"><a href="#block_dot-153"><span class="linenos">153</span></a><span class="k">def</span> <span class="nf">block_dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
</span><span id="block_dot-154"><a href="#block_dot-154"><span class="linenos">154</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="block_dot-155"><a href="#block_dot-155"><span class="linenos">155</span></a><span class="sd">    Perform element-wise dot product between corresponding vectors in two arrays.</span>
</span><span id="block_dot-156"><a href="#block_dot-156"><span class="linenos">156</span></a><span class="sd">    </span>
</span><span id="block_dot-157"><a href="#block_dot-157"><span class="linenos">157</span></a><span class="sd">    Parameters</span>
</span><span id="block_dot-158"><a href="#block_dot-158"><span class="linenos">158</span></a><span class="sd">    ----------</span>
</span><span id="block_dot-159"><a href="#block_dot-159"><span class="linenos">159</span></a><span class="sd">    a : ndarray, shape (N, m)</span>
</span><span id="block_dot-160"><a href="#block_dot-160"><span class="linenos">160</span></a><span class="sd">        First array of vectors.</span>
</span><span id="block_dot-161"><a href="#block_dot-161"><span class="linenos">161</span></a><span class="sd">    b : ndarray, shape (N, m)</span>
</span><span id="block_dot-162"><a href="#block_dot-162"><span class="linenos">162</span></a><span class="sd">        Second array of vectors (must have same shape as a).</span>
</span><span id="block_dot-163"><a href="#block_dot-163"><span class="linenos">163</span></a><span class="sd">    </span>
</span><span id="block_dot-164"><a href="#block_dot-164"><span class="linenos">164</span></a><span class="sd">    Returns</span>
</span><span id="block_dot-165"><a href="#block_dot-165"><span class="linenos">165</span></a><span class="sd">    -------</span>
</span><span id="block_dot-166"><a href="#block_dot-166"><span class="linenos">166</span></a><span class="sd">    result : ndarray, shape (N,)</span>
</span><span id="block_dot-167"><a href="#block_dot-167"><span class="linenos">167</span></a><span class="sd">        Array containing the dot product of each pair of corresponding vectors.</span>
</span><span id="block_dot-168"><a href="#block_dot-168"><span class="linenos">168</span></a><span class="sd">        result[i] = a[i]  b[i]</span>
</span><span id="block_dot-169"><a href="#block_dot-169"><span class="linenos">169</span></a><span class="sd">    </span>
</span><span id="block_dot-170"><a href="#block_dot-170"><span class="linenos">170</span></a><span class="sd">    Notes</span>
</span><span id="block_dot-171"><a href="#block_dot-171"><span class="linenos">171</span></a><span class="sd">    -----</span>
</span><span id="block_dot-172"><a href="#block_dot-172"><span class="linenos">172</span></a><span class="sd">    This is more efficient than using a loop for computing many dot products.</span>
</span><span id="block_dot-173"><a href="#block_dot-173"><span class="linenos">173</span></a><span class="sd">    Equivalent to np.einsum(&#39;ij,ij-&gt;i&#39;, a, b) but more readable.</span>
</span><span id="block_dot-174"><a href="#block_dot-174"><span class="linenos">174</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="block_dot-175"><a href="#block_dot-175"><span class="linenos">175</span></a>
</span><span id="block_dot-176"><a href="#block_dot-176"><span class="linenos">176</span></a>
</span><span id="block_dot-177"><a href="#block_dot-177"><span class="linenos">177</span></a>    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Perform element-wise dot product between corresponding vectors in two arrays.</p>

<h2 id="parameters">Parameters</h2>

<p>a : ndarray, shape (N, m)
    First array of vectors.
b : ndarray, shape (N, m)
    Second array of vectors (must have same shape as a).</p>

<h2 id="returns">Returns</h2>

<p>result : ndarray, shape (N,)
    Array containing the dot product of each pair of corresponding vectors.
    result[i] = a[i]  b[i]</p>

<h2 id="notes">Notes</h2>

<p>This is more efficient than using a loop for computing many dot products.
Equivalent to np.einsum('ij,ij->i', a, b) but more readable.</p>
</div>


                </section>
                <section id="pixel_plane">
                            <input id="pixel_plane-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pixel_plane</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">d0</span>, </span><span class="param"><span class="n">lon</span>, </span><span class="param"><span class="n">lat</span>, </span><span class="param"><span class="n">width</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">height</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">ray_spacing</span><span class="o">=</span><span class="mf">0.1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="pixel_plane-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pixel_plane"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pixel_plane-180"><a href="#pixel_plane-180"><span class="linenos">180</span></a><span class="k">def</span> <span class="nf">pixel_plane</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ray_spacing</span><span class="o">=</span><span class="mf">.1</span><span class="p">):</span>
</span><span id="pixel_plane-181"><a href="#pixel_plane-181"><span class="linenos">181</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="pixel_plane-182"><a href="#pixel_plane-182"><span class="linenos">182</span></a><span class="sd">    Generate a rectangular pixel array (grid of rays) for ray tracing, as defined</span>
</span><span id="pixel_plane-183"><a href="#pixel_plane-183"><span class="linenos">183</span></a><span class="sd">    in Li et al., 2018. This is the explicit implementation showing the full</span>
</span><span id="pixel_plane-184"><a href="#pixel_plane-184"><span class="linenos">184</span></a><span class="sd">    algorithm.</span>
</span><span id="pixel_plane-185"><a href="#pixel_plane-185"><span class="linenos">185</span></a><span class="sd">    </span>
</span><span id="pixel_plane-186"><a href="#pixel_plane-186"><span class="linenos">186</span></a><span class="sd">    This function creates a planar grid of ray origins and directions pointing</span>
</span><span id="pixel_plane-187"><a href="#pixel_plane-187"><span class="linenos">187</span></a><span class="sd">    toward a specified direction in 3D space, useful for simulating parallel</span>
</span><span id="pixel_plane-188"><a href="#pixel_plane-188"><span class="linenos">188</span></a><span class="sd">    light sources like the Sun.</span>
</span><span id="pixel_plane-189"><a href="#pixel_plane-189"><span class="linenos">189</span></a><span class="sd">    </span>
</span><span id="pixel_plane-190"><a href="#pixel_plane-190"><span class="linenos">190</span></a><span class="sd">    Parameters</span>
</span><span id="pixel_plane-191"><a href="#pixel_plane-191"><span class="linenos">191</span></a><span class="sd">    ----------</span>
</span><span id="pixel_plane-192"><a href="#pixel_plane-192"><span class="linenos">192</span></a><span class="sd">    d0 : float</span>
</span><span id="pixel_plane-193"><a href="#pixel_plane-193"><span class="linenos">193</span></a><span class="sd">        Distance of the pixel plane from the origin (in meters). This defines</span>
</span><span id="pixel_plane-194"><a href="#pixel_plane-194"><span class="linenos">194</span></a><span class="sd">        how far the ray origins are from the coordinate system origin.</span>
</span><span id="pixel_plane-195"><a href="#pixel_plane-195"><span class="linenos">195</span></a><span class="sd">    lon : float</span>
</span><span id="pixel_plane-196"><a href="#pixel_plane-196"><span class="linenos">196</span></a><span class="sd">        Longitude of the pixel plane&#39;s center direction (in radians). Defines</span>
</span><span id="pixel_plane-197"><a href="#pixel_plane-197"><span class="linenos">197</span></a><span class="sd">        the azimuthal angle in spherical coordinates.</span>
</span><span id="pixel_plane-198"><a href="#pixel_plane-198"><span class="linenos">198</span></a><span class="sd">    lat : float</span>
</span><span id="pixel_plane-199"><a href="#pixel_plane-199"><span class="linenos">199</span></a><span class="sd">        Latitude of the pixel plane&#39;s center direction (in radians). Defines</span>
</span><span id="pixel_plane-200"><a href="#pixel_plane-200"><span class="linenos">200</span></a><span class="sd">        the elevation angle in spherical coordinates.</span>
</span><span id="pixel_plane-201"><a href="#pixel_plane-201"><span class="linenos">201</span></a><span class="sd">    width : float, default=1</span>
</span><span id="pixel_plane-202"><a href="#pixel_plane-202"><span class="linenos">202</span></a><span class="sd">        Width of the plane (in meters). The plane extends width/2 in the</span>
</span><span id="pixel_plane-203"><a href="#pixel_plane-203"><span class="linenos">203</span></a><span class="sd">        horizontal direction.</span>
</span><span id="pixel_plane-204"><a href="#pixel_plane-204"><span class="linenos">204</span></a><span class="sd">    height : float, default=1</span>
</span><span id="pixel_plane-205"><a href="#pixel_plane-205"><span class="linenos">205</span></a><span class="sd">        Height of the plane (in meters). The plane extends height/2 in the</span>
</span><span id="pixel_plane-206"><a href="#pixel_plane-206"><span class="linenos">206</span></a><span class="sd">        vertical direction.</span>
</span><span id="pixel_plane-207"><a href="#pixel_plane-207"><span class="linenos">207</span></a><span class="sd">    ray_spacing : float, default=0.1</span>
</span><span id="pixel_plane-208"><a href="#pixel_plane-208"><span class="linenos">208</span></a><span class="sd">        Spacing between adjacent rays (in meters). Smaller values create denser</span>
</span><span id="pixel_plane-209"><a href="#pixel_plane-209"><span class="linenos">209</span></a><span class="sd">        ray grids but increase computation time.</span>
</span><span id="pixel_plane-210"><a href="#pixel_plane-210"><span class="linenos">210</span></a><span class="sd">    </span>
</span><span id="pixel_plane-211"><a href="#pixel_plane-211"><span class="linenos">211</span></a><span class="sd">    Returns</span>
</span><span id="pixel_plane-212"><a href="#pixel_plane-212"><span class="linenos">212</span></a><span class="sd">    -------</span>
</span><span id="pixel_plane-213"><a href="#pixel_plane-213"><span class="linenos">213</span></a><span class="sd">    locs : ndarray, shape (N, 3)</span>
</span><span id="pixel_plane-214"><a href="#pixel_plane-214"><span class="linenos">214</span></a><span class="sd">        Ray origin positions in 3D space. N = (width/ray_spacing + 1)  </span>
</span><span id="pixel_plane-215"><a href="#pixel_plane-215"><span class="linenos">215</span></a><span class="sd">        (height/ray_spacing + 1).</span>
</span><span id="pixel_plane-216"><a href="#pixel_plane-216"><span class="linenos">216</span></a><span class="sd">    dirs : ndarray, shape (N, 3)</span>
</span><span id="pixel_plane-217"><a href="#pixel_plane-217"><span class="linenos">217</span></a><span class="sd">        Ray direction unit vectors. All rays point toward the origin (or away</span>
</span><span id="pixel_plane-218"><a href="#pixel_plane-218"><span class="linenos">218</span></a><span class="sd">        from the direction specified by lon/lat).</span>
</span><span id="pixel_plane-219"><a href="#pixel_plane-219"><span class="linenos">219</span></a><span class="sd">    </span>
</span><span id="pixel_plane-220"><a href="#pixel_plane-220"><span class="linenos">220</span></a><span class="sd">    Notes</span>
</span><span id="pixel_plane-221"><a href="#pixel_plane-221"><span class="linenos">221</span></a><span class="sd">    -----</span>
</span><span id="pixel_plane-222"><a href="#pixel_plane-222"><span class="linenos">222</span></a><span class="sd">    The pixel plane is oriented perpendicular to the direction vector defined</span>
</span><span id="pixel_plane-223"><a href="#pixel_plane-223"><span class="linenos">223</span></a><span class="sd">    by (lon, lat) and positioned at distance d0 from the origin. This creates</span>
</span><span id="pixel_plane-224"><a href="#pixel_plane-224"><span class="linenos">224</span></a><span class="sd">    a uniform grid of parallel rays suitable for simulating distant light sources.</span>
</span><span id="pixel_plane-225"><a href="#pixel_plane-225"><span class="linenos">225</span></a><span class="sd">    </span>
</span><span id="pixel_plane-226"><a href="#pixel_plane-226"><span class="linenos">226</span></a><span class="sd">    For performance-critical applications, use pixel_plane_opt instead.</span>
</span><span id="pixel_plane-227"><a href="#pixel_plane-227"><span class="linenos">227</span></a><span class="sd">    </span>
</span><span id="pixel_plane-228"><a href="#pixel_plane-228"><span class="linenos">228</span></a><span class="sd">    References</span>
</span><span id="pixel_plane-229"><a href="#pixel_plane-229"><span class="linenos">229</span></a><span class="sd">    ----------</span>
</span><span id="pixel_plane-230"><a href="#pixel_plane-230"><span class="linenos">230</span></a><span class="sd">    Li et al., 2018 - Solar radiation pressure modeling methodology</span>
</span><span id="pixel_plane-231"><a href="#pixel_plane-231"><span class="linenos">231</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="pixel_plane-232"><a href="#pixel_plane-232"><span class="linenos">232</span></a>
</span><span id="pixel_plane-233"><a href="#pixel_plane-233"><span class="linenos">233</span></a>
</span><span id="pixel_plane-234"><a href="#pixel_plane-234"><span class="linenos">234</span></a>
</span><span id="pixel_plane-235"><a href="#pixel_plane-235"><span class="linenos">235</span></a>
</span><span id="pixel_plane-236"><a href="#pixel_plane-236"><span class="linenos">236</span></a>    <span class="n">w2</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="pixel_plane-237"><a href="#pixel_plane-237"><span class="linenos">237</span></a>    <span class="n">h2</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="pixel_plane-238"><a href="#pixel_plane-238"><span class="linenos">238</span></a>    <span class="c1"># Build the direction vector</span>
</span><span id="pixel_plane-239"><a href="#pixel_plane-239"><span class="linenos">239</span></a>    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">d0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="o">-</span><span class="n">d0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="o">-</span><span class="n">d0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)])</span>
</span><span id="pixel_plane-240"><a href="#pixel_plane-240"><span class="linenos">240</span></a>
</span><span id="pixel_plane-241"><a href="#pixel_plane-241"><span class="linenos">241</span></a>    <span class="c1"># Build the transformation matrix</span>
</span><span id="pixel_plane-242"><a href="#pixel_plane-242"><span class="linenos">242</span></a>    <span class="n">R1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="pixel_plane-243"><a href="#pixel_plane-243"><span class="linenos">243</span></a>                   <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="pixel_plane-244"><a href="#pixel_plane-244"><span class="linenos">244</span></a>                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</span><span id="pixel_plane-245"><a href="#pixel_plane-245"><span class="linenos">245</span></a>                  <span class="p">)</span>
</span><span id="pixel_plane-246"><a href="#pixel_plane-246"><span class="linenos">246</span></a>    <span class="n">R2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">)],</span>
</span><span id="pixel_plane-247"><a href="#pixel_plane-247"><span class="linenos">247</span></a>                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="pixel_plane-248"><a href="#pixel_plane-248"><span class="linenos">248</span></a>                   <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">)]])</span>
</span><span id="pixel_plane-249"><a href="#pixel_plane-249"><span class="linenos">249</span></a>    <span class="n">R</span> <span class="o">=</span> <span class="n">R1</span> <span class="o">@</span> <span class="n">R2</span>
</span><span id="pixel_plane-250"><a href="#pixel_plane-250"><span class="linenos">250</span></a>
</span><span id="pixel_plane-251"><a href="#pixel_plane-251"><span class="linenos">251</span></a>    <span class="c1"># Build the pixel matrix</span>
</span><span id="pixel_plane-252"><a href="#pixel_plane-252"><span class="linenos">252</span></a>    <span class="n">basic_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(((</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">ray_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">ray_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="pixel_plane-253"><a href="#pixel_plane-253"><span class="linenos">253</span></a>    <span class="n">basic_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">basic_coords</span><span class="p">)</span>
</span><span id="pixel_plane-254"><a href="#pixel_plane-254"><span class="linenos">254</span></a>    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="pixel_plane-255"><a href="#pixel_plane-255"><span class="linenos">255</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">w2</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">ray_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
</span><span id="pixel_plane-256"><a href="#pixel_plane-256"><span class="linenos">256</span></a>        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">h2</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">ray_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)):</span>
</span><span id="pixel_plane-257"><a href="#pixel_plane-257"><span class="linenos">257</span></a>            <span class="n">basic_coords</span><span class="p">[</span><span class="n">counter</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">R</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">])</span> <span class="o">-</span> <span class="n">x0</span>
</span><span id="pixel_plane-258"><a href="#pixel_plane-258"><span class="linenos">258</span></a>            <span class="n">basic_dirs</span><span class="p">[</span><span class="n">counter</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="pixel_plane-259"><a href="#pixel_plane-259"><span class="linenos">259</span></a>            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="pixel_plane-260"><a href="#pixel_plane-260"><span class="linenos">260</span></a>
</span><span id="pixel_plane-261"><a href="#pixel_plane-261"><span class="linenos">261</span></a>    <span class="c1"># Return the output in the shape required by trimesh</span>
</span><span id="pixel_plane-262"><a href="#pixel_plane-262"><span class="linenos">262</span></a>    <span class="k">return</span> <span class="n">basic_coords</span><span class="p">,</span> <span class="n">basic_dirs</span>
</span></pre></div>


            <div class="docstring"><p>Generate a rectangular pixel array (grid of rays) for ray tracing, as defined
in Li et al., 2018. This is the explicit implementation showing the full
algorithm.</p>

<p>This function creates a planar grid of ray origins and directions pointing
toward a specified direction in 3D space, useful for simulating parallel
light sources like the Sun.</p>

<h2 id="parameters">Parameters</h2>

<p>d0 : float
    Distance of the pixel plane from the origin (in meters). This defines
    how far the ray origins are from the coordinate system origin.
lon : float
    Longitude of the pixel plane's center direction (in radians). Defines
    the azimuthal angle in spherical coordinates.
lat : float
    Latitude of the pixel plane's center direction (in radians). Defines
    the elevation angle in spherical coordinates.
width : float, default=1
    Width of the plane (in meters). The plane extends width/2 in the
    horizontal direction.
height : float, default=1
    Height of the plane (in meters). The plane extends height/2 in the
    vertical direction.
ray_spacing : float, default=0.1
    Spacing between adjacent rays (in meters). Smaller values create denser
    ray grids but increase computation time.</p>

<h2 id="returns">Returns</h2>

<p>locs : ndarray, shape (N, 3)
    Ray origin positions in 3D space. N = (width/ray_spacing + 1)  
    (height/ray_spacing + 1).
dirs : ndarray, shape (N, 3)
    Ray direction unit vectors. All rays point toward the origin (or away
    from the direction specified by lon/lat).</p>

<h2 id="notes">Notes</h2>

<p>The pixel plane is oriented perpendicular to the direction vector defined
by (lon, lat) and positioned at distance d0 from the origin. This creates
a uniform grid of parallel rays suitable for simulating distant light sources.</p>

<p>For performance-critical applications, use pixel_plane_opt instead.</p>

<h2 id="references">References</h2>

<p>Li et al., 2018 - Solar radiation pressure modeling methodology</p>
</div>


                </section>
                <section id="fast_vector_build">
                            <input id="fast_vector_build-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jit(nopython=True)</div>

        <span class="def">def</span>
        <span class="name">fast_vector_build</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">linsp1</span>, </span><span class="param"><span class="n">linsp2</span>, </span><span class="param"><span class="n">dim1</span>, </span><span class="param"><span class="n">dim2</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="fast_vector_build-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#fast_vector_build"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="fast_vector_build-265"><a href="#fast_vector_build-265"><span class="linenos">265</span></a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="fast_vector_build-266"><a href="#fast_vector_build-266"><span class="linenos">266</span></a><span class="k">def</span> <span class="nf">fast_vector_build</span><span class="p">(</span><span class="n">linsp1</span><span class="p">,</span> <span class="n">linsp2</span><span class="p">,</span> <span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span><span class="p">):</span>
</span><span id="fast_vector_build-267"><a href="#fast_vector_build-267"><span class="linenos">267</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="fast_vector_build-268"><a href="#fast_vector_build-268"><span class="linenos">268</span></a><span class="sd">    Efficiently build a pixel array coordinate grid using Numba&#39;s JIT compilation</span>
</span><span id="fast_vector_build-269"><a href="#fast_vector_build-269"><span class="linenos">269</span></a><span class="sd">    for performance.</span>
</span><span id="fast_vector_build-270"><a href="#fast_vector_build-270"><span class="linenos">270</span></a><span class="sd">    </span>
</span><span id="fast_vector_build-271"><a href="#fast_vector_build-271"><span class="linenos">271</span></a><span class="sd">    Parameters</span>
</span><span id="fast_vector_build-272"><a href="#fast_vector_build-272"><span class="linenos">272</span></a><span class="sd">    ----------</span>
</span><span id="fast_vector_build-273"><a href="#fast_vector_build-273"><span class="linenos">273</span></a><span class="sd">    linsp1 : ndarray, shape (dim1,)</span>
</span><span id="fast_vector_build-274"><a href="#fast_vector_build-274"><span class="linenos">274</span></a><span class="sd">        Linear space defining positions along the first dimension (typically width).</span>
</span><span id="fast_vector_build-275"><a href="#fast_vector_build-275"><span class="linenos">275</span></a><span class="sd">    linsp2 : ndarray, shape (dim2,)</span>
</span><span id="fast_vector_build-276"><a href="#fast_vector_build-276"><span class="linenos">276</span></a><span class="sd">        Linear space defining positions along the second dimension (typically height).</span>
</span><span id="fast_vector_build-277"><a href="#fast_vector_build-277"><span class="linenos">277</span></a><span class="sd">    dim1 : int</span>
</span><span id="fast_vector_build-278"><a href="#fast_vector_build-278"><span class="linenos">278</span></a><span class="sd">        Number of points in the first dimension.</span>
</span><span id="fast_vector_build-279"><a href="#fast_vector_build-279"><span class="linenos">279</span></a><span class="sd">    dim2 : int</span>
</span><span id="fast_vector_build-280"><a href="#fast_vector_build-280"><span class="linenos">280</span></a><span class="sd">        Number of points in the second dimension.</span>
</span><span id="fast_vector_build-281"><a href="#fast_vector_build-281"><span class="linenos">281</span></a><span class="sd">    </span>
</span><span id="fast_vector_build-282"><a href="#fast_vector_build-282"><span class="linenos">282</span></a><span class="sd">    Returns</span>
</span><span id="fast_vector_build-283"><a href="#fast_vector_build-283"><span class="linenos">283</span></a><span class="sd">    -------</span>
</span><span id="fast_vector_build-284"><a href="#fast_vector_build-284"><span class="linenos">284</span></a><span class="sd">    result : ndarray, shape (dim1  dim2, 3)</span>
</span><span id="fast_vector_build-285"><a href="#fast_vector_build-285"><span class="linenos">285</span></a><span class="sd">        Array of 3D coordinates forming a rectangular grid in the y-z plane</span>
</span><span id="fast_vector_build-286"><a href="#fast_vector_build-286"><span class="linenos">286</span></a><span class="sd">        (x=0 for all points). The grid is built by nested iteration over linsp1</span>
</span><span id="fast_vector_build-287"><a href="#fast_vector_build-287"><span class="linenos">287</span></a><span class="sd">        and linsp2.</span>
</span><span id="fast_vector_build-288"><a href="#fast_vector_build-288"><span class="linenos">288</span></a><span class="sd">    </span>
</span><span id="fast_vector_build-289"><a href="#fast_vector_build-289"><span class="linenos">289</span></a><span class="sd">    Notes</span>
</span><span id="fast_vector_build-290"><a href="#fast_vector_build-290"><span class="linenos">290</span></a><span class="sd">    -----</span>
</span><span id="fast_vector_build-291"><a href="#fast_vector_build-291"><span class="linenos">291</span></a><span class="sd">    This function is JIT-compiled with Numba for significant performance improvement</span>
</span><span id="fast_vector_build-292"><a href="#fast_vector_build-292"><span class="linenos">292</span></a><span class="sd">    over pure Python loops. Used internally by pixel_plane_opt.</span>
</span><span id="fast_vector_build-293"><a href="#fast_vector_build-293"><span class="linenos">293</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="fast_vector_build-294"><a href="#fast_vector_build-294"><span class="linenos">294</span></a>    <span class="n">basic_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim1</span> <span class="o">*</span> <span class="n">dim2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="fast_vector_build-295"><a href="#fast_vector_build-295"><span class="linenos">295</span></a>    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="fast_vector_build-296"><a href="#fast_vector_build-296"><span class="linenos">296</span></a>
</span><span id="fast_vector_build-297"><a href="#fast_vector_build-297"><span class="linenos">297</span></a>    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">linsp1</span><span class="p">:</span>
</span><span id="fast_vector_build-298"><a href="#fast_vector_build-298"><span class="linenos">298</span></a>        <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">linsp2</span><span class="p">:</span>
</span><span id="fast_vector_build-299"><a href="#fast_vector_build-299"><span class="linenos">299</span></a>            <span class="n">basic_coords</span><span class="p">[</span><span class="n">counter</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">]</span>
</span><span id="fast_vector_build-300"><a href="#fast_vector_build-300"><span class="linenos">300</span></a>            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="fast_vector_build-301"><a href="#fast_vector_build-301"><span class="linenos">301</span></a>    <span class="k">return</span> <span class="n">basic_coords</span>
</span></pre></div>


            <div class="docstring"><p>Efficiently build a pixel array coordinate grid using Numba's JIT compilation
for performance.</p>

<h2 id="parameters">Parameters</h2>

<p>linsp1 : ndarray, shape (dim1,)
    Linear space defining positions along the first dimension (typically width).
linsp2 : ndarray, shape (dim2,)
    Linear space defining positions along the second dimension (typically height).
dim1 : int
    Number of points in the first dimension.
dim2 : int
    Number of points in the second dimension.</p>

<h2 id="returns">Returns</h2>

<p>result : ndarray, shape (dim1  dim2, 3)
    Array of 3D coordinates forming a rectangular grid in the y-z plane
    (x=0 for all points). The grid is built by nested iteration over linsp1
    and linsp2.</p>

<h2 id="notes">Notes</h2>

<p>This function is JIT-compiled with Numba for significant performance improvement
over pure Python loops. Used internally by pixel_plane_opt.</p>
</div>


                </section>
                <section id="pixel_plane_opt">
                            <input id="pixel_plane_opt-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">pixel_plane_opt</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">d0</span>, </span><span class="param"><span class="n">lon</span>, </span><span class="param"><span class="n">lat</span>, </span><span class="param"><span class="n">width</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">height</span><span class="o">=</span><span class="mi">1</span>, </span><span class="param"><span class="n">ray_spacing</span><span class="o">=</span><span class="mf">0.1</span>, </span><span class="param"><span class="n">packets</span><span class="o">=</span><span class="mi">1</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="pixel_plane_opt-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#pixel_plane_opt"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="pixel_plane_opt-304"><a href="#pixel_plane_opt-304"><span class="linenos">304</span></a><span class="k">def</span> <span class="nf">pixel_plane_opt</span><span class="p">(</span><span class="n">d0</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ray_spacing</span><span class="o">=</span><span class="mf">.1</span><span class="p">,</span> <span class="n">packets</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</span><span id="pixel_plane_opt-305"><a href="#pixel_plane_opt-305"><span class="linenos">305</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="pixel_plane_opt-306"><a href="#pixel_plane_opt-306"><span class="linenos">306</span></a><span class="sd">    Generate a rectangular pixel array for ray tracing - optimized version with</span>
</span><span id="pixel_plane_opt-307"><a href="#pixel_plane_opt-307"><span class="linenos">307</span></a><span class="sd">    optional ray packet subdivision.</span>
</span><span id="pixel_plane_opt-308"><a href="#pixel_plane_opt-308"><span class="linenos">308</span></a><span class="sd">    </span>
</span><span id="pixel_plane_opt-309"><a href="#pixel_plane_opt-309"><span class="linenos">309</span></a><span class="sd">    This is a performance-optimized implementation of pixel_plane that uses</span>
</span><span id="pixel_plane_opt-310"><a href="#pixel_plane_opt-310"><span class="linenos">310</span></a><span class="sd">    vectorized operations and Numba JIT compilation. It also supports dividing</span>
</span><span id="pixel_plane_opt-311"><a href="#pixel_plane_opt-311"><span class="linenos">311</span></a><span class="sd">    the rays into packets to avoid segmentation faults with very large ray counts.</span>
</span><span id="pixel_plane_opt-312"><a href="#pixel_plane_opt-312"><span class="linenos">312</span></a><span class="sd">    </span>
</span><span id="pixel_plane_opt-313"><a href="#pixel_plane_opt-313"><span class="linenos">313</span></a><span class="sd">    Parameters</span>
</span><span id="pixel_plane_opt-314"><a href="#pixel_plane_opt-314"><span class="linenos">314</span></a><span class="sd">    ----------</span>
</span><span id="pixel_plane_opt-315"><a href="#pixel_plane_opt-315"><span class="linenos">315</span></a><span class="sd">    d0 : float</span>
</span><span id="pixel_plane_opt-316"><a href="#pixel_plane_opt-316"><span class="linenos">316</span></a><span class="sd">        Distance of the pixel plane from the origin (in meters).</span>
</span><span id="pixel_plane_opt-317"><a href="#pixel_plane_opt-317"><span class="linenos">317</span></a><span class="sd">    lon : float</span>
</span><span id="pixel_plane_opt-318"><a href="#pixel_plane_opt-318"><span class="linenos">318</span></a><span class="sd">        Longitude of the pixel plane&#39;s center direction (in radians).</span>
</span><span id="pixel_plane_opt-319"><a href="#pixel_plane_opt-319"><span class="linenos">319</span></a><span class="sd">    lat : float</span>
</span><span id="pixel_plane_opt-320"><a href="#pixel_plane_opt-320"><span class="linenos">320</span></a><span class="sd">        Latitude of the pixel plane&#39;s center direction (in radians).</span>
</span><span id="pixel_plane_opt-321"><a href="#pixel_plane_opt-321"><span class="linenos">321</span></a><span class="sd">    width : float, default=1</span>
</span><span id="pixel_plane_opt-322"><a href="#pixel_plane_opt-322"><span class="linenos">322</span></a><span class="sd">        Width of the plane (in meters).</span>
</span><span id="pixel_plane_opt-323"><a href="#pixel_plane_opt-323"><span class="linenos">323</span></a><span class="sd">    height : float, default=1</span>
</span><span id="pixel_plane_opt-324"><a href="#pixel_plane_opt-324"><span class="linenos">324</span></a><span class="sd">        Height of the plane (in meters).</span>
</span><span id="pixel_plane_opt-325"><a href="#pixel_plane_opt-325"><span class="linenos">325</span></a><span class="sd">    ray_spacing : float, default=0.1</span>
</span><span id="pixel_plane_opt-326"><a href="#pixel_plane_opt-326"><span class="linenos">326</span></a><span class="sd">        Spacing between adjacent rays (in meters). Determines ray grid density.</span>
</span><span id="pixel_plane_opt-327"><a href="#pixel_plane_opt-327"><span class="linenos">327</span></a><span class="sd">    packets : int, default=1</span>
</span><span id="pixel_plane_opt-328"><a href="#pixel_plane_opt-328"><span class="linenos">328</span></a><span class="sd">        Number of ray packets to subdivide the rays into. Use values &gt; 1 to</span>
</span><span id="pixel_plane_opt-329"><a href="#pixel_plane_opt-329"><span class="linenos">329</span></a><span class="sd">        avoid segmentation faults or memory issues with very large numbers of</span>
</span><span id="pixel_plane_opt-330"><a href="#pixel_plane_opt-330"><span class="linenos">330</span></a><span class="sd">        rays (typically &gt; 10^6). Each packet is processed separately by the</span>
</span><span id="pixel_plane_opt-331"><a href="#pixel_plane_opt-331"><span class="linenos">331</span></a><span class="sd">        ray tracer.</span>
</span><span id="pixel_plane_opt-332"><a href="#pixel_plane_opt-332"><span class="linenos">332</span></a><span class="sd">    </span>
</span><span id="pixel_plane_opt-333"><a href="#pixel_plane_opt-333"><span class="linenos">333</span></a><span class="sd">    Returns</span>
</span><span id="pixel_plane_opt-334"><a href="#pixel_plane_opt-334"><span class="linenos">334</span></a><span class="sd">    -------</span>
</span><span id="pixel_plane_opt-335"><a href="#pixel_plane_opt-335"><span class="linenos">335</span></a><span class="sd">    locs : ndarray or list of ndarrays</span>
</span><span id="pixel_plane_opt-336"><a href="#pixel_plane_opt-336"><span class="linenos">336</span></a><span class="sd">        Ray origin positions. If packets=1, returns single array of shape (N, 3).</span>
</span><span id="pixel_plane_opt-337"><a href="#pixel_plane_opt-337"><span class="linenos">337</span></a><span class="sd">        If packets&gt;1, returns list of arrays, each containing a subset of rays.</span>
</span><span id="pixel_plane_opt-338"><a href="#pixel_plane_opt-338"><span class="linenos">338</span></a><span class="sd">    dirs : ndarray or list of ndarrays</span>
</span><span id="pixel_plane_opt-339"><a href="#pixel_plane_opt-339"><span class="linenos">339</span></a><span class="sd">        Ray direction unit vectors. Same structure as locs.</span>
</span><span id="pixel_plane_opt-340"><a href="#pixel_plane_opt-340"><span class="linenos">340</span></a><span class="sd">    </span>
</span><span id="pixel_plane_opt-341"><a href="#pixel_plane_opt-341"><span class="linenos">341</span></a><span class="sd">    Notes</span>
</span><span id="pixel_plane_opt-342"><a href="#pixel_plane_opt-342"><span class="linenos">342</span></a><span class="sd">    -----</span>
</span><span id="pixel_plane_opt-343"><a href="#pixel_plane_opt-343"><span class="linenos">343</span></a><span class="sd">    This is the recommended function for pixel plane generation due to its</span>
</span><span id="pixel_plane_opt-344"><a href="#pixel_plane_opt-344"><span class="linenos">344</span></a><span class="sd">    performance optimizations. Use packets &gt; 1 when dealing with very dense</span>
</span><span id="pixel_plane_opt-345"><a href="#pixel_plane_opt-345"><span class="linenos">345</span></a><span class="sd">    ray grids (small ray_spacing values).</span>
</span><span id="pixel_plane_opt-346"><a href="#pixel_plane_opt-346"><span class="linenos">346</span></a><span class="sd">    </span>
</span><span id="pixel_plane_opt-347"><a href="#pixel_plane_opt-347"><span class="linenos">347</span></a><span class="sd">    The function uses Numba JIT compilation via fast_vector_build for efficient</span>
</span><span id="pixel_plane_opt-348"><a href="#pixel_plane_opt-348"><span class="linenos">348</span></a><span class="sd">    coordinate grid generation.</span>
</span><span id="pixel_plane_opt-349"><a href="#pixel_plane_opt-349"><span class="linenos">349</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="pixel_plane_opt-350"><a href="#pixel_plane_opt-350"><span class="linenos">350</span></a>    <span class="n">w2</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="pixel_plane_opt-351"><a href="#pixel_plane_opt-351"><span class="linenos">351</span></a>    <span class="n">h2</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="pixel_plane_opt-352"><a href="#pixel_plane_opt-352"><span class="linenos">352</span></a>    <span class="c1"># Build the direction vector</span>
</span><span id="pixel_plane_opt-353"><a href="#pixel_plane_opt-353"><span class="linenos">353</span></a>    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">d0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="o">-</span><span class="n">d0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span> <span class="o">-</span><span class="n">d0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat</span><span class="p">)])</span>
</span><span id="pixel_plane_opt-354"><a href="#pixel_plane_opt-354"><span class="linenos">354</span></a>    <span class="n">x0_unit</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
</span><span id="pixel_plane_opt-355"><a href="#pixel_plane_opt-355"><span class="linenos">355</span></a>    <span class="c1"># Build the transformation matrix</span>
</span><span id="pixel_plane_opt-356"><a href="#pixel_plane_opt-356"><span class="linenos">356</span></a>    <span class="n">R1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="pixel_plane_opt-357"><a href="#pixel_plane_opt-357"><span class="linenos">357</span></a>                   <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="pixel_plane_opt-358"><a href="#pixel_plane_opt-358"><span class="linenos">358</span></a>                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
</span><span id="pixel_plane_opt-359"><a href="#pixel_plane_opt-359"><span class="linenos">359</span></a>                  <span class="p">)</span>
</span><span id="pixel_plane_opt-360"><a href="#pixel_plane_opt-360"><span class="linenos">360</span></a>    <span class="n">R2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">)],</span>
</span><span id="pixel_plane_opt-361"><a href="#pixel_plane_opt-361"><span class="linenos">361</span></a>                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
</span><span id="pixel_plane_opt-362"><a href="#pixel_plane_opt-362"><span class="linenos">362</span></a>                   <span class="p">[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">lat</span><span class="p">)]])</span>
</span><span id="pixel_plane_opt-363"><a href="#pixel_plane_opt-363"><span class="linenos">363</span></a>    <span class="n">R</span> <span class="o">=</span> <span class="n">R1</span> <span class="o">@</span> <span class="n">R2</span>
</span><span id="pixel_plane_opt-364"><a href="#pixel_plane_opt-364"><span class="linenos">364</span></a>
</span><span id="pixel_plane_opt-365"><a href="#pixel_plane_opt-365"><span class="linenos">365</span></a>    <span class="c1"># Build the pixel matrix</span>
</span><span id="pixel_plane_opt-366"><a href="#pixel_plane_opt-366"><span class="linenos">366</span></a>
</span><span id="pixel_plane_opt-367"><a href="#pixel_plane_opt-367"><span class="linenos">367</span></a>    <span class="n">dim1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">/</span> <span class="n">ray_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="pixel_plane_opt-368"><a href="#pixel_plane_opt-368"><span class="linenos">368</span></a>    <span class="n">dim2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="n">ray_spacing</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="pixel_plane_opt-369"><a href="#pixel_plane_opt-369"><span class="linenos">369</span></a>    <span class="n">basic_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim1</span> <span class="o">*</span> <span class="n">dim2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="pixel_plane_opt-370"><a href="#pixel_plane_opt-370"><span class="linenos">370</span></a>    <span class="n">basic_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">basic_coords</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">x0_unit</span><span class="p">)</span>
</span><span id="pixel_plane_opt-371"><a href="#pixel_plane_opt-371"><span class="linenos">371</span></a>
</span><span id="pixel_plane_opt-372"><a href="#pixel_plane_opt-372"><span class="linenos">372</span></a>    <span class="n">linsp1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">w2</span><span class="p">,</span> <span class="n">w2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">dim1</span><span class="p">)</span>
</span><span id="pixel_plane_opt-373"><a href="#pixel_plane_opt-373"><span class="linenos">373</span></a>    <span class="n">linsp2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">h2</span><span class="p">,</span> <span class="n">h2</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">dim2</span><span class="p">)</span>
</span><span id="pixel_plane_opt-374"><a href="#pixel_plane_opt-374"><span class="linenos">374</span></a>
</span><span id="pixel_plane_opt-375"><a href="#pixel_plane_opt-375"><span class="linenos">375</span></a>    <span class="n">basic_coords</span> <span class="o">=</span> <span class="n">fast_vector_build</span><span class="p">(</span><span class="n">linsp1</span><span class="p">,</span> <span class="n">linsp2</span><span class="p">,</span> <span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span><span class="p">)</span>
</span><span id="pixel_plane_opt-376"><a href="#pixel_plane_opt-376"><span class="linenos">376</span></a>
</span><span id="pixel_plane_opt-377"><a href="#pixel_plane_opt-377"><span class="linenos">377</span></a>    <span class="n">basic_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">basic_coords</span><span class="p">),</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</span><span id="pixel_plane_opt-378"><a href="#pixel_plane_opt-378"><span class="linenos">378</span></a>    <span class="n">basic_coords</span> <span class="o">-=</span> <span class="n">x0</span>
</span><span id="pixel_plane_opt-379"><a href="#pixel_plane_opt-379"><span class="linenos">379</span></a>
</span><span id="pixel_plane_opt-380"><a href="#pixel_plane_opt-380"><span class="linenos">380</span></a>    <span class="c1"># Return the output in the shape required by trimesh</span>
</span><span id="pixel_plane_opt-381"><a href="#pixel_plane_opt-381"><span class="linenos">381</span></a>
</span><span id="pixel_plane_opt-382"><a href="#pixel_plane_opt-382"><span class="linenos">382</span></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">packets</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="pixel_plane_opt-383"><a href="#pixel_plane_opt-383"><span class="linenos">383</span></a>        <span class="n">basic_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">basic_coords</span><span class="p">,</span> <span class="n">packets</span><span class="p">)</span>
</span><span id="pixel_plane_opt-384"><a href="#pixel_plane_opt-384"><span class="linenos">384</span></a>        <span class="n">basic_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">basic_dirs</span><span class="p">,</span> <span class="n">packets</span><span class="p">)</span>
</span><span id="pixel_plane_opt-385"><a href="#pixel_plane_opt-385"><span class="linenos">385</span></a>
</span><span id="pixel_plane_opt-386"><a href="#pixel_plane_opt-386"><span class="linenos">386</span></a>    <span class="k">return</span> <span class="n">basic_coords</span><span class="p">,</span> <span class="n">basic_dirs</span>
</span></pre></div>


            <div class="docstring"><p>Generate a rectangular pixel array for ray tracing - optimized version with
optional ray packet subdivision.</p>

<p>This is a performance-optimized implementation of pixel_plane that uses
vectorized operations and Numba JIT compilation. It also supports dividing
the rays into packets to avoid segmentation faults with very large ray counts.</p>

<h2 id="parameters">Parameters</h2>

<p>d0 : float
    Distance of the pixel plane from the origin (in meters).
lon : float
    Longitude of the pixel plane's center direction (in radians).
lat : float
    Latitude of the pixel plane's center direction (in radians).
width : float, default=1
    Width of the plane (in meters).
height : float, default=1
    Height of the plane (in meters).
ray_spacing : float, default=0.1
    Spacing between adjacent rays (in meters). Determines ray grid density.
packets : int, default=1
    Number of ray packets to subdivide the rays into. Use values &gt; 1 to
    avoid segmentation faults or memory issues with very large numbers of
    rays (typically &gt; 10^6). Each packet is processed separately by the
    ray tracer.</p>

<h2 id="returns">Returns</h2>

<p>locs : ndarray or list of ndarrays
    Ray origin positions. If packets=1, returns single array of shape (N, 3).
    If packets>1, returns list of arrays, each containing a subset of rays.
dirs : ndarray or list of ndarrays
    Ray direction unit vectors. Same structure as locs.</p>

<h2 id="notes">Notes</h2>

<p>This is the recommended function for pixel plane generation due to its
performance optimizations. Use packets &gt; 1 when dealing with very dense
ray grids (small ray_spacing values).</p>

<p>The function uses Numba JIT compilation via fast_vector_build for efficient
coordinate grid generation.</p>
</div>


                </section>
                <section id="reflected">
                            <input id="reflected-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">reflected</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">incoming</span>, </span><span class="param"><span class="n">normal</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="reflected-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#reflected"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="reflected-389"><a href="#reflected-389"><span class="linenos">389</span></a><span class="k">def</span> <span class="nf">reflected</span><span class="p">(</span><span class="n">incoming</span><span class="p">,</span> <span class="n">normal</span><span class="p">):</span>
</span><span id="reflected-390"><a href="#reflected-390"><span class="linenos">390</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="reflected-391"><a href="#reflected-391"><span class="linenos">391</span></a><span class="sd">    Compute reflected ray directions given incoming rays and surface normals.</span>
</span><span id="reflected-392"><a href="#reflected-392"><span class="linenos">392</span></a><span class="sd">    Uses the law of reflection: r = i - 2(in)n</span>
</span><span id="reflected-393"><a href="#reflected-393"><span class="linenos">393</span></a><span class="sd">    </span>
</span><span id="reflected-394"><a href="#reflected-394"><span class="linenos">394</span></a><span class="sd">    This is a vectorized implementation using numpy.einsum for efficient</span>
</span><span id="reflected-395"><a href="#reflected-395"><span class="linenos">395</span></a><span class="sd">    computation of many reflections simultaneously.</span>
</span><span id="reflected-396"><a href="#reflected-396"><span class="linenos">396</span></a><span class="sd">    </span>
</span><span id="reflected-397"><a href="#reflected-397"><span class="linenos">397</span></a><span class="sd">    Parameters</span>
</span><span id="reflected-398"><a href="#reflected-398"><span class="linenos">398</span></a><span class="sd">    ----------</span>
</span><span id="reflected-399"><a href="#reflected-399"><span class="linenos">399</span></a><span class="sd">    incoming : ndarray, shape (N, 3)</span>
</span><span id="reflected-400"><a href="#reflected-400"><span class="linenos">400</span></a><span class="sd">        Incoming ray direction vectors (do not need to be normalized).</span>
</span><span id="reflected-401"><a href="#reflected-401"><span class="linenos">401</span></a><span class="sd">    normal : ndarray, shape (N, 3)</span>
</span><span id="reflected-402"><a href="#reflected-402"><span class="linenos">402</span></a><span class="sd">        Surface normal vectors at reflection points (should be unit vectors).</span>
</span><span id="reflected-403"><a href="#reflected-403"><span class="linenos">403</span></a><span class="sd">    </span>
</span><span id="reflected-404"><a href="#reflected-404"><span class="linenos">404</span></a><span class="sd">    Returns</span>
</span><span id="reflected-405"><a href="#reflected-405"><span class="linenos">405</span></a><span class="sd">    -------</span>
</span><span id="reflected-406"><a href="#reflected-406"><span class="linenos">406</span></a><span class="sd">    reflected : ndarray, shape (N, 3)</span>
</span><span id="reflected-407"><a href="#reflected-407"><span class="linenos">407</span></a><span class="sd">        Reflected ray direction vectors. These are NOT normalized - maintain</span>
</span><span id="reflected-408"><a href="#reflected-408"><span class="linenos">408</span></a><span class="sd">        the same magnitude as the incoming vectors.</span>
</span><span id="reflected-409"><a href="#reflected-409"><span class="linenos">409</span></a><span class="sd">    </span>
</span><span id="reflected-410"><a href="#reflected-410"><span class="linenos">410</span></a><span class="sd">    Notes</span>
</span><span id="reflected-411"><a href="#reflected-411"><span class="linenos">411</span></a><span class="sd">    -----</span>
</span><span id="reflected-412"><a href="#reflected-412"><span class="linenos">412</span></a><span class="sd">    The reflection formula used is: r = i - 2(in)n, where:</span>
</span><span id="reflected-413"><a href="#reflected-413"><span class="linenos">413</span></a><span class="sd">    - i is the incoming direction</span>
</span><span id="reflected-414"><a href="#reflected-414"><span class="linenos">414</span></a><span class="sd">    - n is the surface normal</span>
</span><span id="reflected-415"><a href="#reflected-415"><span class="linenos">415</span></a><span class="sd">    - r is the reflected direction</span>
</span><span id="reflected-416"><a href="#reflected-416"><span class="linenos">416</span></a><span class="sd">    </span>
</span><span id="reflected-417"><a href="#reflected-417"><span class="linenos">417</span></a><span class="sd">    This formula gives the specular (mirror-like) reflection direction.</span>
</span><span id="reflected-418"><a href="#reflected-418"><span class="linenos">418</span></a><span class="sd">    Uses np.einsum for efficient vectorized dot product computation.</span>
</span><span id="reflected-419"><a href="#reflected-419"><span class="linenos">419</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="reflected-420"><a href="#reflected-420"><span class="linenos">420</span></a>
</span><span id="reflected-421"><a href="#reflected-421"><span class="linenos">421</span></a>    <span class="k">return</span> <span class="n">incoming</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">normal</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,ij-&gt;i&#39;</span><span class="p">,</span> <span class="n">incoming</span><span class="p">,</span> <span class="n">normal</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
</span></pre></div>


            <div class="docstring"><p>Compute reflected ray directions given incoming rays and surface normals.
Uses the law of reflection: r = i - 2(in)n</p>

<p>This is a vectorized implementation using numpy.einsum for efficient
computation of many reflections simultaneously.</p>

<h2 id="parameters">Parameters</h2>

<p>incoming : ndarray, shape (N, 3)
    Incoming ray direction vectors (do not need to be normalized).
normal : ndarray, shape (N, 3)
    Surface normal vectors at reflection points (should be unit vectors).</p>

<h2 id="returns">Returns</h2>

<p>reflected : ndarray, shape (N, 3)
    Reflected ray direction vectors. These are NOT normalized - maintain
    the same magnitude as the incoming vectors.</p>

<h2 id="notes">Notes</h2>

<p>The reflection formula used is: r = i - 2(in)n, where:</p>

<ul>
<li>i is the incoming direction</li>
<li>n is the surface normal</li>
<li>r is the reflected direction</li>
</ul>

<p>This formula gives the specular (mirror-like) reflection direction.
Uses np.einsum for efficient vectorized dot product computation.</p>
</div>


                </section>
                <section id="get_orthogonal">
                            <input id="get_orthogonal-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jit(nopython=True)</div>

        <span class="def">def</span>
        <span class="name">get_orthogonal</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">v</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_orthogonal-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_orthogonal"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_orthogonal-424"><a href="#get_orthogonal-424"><span class="linenos">424</span></a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="get_orthogonal-425"><a href="#get_orthogonal-425"><span class="linenos">425</span></a><span class="k">def</span> <span class="nf">get_orthogonal</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
</span><span id="get_orthogonal-426"><a href="#get_orthogonal-426"><span class="linenos">426</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_orthogonal-427"><a href="#get_orthogonal-427"><span class="linenos">427</span></a><span class="sd">    Generate a unit vector orthogonal to the input vector using randomization.</span>
</span><span id="get_orthogonal-428"><a href="#get_orthogonal-428"><span class="linenos">428</span></a><span class="sd">    </span>
</span><span id="get_orthogonal-429"><a href="#get_orthogonal-429"><span class="linenos">429</span></a><span class="sd">    Parameters</span>
</span><span id="get_orthogonal-430"><a href="#get_orthogonal-430"><span class="linenos">430</span></a><span class="sd">    ----------</span>
</span><span id="get_orthogonal-431"><a href="#get_orthogonal-431"><span class="linenos">431</span></a><span class="sd">    v : ndarray, shape (3,)</span>
</span><span id="get_orthogonal-432"><a href="#get_orthogonal-432"><span class="linenos">432</span></a><span class="sd">        Input vector to which the result should be orthogonal.</span>
</span><span id="get_orthogonal-433"><a href="#get_orthogonal-433"><span class="linenos">433</span></a><span class="sd">    </span>
</span><span id="get_orthogonal-434"><a href="#get_orthogonal-434"><span class="linenos">434</span></a><span class="sd">    Returns</span>
</span><span id="get_orthogonal-435"><a href="#get_orthogonal-435"><span class="linenos">435</span></a><span class="sd">    -------</span>
</span><span id="get_orthogonal-436"><a href="#get_orthogonal-436"><span class="linenos">436</span></a><span class="sd">    x : ndarray, shape (3,)</span>
</span><span id="get_orthogonal-437"><a href="#get_orthogonal-437"><span class="linenos">437</span></a><span class="sd">        Unit vector orthogonal to v (x  v = 0 and ||x|| = 1).</span>
</span><span id="get_orthogonal-438"><a href="#get_orthogonal-438"><span class="linenos">438</span></a><span class="sd">    </span>
</span><span id="get_orthogonal-439"><a href="#get_orthogonal-439"><span class="linenos">439</span></a><span class="sd">    Notes</span>
</span><span id="get_orthogonal-440"><a href="#get_orthogonal-440"><span class="linenos">440</span></a><span class="sd">    -----</span>
</span><span id="get_orthogonal-441"><a href="#get_orthogonal-441"><span class="linenos">441</span></a><span class="sd">    Uses a random vector projection method: generates a random 3D vector,</span>
</span><span id="get_orthogonal-442"><a href="#get_orthogonal-442"><span class="linenos">442</span></a><span class="sd">    projects out the component parallel to v, and normalizes. This is used</span>
</span><span id="get_orthogonal-443"><a href="#get_orthogonal-443"><span class="linenos">443</span></a><span class="sd">    internally for constructing local coordinate systems on surface normals.</span>
</span><span id="get_orthogonal-444"><a href="#get_orthogonal-444"><span class="linenos">444</span></a><span class="sd">    </span>
</span><span id="get_orthogonal-445"><a href="#get_orthogonal-445"><span class="linenos">445</span></a><span class="sd">    JIT-compiled with Numba for performance.</span>
</span><span id="get_orthogonal-446"><a href="#get_orthogonal-446"><span class="linenos">446</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_orthogonal-447"><a href="#get_orthogonal-447"><span class="linenos">447</span></a>
</span><span id="get_orthogonal-448"><a href="#get_orthogonal-448"><span class="linenos">448</span></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span id="get_orthogonal-449"><a href="#get_orthogonal-449"><span class="linenos">449</span></a>    <span class="n">x</span> <span class="o">-=</span> <span class="n">x</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span>
</span><span id="get_orthogonal-450"><a href="#get_orthogonal-450"><span class="linenos">450</span></a>    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="get_orthogonal-451"><a href="#get_orthogonal-451"><span class="linenos">451</span></a>
</span><span id="get_orthogonal-452"><a href="#get_orthogonal-452"><span class="linenos">452</span></a>    <span class="k">return</span> <span class="n">x</span>
</span></pre></div>


            <div class="docstring"><p>Generate a unit vector orthogonal to the input vector using randomization.</p>

<h2 id="parameters">Parameters</h2>

<p>v : ndarray, shape (3,)
    Input vector to which the result should be orthogonal.</p>

<h2 id="returns">Returns</h2>

<p>x : ndarray, shape (3,)
    Unit vector orthogonal to v (x  v = 0 and ||x|| = 1).</p>

<h2 id="notes">Notes</h2>

<p>Uses a random vector projection method: generates a random 3D vector,
projects out the component parallel to v, and normalizes. This is used
internally for constructing local coordinate systems on surface normals.</p>

<p>JIT-compiled with Numba for performance.</p>
</div>


                </section>
                <section id="sample_lambert_dist">
                            <input id="sample_lambert_dist-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jit(nopython=True)</div>

        <span class="def">def</span>
        <span class="name">sample_lambert_dist</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">normal</span>, </span><span class="param"><span class="n">num</span><span class="o">=</span><span class="mi">100</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="sample_lambert_dist-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#sample_lambert_dist"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="sample_lambert_dist-455"><a href="#sample_lambert_dist-455"><span class="linenos">455</span></a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="sample_lambert_dist-456"><a href="#sample_lambert_dist-456"><span class="linenos">456</span></a><span class="k">def</span> <span class="nf">sample_lambert_dist</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
</span><span id="sample_lambert_dist-457"><a href="#sample_lambert_dist-457"><span class="linenos">457</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="sample_lambert_dist-458"><a href="#sample_lambert_dist-458"><span class="linenos">458</span></a><span class="sd">    Generate a cloud of direction vectors following the Lambert cosine</span>
</span><span id="sample_lambert_dist-459"><a href="#sample_lambert_dist-459"><span class="linenos">459</span></a><span class="sd">    distribution (also known as Lambertian distribution or cosine-weighted</span>
</span><span id="sample_lambert_dist-460"><a href="#sample_lambert_dist-460"><span class="linenos">460</span></a><span class="sd">    hemisphere sampling).</span>
</span><span id="sample_lambert_dist-461"><a href="#sample_lambert_dist-461"><span class="linenos">461</span></a><span class="sd">    </span>
</span><span id="sample_lambert_dist-462"><a href="#sample_lambert_dist-462"><span class="linenos">462</span></a><span class="sd">    The Lambert distribution models ideal diffuse reflection where the</span>
</span><span id="sample_lambert_dist-463"><a href="#sample_lambert_dist-463"><span class="linenos">463</span></a><span class="sd">    probability of a ray being reflected in a given direction is proportional</span>
</span><span id="sample_lambert_dist-464"><a href="#sample_lambert_dist-464"><span class="linenos">464</span></a><span class="sd">    to the cosine of the angle between that direction and the surface normal.</span>
</span><span id="sample_lambert_dist-465"><a href="#sample_lambert_dist-465"><span class="linenos">465</span></a><span class="sd">    This is physically accurate for perfectly diffuse (Lambertian) surfaces.</span>
</span><span id="sample_lambert_dist-466"><a href="#sample_lambert_dist-466"><span class="linenos">466</span></a><span class="sd">    </span>
</span><span id="sample_lambert_dist-467"><a href="#sample_lambert_dist-467"><span class="linenos">467</span></a><span class="sd">    Parameters</span>
</span><span id="sample_lambert_dist-468"><a href="#sample_lambert_dist-468"><span class="linenos">468</span></a><span class="sd">    ----------</span>
</span><span id="sample_lambert_dist-469"><a href="#sample_lambert_dist-469"><span class="linenos">469</span></a><span class="sd">    normal : ndarray, shape (3,)</span>
</span><span id="sample_lambert_dist-470"><a href="#sample_lambert_dist-470"><span class="linenos">470</span></a><span class="sd">        Surface normal vector defining the hemisphere orientation (should be</span>
</span><span id="sample_lambert_dist-471"><a href="#sample_lambert_dist-471"><span class="linenos">471</span></a><span class="sd">        a unit vector).</span>
</span><span id="sample_lambert_dist-472"><a href="#sample_lambert_dist-472"><span class="linenos">472</span></a><span class="sd">    num : int, default=100</span>
</span><span id="sample_lambert_dist-473"><a href="#sample_lambert_dist-473"><span class="linenos">473</span></a><span class="sd">        Number of sample directions to generate.</span>
</span><span id="sample_lambert_dist-474"><a href="#sample_lambert_dist-474"><span class="linenos">474</span></a><span class="sd">    </span>
</span><span id="sample_lambert_dist-475"><a href="#sample_lambert_dist-475"><span class="linenos">475</span></a><span class="sd">    Returns</span>
</span><span id="sample_lambert_dist-476"><a href="#sample_lambert_dist-476"><span class="linenos">476</span></a><span class="sd">    -------</span>
</span><span id="sample_lambert_dist-477"><a href="#sample_lambert_dist-477"><span class="linenos">477</span></a><span class="sd">    v : ndarray, shape (num, 3)</span>
</span><span id="sample_lambert_dist-478"><a href="#sample_lambert_dist-478"><span class="linenos">478</span></a><span class="sd">        Array of sampled direction vectors distributed according to Lambert&#39;s</span>
</span><span id="sample_lambert_dist-479"><a href="#sample_lambert_dist-479"><span class="linenos">479</span></a><span class="sd">        cosine law. All vectors point into the hemisphere defined by the normal.</span>
</span><span id="sample_lambert_dist-480"><a href="#sample_lambert_dist-480"><span class="linenos">480</span></a><span class="sd">    </span>
</span><span id="sample_lambert_dist-481"><a href="#sample_lambert_dist-481"><span class="linenos">481</span></a><span class="sd">    Notes</span>
</span><span id="sample_lambert_dist-482"><a href="#sample_lambert_dist-482"><span class="linenos">482</span></a><span class="sd">    -----</span>
</span><span id="sample_lambert_dist-483"><a href="#sample_lambert_dist-483"><span class="linenos">483</span></a><span class="sd">    The sampling uses spherical coordinates with:</span>
</span><span id="sample_lambert_dist-484"><a href="#sample_lambert_dist-484"><span class="linenos">484</span></a><span class="sd">    -  (polar angle): sampled as  = arccos() where  ~ U(0,1)</span>
</span><span id="sample_lambert_dist-485"><a href="#sample_lambert_dist-485"><span class="linenos">485</span></a><span class="sd">    -  (azimuthal angle): sampled uniformly as  ~ U(0, 2)</span>
</span><span id="sample_lambert_dist-486"><a href="#sample_lambert_dist-486"><span class="linenos">486</span></a><span class="sd">    </span>
</span><span id="sample_lambert_dist-487"><a href="#sample_lambert_dist-487"><span class="linenos">487</span></a><span class="sd">    This ensures that the probability density is proportional to cos(), which</span>
</span><span id="sample_lambert_dist-488"><a href="#sample_lambert_dist-488"><span class="linenos">488</span></a><span class="sd">    is characteristic of ideal diffuse reflection (Lambert&#39;s cosine law).</span>
</span><span id="sample_lambert_dist-489"><a href="#sample_lambert_dist-489"><span class="linenos">489</span></a><span class="sd">    </span>
</span><span id="sample_lambert_dist-490"><a href="#sample_lambert_dist-490"><span class="linenos">490</span></a><span class="sd">    JIT-compiled with Numba for performance. Used for modeling diffuse</span>
</span><span id="sample_lambert_dist-491"><a href="#sample_lambert_dist-491"><span class="linenos">491</span></a><span class="sd">    reflection in ray tracing.</span>
</span><span id="sample_lambert_dist-492"><a href="#sample_lambert_dist-492"><span class="linenos">492</span></a><span class="sd">    </span>
</span><span id="sample_lambert_dist-493"><a href="#sample_lambert_dist-493"><span class="linenos">493</span></a><span class="sd">    References</span>
</span><span id="sample_lambert_dist-494"><a href="#sample_lambert_dist-494"><span class="linenos">494</span></a><span class="sd">    ----------</span>
</span><span id="sample_lambert_dist-495"><a href="#sample_lambert_dist-495"><span class="linenos">495</span></a><span class="sd">    Lambert&#39;s Cosine Law: I = I cos() where  is the angle from the normal</span>
</span><span id="sample_lambert_dist-496"><a href="#sample_lambert_dist-496"><span class="linenos">496</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="sample_lambert_dist-497"><a href="#sample_lambert_dist-497"><span class="linenos">497</span></a>
</span><span id="sample_lambert_dist-498"><a href="#sample_lambert_dist-498"><span class="linenos">498</span></a>    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">num</span><span class="p">)))</span>
</span><span id="sample_lambert_dist-499"><a href="#sample_lambert_dist-499"><span class="linenos">499</span></a>    <span class="n">cos_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="sample_lambert_dist-500"><a href="#sample_lambert_dist-500"><span class="linenos">500</span></a>    <span class="n">sin_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
</span><span id="sample_lambert_dist-501"><a href="#sample_lambert_dist-501"><span class="linenos">501</span></a>    <span class="n">psi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">num</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
</span><span id="sample_lambert_dist-502"><a href="#sample_lambert_dist-502"><span class="linenos">502</span></a>
</span><span id="sample_lambert_dist-503"><a href="#sample_lambert_dist-503"><span class="linenos">503</span></a>    <span class="n">a</span> <span class="o">=</span> <span class="n">sin_theta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>
</span><span id="sample_lambert_dist-504"><a href="#sample_lambert_dist-504"><span class="linenos">504</span></a>    <span class="n">b</span> <span class="o">=</span> <span class="n">sin_theta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>
</span><span id="sample_lambert_dist-505"><a href="#sample_lambert_dist-505"><span class="linenos">505</span></a>    <span class="n">c</span> <span class="o">=</span> <span class="n">cos_theta</span>
</span><span id="sample_lambert_dist-506"><a href="#sample_lambert_dist-506"><span class="linenos">506</span></a>
</span><span id="sample_lambert_dist-507"><a href="#sample_lambert_dist-507"><span class="linenos">507</span></a>    <span class="n">t1</span> <span class="o">=</span> <span class="n">get_orthogonal</span><span class="p">(</span><span class="n">normal</span><span class="p">)</span>
</span><span id="sample_lambert_dist-508"><a href="#sample_lambert_dist-508"><span class="linenos">508</span></a>    <span class="n">t2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">normal</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
</span><span id="sample_lambert_dist-509"><a href="#sample_lambert_dist-509"><span class="linenos">509</span></a>
</span><span id="sample_lambert_dist-510"><a href="#sample_lambert_dist-510"><span class="linenos">510</span></a>    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
</span><span id="sample_lambert_dist-511"><a href="#sample_lambert_dist-511"><span class="linenos">511</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
</span><span id="sample_lambert_dist-512"><a href="#sample_lambert_dist-512"><span class="linenos">512</span></a>        <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">t2</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">normal</span>
</span><span id="sample_lambert_dist-513"><a href="#sample_lambert_dist-513"><span class="linenos">513</span></a>    <span class="k">return</span> <span class="n">v</span>
</span></pre></div>


            <div class="docstring"><p>Generate a cloud of direction vectors following the Lambert cosine
distribution (also known as Lambertian distribution or cosine-weighted
hemisphere sampling).</p>

<p>The Lambert distribution models ideal diffuse reflection where the
probability of a ray being reflected in a given direction is proportional
to the cosine of the angle between that direction and the surface normal.
This is physically accurate for perfectly diffuse (Lambertian) surfaces.</p>

<h2 id="parameters">Parameters</h2>

<p>normal : ndarray, shape (3,)
    Surface normal vector defining the hemisphere orientation (should be
    a unit vector).
num : int, default=100
    Number of sample directions to generate.</p>

<h2 id="returns">Returns</h2>

<p>v : ndarray, shape (num, 3)
    Array of sampled direction vectors distributed according to Lambert's
    cosine law. All vectors point into the hemisphere defined by the normal.</p>

<h2 id="notes">Notes</h2>

<p>The sampling uses spherical coordinates with:</p>

<ul>
<li> (polar angle): sampled as  = arccos() where  ~ U(0,1)</li>
<li> (azimuthal angle): sampled uniformly as  ~ U(0, 2)</li>
</ul>

<p>This ensures that the probability density is proportional to cos(), which
is characteristic of ideal diffuse reflection (Lambert's cosine law).</p>

<p>JIT-compiled with Numba for performance. Used for modeling diffuse
reflection in ray tracing.</p>

<h2 id="references">References</h2>

<p>Lambert's Cosine Law: I = I cos() where  is the angle from the normal</p>
</div>


                </section>
                <section id="diffuse">
                            <input id="diffuse-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">diffuse</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">normals</span>, </span><span class="param"><span class="n">num</span><span class="o">=</span><span class="mi">10</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="diffuse-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#diffuse"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="diffuse-524"><a href="#diffuse-524"><span class="linenos">524</span></a><span class="k">def</span> <span class="nf">diffuse</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
</span><span id="diffuse-525"><a href="#diffuse-525"><span class="linenos">525</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="diffuse-526"><a href="#diffuse-526"><span class="linenos">526</span></a><span class="sd">    Compute multiple diffuse reflection directions for an array of surface</span>
</span><span id="diffuse-527"><a href="#diffuse-527"><span class="linenos">527</span></a><span class="sd">    normals by sampling the Lambert cosine distribution.</span>
</span><span id="diffuse-528"><a href="#diffuse-528"><span class="linenos">528</span></a><span class="sd">    </span>
</span><span id="diffuse-529"><a href="#diffuse-529"><span class="linenos">529</span></a><span class="sd">    For each input normal, generates num diffusely reflected ray directions</span>
</span><span id="diffuse-530"><a href="#diffuse-530"><span class="linenos">530</span></a><span class="sd">    following Lambert&#39;s cosine law. This models realistic diffuse scattering</span>
</span><span id="diffuse-531"><a href="#diffuse-531"><span class="linenos">531</span></a><span class="sd">    from rough surfaces.</span>
</span><span id="diffuse-532"><a href="#diffuse-532"><span class="linenos">532</span></a><span class="sd">    </span>
</span><span id="diffuse-533"><a href="#diffuse-533"><span class="linenos">533</span></a><span class="sd">    Parameters</span>
</span><span id="diffuse-534"><a href="#diffuse-534"><span class="linenos">534</span></a><span class="sd">    ----------</span>
</span><span id="diffuse-535"><a href="#diffuse-535"><span class="linenos">535</span></a><span class="sd">    normals : ndarray, shape (N, 3)</span>
</span><span id="diffuse-536"><a href="#diffuse-536"><span class="linenos">536</span></a><span class="sd">        Array of surface normal unit vectors at reflection points.</span>
</span><span id="diffuse-537"><a href="#diffuse-537"><span class="linenos">537</span></a><span class="sd">    num : int, default=10</span>
</span><span id="diffuse-538"><a href="#diffuse-538"><span class="linenos">538</span></a><span class="sd">        Number of diffuse samples to generate for each normal. Higher values</span>
</span><span id="diffuse-539"><a href="#diffuse-539"><span class="linenos">539</span></a><span class="sd">        give more accurate diffuse reflection modeling but increase computation.</span>
</span><span id="diffuse-540"><a href="#diffuse-540"><span class="linenos">540</span></a><span class="sd">    </span>
</span><span id="diffuse-541"><a href="#diffuse-541"><span class="linenos">541</span></a><span class="sd">    Returns</span>
</span><span id="diffuse-542"><a href="#diffuse-542"><span class="linenos">542</span></a><span class="sd">    -------</span>
</span><span id="diffuse-543"><a href="#diffuse-543"><span class="linenos">543</span></a><span class="sd">    diffuse_directions : ndarray, shape (N  num, 3)</span>
</span><span id="diffuse-544"><a href="#diffuse-544"><span class="linenos">544</span></a><span class="sd">        Array of sampled diffuse direction vectors. For each of the N input</span>
</span><span id="diffuse-545"><a href="#diffuse-545"><span class="linenos">545</span></a><span class="sd">        normals, generates num directions, resulting in Nnum total directions.</span>
</span><span id="diffuse-546"><a href="#diffuse-546"><span class="linenos">546</span></a><span class="sd">        Directions are ordered so that directions [inum : (i+1)num] correspond</span>
</span><span id="diffuse-547"><a href="#diffuse-547"><span class="linenos">547</span></a><span class="sd">        to normal i.</span>
</span><span id="diffuse-548"><a href="#diffuse-548"><span class="linenos">548</span></a><span class="sd">    </span>
</span><span id="diffuse-549"><a href="#diffuse-549"><span class="linenos">549</span></a><span class="sd">    Notes</span>
</span><span id="diffuse-550"><a href="#diffuse-550"><span class="linenos">550</span></a><span class="sd">    -----</span>
</span><span id="diffuse-551"><a href="#diffuse-551"><span class="linenos">551</span></a><span class="sd">    This function is used to model non-specular (rough) surface reflections.</span>
</span><span id="diffuse-552"><a href="#diffuse-552"><span class="linenos">552</span></a><span class="sd">    Each diffuse direction is randomly sampled from the hemisphere above the</span>
</span><span id="diffuse-553"><a href="#diffuse-553"><span class="linenos">553</span></a><span class="sd">    surface, weighted by the cosine of the angle from the normal (Lambert&#39;s law).</span>
</span><span id="diffuse-554"><a href="#diffuse-554"><span class="linenos">554</span></a><span class="sd">    </span>
</span><span id="diffuse-555"><a href="#diffuse-555"><span class="linenos">555</span></a><span class="sd">    The returned array can be fed directly into the ray tracer to simulate</span>
</span><span id="diffuse-556"><a href="#diffuse-556"><span class="linenos">556</span></a><span class="sd">    secondary illumination from diffuse reflections.</span>
</span><span id="diffuse-557"><a href="#diffuse-557"><span class="linenos">557</span></a><span class="sd">    </span>
</span><span id="diffuse-558"><a href="#diffuse-558"><span class="linenos">558</span></a><span class="sd">    Example</span>
</span><span id="diffuse-559"><a href="#diffuse-559"><span class="linenos">559</span></a><span class="sd">    -------</span>
</span><span id="diffuse-560"><a href="#diffuse-560"><span class="linenos">560</span></a><span class="sd">    &gt;&gt;&gt; normals = np.array([[0, 0, 1], [0, 1, 0]])  # Two normals</span>
</span><span id="diffuse-561"><a href="#diffuse-561"><span class="linenos">561</span></a><span class="sd">    &gt;&gt;&gt; dirs = diffuse(normals, num=5)  # 5 samples each</span>
</span><span id="diffuse-562"><a href="#diffuse-562"><span class="linenos">562</span></a><span class="sd">    &gt;&gt;&gt; dirs.shape</span>
</span><span id="diffuse-563"><a href="#diffuse-563"><span class="linenos">563</span></a><span class="sd">    (10, 3)  # 2 normals  5 samples = 10 directions</span>
</span><span id="diffuse-564"><a href="#diffuse-564"><span class="linenos">564</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="diffuse-565"><a href="#diffuse-565"><span class="linenos">565</span></a>
</span><span id="diffuse-566"><a href="#diffuse-566"><span class="linenos">566</span></a>
</span><span id="diffuse-567"><a href="#diffuse-567"><span class="linenos">567</span></a>    <span class="n">diffuse_directions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.0</span>
</span><span id="diffuse-568"><a href="#diffuse-568"><span class="linenos">568</span></a>
</span><span id="diffuse-569"><a href="#diffuse-569"><span class="linenos">569</span></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">normals</span><span class="p">):</span>
</span><span id="diffuse-570"><a href="#diffuse-570"><span class="linenos">570</span></a>        <span class="n">diff_dirs</span> <span class="o">=</span> <span class="n">sample_lambert_dist</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
</span><span id="diffuse-571"><a href="#diffuse-571"><span class="linenos">571</span></a>
</span><span id="diffuse-572"><a href="#diffuse-572"><span class="linenos">572</span></a>        <span class="n">diffuse_directions</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">num</span><span class="p">:</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="n">diff_dirs</span>
</span><span id="diffuse-573"><a href="#diffuse-573"><span class="linenos">573</span></a>
</span><span id="diffuse-574"><a href="#diffuse-574"><span class="linenos">574</span></a>    <span class="k">return</span> <span class="n">diffuse_directions</span>
</span></pre></div>


            <div class="docstring"><p>Compute multiple diffuse reflection directions for an array of surface
normals by sampling the Lambert cosine distribution.</p>

<p>For each input normal, generates num diffusely reflected ray directions
following Lambert's cosine law. This models realistic diffuse scattering
from rough surfaces.</p>

<h2 id="parameters">Parameters</h2>

<p>normals : ndarray, shape (N, 3)
    Array of surface normal unit vectors at reflection points.
num : int, default=10
    Number of diffuse samples to generate for each normal. Higher values
    give more accurate diffuse reflection modeling but increase computation.</p>

<h2 id="returns">Returns</h2>

<p>diffuse_directions : ndarray, shape (N  num, 3)
    Array of sampled diffuse direction vectors. For each of the N input
    normals, generates num directions, resulting in Nnum total directions.
    Directions are ordered so that directions [inum : (i+1)num] correspond
    to normal i.</p>

<h2 id="notes">Notes</h2>

<p>This function is used to model non-specular (rough) surface reflections.
Each diffuse direction is randomly sampled from the hemisphere above the
surface, weighted by the cosine of the angle from the normal (Lambert's law).</p>

<p>The returned array can be fed directly into the ray tracer to simulate
secondary illumination from diffuse reflections.</p>

<h2 id="example">Example</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="n">normals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>  <span class="c1"># Two normals</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dirs</span> <span class="o">=</span> <span class="n">diffuse</span><span class="p">(</span><span class="n">normals</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 5 samples each</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">dirs</span><span class="o">.</span><span class="n">shape</span>
<span class="go">(10, 3)  # 2 normals  5 samples = 10 directions</span>
</code></pre>
</div>
</div>


                </section>
                <section id="compute_secondary_bounce">
                            <input id="compute_secondary_bounce-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">compute_secondary_bounce</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">location</span>,</span><span class="param">	<span class="n">index_tri</span>,</span><span class="param">	<span class="n">mesh_obj</span>,</span><span class="param">	<span class="n">ray_directions</span>,</span><span class="param">	<span class="n">index_ray</span>,</span><span class="param">	<span class="n">diffusion</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">num_diffuse</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="compute_secondary_bounce-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#compute_secondary_bounce"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="compute_secondary_bounce-579"><a href="#compute_secondary_bounce-579"><span class="linenos">579</span></a><span class="k">def</span> <span class="nf">compute_secondary_bounce</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">index_tri</span><span class="p">,</span> <span class="n">mesh_obj</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">,</span> <span class="n">index_ray</span><span class="p">,</span> <span class="n">diffusion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="compute_secondary_bounce-580"><a href="#compute_secondary_bounce-580"><span class="linenos">580</span></a>                             <span class="n">num_diffuse</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="compute_secondary_bounce-581"><a href="#compute_secondary_bounce-581"><span class="linenos">581</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="compute_secondary_bounce-582"><a href="#compute_secondary_bounce-582"><span class="linenos">582</span></a><span class="sd">    Prepare ray origins and directions for subsequent ray tracing bounces by</span>
</span><span id="compute_secondary_bounce-583"><a href="#compute_secondary_bounce-583"><span class="linenos">583</span></a><span class="sd">    computing specular and optionally diffuse reflection directions.</span>
</span><span id="compute_secondary_bounce-584"><a href="#compute_secondary_bounce-584"><span class="linenos">584</span></a><span class="sd">    </span>
</span><span id="compute_secondary_bounce-585"><a href="#compute_secondary_bounce-585"><span class="linenos">585</span></a><span class="sd">    This function takes the results of a ray-surface intersection and computes</span>
</span><span id="compute_secondary_bounce-586"><a href="#compute_secondary_bounce-586"><span class="linenos">586</span></a><span class="sd">    the reflected rays needed for the next bounce iteration in multi-bounce</span>
</span><span id="compute_secondary_bounce-587"><a href="#compute_secondary_bounce-587"><span class="linenos">587</span></a><span class="sd">    ray tracing.</span>
</span><span id="compute_secondary_bounce-588"><a href="#compute_secondary_bounce-588"><span class="linenos">588</span></a><span class="sd">    </span>
</span><span id="compute_secondary_bounce-589"><a href="#compute_secondary_bounce-589"><span class="linenos">589</span></a><span class="sd">    Parameters</span>
</span><span id="compute_secondary_bounce-590"><a href="#compute_secondary_bounce-590"><span class="linenos">590</span></a><span class="sd">    ----------</span>
</span><span id="compute_secondary_bounce-591"><a href="#compute_secondary_bounce-591"><span class="linenos">591</span></a><span class="sd">    location : ndarray, shape (N_hits, 3)</span>
</span><span id="compute_secondary_bounce-592"><a href="#compute_secondary_bounce-592"><span class="linenos">592</span></a><span class="sd">        3D coordinates of ray-surface intersection points.</span>
</span><span id="compute_secondary_bounce-593"><a href="#compute_secondary_bounce-593"><span class="linenos">593</span></a><span class="sd">    index_tri : ndarray, shape (N_hits,)</span>
</span><span id="compute_secondary_bounce-594"><a href="#compute_secondary_bounce-594"><span class="linenos">594</span></a><span class="sd">        Indices of the mesh faces (triangles) that were intersected by rays.</span>
</span><span id="compute_secondary_bounce-595"><a href="#compute_secondary_bounce-595"><span class="linenos">595</span></a><span class="sd">    mesh_obj : trimesh.Trimesh</span>
</span><span id="compute_secondary_bounce-596"><a href="#compute_secondary_bounce-596"><span class="linenos">596</span></a><span class="sd">        The mesh object containing geometry information (vertices, faces, normals).</span>
</span><span id="compute_secondary_bounce-597"><a href="#compute_secondary_bounce-597"><span class="linenos">597</span></a><span class="sd">    ray_directions : ndarray, shape (N_rays, 3)</span>
</span><span id="compute_secondary_bounce-598"><a href="#compute_secondary_bounce-598"><span class="linenos">598</span></a><span class="sd">        Direction vectors of the incident rays (before intersection).</span>
</span><span id="compute_secondary_bounce-599"><a href="#compute_secondary_bounce-599"><span class="linenos">599</span></a><span class="sd">    index_ray : ndarray, shape (N_hits,)</span>
</span><span id="compute_secondary_bounce-600"><a href="#compute_secondary_bounce-600"><span class="linenos">600</span></a><span class="sd">        Indices of the rays that successfully intersected the mesh. Used to</span>
</span><span id="compute_secondary_bounce-601"><a href="#compute_secondary_bounce-601"><span class="linenos">601</span></a><span class="sd">        map from the original ray array to the subset that hit surfaces.</span>
</span><span id="compute_secondary_bounce-602"><a href="#compute_secondary_bounce-602"><span class="linenos">602</span></a><span class="sd">    diffusion : bool, default=False</span>
</span><span id="compute_secondary_bounce-603"><a href="#compute_secondary_bounce-603"><span class="linenos">603</span></a><span class="sd">        If True, compute diffuse reflection directions in addition to specular</span>
</span><span id="compute_secondary_bounce-604"><a href="#compute_secondary_bounce-604"><span class="linenos">604</span></a><span class="sd">        reflections. Used for modeling rough surface scattering.</span>
</span><span id="compute_secondary_bounce-605"><a href="#compute_secondary_bounce-605"><span class="linenos">605</span></a><span class="sd">    num_diffuse : int or None, default=None</span>
</span><span id="compute_secondary_bounce-606"><a href="#compute_secondary_bounce-606"><span class="linenos">606</span></a><span class="sd">        Number of diffuse samples per intersection point. Required if</span>
</span><span id="compute_secondary_bounce-607"><a href="#compute_secondary_bounce-607"><span class="linenos">607</span></a><span class="sd">        diffusion=True, ignored otherwise.</span>
</span><span id="compute_secondary_bounce-608"><a href="#compute_secondary_bounce-608"><span class="linenos">608</span></a><span class="sd">    </span>
</span><span id="compute_secondary_bounce-609"><a href="#compute_secondary_bounce-609"><span class="linenos">609</span></a><span class="sd">    Returns</span>
</span><span id="compute_secondary_bounce-610"><a href="#compute_secondary_bounce-610"><span class="linenos">610</span></a><span class="sd">    -------</span>
</span><span id="compute_secondary_bounce-611"><a href="#compute_secondary_bounce-611"><span class="linenos">611</span></a><span class="sd">    location : ndarray, shape (N_hits, 3)</span>
</span><span id="compute_secondary_bounce-612"><a href="#compute_secondary_bounce-612"><span class="linenos">612</span></a><span class="sd">        Same as input location (pass-through for convenience).</span>
</span><span id="compute_secondary_bounce-613"><a href="#compute_secondary_bounce-613"><span class="linenos">613</span></a><span class="sd">    reflect_dirs : ndarray, shape (N_hits, 3)</span>
</span><span id="compute_secondary_bounce-614"><a href="#compute_secondary_bounce-614"><span class="linenos">614</span></a><span class="sd">        Specularly reflected ray directions for each intersection point.</span>
</span><span id="compute_secondary_bounce-615"><a href="#compute_secondary_bounce-615"><span class="linenos">615</span></a><span class="sd">        Computed using the law of reflection with surface normals.</span>
</span><span id="compute_secondary_bounce-616"><a href="#compute_secondary_bounce-616"><span class="linenos">616</span></a><span class="sd">    diffuse_dirs : ndarray, shape (N_hits  num_diffuse, 3) or int</span>
</span><span id="compute_secondary_bounce-617"><a href="#compute_secondary_bounce-617"><span class="linenos">617</span></a><span class="sd">        If diffusion=True: array of diffusely reflected directions sampled</span>
</span><span id="compute_secondary_bounce-618"><a href="#compute_secondary_bounce-618"><span class="linenos">618</span></a><span class="sd">        from Lambert distribution for each intersection point.</span>
</span><span id="compute_secondary_bounce-619"><a href="#compute_secondary_bounce-619"><span class="linenos">619</span></a><span class="sd">        If diffusion=False: returns -1 (dummy value for consistent return signature).</span>
</span><span id="compute_secondary_bounce-620"><a href="#compute_secondary_bounce-620"><span class="linenos">620</span></a><span class="sd">    </span>
</span><span id="compute_secondary_bounce-621"><a href="#compute_secondary_bounce-621"><span class="linenos">621</span></a><span class="sd">    Notes</span>
</span><span id="compute_secondary_bounce-622"><a href="#compute_secondary_bounce-622"><span class="linenos">622</span></a><span class="sd">    -----</span>
</span><span id="compute_secondary_bounce-623"><a href="#compute_secondary_bounce-623"><span class="linenos">623</span></a><span class="sd">    This function is typically called iteratively in multi-bounce ray tracing:</span>
</span><span id="compute_secondary_bounce-624"><a href="#compute_secondary_bounce-624"><span class="linenos">624</span></a><span class="sd">    1. First bounce: rays from source hit surface</span>
</span><span id="compute_secondary_bounce-625"><a href="#compute_secondary_bounce-625"><span class="linenos">625</span></a><span class="sd">    2. Compute secondary bounces from intersection points</span>
</span><span id="compute_secondary_bounce-626"><a href="#compute_secondary_bounce-626"><span class="linenos">626</span></a><span class="sd">    3. Trace secondary rays</span>
</span><span id="compute_secondary_bounce-627"><a href="#compute_secondary_bounce-627"><span class="linenos">627</span></a><span class="sd">    4. Repeat for N bounces</span>
</span><span id="compute_secondary_bounce-628"><a href="#compute_secondary_bounce-628"><span class="linenos">628</span></a><span class="sd">    </span>
</span><span id="compute_secondary_bounce-629"><a href="#compute_secondary_bounce-629"><span class="linenos">629</span></a><span class="sd">    The specular reflections follow the law of reflection, while diffuse</span>
</span><span id="compute_secondary_bounce-630"><a href="#compute_secondary_bounce-630"><span class="linenos">630</span></a><span class="sd">    reflections sample the Lambert cosine distribution, providing physically</span>
</span><span id="compute_secondary_bounce-631"><a href="#compute_secondary_bounce-631"><span class="linenos">631</span></a><span class="sd">    accurate modeling of both mirror-like and rough surfaces.</span>
</span><span id="compute_secondary_bounce-632"><a href="#compute_secondary_bounce-632"><span class="linenos">632</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="compute_secondary_bounce-633"><a href="#compute_secondary_bounce-633"><span class="linenos">633</span></a>    <span class="n">reflect_dirs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
</span><span id="compute_secondary_bounce-634"><a href="#compute_secondary_bounce-634"><span class="linenos">634</span></a>    <span class="n">normals</span> <span class="o">=</span> <span class="n">mesh_obj</span><span class="o">.</span><span class="n">face_normals</span>
</span><span id="compute_secondary_bounce-635"><a href="#compute_secondary_bounce-635"><span class="linenos">635</span></a>
</span><span id="compute_secondary_bounce-636"><a href="#compute_secondary_bounce-636"><span class="linenos">636</span></a>    <span class="n">reflect_dirs</span> <span class="o">=</span> <span class="n">reflected</span><span class="p">(</span><span class="n">ray_directions</span><span class="p">[</span><span class="n">index_ray</span><span class="p">],</span> <span class="n">normals</span><span class="p">[</span><span class="n">index_tri</span><span class="p">])</span>
</span><span id="compute_secondary_bounce-637"><a href="#compute_secondary_bounce-637"><span class="linenos">637</span></a>
</span><span id="compute_secondary_bounce-638"><a href="#compute_secondary_bounce-638"><span class="linenos">638</span></a>    <span class="k">if</span> <span class="n">diffusion</span><span class="p">:</span>
</span><span id="compute_secondary_bounce-639"><a href="#compute_secondary_bounce-639"><span class="linenos">639</span></a>        <span class="n">diffuse_dirs</span> <span class="o">=</span> <span class="n">diffuse</span><span class="p">(</span><span class="n">normals</span><span class="p">[</span><span class="n">index_tri</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="n">num_diffuse</span><span class="p">)</span>
</span><span id="compute_secondary_bounce-640"><a href="#compute_secondary_bounce-640"><span class="linenos">640</span></a>
</span><span id="compute_secondary_bounce-641"><a href="#compute_secondary_bounce-641"><span class="linenos">641</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="compute_secondary_bounce-642"><a href="#compute_secondary_bounce-642"><span class="linenos">642</span></a>        <span class="n">diffuse_dirs</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>  <span class="c1"># Dummy variable for return values management</span>
</span><span id="compute_secondary_bounce-643"><a href="#compute_secondary_bounce-643"><span class="linenos">643</span></a>
</span><span id="compute_secondary_bounce-644"><a href="#compute_secondary_bounce-644"><span class="linenos">644</span></a>    <span class="k">return</span> <span class="n">location</span><span class="p">,</span> <span class="n">reflect_dirs</span><span class="p">,</span> <span class="n">diffuse_dirs</span>
</span></pre></div>


            <div class="docstring"><p>Prepare ray origins and directions for subsequent ray tracing bounces by
computing specular and optionally diffuse reflection directions.</p>

<p>This function takes the results of a ray-surface intersection and computes
the reflected rays needed for the next bounce iteration in multi-bounce
ray tracing.</p>

<h2 id="parameters">Parameters</h2>

<p>location : ndarray, shape (N_hits, 3)
    3D coordinates of ray-surface intersection points.
index_tri : ndarray, shape (N_hits,)
    Indices of the mesh faces (triangles) that were intersected by rays.
mesh_obj : trimesh.Trimesh
    The mesh object containing geometry information (vertices, faces, normals).
ray_directions : ndarray, shape (N_rays, 3)
    Direction vectors of the incident rays (before intersection).
index_ray : ndarray, shape (N_hits,)
    Indices of the rays that successfully intersected the mesh. Used to
    map from the original ray array to the subset that hit surfaces.
diffusion : bool, default=False
    If True, compute diffuse reflection directions in addition to specular
    reflections. Used for modeling rough surface scattering.
num_diffuse : int or None, default=None
    Number of diffuse samples per intersection point. Required if
    diffusion=True, ignored otherwise.</p>

<h2 id="returns">Returns</h2>

<p>location : ndarray, shape (N_hits, 3)
    Same as input location (pass-through for convenience).
reflect_dirs : ndarray, shape (N_hits, 3)
    Specularly reflected ray directions for each intersection point.
    Computed using the law of reflection with surface normals.
diffuse_dirs : ndarray, shape (N_hits  num_diffuse, 3) or int
    If diffusion=True: array of diffusely reflected directions sampled
    from Lambert distribution for each intersection point.
    If diffusion=False: returns -1 (dummy value for consistent return signature).</p>

<h2 id="notes">Notes</h2>

<p>This function is typically called iteratively in multi-bounce ray tracing:</p>

<ol>
<li>First bounce: rays from source hit surface</li>
<li>Compute secondary bounces from intersection points</li>
<li>Trace secondary rays</li>
<li>Repeat for N bounces</li>
</ol>

<p>The specular reflections follow the law of reflection, while diffuse
reflections sample the Lambert cosine distribution, providing physically
accurate modeling of both mirror-like and rough surfaces.</p>
</div>


                </section>
                <section id="save_for_visualization">
                            <input id="save_for_visualization-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">save_for_visualization</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">outputFilePath</span>,</span><span class="param">	<span class="n">mesh</span>,</span><span class="param">	<span class="n">ray_origins</span>,</span><span class="param">	<span class="n">ray_directions</span>,</span><span class="param">	<span class="n">location</span>,</span><span class="param">	<span class="n">index_tri</span>,</span><span class="param">	<span class="n">diffusion_pack</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="save_for_visualization-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#save_for_visualization"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="save_for_visualization-650"><a href="#save_for_visualization-650"><span class="linenos">650</span></a><span class="k">def</span> <span class="nf">save_for_visualization</span><span class="p">(</span><span class="n">outputFilePath</span><span class="p">,</span> <span class="n">mesh</span><span class="p">,</span> <span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">index_tri</span><span class="p">,</span> <span class="n">diffusion_pack</span><span class="p">):</span>
</span><span id="save_for_visualization-651"><a href="#save_for_visualization-651"><span class="linenos">651</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="save_for_visualization-652"><a href="#save_for_visualization-652"><span class="linenos">652</span></a><span class="sd">    Save ray tracing results to a pickled dictionary for post-processing and</span>
</span><span id="save_for_visualization-653"><a href="#save_for_visualization-653"><span class="linenos">653</span></a><span class="sd">    visualization.</span>
</span><span id="save_for_visualization-654"><a href="#save_for_visualization-654"><span class="linenos">654</span></a><span class="sd">    </span>
</span><span id="save_for_visualization-655"><a href="#save_for_visualization-655"><span class="linenos">655</span></a><span class="sd">    Creates a standardized output format that can be loaded by visualization</span>
</span><span id="save_for_visualization-656"><a href="#save_for_visualization-656"><span class="linenos">656</span></a><span class="sd">    scripts (see visual_utils module) for analyzing ray tracing results,</span>
</span><span id="save_for_visualization-657"><a href="#save_for_visualization-657"><span class="linenos">657</span></a><span class="sd">    creating visualizations, and debugging ray path geometries.</span>
</span><span id="save_for_visualization-658"><a href="#save_for_visualization-658"><span class="linenos">658</span></a><span class="sd">    </span>
</span><span id="save_for_visualization-659"><a href="#save_for_visualization-659"><span class="linenos">659</span></a><span class="sd">    Parameters</span>
</span><span id="save_for_visualization-660"><a href="#save_for_visualization-660"><span class="linenos">660</span></a><span class="sd">    ----------</span>
</span><span id="save_for_visualization-661"><a href="#save_for_visualization-661"><span class="linenos">661</span></a><span class="sd">    outputFilePath : str</span>
</span><span id="save_for_visualization-662"><a href="#save_for_visualization-662"><span class="linenos">662</span></a><span class="sd">        Path to output file. Should end with &#39;.pkl&#39; extension. Parent directory</span>
</span><span id="save_for_visualization-663"><a href="#save_for_visualization-663"><span class="linenos">663</span></a><span class="sd">        must exist.</span>
</span><span id="save_for_visualization-664"><a href="#save_for_visualization-664"><span class="linenos">664</span></a><span class="sd">    mesh : trimesh.Trimesh</span>
</span><span id="save_for_visualization-665"><a href="#save_for_visualization-665"><span class="linenos">665</span></a><span class="sd">        The mesh object that was ray-traced. Contains geometry (vertices, faces,</span>
</span><span id="save_for_visualization-666"><a href="#save_for_visualization-666"><span class="linenos">666</span></a><span class="sd">        normals) for visualization.</span>
</span><span id="save_for_visualization-667"><a href="#save_for_visualization-667"><span class="linenos">667</span></a><span class="sd">    ray_origins : list of ndarrays</span>
</span><span id="save_for_visualization-668"><a href="#save_for_visualization-668"><span class="linenos">668</span></a><span class="sd">        List containing ray origin arrays for each bounce. Each element is an</span>
</span><span id="save_for_visualization-669"><a href="#save_for_visualization-669"><span class="linenos">669</span></a><span class="sd">        array of shape (N_rays_i, 3) where i is the bounce number.</span>
</span><span id="save_for_visualization-670"><a href="#save_for_visualization-670"><span class="linenos">670</span></a><span class="sd">    ray_directions : list of ndarrays</span>
</span><span id="save_for_visualization-671"><a href="#save_for_visualization-671"><span class="linenos">671</span></a><span class="sd">        List containing ray direction arrays for each bounce. Same structure</span>
</span><span id="save_for_visualization-672"><a href="#save_for_visualization-672"><span class="linenos">672</span></a><span class="sd">        as ray_origins.</span>
</span><span id="save_for_visualization-673"><a href="#save_for_visualization-673"><span class="linenos">673</span></a><span class="sd">    location : list of ndarrays</span>
</span><span id="save_for_visualization-674"><a href="#save_for_visualization-674"><span class="linenos">674</span></a><span class="sd">        List containing intersection point coordinates for each bounce. Each</span>
</span><span id="save_for_visualization-675"><a href="#save_for_visualization-675"><span class="linenos">675</span></a><span class="sd">        element is shape (N_hits_i, 3).</span>
</span><span id="save_for_visualization-676"><a href="#save_for_visualization-676"><span class="linenos">676</span></a><span class="sd">    index_tri : list of ndarrays</span>
</span><span id="save_for_visualization-677"><a href="#save_for_visualization-677"><span class="linenos">677</span></a><span class="sd">        List containing indices of intersected triangles for each bounce.</span>
</span><span id="save_for_visualization-678"><a href="#save_for_visualization-678"><span class="linenos">678</span></a><span class="sd">        Each element is shape (N_hits_i,).</span>
</span><span id="save_for_visualization-679"><a href="#save_for_visualization-679"><span class="linenos">679</span></a><span class="sd">    diffusion_pack : list or None</span>
</span><span id="save_for_visualization-680"><a href="#save_for_visualization-680"><span class="linenos">680</span></a><span class="sd">        Diffuse ray tracing data if computed, otherwise None. Contains:</span>
</span><span id="save_for_visualization-681"><a href="#save_for_visualization-681"><span class="linenos">681</span></a><span class="sd">        [index_tri_diffusion, index_ray_diffusion, ray_directions_diffusion,</span>
</span><span id="save_for_visualization-682"><a href="#save_for_visualization-682"><span class="linenos">682</span></a><span class="sd">         location_diffusion] for visualization of diffuse scattering.</span>
</span><span id="save_for_visualization-683"><a href="#save_for_visualization-683"><span class="linenos">683</span></a><span class="sd">    </span>
</span><span id="save_for_visualization-684"><a href="#save_for_visualization-684"><span class="linenos">684</span></a><span class="sd">    Returns</span>
</span><span id="save_for_visualization-685"><a href="#save_for_visualization-685"><span class="linenos">685</span></a><span class="sd">    -------</span>
</span><span id="save_for_visualization-686"><a href="#save_for_visualization-686"><span class="linenos">686</span></a><span class="sd">    None</span>
</span><span id="save_for_visualization-687"><a href="#save_for_visualization-687"><span class="linenos">687</span></a><span class="sd">        Data is written to file at outputFilePath.</span>
</span><span id="save_for_visualization-688"><a href="#save_for_visualization-688"><span class="linenos">688</span></a><span class="sd">    </span>
</span><span id="save_for_visualization-689"><a href="#save_for_visualization-689"><span class="linenos">689</span></a><span class="sd">    Notes</span>
</span><span id="save_for_visualization-690"><a href="#save_for_visualization-690"><span class="linenos">690</span></a><span class="sd">    -----</span>
</span><span id="save_for_visualization-691"><a href="#save_for_visualization-691"><span class="linenos">691</span></a><span class="sd">    The output file contains a dictionary with keys:</span>
</span><span id="save_for_visualization-692"><a href="#save_for_visualization-692"><span class="linenos">692</span></a><span class="sd">    - &#39;mesh&#39;: trimesh.Trimesh object</span>
</span><span id="save_for_visualization-693"><a href="#save_for_visualization-693"><span class="linenos">693</span></a><span class="sd">    - &#39;ray_origins&#39;: list of origin arrays per bounce</span>
</span><span id="save_for_visualization-694"><a href="#save_for_visualization-694"><span class="linenos">694</span></a><span class="sd">    - &#39;ray_directions&#39;: list of direction arrays per bounce  </span>
</span><span id="save_for_visualization-695"><a href="#save_for_visualization-695"><span class="linenos">695</span></a><span class="sd">    - &#39;locations&#39;: list of intersection point arrays per bounce</span>
</span><span id="save_for_visualization-696"><a href="#save_for_visualization-696"><span class="linenos">696</span></a><span class="sd">    - &#39;index_tri&#39;: list of triangle index arrays per bounce</span>
</span><span id="save_for_visualization-697"><a href="#save_for_visualization-697"><span class="linenos">697</span></a><span class="sd">    - &#39;diffusion_pack&#39;: diffuse ray data or None</span>
</span><span id="save_for_visualization-698"><a href="#save_for_visualization-698"><span class="linenos">698</span></a><span class="sd">    </span>
</span><span id="save_for_visualization-699"><a href="#save_for_visualization-699"><span class="linenos">699</span></a><span class="sd">    This standardized format allows visualization scripts to recreate the full</span>
</span><span id="save_for_visualization-700"><a href="#save_for_visualization-700"><span class="linenos">700</span></a><span class="sd">    ray tracing geometry including multiple bounces and diffuse scattering.</span>
</span><span id="save_for_visualization-701"><a href="#save_for_visualization-701"><span class="linenos">701</span></a><span class="sd">    </span>
</span><span id="save_for_visualization-702"><a href="#save_for_visualization-702"><span class="linenos">702</span></a><span class="sd">    The file is saved using pickle protocol 4 for Python 3 compatibility.</span>
</span><span id="save_for_visualization-703"><a href="#save_for_visualization-703"><span class="linenos">703</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="save_for_visualization-704"><a href="#save_for_visualization-704"><span class="linenos">704</span></a>
</span><span id="save_for_visualization-705"><a href="#save_for_visualization-705"><span class="linenos">705</span></a>    <span class="n">outdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mesh&#39;</span><span class="p">:</span> <span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;ray_origins&#39;</span><span class="p">:</span> <span class="n">ray_origins</span><span class="p">,</span> <span class="s1">&#39;ray_directions&#39;</span><span class="p">:</span> <span class="n">ray_directions</span><span class="p">,</span> <span class="s1">&#39;locations&#39;</span><span class="p">:</span> <span class="n">location</span><span class="p">,</span>
</span><span id="save_for_visualization-706"><a href="#save_for_visualization-706"><span class="linenos">706</span></a>               <span class="s1">&#39;index_tri&#39;</span><span class="p">:</span> <span class="n">index_tri</span><span class="p">,</span> <span class="s1">&#39;diffusion_pack&#39;</span><span class="p">:</span> <span class="n">diffusion_pack</span><span class="p">}</span>
</span><span id="save_for_visualization-707"><a href="#save_for_visualization-707"><span class="linenos">707</span></a>
</span><span id="save_for_visualization-708"><a href="#save_for_visualization-708"><span class="linenos">708</span></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outputFilePath</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="save_for_visualization-709"><a href="#save_for_visualization-709"><span class="linenos">709</span></a>        <span class="n">pkl</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">outdict</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Save ray tracing results to a pickled dictionary for post-processing and
visualization.</p>

<p>Creates a standardized output format that can be loaded by visualization
scripts (see visual_utils module) for analyzing ray tracing results,
creating visualizations, and debugging ray path geometries.</p>

<h2 id="parameters">Parameters</h2>

<p>outputFilePath : str
    Path to output file. Should end with '.pkl' extension. Parent directory
    must exist.
mesh : trimesh.Trimesh
    The mesh object that was ray-traced. Contains geometry (vertices, faces,
    normals) for visualization.
ray_origins : list of ndarrays
    List containing ray origin arrays for each bounce. Each element is an
    array of shape (N_rays_i, 3) where i is the bounce number.
ray_directions : list of ndarrays
    List containing ray direction arrays for each bounce. Same structure
    as ray_origins.
location : list of ndarrays
    List containing intersection point coordinates for each bounce. Each
    element is shape (N_hits_i, 3).
index_tri : list of ndarrays
    List containing indices of intersected triangles for each bounce.
    Each element is shape (N_hits_i,).
diffusion_pack : list or None
    Diffuse ray tracing data if computed, otherwise None. Contains:
    [index_tri_diffusion, index_ray_diffusion, ray_directions_diffusion,
     location_diffusion] for visualization of diffuse scattering.</p>

<h2 id="returns">Returns</h2>

<p>None
    Data is written to file at outputFilePath.</p>

<h2 id="notes">Notes</h2>

<p>The output file contains a dictionary with keys:</p>

<ul>
<li>'mesh': trimesh.Trimesh object</li>
<li>'ray_origins': list of origin arrays per bounce</li>
<li>'ray_directions': list of direction arrays per bounce  </li>
<li>'locations': list of intersection point arrays per bounce</li>
<li>'index_tri': list of triangle index arrays per bounce</li>
<li>'diffusion_pack': diffuse ray data or None</li>
</ul>

<p>This standardized format allows visualization scripts to recreate the full
ray tracing geometry including multiple bounces and diffuse scattering.</p>

<p>The file is saved using pickle protocol 4 for Python 3 compatibility.</p>
</div>


                </section>
                <section id="exportEXAC">
                            <input id="exportEXAC-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">exportEXAC</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">satelliteID</span>, </span><span class="param"><span class="n">data</span>, </span><span class="param"><span class="n">tstep</span>, </span><span class="param"><span class="n">startTime</span>, </span><span class="param"><span class="n">endTime</span>, </span><span class="param"><span class="n">outFileName</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="exportEXAC-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#exportEXAC"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="exportEXAC-712"><a href="#exportEXAC-712"><span class="linenos">712</span></a><span class="k">def</span> <span class="nf">exportEXAC</span><span class="p">(</span><span class="n">satelliteID</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">tstep</span><span class="p">,</span> <span class="n">startTime</span><span class="p">,</span> <span class="n">endTime</span><span class="p">,</span> <span class="n">outFileName</span><span class="p">):</span>
</span><span id="exportEXAC-713"><a href="#exportEXAC-713"><span class="linenos">713</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="exportEXAC-714"><a href="#exportEXAC-714"><span class="linenos">714</span></a><span class="sd">    Export acceleration data to GEODYN EXAC (External Accelerations) file format.</span>
</span><span id="exportEXAC-715"><a href="#exportEXAC-715"><span class="linenos">715</span></a><span class="sd">    </span>
</span><span id="exportEXAC-716"><a href="#exportEXAC-716"><span class="linenos">716</span></a><span class="sd">    GEODYN is NASA&#39;s precision orbit determination software. The EXAC format is</span>
</span><span id="exportEXAC-717"><a href="#exportEXAC-717"><span class="linenos">717</span></a><span class="sd">    a Fortran-formatted binary file used to provide time-varying external</span>
</span><span id="exportEXAC-718"><a href="#exportEXAC-718"><span class="linenos">718</span></a><span class="sd">    accelerations (such as solar radiation pressure) to the orbit propagator.</span>
</span><span id="exportEXAC-719"><a href="#exportEXAC-719"><span class="linenos">719</span></a><span class="sd">    </span>
</span><span id="exportEXAC-720"><a href="#exportEXAC-720"><span class="linenos">720</span></a><span class="sd">    Parameters</span>
</span><span id="exportEXAC-721"><a href="#exportEXAC-721"><span class="linenos">721</span></a><span class="sd">    ----------</span>
</span><span id="exportEXAC-722"><a href="#exportEXAC-722"><span class="linenos">722</span></a><span class="sd">    satelliteID : int</span>
</span><span id="exportEXAC-723"><a href="#exportEXAC-723"><span class="linenos">723</span></a><span class="sd">        Satellite identifier code used in GEODYN processing.</span>
</span><span id="exportEXAC-724"><a href="#exportEXAC-724"><span class="linenos">724</span></a><span class="sd">    data : ndarray, shape (N, 3)</span>
</span><span id="exportEXAC-725"><a href="#exportEXAC-725"><span class="linenos">725</span></a><span class="sd">        Acceleration data to be written, in km/s. Each row is [ax, ay, az]</span>
</span><span id="exportEXAC-726"><a href="#exportEXAC-726"><span class="linenos">726</span></a><span class="sd">        at one time step.</span>
</span><span id="exportEXAC-727"><a href="#exportEXAC-727"><span class="linenos">727</span></a><span class="sd">    tstep : int or float</span>
</span><span id="exportEXAC-728"><a href="#exportEXAC-728"><span class="linenos">728</span></a><span class="sd">        Time step between data records in seconds (e.g., 60 for 1-minute data).</span>
</span><span id="exportEXAC-729"><a href="#exportEXAC-729"><span class="linenos">729</span></a><span class="sd">    startTime : datetime.datetime</span>
</span><span id="exportEXAC-730"><a href="#exportEXAC-730"><span class="linenos">730</span></a><span class="sd">        Start time of the data series. Must include date and time information</span>
</span><span id="exportEXAC-731"><a href="#exportEXAC-731"><span class="linenos">731</span></a><span class="sd">        down to microseconds.</span>
</span><span id="exportEXAC-732"><a href="#exportEXAC-732"><span class="linenos">732</span></a><span class="sd">    endTime : datetime.datetime</span>
</span><span id="exportEXAC-733"><a href="#exportEXAC-733"><span class="linenos">733</span></a><span class="sd">        End time of the data series. Must be consistent with len(data) and tstep.</span>
</span><span id="exportEXAC-734"><a href="#exportEXAC-734"><span class="linenos">734</span></a><span class="sd">    outFileName : str</span>
</span><span id="exportEXAC-735"><a href="#exportEXAC-735"><span class="linenos">735</span></a><span class="sd">        Path to output EXAC file. Typically uses .exac or .bin extension.</span>
</span><span id="exportEXAC-736"><a href="#exportEXAC-736"><span class="linenos">736</span></a><span class="sd">    </span>
</span><span id="exportEXAC-737"><a href="#exportEXAC-737"><span class="linenos">737</span></a><span class="sd">    Returns</span>
</span><span id="exportEXAC-738"><a href="#exportEXAC-738"><span class="linenos">738</span></a><span class="sd">    -------</span>
</span><span id="exportEXAC-739"><a href="#exportEXAC-739"><span class="linenos">739</span></a><span class="sd">    None</span>
</span><span id="exportEXAC-740"><a href="#exportEXAC-740"><span class="linenos">740</span></a><span class="sd">        Data is written to binary file at outFileName.</span>
</span><span id="exportEXAC-741"><a href="#exportEXAC-741"><span class="linenos">741</span></a><span class="sd">    </span>
</span><span id="exportEXAC-742"><a href="#exportEXAC-742"><span class="linenos">742</span></a><span class="sd">    Notes</span>
</span><span id="exportEXAC-743"><a href="#exportEXAC-743"><span class="linenos">743</span></a><span class="sd">    -----</span>
</span><span id="exportEXAC-744"><a href="#exportEXAC-744"><span class="linenos">744</span></a><span class="sd">    EXAC File Structure:</span>
</span><span id="exportEXAC-745"><a href="#exportEXAC-745"><span class="linenos">745</span></a><span class="sd">    - Master header record: Control parameters and file type identifier</span>
</span><span id="exportEXAC-746"><a href="#exportEXAC-746"><span class="linenos">746</span></a><span class="sd">    - Satellite-specific header: Satellite ID, time step, start/end times</span>
</span><span id="exportEXAC-747"><a href="#exportEXAC-747"><span class="linenos">747</span></a><span class="sd">    - Data records: Time stamp + 3D acceleration vector + padding zeros</span>
</span><span id="exportEXAC-748"><a href="#exportEXAC-748"><span class="linenos">748</span></a><span class="sd">    </span>
</span><span id="exportEXAC-749"><a href="#exportEXAC-749"><span class="linenos">749</span></a><span class="sd">    Time Format:</span>
</span><span id="exportEXAC-750"><a href="#exportEXAC-750"><span class="linenos">750</span></a><span class="sd">    - Stored as YYMMDDHHMMSS (year-month-day-hour-minute-second-microsecond)</span>
</span><span id="exportEXAC-751"><a href="#exportEXAC-751"><span class="linenos">751</span></a><span class="sd">    - Year uses 2-digit format (YY)</span>
</span><span id="exportEXAC-752"><a href="#exportEXAC-752"><span class="linenos">752</span></a><span class="sd">    </span>
</span><span id="exportEXAC-753"><a href="#exportEXAC-753"><span class="linenos">753</span></a><span class="sd">    Coordinate System:</span>
</span><span id="exportEXAC-754"><a href="#exportEXAC-754"><span class="linenos">754</span></a><span class="sd">    - Accelerations should be in the same reference frame as the GEODYN</span>
</span><span id="exportEXAC-755"><a href="#exportEXAC-755"><span class="linenos">755</span></a><span class="sd">      orbit integration (typically J2000 or ICRF)</span>
</span><span id="exportEXAC-756"><a href="#exportEXAC-756"><span class="linenos">756</span></a><span class="sd">    </span>
</span><span id="exportEXAC-757"><a href="#exportEXAC-757"><span class="linenos">757</span></a><span class="sd">    Units:</span>
</span><span id="exportEXAC-758"><a href="#exportEXAC-758"><span class="linenos">758</span></a><span class="sd">    - Accelerations: km/s</span>
</span><span id="exportEXAC-759"><a href="#exportEXAC-759"><span class="linenos">759</span></a><span class="sd">    - Time step: seconds</span>
</span><span id="exportEXAC-760"><a href="#exportEXAC-760"><span class="linenos">760</span></a><span class="sd">    </span>
</span><span id="exportEXAC-761"><a href="#exportEXAC-761"><span class="linenos">761</span></a><span class="sd">    This format is used for high-precision orbit determination where external</span>
</span><span id="exportEXAC-762"><a href="#exportEXAC-762"><span class="linenos">762</span></a><span class="sd">    non-gravitational forces (solar pressure, atmospheric drag, etc.) need to</span>
</span><span id="exportEXAC-763"><a href="#exportEXAC-763"><span class="linenos">763</span></a><span class="sd">    be accurately modeled.</span>
</span><span id="exportEXAC-764"><a href="#exportEXAC-764"><span class="linenos">764</span></a><span class="sd">    </span>
</span><span id="exportEXAC-765"><a href="#exportEXAC-765"><span class="linenos">765</span></a><span class="sd">    Requires scipy.io.FortranFile for binary I/O operations.</span>
</span><span id="exportEXAC-766"><a href="#exportEXAC-766"><span class="linenos">766</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="exportEXAC-767"><a href="#exportEXAC-767"><span class="linenos">767</span></a>
</span><span id="exportEXAC-768"><a href="#exportEXAC-768"><span class="linenos">768</span></a>    <span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">FortranFile</span>
</span><span id="exportEXAC-769"><a href="#exportEXAC-769"><span class="linenos">769</span></a>    <span class="kn">import</span> <span class="nn">datetime</span>
</span><span id="exportEXAC-770"><a href="#exportEXAC-770"><span class="linenos">770</span></a>
</span><span id="exportEXAC-771"><a href="#exportEXAC-771"><span class="linenos">771</span></a>    <span class="n">satid</span> <span class="o">=</span> <span class="n">satelliteID</span>
</span><span id="exportEXAC-772"><a href="#exportEXAC-772"><span class="linenos">772</span></a>    <span class="n">date0</span> <span class="o">=</span> <span class="n">startTime</span>
</span><span id="exportEXAC-773"><a href="#exportEXAC-773"><span class="linenos">773</span></a>    <span class="n">date1</span> <span class="o">=</span> <span class="n">endTime</span>
</span><span id="exportEXAC-774"><a href="#exportEXAC-774"><span class="linenos">774</span></a>    <span class="n">dt</span> <span class="o">=</span> <span class="n">tstep</span>
</span><span id="exportEXAC-775"><a href="#exportEXAC-775"><span class="linenos">775</span></a>    <span class="n">deltatime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">dt</span><span class="p">)</span>
</span><span id="exportEXAC-776"><a href="#exportEXAC-776"><span class="linenos">776</span></a>    <span class="n">outfile</span> <span class="o">=</span> <span class="n">FortranFile</span><span class="p">(</span><span class="n">outFileName</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
</span><span id="exportEXAC-777"><a href="#exportEXAC-777"><span class="linenos">777</span></a>
</span><span id="exportEXAC-778"><a href="#exportEXAC-778"><span class="linenos">778</span></a>    <span class="c1"># General Header</span>
</span><span id="exportEXAC-779"><a href="#exportEXAC-779"><span class="linenos">779</span></a>    <span class="n">masterhdr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">6666666.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="exportEXAC-780"><a href="#exportEXAC-780"><span class="linenos">780</span></a>    <span class="n">outfile</span><span class="o">.</span><span class="n">write_record</span><span class="p">(</span><span class="n">masterhdr</span><span class="p">)</span>
</span><span id="exportEXAC-781"><a href="#exportEXAC-781"><span class="linenos">781</span></a>
</span><span id="exportEXAC-782"><a href="#exportEXAC-782"><span class="linenos">782</span></a>    <span class="c1"># Satellite specific header</span>
</span><span id="exportEXAC-783"><a href="#exportEXAC-783"><span class="linenos">783</span></a>    <span class="n">sathdr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">7777777.0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">satid</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">date0</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">date0</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)),</span>
</span><span id="exportEXAC-784"><a href="#exportEXAC-784"><span class="linenos">784</span></a>                       <span class="nb">float</span><span class="p">(</span><span class="n">date1</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">date1</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)),</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="exportEXAC-785"><a href="#exportEXAC-785"><span class="linenos">785</span></a>    <span class="n">outfile</span><span class="o">.</span><span class="n">write_record</span><span class="p">(</span><span class="n">sathdr</span><span class="p">)</span>
</span><span id="exportEXAC-786"><a href="#exportEXAC-786"><span class="linenos">786</span></a>
</span><span id="exportEXAC-787"><a href="#exportEXAC-787"><span class="linenos">787</span></a>    <span class="c1"># Data records</span>
</span><span id="exportEXAC-788"><a href="#exportEXAC-788"><span class="linenos">788</span></a>    <span class="n">date</span> <span class="o">=</span> <span class="n">date0</span> <span class="o">-</span> <span class="n">deltatime</span>
</span><span id="exportEXAC-789"><a href="#exportEXAC-789"><span class="linenos">789</span></a>    <span class="k">for</span> <span class="n">d_elem</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span><span id="exportEXAC-790"><a href="#exportEXAC-790"><span class="linenos">790</span></a>        <span class="n">date</span> <span class="o">=</span> <span class="n">date</span> <span class="o">+</span> <span class="n">deltatime</span>
</span><span id="exportEXAC-791"><a href="#exportEXAC-791"><span class="linenos">791</span></a>        <span class="n">datarec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="exportEXAC-792"><a href="#exportEXAC-792"><span class="linenos">792</span></a>            <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S&#39;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)),</span> <span class="n">d_elem</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d_elem</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d_elem</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="exportEXAC-793"><a href="#exportEXAC-793"><span class="linenos">793</span></a>             <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</span><span id="exportEXAC-794"><a href="#exportEXAC-794"><span class="linenos">794</span></a>        <span class="n">outfile</span><span class="o">.</span><span class="n">write_record</span><span class="p">(</span><span class="n">datarec</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Export acceleration data to GEODYN EXAC (External Accelerations) file format.</p>

<p>GEODYN is NASA's precision orbit determination software. The EXAC format is
a Fortran-formatted binary file used to provide time-varying external
accelerations (such as solar radiation pressure) to the orbit propagator.</p>

<h2 id="parameters">Parameters</h2>

<p>satelliteID : int
    Satellite identifier code used in GEODYN processing.
data : ndarray, shape (N, 3)
    Acceleration data to be written, in km/s. Each row is [ax, ay, az]
    at one time step.
tstep : int or float
    Time step between data records in seconds (e.g., 60 for 1-minute data).
startTime : datetime.datetime
    Start time of the data series. Must include date and time information
    down to microseconds.
endTime : datetime.datetime
    End time of the data series. Must be consistent with len(data) and tstep.
outFileName : str
    Path to output EXAC file. Typically uses .exac or .bin extension.</p>

<h2 id="returns">Returns</h2>

<p>None
    Data is written to binary file at outFileName.</p>

<h2 id="notes">Notes</h2>

<p>EXAC File Structure:</p>

<ul>
<li>Master header record: Control parameters and file type identifier</li>
<li>Satellite-specific header: Satellite ID, time step, start/end times</li>
<li>Data records: Time stamp + 3D acceleration vector + padding zeros</li>
</ul>

<p>Time Format:</p>

<ul>
<li>Stored as YYMMDDHHMMSS (year-month-day-hour-minute-second-microsecond)</li>
<li>Year uses 2-digit format (YY)</li>
</ul>

<p>Coordinate System:</p>

<ul>
<li>Accelerations should be in the same reference frame as the GEODYN
orbit integration (typically J2000 or ICRF)</li>
</ul>

<p>Units:</p>

<ul>
<li>Accelerations: km/s</li>
<li>Time step: seconds</li>
</ul>

<p>This format is used for high-precision orbit determination where external
non-gravitational forces (solar pressure, atmospheric drag, etc.) need to
be accurately modeled.</p>

<p>Requires scipy.io.FortranFile for binary I/O operations.</p>
</div>


                </section>
                <section id="Embree3_init_geometry">
                            <input id="Embree3_init_geometry-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">Embree3_init_geometry</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">mesh_obj</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Embree3_init_geometry-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Embree3_init_geometry"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Embree3_init_geometry-801"><a href="#Embree3_init_geometry-801"><span class="linenos">801</span></a><span class="k">def</span> <span class="nf">Embree3_init_geometry</span><span class="p">(</span><span class="n">mesh_obj</span><span class="p">):</span>
</span><span id="Embree3_init_geometry-802"><a href="#Embree3_init_geometry-802"><span class="linenos">802</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embree3_init_geometry-803"><a href="#Embree3_init_geometry-803"><span class="linenos">803</span></a><span class="sd">    Initialize mesh geometry for ray tracing using the Embree 3 ray tracing kernel.</span>
</span><span id="Embree3_init_geometry-804"><a href="#Embree3_init_geometry-804"><span class="linenos">804</span></a><span class="sd">    </span>
</span><span id="Embree3_init_geometry-805"><a href="#Embree3_init_geometry-805"><span class="linenos">805</span></a><span class="sd">    Converts a trimesh mesh object into an EmbreeTrimeshShapeModel that can be</span>
</span><span id="Embree3_init_geometry-806"><a href="#Embree3_init_geometry-806"><span class="linenos">806</span></a><span class="sd">    efficiently ray-traced using Intel&#39;s Embree library. Precomputes surface</span>
</span><span id="Embree3_init_geometry-807"><a href="#Embree3_init_geometry-807"><span class="linenos">807</span></a><span class="sd">    normals and face areas for performance.</span>
</span><span id="Embree3_init_geometry-808"><a href="#Embree3_init_geometry-808"><span class="linenos">808</span></a><span class="sd">    </span>
</span><span id="Embree3_init_geometry-809"><a href="#Embree3_init_geometry-809"><span class="linenos">809</span></a><span class="sd">    Parameters</span>
</span><span id="Embree3_init_geometry-810"><a href="#Embree3_init_geometry-810"><span class="linenos">810</span></a><span class="sd">    ----------</span>
</span><span id="Embree3_init_geometry-811"><a href="#Embree3_init_geometry-811"><span class="linenos">811</span></a><span class="sd">    mesh_obj : trimesh.Trimesh</span>
</span><span id="Embree3_init_geometry-812"><a href="#Embree3_init_geometry-812"><span class="linenos">812</span></a><span class="sd">        Input mesh object containing vertices and faces. Must be a valid</span>
</span><span id="Embree3_init_geometry-813"><a href="#Embree3_init_geometry-813"><span class="linenos">813</span></a><span class="sd">        triangular mesh.</span>
</span><span id="Embree3_init_geometry-814"><a href="#Embree3_init_geometry-814"><span class="linenos">814</span></a><span class="sd">    </span>
</span><span id="Embree3_init_geometry-815"><a href="#Embree3_init_geometry-815"><span class="linenos">815</span></a><span class="sd">    Returns</span>
</span><span id="Embree3_init_geometry-816"><a href="#Embree3_init_geometry-816"><span class="linenos">816</span></a><span class="sd">    -------</span>
</span><span id="Embree3_init_geometry-817"><a href="#Embree3_init_geometry-817"><span class="linenos">817</span></a><span class="sd">    scene : EmbreeTrimeshShapeModel</span>
</span><span id="Embree3_init_geometry-818"><a href="#Embree3_init_geometry-818"><span class="linenos">818</span></a><span class="sd">        Shape model object containing:</span>
</span><span id="Embree3_init_geometry-819"><a href="#Embree3_init_geometry-819"><span class="linenos">819</span></a><span class="sd">        - V: vertex coordinates array</span>
</span><span id="Embree3_init_geometry-820"><a href="#Embree3_init_geometry-820"><span class="linenos">820</span></a><span class="sd">        - F: face index array</span>
</span><span id="Embree3_init_geometry-821"><a href="#Embree3_init_geometry-821"><span class="linenos">821</span></a><span class="sd">        - N: face normal vectors</span>
</span><span id="Embree3_init_geometry-822"><a href="#Embree3_init_geometry-822"><span class="linenos">822</span></a><span class="sd">        - A: face areas</span>
</span><span id="Embree3_init_geometry-823"><a href="#Embree3_init_geometry-823"><span class="linenos">823</span></a><span class="sd">        - scene: Embree scene object for ray tracing</span>
</span><span id="Embree3_init_geometry-824"><a href="#Embree3_init_geometry-824"><span class="linenos">824</span></a><span class="sd">    </span>
</span><span id="Embree3_init_geometry-825"><a href="#Embree3_init_geometry-825"><span class="linenos">825</span></a><span class="sd">    Notes</span>
</span><span id="Embree3_init_geometry-826"><a href="#Embree3_init_geometry-826"><span class="linenos">826</span></a><span class="sd">    -----</span>
</span><span id="Embree3_init_geometry-827"><a href="#Embree3_init_geometry-827"><span class="linenos">827</span></a><span class="sd">    This function performs initial geometry setup required by Embree:</span>
</span><span id="Embree3_init_geometry-828"><a href="#Embree3_init_geometry-828"><span class="linenos">828</span></a><span class="sd">    1. Extracts vertices (V) and faces (F) from mesh</span>
</span><span id="Embree3_init_geometry-829"><a href="#Embree3_init_geometry-829"><span class="linenos">829</span></a><span class="sd">    2. Computes face normals (N) and areas (A)</span>
</span><span id="Embree3_init_geometry-830"><a href="#Embree3_init_geometry-830"><span class="linenos">830</span></a><span class="sd">    3. Creates Embree device, geometry, and scene objects</span>
</span><span id="Embree3_init_geometry-831"><a href="#Embree3_init_geometry-831"><span class="linenos">831</span></a><span class="sd">    4. Loads vertex and index buffers into Embree</span>
</span><span id="Embree3_init_geometry-832"><a href="#Embree3_init_geometry-832"><span class="linenos">832</span></a><span class="sd">    </span>
</span><span id="Embree3_init_geometry-833"><a href="#Embree3_init_geometry-833"><span class="linenos">833</span></a><span class="sd">    The returned object can be used with Embree&#39;s ray intersection functions</span>
</span><span id="Embree3_init_geometry-834"><a href="#Embree3_init_geometry-834"><span class="linenos">834</span></a><span class="sd">    for high-performance ray tracing. Embree uses hardware-accelerated BVH</span>
</span><span id="Embree3_init_geometry-835"><a href="#Embree3_init_geometry-835"><span class="linenos">835</span></a><span class="sd">    (Bounding Volume Hierarchy) structures for fast ray-triangle intersections.</span>
</span><span id="Embree3_init_geometry-836"><a href="#Embree3_init_geometry-836"><span class="linenos">836</span></a><span class="sd">    </span>
</span><span id="Embree3_init_geometry-837"><a href="#Embree3_init_geometry-837"><span class="linenos">837</span></a><span class="sd">    NOTE: The Embree 3 wrapper functions were developed by Sam Potter</span>
</span><span id="Embree3_init_geometry-838"><a href="#Embree3_init_geometry-838"><span class="linenos">838</span></a><span class="sd">    (https://github.com/sampotter/python-embree)</span>
</span><span id="Embree3_init_geometry-839"><a href="#Embree3_init_geometry-839"><span class="linenos">839</span></a><span class="sd">    </span>
</span><span id="Embree3_init_geometry-840"><a href="#Embree3_init_geometry-840"><span class="linenos">840</span></a><span class="sd">    See Also</span>
</span><span id="Embree3_init_geometry-841"><a href="#Embree3_init_geometry-841"><span class="linenos">841</span></a><span class="sd">    --------</span>
</span><span id="Embree3_init_geometry-842"><a href="#Embree3_init_geometry-842"><span class="linenos">842</span></a><span class="sd">    EmbreeTrimeshShapeModel : The shape model class</span>
</span><span id="Embree3_init_geometry-843"><a href="#Embree3_init_geometry-843"><span class="linenos">843</span></a><span class="sd">    RTXkernel : Main ray tracing interface</span>
</span><span id="Embree3_init_geometry-844"><a href="#Embree3_init_geometry-844"><span class="linenos">844</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Embree3_init_geometry-845"><a href="#Embree3_init_geometry-845"><span class="linenos">845</span></a>    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh_obj</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="Embree3_init_geometry-846"><a href="#Embree3_init_geometry-846"><span class="linenos">846</span></a>    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh_obj</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="Embree3_init_geometry-847"><a href="#Embree3_init_geometry-847"><span class="linenos">847</span></a>
</span><span id="Embree3_init_geometry-848"><a href="#Embree3_init_geometry-848"><span class="linenos">848</span></a>    <span class="c1"># P = get_centroids(V, F)</span>
</span><span id="Embree3_init_geometry-849"><a href="#Embree3_init_geometry-849"><span class="linenos">849</span></a>    <span class="n">N</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">get_surface_normals_and_face_areas</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="Embree3_init_geometry-850"><a href="#Embree3_init_geometry-850"><span class="linenos">850</span></a>
</span><span id="Embree3_init_geometry-851"><a href="#Embree3_init_geometry-851"><span class="linenos">851</span></a>    <span class="k">return</span> <span class="n">EmbreeTrimeshShapeModel</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize mesh geometry for ray tracing using the Embree 3 ray tracing kernel.</p>

<p>Converts a trimesh mesh object into an EmbreeTrimeshShapeModel that can be
efficiently ray-traced using Intel's Embree library. Precomputes surface
normals and face areas for performance.</p>

<h2 id="parameters">Parameters</h2>

<p>mesh_obj : trimesh.Trimesh
    Input mesh object containing vertices and faces. Must be a valid
    triangular mesh.</p>

<h2 id="returns">Returns</h2>

<p>scene : EmbreeTrimeshShapeModel
    Shape model object containing:
    - V: vertex coordinates array
    - F: face index array
    - N: face normal vectors
    - A: face areas
    - scene: Embree scene object for ray tracing</p>

<h2 id="notes">Notes</h2>

<p>This function performs initial geometry setup required by Embree:</p>

<ol>
<li>Extracts vertices (V) and faces (F) from mesh</li>
<li>Computes face normals (N) and areas (A)</li>
<li>Creates Embree device, geometry, and scene objects</li>
<li>Loads vertex and index buffers into Embree</li>
</ol>

<p>The returned object can be used with Embree's ray intersection functions
for high-performance ray tracing. Embree uses hardware-accelerated BVH
(Bounding Volume Hierarchy) structures for fast ray-triangle intersections.</p>

<p>NOTE: The Embree 3 wrapper functions were developed by Sam Potter
(<a href="https://github.com/sampotter/python-embree">https://github.com/sampotter/python-embree</a>)</p>

<h2 id="see-also">See Also</h2>

<p>EmbreeTrimeshShapeModel : The shape model class
RTXkernel : Main ray tracing interface</p>
</div>


                </section>
                <section id="Embree3_init_rayhit">
                            <input id="Embree3_init_rayhit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">Embree3_init_rayhit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">ray_origins</span>, </span><span class="param"><span class="n">ray_directions</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Embree3_init_rayhit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Embree3_init_rayhit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Embree3_init_rayhit-854"><a href="#Embree3_init_rayhit-854"><span class="linenos">854</span></a><span class="k">def</span> <span class="nf">Embree3_init_rayhit</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">):</span>
</span><span id="Embree3_init_rayhit-855"><a href="#Embree3_init_rayhit-855"><span class="linenos">855</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embree3_init_rayhit-856"><a href="#Embree3_init_rayhit-856"><span class="linenos">856</span></a><span class="sd">    Initialize Embree 3 RayHit data structure for ray tracing queries.</span>
</span><span id="Embree3_init_rayhit-857"><a href="#Embree3_init_rayhit-857"><span class="linenos">857</span></a><span class="sd">    </span>
</span><span id="Embree3_init_rayhit-858"><a href="#Embree3_init_rayhit-858"><span class="linenos">858</span></a><span class="sd">    Creates and configures an Embree RayHit1M object that stores ray information</span>
</span><span id="Embree3_init_rayhit-859"><a href="#Embree3_init_rayhit-859"><span class="linenos">859</span></a><span class="sd">    (origins, directions, parameters) and will be populated with hit information</span>
</span><span id="Embree3_init_rayhit-860"><a href="#Embree3_init_rayhit-860"><span class="linenos">860</span></a><span class="sd">    (intersection distances, geometry IDs) by the ray tracer.</span>
</span><span id="Embree3_init_rayhit-861"><a href="#Embree3_init_rayhit-861"><span class="linenos">861</span></a><span class="sd">    </span>
</span><span id="Embree3_init_rayhit-862"><a href="#Embree3_init_rayhit-862"><span class="linenos">862</span></a><span class="sd">    Parameters</span>
</span><span id="Embree3_init_rayhit-863"><a href="#Embree3_init_rayhit-863"><span class="linenos">863</span></a><span class="sd">    ----------</span>
</span><span id="Embree3_init_rayhit-864"><a href="#Embree3_init_rayhit-864"><span class="linenos">864</span></a><span class="sd">    ray_origins : ndarray, shape (N, 3)</span>
</span><span id="Embree3_init_rayhit-865"><a href="#Embree3_init_rayhit-865"><span class="linenos">865</span></a><span class="sd">        Starting positions of rays in 3D space.</span>
</span><span id="Embree3_init_rayhit-866"><a href="#Embree3_init_rayhit-866"><span class="linenos">866</span></a><span class="sd">    ray_directions : ndarray, shape (N, 3)</span>
</span><span id="Embree3_init_rayhit-867"><a href="#Embree3_init_rayhit-867"><span class="linenos">867</span></a><span class="sd">        Direction vectors of rays (do not need to be normalized; Embree handles</span>
</span><span id="Embree3_init_rayhit-868"><a href="#Embree3_init_rayhit-868"><span class="linenos">868</span></a><span class="sd">        this internally).</span>
</span><span id="Embree3_init_rayhit-869"><a href="#Embree3_init_rayhit-869"><span class="linenos">869</span></a><span class="sd">    </span>
</span><span id="Embree3_init_rayhit-870"><a href="#Embree3_init_rayhit-870"><span class="linenos">870</span></a><span class="sd">    Returns</span>
</span><span id="Embree3_init_rayhit-871"><a href="#Embree3_init_rayhit-871"><span class="linenos">871</span></a><span class="sd">    -------</span>
</span><span id="Embree3_init_rayhit-872"><a href="#Embree3_init_rayhit-872"><span class="linenos">872</span></a><span class="sd">    rayhit : embree.RayHit1M</span>
</span><span id="Embree3_init_rayhit-873"><a href="#Embree3_init_rayhit-873"><span class="linenos">873</span></a><span class="sd">        Initialized RayHit structure containing:</span>
</span><span id="Embree3_init_rayhit-874"><a href="#Embree3_init_rayhit-874"><span class="linenos">874</span></a><span class="sd">        - org: ray origin coordinates (set from ray_origins)</span>
</span><span id="Embree3_init_rayhit-875"><a href="#Embree3_init_rayhit-875"><span class="linenos">875</span></a><span class="sd">        - dir: ray direction vectors (set from ray_directions)</span>
</span><span id="Embree3_init_rayhit-876"><a href="#Embree3_init_rayhit-876"><span class="linenos">876</span></a><span class="sd">        - tnear: minimum ray parameter (set to 0.0 to trace from origin)</span>
</span><span id="Embree3_init_rayhit-877"><a href="#Embree3_init_rayhit-877"><span class="linenos">877</span></a><span class="sd">        - tfar: maximum ray parameter (set to infinity for unbounded rays)</span>
</span><span id="Embree3_init_rayhit-878"><a href="#Embree3_init_rayhit-878"><span class="linenos">878</span></a><span class="sd">        - prim_id: primitive (triangle) ID (initialized to INVALID, filled by tracer)</span>
</span><span id="Embree3_init_rayhit-879"><a href="#Embree3_init_rayhit-879"><span class="linenos">879</span></a><span class="sd">        - geom_id: geometry ID (initialized to INVALID, filled by tracer)</span>
</span><span id="Embree3_init_rayhit-880"><a href="#Embree3_init_rayhit-880"><span class="linenos">880</span></a><span class="sd">    </span>
</span><span id="Embree3_init_rayhit-881"><a href="#Embree3_init_rayhit-881"><span class="linenos">881</span></a><span class="sd">    Notes</span>
</span><span id="Embree3_init_rayhit-882"><a href="#Embree3_init_rayhit-882"><span class="linenos">882</span></a><span class="sd">    -----</span>
</span><span id="Embree3_init_rayhit-883"><a href="#Embree3_init_rayhit-883"><span class="linenos">883</span></a><span class="sd">    The RayHit1M structure supports tracing multiple rays simultaneously (the &quot;1M&quot;</span>
</span><span id="Embree3_init_rayhit-884"><a href="#Embree3_init_rayhit-884"><span class="linenos">884</span></a><span class="sd">    indicates &quot;1 Million&quot; rays capability). After calling Embree&#39;s intersect</span>
</span><span id="Embree3_init_rayhit-885"><a href="#Embree3_init_rayhit-885"><span class="linenos">885</span></a><span class="sd">    function, the structure will contain:</span>
</span><span id="Embree3_init_rayhit-886"><a href="#Embree3_init_rayhit-886"><span class="linenos">886</span></a><span class="sd">    - Updated tnear/tfar values indicating intersection distances</span>
</span><span id="Embree3_init_rayhit-887"><a href="#Embree3_init_rayhit-887"><span class="linenos">887</span></a><span class="sd">    - prim_id: index of intersected triangle (-1 if no hit)</span>
</span><span id="Embree3_init_rayhit-888"><a href="#Embree3_init_rayhit-888"><span class="linenos">888</span></a><span class="sd">    - geom_id: geometry identifier (-1 if no hit)</span>
</span><span id="Embree3_init_rayhit-889"><a href="#Embree3_init_rayhit-889"><span class="linenos">889</span></a><span class="sd">    - uv: barycentric coordinates of intersection point within triangle</span>
</span><span id="Embree3_init_rayhit-890"><a href="#Embree3_init_rayhit-890"><span class="linenos">890</span></a><span class="sd">    </span>
</span><span id="Embree3_init_rayhit-891"><a href="#Embree3_init_rayhit-891"><span class="linenos">891</span></a><span class="sd">    The tnear parameter is set to 0.0 rather than a small epsilon to avoid</span>
</span><span id="Embree3_init_rayhit-892"><a href="#Embree3_init_rayhit-892"><span class="linenos">892</span></a><span class="sd">    missing intersections, but this may cause numerical issues with very close</span>
</span><span id="Embree3_init_rayhit-893"><a href="#Embree3_init_rayhit-893"><span class="linenos">893</span></a><span class="sd">    surfaces. Adjust if needed for specific applications.</span>
</span><span id="Embree3_init_rayhit-894"><a href="#Embree3_init_rayhit-894"><span class="linenos">894</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Embree3_init_rayhit-895"><a href="#Embree3_init_rayhit-895"><span class="linenos">895</span></a>    <span class="n">nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Number of tracked rays</span>
</span><span id="Embree3_init_rayhit-896"><a href="#Embree3_init_rayhit-896"><span class="linenos">896</span></a>    <span class="n">rayhit</span> <span class="o">=</span> <span class="n">embree</span><span class="o">.</span><span class="n">RayHit1M</span><span class="p">(</span><span class="n">nb</span><span class="p">)</span>
</span><span id="Embree3_init_rayhit-897"><a href="#Embree3_init_rayhit-897"><span class="linenos">897</span></a>
</span><span id="Embree3_init_rayhit-898"><a href="#Embree3_init_rayhit-898"><span class="linenos">898</span></a>    <span class="c1"># Initialize the ray structure</span>
</span><span id="Embree3_init_rayhit-899"><a href="#Embree3_init_rayhit-899"><span class="linenos">899</span></a>    <span class="c1"># rayhit.tnear[:] = 0.001 #Avoid numerical problems</span>
</span><span id="Embree3_init_rayhit-900"><a href="#Embree3_init_rayhit-900"><span class="linenos">900</span></a>    <span class="n">rayhit</span><span class="o">.</span><span class="n">tnear</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.00</span>  <span class="c1"># Avoid numerical problems</span>
</span><span id="Embree3_init_rayhit-901"><a href="#Embree3_init_rayhit-901"><span class="linenos">901</span></a>    <span class="n">rayhit</span><span class="o">.</span><span class="n">tfar</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
</span><span id="Embree3_init_rayhit-902"><a href="#Embree3_init_rayhit-902"><span class="linenos">902</span></a>    <span class="n">rayhit</span><span class="o">.</span><span class="n">prim_id</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">embree</span><span class="o">.</span><span class="n">INVALID_GEOMETRY_ID</span>
</span><span id="Embree3_init_rayhit-903"><a href="#Embree3_init_rayhit-903"><span class="linenos">903</span></a>    <span class="n">rayhit</span><span class="o">.</span><span class="n">geom_id</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">embree</span><span class="o">.</span><span class="n">INVALID_GEOMETRY_ID</span>
</span><span id="Embree3_init_rayhit-904"><a href="#Embree3_init_rayhit-904"><span class="linenos">904</span></a>    <span class="n">rayhit</span><span class="o">.</span><span class="n">org</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ray_origins</span>
</span><span id="Embree3_init_rayhit-905"><a href="#Embree3_init_rayhit-905"><span class="linenos">905</span></a>    <span class="n">rayhit</span><span class="o">.</span><span class="n">dir</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ray_directions</span>
</span><span id="Embree3_init_rayhit-906"><a href="#Embree3_init_rayhit-906"><span class="linenos">906</span></a>
</span><span id="Embree3_init_rayhit-907"><a href="#Embree3_init_rayhit-907"><span class="linenos">907</span></a>    <span class="k">return</span> <span class="n">rayhit</span>
</span></pre></div>


            <div class="docstring"><p>Initialize Embree 3 RayHit data structure for ray tracing queries.</p>

<p>Creates and configures an Embree RayHit1M object that stores ray information
(origins, directions, parameters) and will be populated with hit information
(intersection distances, geometry IDs) by the ray tracer.</p>

<h2 id="parameters">Parameters</h2>

<p>ray_origins : ndarray, shape (N, 3)
    Starting positions of rays in 3D space.
ray_directions : ndarray, shape (N, 3)
    Direction vectors of rays (do not need to be normalized; Embree handles
    this internally).</p>

<h2 id="returns">Returns</h2>

<p>rayhit : embree.RayHit1M
    Initialized RayHit structure containing:
    - org: ray origin coordinates (set from ray_origins)
    - dir: ray direction vectors (set from ray_directions)
    - tnear: minimum ray parameter (set to 0.0 to trace from origin)
    - tfar: maximum ray parameter (set to infinity for unbounded rays)
    - prim_id: primitive (triangle) ID (initialized to INVALID, filled by tracer)
    - geom_id: geometry ID (initialized to INVALID, filled by tracer)</p>

<h2 id="notes">Notes</h2>

<p>The RayHit1M structure supports tracing multiple rays simultaneously (the "1M"
indicates "1 Million" rays capability). After calling Embree's intersect
function, the structure will contain:</p>

<ul>
<li>Updated tnear/tfar values indicating intersection distances</li>
<li>prim_id: index of intersected triangle (-1 if no hit)</li>
<li>geom_id: geometry identifier (-1 if no hit)</li>
<li>uv: barycentric coordinates of intersection point within triangle</li>
</ul>

<p>The tnear parameter is set to 0.0 rather than a small epsilon to avoid
missing intersections, but this may cause numerical issues with very close
surfaces. Adjust if needed for specific applications.</p>
</div>


                </section>
                <section id="Embree3_dump_solution">
                            <input id="Embree3_dump_solution-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">Embree3_dump_solution</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">rayhit</span>, </span><span class="param"><span class="n">V</span>, </span><span class="param"><span class="n">F</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="Embree3_dump_solution-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Embree3_dump_solution"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Embree3_dump_solution-910"><a href="#Embree3_dump_solution-910"><span class="linenos">910</span></a><span class="k">def</span> <span class="nf">Embree3_dump_solution</span><span class="p">(</span><span class="n">rayhit</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
</span><span id="Embree3_dump_solution-911"><a href="#Embree3_dump_solution-911"><span class="linenos">911</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="Embree3_dump_solution-912"><a href="#Embree3_dump_solution-912"><span class="linenos">912</span></a><span class="sd">    Extract and process ray-surface intersection results from Embree RayHit structure.</span>
</span><span id="Embree3_dump_solution-913"><a href="#Embree3_dump_solution-913"><span class="linenos">913</span></a><span class="sd">    </span>
</span><span id="Embree3_dump_solution-914"><a href="#Embree3_dump_solution-914"><span class="linenos">914</span></a><span class="sd">    After Embree&#39;s ray tracing kernel completes, this function extracts the</span>
</span><span id="Embree3_dump_solution-915"><a href="#Embree3_dump_solution-915"><span class="linenos">915</span></a><span class="sd">    intersection data and converts it into standard numpy arrays. It computes</span>
</span><span id="Embree3_dump_solution-916"><a href="#Embree3_dump_solution-916"><span class="linenos">916</span></a><span class="sd">    actual 3D intersection point coordinates from barycentric coordinates.</span>
</span><span id="Embree3_dump_solution-917"><a href="#Embree3_dump_solution-917"><span class="linenos">917</span></a><span class="sd">    </span>
</span><span id="Embree3_dump_solution-918"><a href="#Embree3_dump_solution-918"><span class="linenos">918</span></a><span class="sd">    Parameters</span>
</span><span id="Embree3_dump_solution-919"><a href="#Embree3_dump_solution-919"><span class="linenos">919</span></a><span class="sd">    ----------</span>
</span><span id="Embree3_dump_solution-920"><a href="#Embree3_dump_solution-920"><span class="linenos">920</span></a><span class="sd">    rayhit : embree.RayHit1M</span>
</span><span id="Embree3_dump_solution-921"><a href="#Embree3_dump_solution-921"><span class="linenos">921</span></a><span class="sd">        RayHit structure populated by Embree&#39;s intersect function, containing</span>
</span><span id="Embree3_dump_solution-922"><a href="#Embree3_dump_solution-922"><span class="linenos">922</span></a><span class="sd">        primitive IDs, geometry IDs, barycentric coordinates, etc.</span>
</span><span id="Embree3_dump_solution-923"><a href="#Embree3_dump_solution-923"><span class="linenos">923</span></a><span class="sd">    V : ndarray, shape (N_vertices, 3)</span>
</span><span id="Embree3_dump_solution-924"><a href="#Embree3_dump_solution-924"><span class="linenos">924</span></a><span class="sd">        Vertex coordinates of the mesh.</span>
</span><span id="Embree3_dump_solution-925"><a href="#Embree3_dump_solution-925"><span class="linenos">925</span></a><span class="sd">    F : ndarray, shape (N_faces, 3)</span>
</span><span id="Embree3_dump_solution-926"><a href="#Embree3_dump_solution-926"><span class="linenos">926</span></a><span class="sd">        Face indices of the mesh (each row contains indices of 3 vertices</span>
</span><span id="Embree3_dump_solution-927"><a href="#Embree3_dump_solution-927"><span class="linenos">927</span></a><span class="sd">        forming a triangle).</span>
</span><span id="Embree3_dump_solution-928"><a href="#Embree3_dump_solution-928"><span class="linenos">928</span></a><span class="sd">    </span>
</span><span id="Embree3_dump_solution-929"><a href="#Embree3_dump_solution-929"><span class="linenos">929</span></a><span class="sd">    Returns</span>
</span><span id="Embree3_dump_solution-930"><a href="#Embree3_dump_solution-930"><span class="linenos">930</span></a><span class="sd">    -------</span>
</span><span id="Embree3_dump_solution-931"><a href="#Embree3_dump_solution-931"><span class="linenos">931</span></a><span class="sd">    hits : ndarray, shape (N_hits,) or int</span>
</span><span id="Embree3_dump_solution-932"><a href="#Embree3_dump_solution-932"><span class="linenos">932</span></a><span class="sd">        Indices of triangles that were intersected. Returns -1 if no hits.</span>
</span><span id="Embree3_dump_solution-933"><a href="#Embree3_dump_solution-933"><span class="linenos">933</span></a><span class="sd">    nhits : int</span>
</span><span id="Embree3_dump_solution-934"><a href="#Embree3_dump_solution-934"><span class="linenos">934</span></a><span class="sd">        Number of rays that intersected the mesh. Returns -1 if no hits.</span>
</span><span id="Embree3_dump_solution-935"><a href="#Embree3_dump_solution-935"><span class="linenos">935</span></a><span class="sd">    idh : ndarray, shape (N_hits,) or int</span>
</span><span id="Embree3_dump_solution-936"><a href="#Embree3_dump_solution-936"><span class="linenos">936</span></a><span class="sd">        Indices of rays that successfully hit the mesh (mapping from original</span>
</span><span id="Embree3_dump_solution-937"><a href="#Embree3_dump_solution-937"><span class="linenos">937</span></a><span class="sd">        ray array to hit subset). Returns -1 if no hits.</span>
</span><span id="Embree3_dump_solution-938"><a href="#Embree3_dump_solution-938"><span class="linenos">938</span></a><span class="sd">    Ph : ndarray, shape (N_hits, 3) or int</span>
</span><span id="Embree3_dump_solution-939"><a href="#Embree3_dump_solution-939"><span class="linenos">939</span></a><span class="sd">        3D coordinates of intersection points computed from barycentric</span>
</span><span id="Embree3_dump_solution-940"><a href="#Embree3_dump_solution-940"><span class="linenos">940</span></a><span class="sd">        coordinates. Returns -1 if no hits.</span>
</span><span id="Embree3_dump_solution-941"><a href="#Embree3_dump_solution-941"><span class="linenos">941</span></a><span class="sd">    </span>
</span><span id="Embree3_dump_solution-942"><a href="#Embree3_dump_solution-942"><span class="linenos">942</span></a><span class="sd">    Notes</span>
</span><span id="Embree3_dump_solution-943"><a href="#Embree3_dump_solution-943"><span class="linenos">943</span></a><span class="sd">    -----</span>
</span><span id="Embree3_dump_solution-944"><a href="#Embree3_dump_solution-944"><span class="linenos">944</span></a><span class="sd">    The function identifies valid hits by checking if prim_id != INVALID_GEOMETRY_ID.</span>
</span><span id="Embree3_dump_solution-945"><a href="#Embree3_dump_solution-945"><span class="linenos">945</span></a><span class="sd">    </span>
</span><span id="Embree3_dump_solution-946"><a href="#Embree3_dump_solution-946"><span class="linenos">946</span></a><span class="sd">    For valid hits, intersection points are computed using barycentric interpolation:</span>
</span><span id="Embree3_dump_solution-947"><a href="#Embree3_dump_solution-947"><span class="linenos">947</span></a><span class="sd">        Ph = v1 + (v2 - v1) * u + (v3 - v1) * v</span>
</span><span id="Embree3_dump_solution-948"><a href="#Embree3_dump_solution-948"><span class="linenos">948</span></a><span class="sd">    where:</span>
</span><span id="Embree3_dump_solution-949"><a href="#Embree3_dump_solution-949"><span class="linenos">949</span></a><span class="sd">    - v1, v2, v3 are the triangle vertices</span>
</span><span id="Embree3_dump_solution-950"><a href="#Embree3_dump_solution-950"><span class="linenos">950</span></a><span class="sd">    - u, v are barycentric coordinates from rayhit.uv</span>
</span><span id="Embree3_dump_solution-951"><a href="#Embree3_dump_solution-951"><span class="linenos">951</span></a><span class="sd">    - Ph is the 3D intersection point</span>
</span><span id="Embree3_dump_solution-952"><a href="#Embree3_dump_solution-952"><span class="linenos">952</span></a><span class="sd">    </span>
</span><span id="Embree3_dump_solution-953"><a href="#Embree3_dump_solution-953"><span class="linenos">953</span></a><span class="sd">    If no intersections occurred (nhits=0), all return values are -1 to indicate</span>
</span><span id="Embree3_dump_solution-954"><a href="#Embree3_dump_solution-954"><span class="linenos">954</span></a><span class="sd">    no valid data.</span>
</span><span id="Embree3_dump_solution-955"><a href="#Embree3_dump_solution-955"><span class="linenos">955</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Embree3_dump_solution-956"><a href="#Embree3_dump_solution-956"><span class="linenos">956</span></a>
</span><span id="Embree3_dump_solution-957"><a href="#Embree3_dump_solution-957"><span class="linenos">957</span></a>    <span class="n">ishit</span> <span class="o">=</span> <span class="n">rayhit</span><span class="o">.</span><span class="n">prim_id</span> <span class="o">!=</span> <span class="n">embree</span><span class="o">.</span><span class="n">INVALID_GEOMETRY_ID</span>
</span><span id="Embree3_dump_solution-958"><a href="#Embree3_dump_solution-958"><span class="linenos">958</span></a>    <span class="n">idh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">ishit</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="Embree3_dump_solution-959"><a href="#Embree3_dump_solution-959"><span class="linenos">959</span></a>    <span class="n">hits</span> <span class="o">=</span> <span class="n">rayhit</span><span class="o">.</span><span class="n">prim_id</span><span class="p">[</span><span class="n">idh</span><span class="p">]</span>
</span><span id="Embree3_dump_solution-960"><a href="#Embree3_dump_solution-960"><span class="linenos">960</span></a>    <span class="n">nhits</span> <span class="o">=</span> <span class="n">hits</span><span class="o">.</span><span class="n">size</span>
</span><span id="Embree3_dump_solution-961"><a href="#Embree3_dump_solution-961"><span class="linenos">961</span></a>
</span><span id="Embree3_dump_solution-962"><a href="#Embree3_dump_solution-962"><span class="linenos">962</span></a>    <span class="k">if</span> <span class="n">nhits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Embree3_dump_solution-963"><a href="#Embree3_dump_solution-963"><span class="linenos">963</span></a>        <span class="n">p</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="n">F</span><span class="p">[</span><span class="n">hits</span><span class="p">]]</span>
</span><span id="Embree3_dump_solution-964"><a href="#Embree3_dump_solution-964"><span class="linenos">964</span></a>        <span class="n">v1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Embree3_dump_solution-965"><a href="#Embree3_dump_solution-965"><span class="linenos">965</span></a>        <span class="n">v2</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="Embree3_dump_solution-966"><a href="#Embree3_dump_solution-966"><span class="linenos">966</span></a>        <span class="n">v3</span> <span class="o">=</span> <span class="n">p</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
</span><span id="Embree3_dump_solution-967"><a href="#Embree3_dump_solution-967"><span class="linenos">967</span></a>        <span class="n">u</span> <span class="o">=</span> <span class="n">rayhit</span><span class="o">.</span><span class="n">uv</span><span class="p">[</span><span class="n">idh</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="Embree3_dump_solution-968"><a href="#Embree3_dump_solution-968"><span class="linenos">968</span></a>        <span class="n">v</span> <span class="o">=</span> <span class="n">rayhit</span><span class="o">.</span><span class="n">uv</span><span class="p">[</span><span class="n">idh</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="Embree3_dump_solution-969"><a href="#Embree3_dump_solution-969"><span class="linenos">969</span></a>        <span class="n">Ph</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">+</span> <span class="p">(</span><span class="n">v2</span> <span class="o">-</span> <span class="n">v1</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">v3</span> <span class="o">-</span> <span class="n">v1</span><span class="p">)</span> <span class="o">*</span> <span class="n">v</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
</span><span id="Embree3_dump_solution-970"><a href="#Embree3_dump_solution-970"><span class="linenos">970</span></a>
</span><span id="Embree3_dump_solution-971"><a href="#Embree3_dump_solution-971"><span class="linenos">971</span></a>        <span class="k">return</span> <span class="n">hits</span><span class="p">,</span> <span class="n">nhits</span><span class="p">,</span> <span class="n">idh</span><span class="p">,</span> <span class="n">Ph</span>
</span><span id="Embree3_dump_solution-972"><a href="#Embree3_dump_solution-972"><span class="linenos">972</span></a>
</span><span id="Embree3_dump_solution-973"><a href="#Embree3_dump_solution-973"><span class="linenos">973</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="Embree3_dump_solution-974"><a href="#Embree3_dump_solution-974"><span class="linenos">974</span></a>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
</span></pre></div>


            <div class="docstring"><p>Extract and process ray-surface intersection results from Embree RayHit structure.</p>

<p>After Embree's ray tracing kernel completes, this function extracts the
intersection data and converts it into standard numpy arrays. It computes
actual 3D intersection point coordinates from barycentric coordinates.</p>

<h2 id="parameters">Parameters</h2>

<p>rayhit : embree.RayHit1M
    RayHit structure populated by Embree's intersect function, containing
    primitive IDs, geometry IDs, barycentric coordinates, etc.
V : ndarray, shape (N_vertices, 3)
    Vertex coordinates of the mesh.
F : ndarray, shape (N_faces, 3)
    Face indices of the mesh (each row contains indices of 3 vertices
    forming a triangle).</p>

<h2 id="returns">Returns</h2>

<p>hits : ndarray, shape (N_hits,) or int
    Indices of triangles that were intersected. Returns -1 if no hits.
nhits : int
    Number of rays that intersected the mesh. Returns -1 if no hits.
idh : ndarray, shape (N_hits,) or int
    Indices of rays that successfully hit the mesh (mapping from original
    ray array to hit subset). Returns -1 if no hits.
Ph : ndarray, shape (N_hits, 3) or int
    3D coordinates of intersection points computed from barycentric
    coordinates. Returns -1 if no hits.</p>

<h2 id="notes">Notes</h2>

<p>The function identifies valid hits by checking if prim_id != INVALID_GEOMETRY_ID.</p>

<p>For valid hits, intersection points are computed using barycentric interpolation:
    Ph = v1 + (v2 - v1) * u + (v3 - v1) * v
where:</p>

<ul>
<li>v1, v2, v3 are the triangle vertices</li>
<li>u, v are barycentric coordinates from rayhit.uv</li>
<li>Ph is the 3D intersection point</li>
</ul>

<p>If no intersections occurred (nhits=0), all return values are -1 to indicate
no valid data.</p>
</div>


                </section>
                <section id="cgal_init_geometry">
                            <input id="cgal_init_geometry-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">cgal_init_geometry</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">mesh_obj</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="cgal_init_geometry-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#cgal_init_geometry"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="cgal_init_geometry-979"><a href="#cgal_init_geometry-979"><span class="linenos"> 979</span></a><span class="k">def</span> <span class="nf">cgal_init_geometry</span><span class="p">(</span><span class="n">mesh_obj</span><span class="p">):</span>
</span><span id="cgal_init_geometry-980"><a href="#cgal_init_geometry-980"><span class="linenos"> 980</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="cgal_init_geometry-981"><a href="#cgal_init_geometry-981"><span class="linenos"> 981</span></a><span class="sd">    Initialize mesh geometry for ray tracing using the CGAL (Computational Geometry</span>
</span><span id="cgal_init_geometry-982"><a href="#cgal_init_geometry-982"><span class="linenos"> 982</span></a><span class="sd">    Algorithms Library) ray tracing kernel.</span>
</span><span id="cgal_init_geometry-983"><a href="#cgal_init_geometry-983"><span class="linenos"> 983</span></a><span class="sd">    </span>
</span><span id="cgal_init_geometry-984"><a href="#cgal_init_geometry-984"><span class="linenos"> 984</span></a><span class="sd">    Converts a trimesh mesh object into a CgalTrimeshShapeModel that uses CGAL&#39;s</span>
</span><span id="cgal_init_geometry-985"><a href="#cgal_init_geometry-985"><span class="linenos"> 985</span></a><span class="sd">    AABB (Axis-Aligned Bounding Box) tree for efficient ray-triangle intersections.</span>
</span><span id="cgal_init_geometry-986"><a href="#cgal_init_geometry-986"><span class="linenos"> 986</span></a><span class="sd">    </span>
</span><span id="cgal_init_geometry-987"><a href="#cgal_init_geometry-987"><span class="linenos"> 987</span></a><span class="sd">    Parameters</span>
</span><span id="cgal_init_geometry-988"><a href="#cgal_init_geometry-988"><span class="linenos"> 988</span></a><span class="sd">    ----------</span>
</span><span id="cgal_init_geometry-989"><a href="#cgal_init_geometry-989"><span class="linenos"> 989</span></a><span class="sd">    mesh_obj : trimesh.Trimesh</span>
</span><span id="cgal_init_geometry-990"><a href="#cgal_init_geometry-990"><span class="linenos"> 990</span></a><span class="sd">        Input mesh object containing vertices and faces.</span>
</span><span id="cgal_init_geometry-991"><a href="#cgal_init_geometry-991"><span class="linenos"> 991</span></a><span class="sd">    </span>
</span><span id="cgal_init_geometry-992"><a href="#cgal_init_geometry-992"><span class="linenos"> 992</span></a><span class="sd">    Returns</span>
</span><span id="cgal_init_geometry-993"><a href="#cgal_init_geometry-993"><span class="linenos"> 993</span></a><span class="sd">    -------</span>
</span><span id="cgal_init_geometry-994"><a href="#cgal_init_geometry-994"><span class="linenos"> 994</span></a><span class="sd">    CgalTrimeshShapeModel : shape model object</span>
</span><span id="cgal_init_geometry-995"><a href="#cgal_init_geometry-995"><span class="linenos"> 995</span></a><span class="sd">        Shape model configured for CGAL ray tracing, containing:</span>
</span><span id="cgal_init_geometry-996"><a href="#cgal_init_geometry-996"><span class="linenos"> 996</span></a><span class="sd">        - V: vertex coordinates</span>
</span><span id="cgal_init_geometry-997"><a href="#cgal_init_geometry-997"><span class="linenos"> 997</span></a><span class="sd">        - F: face indices</span>
</span><span id="cgal_init_geometry-998"><a href="#cgal_init_geometry-998"><span class="linenos"> 998</span></a><span class="sd">        - N: face normals</span>
</span><span id="cgal_init_geometry-999"><a href="#cgal_init_geometry-999"><span class="linenos"> 999</span></a><span class="sd">        - A: face areas</span>
</span><span id="cgal_init_geometry-1000"><a href="#cgal_init_geometry-1000"><span class="linenos">1000</span></a><span class="sd">        - aabb: CGAL AABB tree structure for fast queries</span>
</span><span id="cgal_init_geometry-1001"><a href="#cgal_init_geometry-1001"><span class="linenos">1001</span></a><span class="sd">    </span>
</span><span id="cgal_init_geometry-1002"><a href="#cgal_init_geometry-1002"><span class="linenos">1002</span></a><span class="sd">    Notes</span>
</span><span id="cgal_init_geometry-1003"><a href="#cgal_init_geometry-1003"><span class="linenos">1003</span></a><span class="sd">    -----</span>
</span><span id="cgal_init_geometry-1004"><a href="#cgal_init_geometry-1004"><span class="linenos">1004</span></a><span class="sd">    CGAL is a C++ library providing robust geometric algorithms. The AABB tree</span>
</span><span id="cgal_init_geometry-1005"><a href="#cgal_init_geometry-1005"><span class="linenos">1005</span></a><span class="sd">    structure enables efficient ray tracing through hierarchical spatial subdivision.</span>
</span><span id="cgal_init_geometry-1006"><a href="#cgal_init_geometry-1006"><span class="linenos">1006</span></a><span class="sd">    </span>
</span><span id="cgal_init_geometry-1007"><a href="#cgal_init_geometry-1007"><span class="linenos">1007</span></a><span class="sd">    This function is adapted from python-flux. CGAL may be more robust than</span>
</span><span id="cgal_init_geometry-1008"><a href="#cgal_init_geometry-1008"><span class="linenos">1008</span></a><span class="sd">    Embree for certain edge cases (nearly degenerate triangles, numerical precision</span>
</span><span id="cgal_init_geometry-1009"><a href="#cgal_init_geometry-1009"><span class="linenos">1009</span></a><span class="sd">    issues) but is typically slower for large numbers of rays.</span>
</span><span id="cgal_init_geometry-1010"><a href="#cgal_init_geometry-1010"><span class="linenos">1010</span></a><span class="sd">    </span>
</span><span id="cgal_init_geometry-1011"><a href="#cgal_init_geometry-1011"><span class="linenos">1011</span></a><span class="sd">    See Also</span>
</span><span id="cgal_init_geometry-1012"><a href="#cgal_init_geometry-1012"><span class="linenos">1012</span></a><span class="sd">    --------</span>
</span><span id="cgal_init_geometry-1013"><a href="#cgal_init_geometry-1013"><span class="linenos">1013</span></a><span class="sd">    CgalTrimeshShapeModel : The CGAL-based shape model class</span>
</span><span id="cgal_init_geometry-1014"><a href="#cgal_init_geometry-1014"><span class="linenos">1014</span></a><span class="sd">    RTXkernel : Main ray tracing interface that can use CGAL kernel</span>
</span><span id="cgal_init_geometry-1015"><a href="#cgal_init_geometry-1015"><span class="linenos">1015</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="cgal_init_geometry-1016"><a href="#cgal_init_geometry-1016"><span class="linenos">1016</span></a>    <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh_obj</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
</span><span id="cgal_init_geometry-1017"><a href="#cgal_init_geometry-1017"><span class="linenos">1017</span></a>    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh_obj</span><span class="o">.</span><span class="n">faces</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
</span><span id="cgal_init_geometry-1018"><a href="#cgal_init_geometry-1018"><span class="linenos">1018</span></a>
</span><span id="cgal_init_geometry-1019"><a href="#cgal_init_geometry-1019"><span class="linenos">1019</span></a>    <span class="n">N</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">get_surface_normals_and_face_areas</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="cgal_init_geometry-1020"><a href="#cgal_init_geometry-1020"><span class="linenos">1020</span></a>
</span><span id="cgal_init_geometry-1021"><a href="#cgal_init_geometry-1021"><span class="linenos">1021</span></a>    <span class="k">return</span> <span class="n">CgalTrimeshShapeModel</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize mesh geometry for ray tracing using the CGAL (Computational Geometry
Algorithms Library) ray tracing kernel.</p>

<p>Converts a trimesh mesh object into a CgalTrimeshShapeModel that uses CGAL's
AABB (Axis-Aligned Bounding Box) tree for efficient ray-triangle intersections.</p>

<h2 id="parameters">Parameters</h2>

<p>mesh_obj : trimesh.Trimesh
    Input mesh object containing vertices and faces.</p>

<h2 id="returns">Returns</h2>

<p>CgalTrimeshShapeModel : shape model object
    Shape model configured for CGAL ray tracing, containing:
    - V: vertex coordinates
    - F: face indices
    - N: face normals
    - A: face areas
    - aabb: CGAL AABB tree structure for fast queries</p>

<h2 id="notes">Notes</h2>

<p>CGAL is a C++ library providing robust geometric algorithms. The AABB tree
structure enables efficient ray tracing through hierarchical spatial subdivision.</p>

<p>This function is adapted from python-flux. CGAL may be more robust than
Embree for certain edge cases (nearly degenerate triangles, numerical precision
issues) but is typically slower for large numbers of rays.</p>

<h2 id="see-also">See Also</h2>

<p>CgalTrimeshShapeModel : The CGAL-based shape model class
RTXkernel : Main ray tracing interface that can use CGAL kernel</p>
</div>


                </section>
                <section id="get_centroids">
                            <input id="get_centroids-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_centroids</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">V</span>, </span><span class="param"><span class="n">F</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_centroids-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_centroids"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_centroids-1026"><a href="#get_centroids-1026"><span class="linenos">1026</span></a><span class="k">def</span> <span class="nf">get_centroids</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
</span><span id="get_centroids-1027"><a href="#get_centroids-1027"><span class="linenos">1027</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_centroids-1028"><a href="#get_centroids-1028"><span class="linenos">1028</span></a><span class="sd">    Compute the geometric centroids of all triangular faces in a mesh.</span>
</span><span id="get_centroids-1029"><a href="#get_centroids-1029"><span class="linenos">1029</span></a><span class="sd">    </span>
</span><span id="get_centroids-1030"><a href="#get_centroids-1030"><span class="linenos">1030</span></a><span class="sd">    The centroid of a triangle is the arithmetic mean of its three vertices,</span>
</span><span id="get_centroids-1031"><a href="#get_centroids-1031"><span class="linenos">1031</span></a><span class="sd">    representing the triangle&#39;s center of mass (assuming uniform density).</span>
</span><span id="get_centroids-1032"><a href="#get_centroids-1032"><span class="linenos">1032</span></a><span class="sd">    </span>
</span><span id="get_centroids-1033"><a href="#get_centroids-1033"><span class="linenos">1033</span></a><span class="sd">    Parameters</span>
</span><span id="get_centroids-1034"><a href="#get_centroids-1034"><span class="linenos">1034</span></a><span class="sd">    ----------</span>
</span><span id="get_centroids-1035"><a href="#get_centroids-1035"><span class="linenos">1035</span></a><span class="sd">    V : ndarray, shape (N_vertices, 3)</span>
</span><span id="get_centroids-1036"><a href="#get_centroids-1036"><span class="linenos">1036</span></a><span class="sd">        Vertex coordinates of the mesh.</span>
</span><span id="get_centroids-1037"><a href="#get_centroids-1037"><span class="linenos">1037</span></a><span class="sd">    F : ndarray, shape (N_faces, 3)</span>
</span><span id="get_centroids-1038"><a href="#get_centroids-1038"><span class="linenos">1038</span></a><span class="sd">        Face indices. Each row contains three vertex indices forming a triangle.</span>
</span><span id="get_centroids-1039"><a href="#get_centroids-1039"><span class="linenos">1039</span></a><span class="sd">    </span>
</span><span id="get_centroids-1040"><a href="#get_centroids-1040"><span class="linenos">1040</span></a><span class="sd">    Returns</span>
</span><span id="get_centroids-1041"><a href="#get_centroids-1041"><span class="linenos">1041</span></a><span class="sd">    -------</span>
</span><span id="get_centroids-1042"><a href="#get_centroids-1042"><span class="linenos">1042</span></a><span class="sd">    P : ndarray, shape (N_faces, 3)</span>
</span><span id="get_centroids-1043"><a href="#get_centroids-1043"><span class="linenos">1043</span></a><span class="sd">        Centroid coordinates for each face. P[i] = (V[F[i][0]] + V[F[i][1]] +</span>
</span><span id="get_centroids-1044"><a href="#get_centroids-1044"><span class="linenos">1044</span></a><span class="sd">        V[F[i][2]]) / 3</span>
</span><span id="get_centroids-1045"><a href="#get_centroids-1045"><span class="linenos">1045</span></a><span class="sd">    </span>
</span><span id="get_centroids-1046"><a href="#get_centroids-1046"><span class="linenos">1046</span></a><span class="sd">    Notes</span>
</span><span id="get_centroids-1047"><a href="#get_centroids-1047"><span class="linenos">1047</span></a><span class="sd">    -----</span>
</span><span id="get_centroids-1048"><a href="#get_centroids-1048"><span class="linenos">1048</span></a><span class="sd">    Uses vectorized numpy operations: V[F] creates shape (N_faces, 3, 3) array</span>
</span><span id="get_centroids-1049"><a href="#get_centroids-1049"><span class="linenos">1049</span></a><span class="sd">    where V[F][i] is the 33 matrix of vertices for face i. Taking mean along</span>
</span><span id="get_centroids-1050"><a href="#get_centroids-1050"><span class="linenos">1050</span></a><span class="sd">    axis=1 computes centroids efficiently for all faces simultaneously.</span>
</span><span id="get_centroids-1051"><a href="#get_centroids-1051"><span class="linenos">1051</span></a>
</span><span id="get_centroids-1052"><a href="#get_centroids-1052"><span class="linenos">1052</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_centroids-1053"><a href="#get_centroids-1053"><span class="linenos">1053</span></a>
</span><span id="get_centroids-1054"><a href="#get_centroids-1054"><span class="linenos">1054</span></a>    <span class="k">return</span> <span class="n">V</span><span class="p">[</span><span class="n">F</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Compute the geometric centroids of all triangular faces in a mesh.</p>

<p>The centroid of a triangle is the arithmetic mean of its three vertices,
representing the triangle's center of mass (assuming uniform density).</p>

<h2 id="parameters">Parameters</h2>

<p>V : ndarray, shape (N_vertices, 3)
    Vertex coordinates of the mesh.
F : ndarray, shape (N_faces, 3)
    Face indices. Each row contains three vertex indices forming a triangle.</p>

<h2 id="returns">Returns</h2>

<p>P : ndarray, shape (N_faces, 3)
    Centroid coordinates for each face. P[i] = (V[F[i][0]] + V[F[i][1]] +
    V[F[i][2]]) / 3</p>

<h2 id="notes">Notes</h2>

<p>Uses vectorized numpy operations: V[F] creates shape (N_faces, 3, 3) array
where V[F][i] is the 33 matrix of vertices for face i. Taking mean along
axis=1 computes centroids efficiently for all faces simultaneously.</p>
</div>


                </section>
                <section id="get_cross_products">
                            <input id="get_cross_products-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_cross_products</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">V</span>, </span><span class="param"><span class="n">F</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_cross_products-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_cross_products"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_cross_products-1057"><a href="#get_cross_products-1057"><span class="linenos">1057</span></a><span class="k">def</span> <span class="nf">get_cross_products</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
</span><span id="get_cross_products-1058"><a href="#get_cross_products-1058"><span class="linenos">1058</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_cross_products-1059"><a href="#get_cross_products-1059"><span class="linenos">1059</span></a><span class="sd">    Compute cross products of edge vectors for all triangular faces in a mesh.</span>
</span><span id="get_cross_products-1060"><a href="#get_cross_products-1060"><span class="linenos">1060</span></a><span class="sd">    </span>
</span><span id="get_cross_products-1061"><a href="#get_cross_products-1061"><span class="linenos">1061</span></a><span class="sd">    For each triangle, computes the cross product of two edge vectors. The</span>
</span><span id="get_cross_products-1062"><a href="#get_cross_products-1062"><span class="linenos">1062</span></a><span class="sd">    magnitude of this cross product equals twice the triangle&#39;s area, and its</span>
</span><span id="get_cross_products-1063"><a href="#get_cross_products-1063"><span class="linenos">1063</span></a><span class="sd">    direction is perpendicular to the triangle plane (unnormalized normal).</span>
</span><span id="get_cross_products-1064"><a href="#get_cross_products-1064"><span class="linenos">1064</span></a><span class="sd">    </span>
</span><span id="get_cross_products-1065"><a href="#get_cross_products-1065"><span class="linenos">1065</span></a><span class="sd">    Parameters</span>
</span><span id="get_cross_products-1066"><a href="#get_cross_products-1066"><span class="linenos">1066</span></a><span class="sd">    ----------</span>
</span><span id="get_cross_products-1067"><a href="#get_cross_products-1067"><span class="linenos">1067</span></a><span class="sd">    V : ndarray, shape (N_vertices, 3)</span>
</span><span id="get_cross_products-1068"><a href="#get_cross_products-1068"><span class="linenos">1068</span></a><span class="sd">        Vertex coordinates of the mesh.</span>
</span><span id="get_cross_products-1069"><a href="#get_cross_products-1069"><span class="linenos">1069</span></a><span class="sd">    F : ndarray, shape (N_faces, 3)</span>
</span><span id="get_cross_products-1070"><a href="#get_cross_products-1070"><span class="linenos">1070</span></a><span class="sd">        Face indices. Each row contains three vertex indices [v0, v1, v2].</span>
</span><span id="get_cross_products-1071"><a href="#get_cross_products-1071"><span class="linenos">1071</span></a><span class="sd">    </span>
</span><span id="get_cross_products-1072"><a href="#get_cross_products-1072"><span class="linenos">1072</span></a><span class="sd">    Returns</span>
</span><span id="get_cross_products-1073"><a href="#get_cross_products-1073"><span class="linenos">1073</span></a><span class="sd">    -------</span>
</span><span id="get_cross_products-1074"><a href="#get_cross_products-1074"><span class="linenos">1074</span></a><span class="sd">    C : ndarray, shape (N_faces, 3)</span>
</span><span id="get_cross_products-1075"><a href="#get_cross_products-1075"><span class="linenos">1075</span></a><span class="sd">        Cross product vectors for each face. C[i] = (v1 - v0)  (v2 - v0)</span>
</span><span id="get_cross_products-1076"><a href="#get_cross_products-1076"><span class="linenos">1076</span></a><span class="sd">        where v0, v1, v2 are the vertices of triangle i.</span>
</span><span id="get_cross_products-1077"><a href="#get_cross_products-1077"><span class="linenos">1077</span></a><span class="sd">    </span>
</span><span id="get_cross_products-1078"><a href="#get_cross_products-1078"><span class="linenos">1078</span></a><span class="sd">    Notes</span>
</span><span id="get_cross_products-1079"><a href="#get_cross_products-1079"><span class="linenos">1079</span></a><span class="sd">    -----</span>
</span><span id="get_cross_products-1080"><a href="#get_cross_products-1080"><span class="linenos">1080</span></a><span class="sd">    Used internally by get_face_areas and get_surface_normals for efficient</span>
</span><span id="get_cross_products-1081"><a href="#get_cross_products-1081"><span class="linenos">1081</span></a><span class="sd">    vectorized computation of geometric properties.</span>
</span><span id="get_cross_products-1082"><a href="#get_cross_products-1082"><span class="linenos">1082</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_cross_products-1083"><a href="#get_cross_products-1083"><span class="linenos">1083</span></a>    <span class="n">V0</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="n">F</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
</span><span id="get_cross_products-1084"><a href="#get_cross_products-1084"><span class="linenos">1084</span></a>    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="n">F</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">V0</span><span class="p">,</span> <span class="n">V</span><span class="p">[</span><span class="n">F</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">V0</span><span class="p">)</span>
</span><span id="get_cross_products-1085"><a href="#get_cross_products-1085"><span class="linenos">1085</span></a>    <span class="k">return</span> <span class="n">C</span>
</span></pre></div>


            <div class="docstring"><p>Compute cross products of edge vectors for all triangular faces in a mesh.</p>

<p>For each triangle, computes the cross product of two edge vectors. The
magnitude of this cross product equals twice the triangle's area, and its
direction is perpendicular to the triangle plane (unnormalized normal).</p>

<h2 id="parameters">Parameters</h2>

<p>V : ndarray, shape (N_vertices, 3)
    Vertex coordinates of the mesh.
F : ndarray, shape (N_faces, 3)
    Face indices. Each row contains three vertex indices [v0, v1, v2].</p>

<h2 id="returns">Returns</h2>

<p>C : ndarray, shape (N_faces, 3)
    Cross product vectors for each face. C[i] = (v1 - v0)  (v2 - v0)
    where v0, v1, v2 are the vertices of triangle i.</p>

<h2 id="notes">Notes</h2>

<p>Used internally by get_face_areas and get_surface_normals for efficient
vectorized computation of geometric properties.</p>
</div>


                </section>
                <section id="get_face_areas">
                            <input id="get_face_areas-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_face_areas</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">V</span>, </span><span class="param"><span class="n">F</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_face_areas-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_face_areas"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_face_areas-1088"><a href="#get_face_areas-1088"><span class="linenos">1088</span></a><span class="k">def</span> <span class="nf">get_face_areas</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
</span><span id="get_face_areas-1089"><a href="#get_face_areas-1089"><span class="linenos">1089</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_face_areas-1090"><a href="#get_face_areas-1090"><span class="linenos">1090</span></a><span class="sd">    Compute the areas of all triangular faces in a mesh.</span>
</span><span id="get_face_areas-1091"><a href="#get_face_areas-1091"><span class="linenos">1091</span></a><span class="sd">    </span>
</span><span id="get_face_areas-1092"><a href="#get_face_areas-1092"><span class="linenos">1092</span></a><span class="sd">    Parameters</span>
</span><span id="get_face_areas-1093"><a href="#get_face_areas-1093"><span class="linenos">1093</span></a><span class="sd">    ----------</span>
</span><span id="get_face_areas-1094"><a href="#get_face_areas-1094"><span class="linenos">1094</span></a><span class="sd">    V : ndarray, shape (N_vertices, 3)</span>
</span><span id="get_face_areas-1095"><a href="#get_face_areas-1095"><span class="linenos">1095</span></a><span class="sd">        Vertex coordinates of the mesh.</span>
</span><span id="get_face_areas-1096"><a href="#get_face_areas-1096"><span class="linenos">1096</span></a><span class="sd">    F : ndarray, shape (N_faces, 3)</span>
</span><span id="get_face_areas-1097"><a href="#get_face_areas-1097"><span class="linenos">1097</span></a><span class="sd">        Face indices.</span>
</span><span id="get_face_areas-1098"><a href="#get_face_areas-1098"><span class="linenos">1098</span></a><span class="sd">    </span>
</span><span id="get_face_areas-1099"><a href="#get_face_areas-1099"><span class="linenos">1099</span></a><span class="sd">    Returns</span>
</span><span id="get_face_areas-1100"><a href="#get_face_areas-1100"><span class="linenos">1100</span></a><span class="sd">    -------</span>
</span><span id="get_face_areas-1101"><a href="#get_face_areas-1101"><span class="linenos">1101</span></a><span class="sd">    A : ndarray, shape (N_faces,)</span>
</span><span id="get_face_areas-1102"><a href="#get_face_areas-1102"><span class="linenos">1102</span></a><span class="sd">        Area of each face in the same units as V (e.g., if V is in meters,</span>
</span><span id="get_face_areas-1103"><a href="#get_face_areas-1103"><span class="linenos">1103</span></a><span class="sd">        areas are in square meters).</span>
</span><span id="get_face_areas-1104"><a href="#get_face_areas-1104"><span class="linenos">1104</span></a><span class="sd">    </span>
</span><span id="get_face_areas-1105"><a href="#get_face_areas-1105"><span class="linenos">1105</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_face_areas-1106"><a href="#get_face_areas-1106"><span class="linenos">1106</span></a>
</span><span id="get_face_areas-1107"><a href="#get_face_areas-1107"><span class="linenos">1107</span></a>    <span class="n">C</span> <span class="o">=</span> <span class="n">get_cross_products</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="get_face_areas-1108"><a href="#get_face_areas-1108"><span class="linenos">1108</span></a>    <span class="n">C_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="get_face_areas-1109"><a href="#get_face_areas-1109"><span class="linenos">1109</span></a>    <span class="n">A</span> <span class="o">=</span> <span class="n">C_norms</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="get_face_areas-1110"><a href="#get_face_areas-1110"><span class="linenos">1110</span></a>    <span class="k">return</span> <span class="n">A</span>
</span></pre></div>


            <div class="docstring"><p>Compute the areas of all triangular faces in a mesh.</p>

<h2 id="parameters">Parameters</h2>

<p>V : ndarray, shape (N_vertices, 3)
    Vertex coordinates of the mesh.
F : ndarray, shape (N_faces, 3)
    Face indices.</p>

<h2 id="returns">Returns</h2>

<p>A : ndarray, shape (N_faces,)
    Area of each face in the same units as V (e.g., if V is in meters,
    areas are in square meters).</p>
</div>


                </section>
                <section id="get_surface_normals">
                            <input id="get_surface_normals-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_surface_normals</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">V</span>, </span><span class="param"><span class="n">F</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_surface_normals-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_surface_normals"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_surface_normals-1113"><a href="#get_surface_normals-1113"><span class="linenos">1113</span></a><span class="k">def</span> <span class="nf">get_surface_normals</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
</span><span id="get_surface_normals-1114"><a href="#get_surface_normals-1114"><span class="linenos">1114</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_surface_normals-1115"><a href="#get_surface_normals-1115"><span class="linenos">1115</span></a><span class="sd">    Compute outward-pointing unit normal vectors for all triangular faces.</span>
</span><span id="get_surface_normals-1116"><a href="#get_surface_normals-1116"><span class="linenos">1116</span></a><span class="sd">    </span>
</span><span id="get_surface_normals-1117"><a href="#get_surface_normals-1117"><span class="linenos">1117</span></a><span class="sd">    Parameters</span>
</span><span id="get_surface_normals-1118"><a href="#get_surface_normals-1118"><span class="linenos">1118</span></a><span class="sd">    ----------</span>
</span><span id="get_surface_normals-1119"><a href="#get_surface_normals-1119"><span class="linenos">1119</span></a><span class="sd">    V : ndarray, shape (N_vertices, 3)</span>
</span><span id="get_surface_normals-1120"><a href="#get_surface_normals-1120"><span class="linenos">1120</span></a><span class="sd">        Vertex coordinates of the mesh.</span>
</span><span id="get_surface_normals-1121"><a href="#get_surface_normals-1121"><span class="linenos">1121</span></a><span class="sd">    F : ndarray, shape (N_faces, 3)</span>
</span><span id="get_surface_normals-1122"><a href="#get_surface_normals-1122"><span class="linenos">1122</span></a><span class="sd">        Face indices.</span>
</span><span id="get_surface_normals-1123"><a href="#get_surface_normals-1123"><span class="linenos">1123</span></a><span class="sd">    </span>
</span><span id="get_surface_normals-1124"><a href="#get_surface_normals-1124"><span class="linenos">1124</span></a><span class="sd">    Returns</span>
</span><span id="get_surface_normals-1125"><a href="#get_surface_normals-1125"><span class="linenos">1125</span></a><span class="sd">    -------</span>
</span><span id="get_surface_normals-1126"><a href="#get_surface_normals-1126"><span class="linenos">1126</span></a><span class="sd">    N : ndarray, shape (N_faces, 3)</span>
</span><span id="get_surface_normals-1127"><a href="#get_surface_normals-1127"><span class="linenos">1127</span></a><span class="sd">        Unit normal vectors perpendicular to each face. Direction follows</span>
</span><span id="get_surface_normals-1128"><a href="#get_surface_normals-1128"><span class="linenos">1128</span></a><span class="sd">        right-hand rule with respect to vertex ordering in F.</span>
</span><span id="get_surface_normals-1129"><a href="#get_surface_normals-1129"><span class="linenos">1129</span></a><span class="sd">    </span>
</span><span id="get_surface_normals-1130"><a href="#get_surface_normals-1130"><span class="linenos">1130</span></a>
</span><span id="get_surface_normals-1131"><a href="#get_surface_normals-1131"><span class="linenos">1131</span></a><span class="sd"> </span>
</span><span id="get_surface_normals-1132"><a href="#get_surface_normals-1132"><span class="linenos">1132</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_surface_normals-1133"><a href="#get_surface_normals-1133"><span class="linenos">1133</span></a>
</span><span id="get_surface_normals-1134"><a href="#get_surface_normals-1134"><span class="linenos">1134</span></a>    <span class="n">C</span> <span class="o">=</span> <span class="n">get_cross_products</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="get_surface_normals-1135"><a href="#get_surface_normals-1135"><span class="linenos">1135</span></a>    <span class="n">C_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="get_surface_normals-1136"><a href="#get_surface_normals-1136"><span class="linenos">1136</span></a>    <span class="n">N</span> <span class="o">=</span> <span class="n">C</span> <span class="o">/</span> <span class="n">C_norms</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="get_surface_normals-1137"><a href="#get_surface_normals-1137"><span class="linenos">1137</span></a>    <span class="k">return</span> <span class="n">N</span>
</span></pre></div>


            <div class="docstring"><p>Compute outward-pointing unit normal vectors for all triangular faces.</p>

<h2 id="parameters">Parameters</h2>

<p>V : ndarray, shape (N_vertices, 3)
    Vertex coordinates of the mesh.
F : ndarray, shape (N_faces, 3)
    Face indices.</p>

<h2 id="returns">Returns</h2>

<p>N : ndarray, shape (N_faces, 3)
    Unit normal vectors perpendicular to each face. Direction follows
    right-hand rule with respect to vertex ordering in F.</p>
</div>


                </section>
                <section id="get_surface_normals_and_face_areas">
                            <input id="get_surface_normals_and_face_areas-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_surface_normals_and_face_areas</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">V</span>, </span><span class="param"><span class="n">F</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_surface_normals_and_face_areas-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_surface_normals_and_face_areas"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_surface_normals_and_face_areas-1140"><a href="#get_surface_normals_and_face_areas-1140"><span class="linenos">1140</span></a><span class="k">def</span> <span class="nf">get_surface_normals_and_face_areas</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">):</span>
</span><span id="get_surface_normals_and_face_areas-1141"><a href="#get_surface_normals_and_face_areas-1141"><span class="linenos">1141</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_surface_normals_and_face_areas-1142"><a href="#get_surface_normals_and_face_areas-1142"><span class="linenos">1142</span></a><span class="sd">    Efficiently compute both surface normals and face areas simultaneously.</span>
</span><span id="get_surface_normals_and_face_areas-1143"><a href="#get_surface_normals_and_face_areas-1143"><span class="linenos">1143</span></a><span class="sd">    </span>
</span><span id="get_surface_normals_and_face_areas-1144"><a href="#get_surface_normals_and_face_areas-1144"><span class="linenos">1144</span></a><span class="sd">    This is more efficient than calling get_surface_normals and get_face_areas</span>
</span><span id="get_surface_normals_and_face_areas-1145"><a href="#get_surface_normals_and_face_areas-1145"><span class="linenos">1145</span></a><span class="sd">    separately because it computes the cross products only once.</span>
</span><span id="get_surface_normals_and_face_areas-1146"><a href="#get_surface_normals_and_face_areas-1146"><span class="linenos">1146</span></a><span class="sd">    </span>
</span><span id="get_surface_normals_and_face_areas-1147"><a href="#get_surface_normals_and_face_areas-1147"><span class="linenos">1147</span></a><span class="sd">    Parameters</span>
</span><span id="get_surface_normals_and_face_areas-1148"><a href="#get_surface_normals_and_face_areas-1148"><span class="linenos">1148</span></a><span class="sd">    ----------</span>
</span><span id="get_surface_normals_and_face_areas-1149"><a href="#get_surface_normals_and_face_areas-1149"><span class="linenos">1149</span></a><span class="sd">    V : ndarray, shape (N_vertices, 3)</span>
</span><span id="get_surface_normals_and_face_areas-1150"><a href="#get_surface_normals_and_face_areas-1150"><span class="linenos">1150</span></a><span class="sd">        Vertex coordinates of the mesh.</span>
</span><span id="get_surface_normals_and_face_areas-1151"><a href="#get_surface_normals_and_face_areas-1151"><span class="linenos">1151</span></a><span class="sd">    F : ndarray, shape (N_faces, 3)</span>
</span><span id="get_surface_normals_and_face_areas-1152"><a href="#get_surface_normals_and_face_areas-1152"><span class="linenos">1152</span></a><span class="sd">        Face indices.</span>
</span><span id="get_surface_normals_and_face_areas-1153"><a href="#get_surface_normals_and_face_areas-1153"><span class="linenos">1153</span></a><span class="sd">    </span>
</span><span id="get_surface_normals_and_face_areas-1154"><a href="#get_surface_normals_and_face_areas-1154"><span class="linenos">1154</span></a><span class="sd">    Returns</span>
</span><span id="get_surface_normals_and_face_areas-1155"><a href="#get_surface_normals_and_face_areas-1155"><span class="linenos">1155</span></a><span class="sd">    -------</span>
</span><span id="get_surface_normals_and_face_areas-1156"><a href="#get_surface_normals_and_face_areas-1156"><span class="linenos">1156</span></a><span class="sd">    N : ndarray, shape (N_faces, 3)</span>
</span><span id="get_surface_normals_and_face_areas-1157"><a href="#get_surface_normals_and_face_areas-1157"><span class="linenos">1157</span></a><span class="sd">        Unit normal vectors for each face.</span>
</span><span id="get_surface_normals_and_face_areas-1158"><a href="#get_surface_normals_and_face_areas-1158"><span class="linenos">1158</span></a><span class="sd">    A : ndarray, shape (N_faces,)</span>
</span><span id="get_surface_normals_and_face_areas-1159"><a href="#get_surface_normals_and_face_areas-1159"><span class="linenos">1159</span></a><span class="sd">        Area of each face.</span>
</span><span id="get_surface_normals_and_face_areas-1160"><a href="#get_surface_normals_and_face_areas-1160"><span class="linenos">1160</span></a><span class="sd">    </span>
</span><span id="get_surface_normals_and_face_areas-1161"><a href="#get_surface_normals_and_face_areas-1161"><span class="linenos">1161</span></a><span class="sd">    Notes</span>
</span><span id="get_surface_normals_and_face_areas-1162"><a href="#get_surface_normals_and_face_areas-1162"><span class="linenos">1162</span></a><span class="sd">    -----</span>
</span><span id="get_surface_normals_and_face_areas-1163"><a href="#get_surface_normals_and_face_areas-1163"><span class="linenos">1163</span></a><span class="sd">    Computation steps:</span>
</span><span id="get_surface_normals_and_face_areas-1164"><a href="#get_surface_normals_and_face_areas-1164"><span class="linenos">1164</span></a><span class="sd">    1. Compute cross products C = (v1 - v0)  (v2 - v0)</span>
</span><span id="get_surface_normals_and_face_areas-1165"><a href="#get_surface_normals_and_face_areas-1165"><span class="linenos">1165</span></a><span class="sd">    2. Compute magnitudes ||C||</span>
</span><span id="get_surface_normals_and_face_areas-1166"><a href="#get_surface_normals_and_face_areas-1166"><span class="linenos">1166</span></a><span class="sd">    3. Normals: N = C / ||C||</span>
</span><span id="get_surface_normals_and_face_areas-1167"><a href="#get_surface_normals_and_face_areas-1167"><span class="linenos">1167</span></a><span class="sd">    4. Areas: A = ||C|| / 2</span>
</span><span id="get_surface_normals_and_face_areas-1168"><a href="#get_surface_normals_and_face_areas-1168"><span class="linenos">1168</span></a><span class="sd">    </span>
</span><span id="get_surface_normals_and_face_areas-1169"><a href="#get_surface_normals_and_face_areas-1169"><span class="linenos">1169</span></a><span class="sd">    This is the recommended function when both quantities are needed, as it</span>
</span><span id="get_surface_normals_and_face_areas-1170"><a href="#get_surface_normals_and_face_areas-1170"><span class="linenos">1170</span></a><span class="sd">    avoids redundant cross product calculations.</span>
</span><span id="get_surface_normals_and_face_areas-1171"><a href="#get_surface_normals_and_face_areas-1171"><span class="linenos">1171</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_surface_normals_and_face_areas-1172"><a href="#get_surface_normals_and_face_areas-1172"><span class="linenos">1172</span></a>    <span class="n">C</span> <span class="o">=</span> <span class="n">get_cross_products</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="get_surface_normals_and_face_areas-1173"><a href="#get_surface_normals_and_face_areas-1173"><span class="linenos">1173</span></a>    <span class="n">C_norms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">C</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</span><span id="get_surface_normals_and_face_areas-1174"><a href="#get_surface_normals_and_face_areas-1174"><span class="linenos">1174</span></a>    <span class="n">N</span> <span class="o">=</span> <span class="n">C</span> <span class="o">/</span> <span class="n">C_norms</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="get_surface_normals_and_face_areas-1175"><a href="#get_surface_normals_and_face_areas-1175"><span class="linenos">1175</span></a>    <span class="n">A</span> <span class="o">=</span> <span class="n">C_norms</span> <span class="o">/</span> <span class="mi">2</span>
</span><span id="get_surface_normals_and_face_areas-1176"><a href="#get_surface_normals_and_face_areas-1176"><span class="linenos">1176</span></a>    <span class="k">return</span> <span class="n">N</span><span class="p">,</span> <span class="n">A</span>
</span></pre></div>


            <div class="docstring"><p>Efficiently compute both surface normals and face areas simultaneously.</p>

<p>This is more efficient than calling get_surface_normals and get_face_areas
separately because it computes the cross products only once.</p>

<h2 id="parameters">Parameters</h2>

<p>V : ndarray, shape (N_vertices, 3)
    Vertex coordinates of the mesh.
F : ndarray, shape (N_faces, 3)
    Face indices.</p>

<h2 id="returns">Returns</h2>

<p>N : ndarray, shape (N_faces, 3)
    Unit normal vectors for each face.
A : ndarray, shape (N_faces,)
    Area of each face.</p>

<h2 id="notes">Notes</h2>

<p>Computation steps:</p>

<ol>
<li>Compute cross products C = (v1 - v0)  (v2 - v0)</li>
<li>Compute magnitudes ||C||</li>
<li>Normals: N = C / ||C||</li>
<li>Areas: A = ||C|| / 2</li>
</ol>

<p>This is the recommended function when both quantities are needed, as it
avoids redundant cross product calculations.</p>
</div>


                </section>
                <section id="ShapeModel">
                            <input id="ShapeModel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ShapeModel</span><wbr>(<span class="base">abc.ABC</span>):

                <label class="view-source-button" for="ShapeModel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ShapeModel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ShapeModel-1179"><a href="#ShapeModel-1179"><span class="linenos">1179</span></a><span class="k">class</span> <span class="nc">ShapeModel</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
</span><span id="ShapeModel-1180"><a href="#ShapeModel-1180"><span class="linenos">1180</span></a>    <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Helper class that provides a standard way to create an ABC using
inheritance.</p>
</div>


                </section>
                <section id="TrimeshShapeModel">
                            <input id="TrimeshShapeModel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">TrimeshShapeModel</span><wbr>(<span class="base"><a href="#ShapeModel">ShapeModel</a></span>):

                <label class="view-source-button" for="TrimeshShapeModel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TrimeshShapeModel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TrimeshShapeModel-1183"><a href="#TrimeshShapeModel-1183"><span class="linenos">1183</span></a><span class="k">class</span> <span class="nc">TrimeshShapeModel</span><span class="p">(</span><span class="n">ShapeModel</span><span class="p">):</span>
</span><span id="TrimeshShapeModel-1184"><a href="#TrimeshShapeModel-1184"><span class="linenos">1184</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;A shape model consisting of a single triangle mesh.&quot;&quot;&quot;</span>
</span><span id="TrimeshShapeModel-1185"><a href="#TrimeshShapeModel-1185"><span class="linenos">1185</span></a>
</span><span id="TrimeshShapeModel-1186"><a href="#TrimeshShapeModel-1186"><span class="linenos">1186</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="TrimeshShapeModel-1187"><a href="#TrimeshShapeModel-1187"><span class="linenos">1187</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a triangle mesh shape model. No assumption is made about</span>
</span><span id="TrimeshShapeModel-1188"><a href="#TrimeshShapeModel-1188"><span class="linenos">1188</span></a><span class="sd">        the way vertices or faces are stored when building the shape</span>
</span><span id="TrimeshShapeModel-1189"><a href="#TrimeshShapeModel-1189"><span class="linenos">1189</span></a><span class="sd">        model except that V[F] yields the faces of the mesh. Vertices</span>
</span><span id="TrimeshShapeModel-1190"><a href="#TrimeshShapeModel-1190"><span class="linenos">1190</span></a><span class="sd">        may be repeated or not.</span>
</span><span id="TrimeshShapeModel-1191"><a href="#TrimeshShapeModel-1191"><span class="linenos">1191</span></a>
</span><span id="TrimeshShapeModel-1192"><a href="#TrimeshShapeModel-1192"><span class="linenos">1192</span></a><span class="sd">        Parameters</span>
</span><span id="TrimeshShapeModel-1193"><a href="#TrimeshShapeModel-1193"><span class="linenos">1193</span></a><span class="sd">        ----------</span>
</span><span id="TrimeshShapeModel-1194"><a href="#TrimeshShapeModel-1194"><span class="linenos">1194</span></a><span class="sd">        V : array_like</span>
</span><span id="TrimeshShapeModel-1195"><a href="#TrimeshShapeModel-1195"><span class="linenos">1195</span></a><span class="sd">            An array with shape (num_verts, 3) whose rows correspond to the</span>
</span><span id="TrimeshShapeModel-1196"><a href="#TrimeshShapeModel-1196"><span class="linenos">1196</span></a><span class="sd">            vertices of the triangle mesh</span>
</span><span id="TrimeshShapeModel-1197"><a href="#TrimeshShapeModel-1197"><span class="linenos">1197</span></a><span class="sd">        F : array_like</span>
</span><span id="TrimeshShapeModel-1198"><a href="#TrimeshShapeModel-1198"><span class="linenos">1198</span></a><span class="sd">            An array with shape (num_faces, 3) whose rows index the faces</span>
</span><span id="TrimeshShapeModel-1199"><a href="#TrimeshShapeModel-1199"><span class="linenos">1199</span></a><span class="sd">            of the triangle mesh (i.e., V[F] returns an array with shape</span>
</span><span id="TrimeshShapeModel-1200"><a href="#TrimeshShapeModel-1200"><span class="linenos">1200</span></a><span class="sd">            (num_faces, 3, 3) such that V[F][i] is a 3x3 matrix whose rows</span>
</span><span id="TrimeshShapeModel-1201"><a href="#TrimeshShapeModel-1201"><span class="linenos">1201</span></a><span class="sd">            are the vertices of the ith face.</span>
</span><span id="TrimeshShapeModel-1202"><a href="#TrimeshShapeModel-1202"><span class="linenos">1202</span></a><span class="sd">        N : array_like, optional</span>
</span><span id="TrimeshShapeModel-1203"><a href="#TrimeshShapeModel-1203"><span class="linenos">1203</span></a><span class="sd">            An array with shape (num_faces, 3) consisting of the triangle</span>
</span><span id="TrimeshShapeModel-1204"><a href="#TrimeshShapeModel-1204"><span class="linenos">1204</span></a><span class="sd">            mesh face normals. Can be passed to specify the face normals.</span>
</span><span id="TrimeshShapeModel-1205"><a href="#TrimeshShapeModel-1205"><span class="linenos">1205</span></a><span class="sd">            Otherwise, the face normals will be computed from the cross products</span>
</span><span id="TrimeshShapeModel-1206"><a href="#TrimeshShapeModel-1206"><span class="linenos">1206</span></a><span class="sd">            of the face edges (i.e. np.cross(vi1 - vi0, vi2 - vi0) normalized).</span>
</span><span id="TrimeshShapeModel-1207"><a href="#TrimeshShapeModel-1207"><span class="linenos">1207</span></a><span class="sd">        P : array_like, optional</span>
</span><span id="TrimeshShapeModel-1208"><a href="#TrimeshShapeModel-1208"><span class="linenos">1208</span></a><span class="sd">            An array with shape (num_faces, 3) consisting of the triangle</span>
</span><span id="TrimeshShapeModel-1209"><a href="#TrimeshShapeModel-1209"><span class="linenos">1209</span></a><span class="sd">            centroids. Can be optionally passed to avoid recomputing.</span>
</span><span id="TrimeshShapeModel-1210"><a href="#TrimeshShapeModel-1210"><span class="linenos">1210</span></a><span class="sd">        A : array_like, optional</span>
</span><span id="TrimeshShapeModel-1211"><a href="#TrimeshShapeModel-1211"><span class="linenos">1211</span></a><span class="sd">            An array of shape (num_faces,) containing the triangle areas. Can</span>
</span><span id="TrimeshShapeModel-1212"><a href="#TrimeshShapeModel-1212"><span class="linenos">1212</span></a><span class="sd">            be optionally passed to avoid recomputing.</span>
</span><span id="TrimeshShapeModel-1213"><a href="#TrimeshShapeModel-1213"><span class="linenos">1213</span></a>
</span><span id="TrimeshShapeModel-1214"><a href="#TrimeshShapeModel-1214"><span class="linenos">1214</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TrimeshShapeModel-1215"><a href="#TrimeshShapeModel-1215"><span class="linenos">1215</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">TrimeshShapeModel</span><span class="p">:</span>
</span><span id="TrimeshShapeModel-1216"><a href="#TrimeshShapeModel-1216"><span class="linenos">1216</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;tried to instantiate TrimeshShapeModel directly&quot;</span><span class="p">)</span>
</span><span id="TrimeshShapeModel-1217"><a href="#TrimeshShapeModel-1217"><span class="linenos">1217</span></a>
</span><span id="TrimeshShapeModel-1218"><a href="#TrimeshShapeModel-1218"><span class="linenos">1218</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="TrimeshShapeModel-1219"><a href="#TrimeshShapeModel-1219"><span class="linenos">1219</span></a>
</span><span id="TrimeshShapeModel-1220"><a href="#TrimeshShapeModel-1220"><span class="linenos">1220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">V</span>
</span><span id="TrimeshShapeModel-1221"><a href="#TrimeshShapeModel-1221"><span class="linenos">1221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">F</span>
</span><span id="TrimeshShapeModel-1222"><a href="#TrimeshShapeModel-1222"><span class="linenos">1222</span></a>
</span><span id="TrimeshShapeModel-1223"><a href="#TrimeshShapeModel-1223"><span class="linenos">1223</span></a>        <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">A</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrimeshShapeModel-1224"><a href="#TrimeshShapeModel-1224"><span class="linenos">1224</span></a>            <span class="n">N</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">get_surface_normals_and_face_areas</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="TrimeshShapeModel-1225"><a href="#TrimeshShapeModel-1225"><span class="linenos">1225</span></a>        <span class="k">elif</span> <span class="n">A</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrimeshShapeModel-1226"><a href="#TrimeshShapeModel-1226"><span class="linenos">1226</span></a>            <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="TrimeshShapeModel-1227"><a href="#TrimeshShapeModel-1227"><span class="linenos">1227</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="TrimeshShapeModel-1228"><a href="#TrimeshShapeModel-1228"><span class="linenos">1228</span></a>                    <span class="s1">&#39;must pass same number of surface normals as faces (got &#39;</span> <span class="o">+</span>
</span><span id="TrimeshShapeModel-1229"><a href="#TrimeshShapeModel-1229"><span class="linenos">1229</span></a>                    <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> faces and </span><span class="si">%d</span><span class="s1"> normals&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="TrimeshShapeModel-1230"><a href="#TrimeshShapeModel-1230"><span class="linenos">1230</span></a>                <span class="p">)</span>
</span><span id="TrimeshShapeModel-1231"><a href="#TrimeshShapeModel-1231"><span class="linenos">1231</span></a>            <span class="n">A</span> <span class="o">=</span> <span class="n">get_face_areas</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="TrimeshShapeModel-1232"><a href="#TrimeshShapeModel-1232"><span class="linenos">1232</span></a>        <span class="k">elif</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrimeshShapeModel-1233"><a href="#TrimeshShapeModel-1233"><span class="linenos">1233</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="n">get_surface_normals</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="TrimeshShapeModel-1234"><a href="#TrimeshShapeModel-1234"><span class="linenos">1234</span></a>
</span><span id="TrimeshShapeModel-1235"><a href="#TrimeshShapeModel-1235"><span class="linenos">1235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">get_centroids</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="TrimeshShapeModel-1236"><a href="#TrimeshShapeModel-1236"><span class="linenos">1236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">N</span>
</span><span id="TrimeshShapeModel-1237"><a href="#TrimeshShapeModel-1237"><span class="linenos">1237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">A</span>
</span><span id="TrimeshShapeModel-1238"><a href="#TrimeshShapeModel-1238"><span class="linenos">1238</span></a>
</span><span id="TrimeshShapeModel-1239"><a href="#TrimeshShapeModel-1239"><span class="linenos">1239</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="TrimeshShapeModel-1240"><a href="#TrimeshShapeModel-1240"><span class="linenos">1240</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="TrimeshShapeModel-1241"><a href="#TrimeshShapeModel-1241"><span class="linenos">1241</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="TrimeshShapeModel-1242"><a href="#TrimeshShapeModel-1242"><span class="linenos">1242</span></a>
</span><span id="TrimeshShapeModel-1243"><a href="#TrimeshShapeModel-1243"><span class="linenos">1243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_make_scene</span><span class="p">()</span>
</span><span id="TrimeshShapeModel-1244"><a href="#TrimeshShapeModel-1244"><span class="linenos">1244</span></a>
</span><span id="TrimeshShapeModel-1245"><a href="#TrimeshShapeModel-1245"><span class="linenos">1245</span></a>    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TrimeshShapeModel-1246"><a href="#TrimeshShapeModel-1246"><span class="linenos">1246</span></a>        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">))</span>
</span><span id="TrimeshShapeModel-1247"><a href="#TrimeshShapeModel-1247"><span class="linenos">1247</span></a>
</span><span id="TrimeshShapeModel-1248"><a href="#TrimeshShapeModel-1248"><span class="linenos">1248</span></a>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TrimeshShapeModel-1249"><a href="#TrimeshShapeModel-1249"><span class="linenos">1249</span></a>        <span class="k">return</span> <span class="s1">&#39;a TrimeshShapeModel with </span><span class="si">%d</span><span class="s1"> vertices and </span><span class="si">%d</span><span class="s1"> faces&#39;</span> <span class="o">%</span> <span class="p">(</span>
</span><span id="TrimeshShapeModel-1250"><a href="#TrimeshShapeModel-1250"><span class="linenos">1250</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">num_verts</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_faces</span><span class="p">)</span>
</span><span id="TrimeshShapeModel-1251"><a href="#TrimeshShapeModel-1251"><span class="linenos">1251</span></a>
</span><span id="TrimeshShapeModel-1252"><a href="#TrimeshShapeModel-1252"><span class="linenos">1252</span></a>    <span class="nd">@property</span>
</span><span id="TrimeshShapeModel-1253"><a href="#TrimeshShapeModel-1253"><span class="linenos">1253</span></a>    <span class="k">def</span> <span class="nf">num_faces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TrimeshShapeModel-1254"><a href="#TrimeshShapeModel-1254"><span class="linenos">1254</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="TrimeshShapeModel-1255"><a href="#TrimeshShapeModel-1255"><span class="linenos">1255</span></a>
</span><span id="TrimeshShapeModel-1256"><a href="#TrimeshShapeModel-1256"><span class="linenos">1256</span></a>    <span class="nd">@property</span>
</span><span id="TrimeshShapeModel-1257"><a href="#TrimeshShapeModel-1257"><span class="linenos">1257</span></a>    <span class="k">def</span> <span class="nf">num_verts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TrimeshShapeModel-1258"><a href="#TrimeshShapeModel-1258"><span class="linenos">1258</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="TrimeshShapeModel-1259"><a href="#TrimeshShapeModel-1259"><span class="linenos">1259</span></a>
</span><span id="TrimeshShapeModel-1260"><a href="#TrimeshShapeModel-1260"><span class="linenos">1260</span></a>    <span class="k">def</span> <span class="nf">intersect1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
</span><span id="TrimeshShapeModel-1261"><a href="#TrimeshShapeModel-1261"><span class="linenos">1261</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Trace a single ray starting from `x` and in the direction `d`.  If</span>
</span><span id="TrimeshShapeModel-1262"><a href="#TrimeshShapeModel-1262"><span class="linenos">1262</span></a><span class="sd">        there is a hit, return the index (`i`) of the hit and a</span>
</span><span id="TrimeshShapeModel-1263"><a href="#TrimeshShapeModel-1263"><span class="linenos">1263</span></a><span class="sd">        parameter `t` such that the hit point is given by `x(t) = x +</span>
</span><span id="TrimeshShapeModel-1264"><a href="#TrimeshShapeModel-1264"><span class="linenos">1264</span></a><span class="sd">        t*d`.</span>
</span><span id="TrimeshShapeModel-1265"><a href="#TrimeshShapeModel-1265"><span class="linenos">1265</span></a>
</span><span id="TrimeshShapeModel-1266"><a href="#TrimeshShapeModel-1266"><span class="linenos">1266</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="TrimeshShapeModel-1267"><a href="#TrimeshShapeModel-1267"><span class="linenos">1267</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intersect1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="TrimeshShapeModel-1268"><a href="#TrimeshShapeModel-1268"><span class="linenos">1268</span></a>
</span><span id="TrimeshShapeModel-1269"><a href="#TrimeshShapeModel-1269"><span class="linenos">1269</span></a>    <span class="k">def</span> <span class="nf">intersect1_2d_with_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
</span><span id="TrimeshShapeModel-1270"><a href="#TrimeshShapeModel-1270"><span class="linenos">1270</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Trace a single ray starting from `X` and in the direction `D`.  If</span>
</span><span id="TrimeshShapeModel-1271"><a href="#TrimeshShapeModel-1271"><span class="linenos">1271</span></a><span class="sd">        there is a hit, return the index (`i`) of the hit and the coordinates of</span>
</span><span id="TrimeshShapeModel-1272"><a href="#TrimeshShapeModel-1272"><span class="linenos">1272</span></a><span class="sd">        the centroid of the hit triangle `X(t) = X + t*D`.</span>
</span><span id="TrimeshShapeModel-1273"><a href="#TrimeshShapeModel-1273"><span class="linenos">1273</span></a>
</span><span id="TrimeshShapeModel-1274"><a href="#TrimeshShapeModel-1274"><span class="linenos">1274</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="TrimeshShapeModel-1275"><a href="#TrimeshShapeModel-1275"><span class="linenos">1275</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intersect1_2d_with_coords</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span id="TrimeshShapeModel-1276"><a href="#TrimeshShapeModel-1276"><span class="linenos">1276</span></a>
</span><span id="TrimeshShapeModel-1277"><a href="#TrimeshShapeModel-1277"><span class="linenos">1277</span></a>    <span class="k">def</span> <span class="nf">intersect1_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
</span><span id="TrimeshShapeModel-1278"><a href="#TrimeshShapeModel-1278"><span class="linenos">1278</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Trace a single ray starting from `X` and in the direction `D`.  If</span>
</span><span id="TrimeshShapeModel-1279"><a href="#TrimeshShapeModel-1279"><span class="linenos">1279</span></a><span class="sd">        there is a hit, return the index (`i`).</span>
</span><span id="TrimeshShapeModel-1280"><a href="#TrimeshShapeModel-1280"><span class="linenos">1280</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="TrimeshShapeModel-1281"><a href="#TrimeshShapeModel-1281"><span class="linenos">1281</span></a>
</span><span id="TrimeshShapeModel-1282"><a href="#TrimeshShapeModel-1282"><span class="linenos">1282</span></a>        <span class="n">fint</span><span class="p">,</span> <span class="n">xta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersect1_2d_with_coords</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span id="TrimeshShapeModel-1283"><a href="#TrimeshShapeModel-1283"><span class="linenos">1283</span></a>
</span><span id="TrimeshShapeModel-1284"><a href="#TrimeshShapeModel-1284"><span class="linenos">1284</span></a>        <span class="k">return</span> <span class="n">fint</span>
</span></pre></div>


            <div class="docstring"><p>A shape model consisting of a single triangle mesh.</p>
</div>


                            <div id="TrimeshShapeModel.__init__" class="classattr">
                                        <input id="TrimeshShapeModel.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">TrimeshShapeModel</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">V</span>, </span><span class="param"><span class="n">F</span>, </span><span class="param"><span class="n">N</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">P</span><span class="o">=</span><span class="kc">None</span>, </span><span class="param"><span class="n">A</span><span class="o">=</span><span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="TrimeshShapeModel.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TrimeshShapeModel.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TrimeshShapeModel.__init__-1186"><a href="#TrimeshShapeModel.__init__-1186"><span class="linenos">1186</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">P</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span><span id="TrimeshShapeModel.__init__-1187"><a href="#TrimeshShapeModel.__init__-1187"><span class="linenos">1187</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a triangle mesh shape model. No assumption is made about</span>
</span><span id="TrimeshShapeModel.__init__-1188"><a href="#TrimeshShapeModel.__init__-1188"><span class="linenos">1188</span></a><span class="sd">        the way vertices or faces are stored when building the shape</span>
</span><span id="TrimeshShapeModel.__init__-1189"><a href="#TrimeshShapeModel.__init__-1189"><span class="linenos">1189</span></a><span class="sd">        model except that V[F] yields the faces of the mesh. Vertices</span>
</span><span id="TrimeshShapeModel.__init__-1190"><a href="#TrimeshShapeModel.__init__-1190"><span class="linenos">1190</span></a><span class="sd">        may be repeated or not.</span>
</span><span id="TrimeshShapeModel.__init__-1191"><a href="#TrimeshShapeModel.__init__-1191"><span class="linenos">1191</span></a>
</span><span id="TrimeshShapeModel.__init__-1192"><a href="#TrimeshShapeModel.__init__-1192"><span class="linenos">1192</span></a><span class="sd">        Parameters</span>
</span><span id="TrimeshShapeModel.__init__-1193"><a href="#TrimeshShapeModel.__init__-1193"><span class="linenos">1193</span></a><span class="sd">        ----------</span>
</span><span id="TrimeshShapeModel.__init__-1194"><a href="#TrimeshShapeModel.__init__-1194"><span class="linenos">1194</span></a><span class="sd">        V : array_like</span>
</span><span id="TrimeshShapeModel.__init__-1195"><a href="#TrimeshShapeModel.__init__-1195"><span class="linenos">1195</span></a><span class="sd">            An array with shape (num_verts, 3) whose rows correspond to the</span>
</span><span id="TrimeshShapeModel.__init__-1196"><a href="#TrimeshShapeModel.__init__-1196"><span class="linenos">1196</span></a><span class="sd">            vertices of the triangle mesh</span>
</span><span id="TrimeshShapeModel.__init__-1197"><a href="#TrimeshShapeModel.__init__-1197"><span class="linenos">1197</span></a><span class="sd">        F : array_like</span>
</span><span id="TrimeshShapeModel.__init__-1198"><a href="#TrimeshShapeModel.__init__-1198"><span class="linenos">1198</span></a><span class="sd">            An array with shape (num_faces, 3) whose rows index the faces</span>
</span><span id="TrimeshShapeModel.__init__-1199"><a href="#TrimeshShapeModel.__init__-1199"><span class="linenos">1199</span></a><span class="sd">            of the triangle mesh (i.e., V[F] returns an array with shape</span>
</span><span id="TrimeshShapeModel.__init__-1200"><a href="#TrimeshShapeModel.__init__-1200"><span class="linenos">1200</span></a><span class="sd">            (num_faces, 3, 3) such that V[F][i] is a 3x3 matrix whose rows</span>
</span><span id="TrimeshShapeModel.__init__-1201"><a href="#TrimeshShapeModel.__init__-1201"><span class="linenos">1201</span></a><span class="sd">            are the vertices of the ith face.</span>
</span><span id="TrimeshShapeModel.__init__-1202"><a href="#TrimeshShapeModel.__init__-1202"><span class="linenos">1202</span></a><span class="sd">        N : array_like, optional</span>
</span><span id="TrimeshShapeModel.__init__-1203"><a href="#TrimeshShapeModel.__init__-1203"><span class="linenos">1203</span></a><span class="sd">            An array with shape (num_faces, 3) consisting of the triangle</span>
</span><span id="TrimeshShapeModel.__init__-1204"><a href="#TrimeshShapeModel.__init__-1204"><span class="linenos">1204</span></a><span class="sd">            mesh face normals. Can be passed to specify the face normals.</span>
</span><span id="TrimeshShapeModel.__init__-1205"><a href="#TrimeshShapeModel.__init__-1205"><span class="linenos">1205</span></a><span class="sd">            Otherwise, the face normals will be computed from the cross products</span>
</span><span id="TrimeshShapeModel.__init__-1206"><a href="#TrimeshShapeModel.__init__-1206"><span class="linenos">1206</span></a><span class="sd">            of the face edges (i.e. np.cross(vi1 - vi0, vi2 - vi0) normalized).</span>
</span><span id="TrimeshShapeModel.__init__-1207"><a href="#TrimeshShapeModel.__init__-1207"><span class="linenos">1207</span></a><span class="sd">        P : array_like, optional</span>
</span><span id="TrimeshShapeModel.__init__-1208"><a href="#TrimeshShapeModel.__init__-1208"><span class="linenos">1208</span></a><span class="sd">            An array with shape (num_faces, 3) consisting of the triangle</span>
</span><span id="TrimeshShapeModel.__init__-1209"><a href="#TrimeshShapeModel.__init__-1209"><span class="linenos">1209</span></a><span class="sd">            centroids. Can be optionally passed to avoid recomputing.</span>
</span><span id="TrimeshShapeModel.__init__-1210"><a href="#TrimeshShapeModel.__init__-1210"><span class="linenos">1210</span></a><span class="sd">        A : array_like, optional</span>
</span><span id="TrimeshShapeModel.__init__-1211"><a href="#TrimeshShapeModel.__init__-1211"><span class="linenos">1211</span></a><span class="sd">            An array of shape (num_faces,) containing the triangle areas. Can</span>
</span><span id="TrimeshShapeModel.__init__-1212"><a href="#TrimeshShapeModel.__init__-1212"><span class="linenos">1212</span></a><span class="sd">            be optionally passed to avoid recomputing.</span>
</span><span id="TrimeshShapeModel.__init__-1213"><a href="#TrimeshShapeModel.__init__-1213"><span class="linenos">1213</span></a>
</span><span id="TrimeshShapeModel.__init__-1214"><a href="#TrimeshShapeModel.__init__-1214"><span class="linenos">1214</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="TrimeshShapeModel.__init__-1215"><a href="#TrimeshShapeModel.__init__-1215"><span class="linenos">1215</span></a>        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="n">TrimeshShapeModel</span><span class="p">:</span>
</span><span id="TrimeshShapeModel.__init__-1216"><a href="#TrimeshShapeModel.__init__-1216"><span class="linenos">1216</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;tried to instantiate TrimeshShapeModel directly&quot;</span><span class="p">)</span>
</span><span id="TrimeshShapeModel.__init__-1217"><a href="#TrimeshShapeModel.__init__-1217"><span class="linenos">1217</span></a>
</span><span id="TrimeshShapeModel.__init__-1218"><a href="#TrimeshShapeModel.__init__-1218"><span class="linenos">1218</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">V</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="TrimeshShapeModel.__init__-1219"><a href="#TrimeshShapeModel.__init__-1219"><span class="linenos">1219</span></a>
</span><span id="TrimeshShapeModel.__init__-1220"><a href="#TrimeshShapeModel.__init__-1220"><span class="linenos">1220</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="n">V</span>
</span><span id="TrimeshShapeModel.__init__-1221"><a href="#TrimeshShapeModel.__init__-1221"><span class="linenos">1221</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="n">F</span>
</span><span id="TrimeshShapeModel.__init__-1222"><a href="#TrimeshShapeModel.__init__-1222"><span class="linenos">1222</span></a>
</span><span id="TrimeshShapeModel.__init__-1223"><a href="#TrimeshShapeModel.__init__-1223"><span class="linenos">1223</span></a>        <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">A</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrimeshShapeModel.__init__-1224"><a href="#TrimeshShapeModel.__init__-1224"><span class="linenos">1224</span></a>            <span class="n">N</span><span class="p">,</span> <span class="n">A</span> <span class="o">=</span> <span class="n">get_surface_normals_and_face_areas</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="TrimeshShapeModel.__init__-1225"><a href="#TrimeshShapeModel.__init__-1225"><span class="linenos">1225</span></a>        <span class="k">elif</span> <span class="n">A</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrimeshShapeModel.__init__-1226"><a href="#TrimeshShapeModel.__init__-1226"><span class="linenos">1226</span></a>            <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="TrimeshShapeModel.__init__-1227"><a href="#TrimeshShapeModel.__init__-1227"><span class="linenos">1227</span></a>                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
</span><span id="TrimeshShapeModel.__init__-1228"><a href="#TrimeshShapeModel.__init__-1228"><span class="linenos">1228</span></a>                    <span class="s1">&#39;must pass same number of surface normals as faces (got &#39;</span> <span class="o">+</span>
</span><span id="TrimeshShapeModel.__init__-1229"><a href="#TrimeshShapeModel.__init__-1229"><span class="linenos">1229</span></a>                    <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> faces and </span><span class="si">%d</span><span class="s1"> normals&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="TrimeshShapeModel.__init__-1230"><a href="#TrimeshShapeModel.__init__-1230"><span class="linenos">1230</span></a>                <span class="p">)</span>
</span><span id="TrimeshShapeModel.__init__-1231"><a href="#TrimeshShapeModel.__init__-1231"><span class="linenos">1231</span></a>            <span class="n">A</span> <span class="o">=</span> <span class="n">get_face_areas</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="TrimeshShapeModel.__init__-1232"><a href="#TrimeshShapeModel.__init__-1232"><span class="linenos">1232</span></a>        <span class="k">elif</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="TrimeshShapeModel.__init__-1233"><a href="#TrimeshShapeModel.__init__-1233"><span class="linenos">1233</span></a>            <span class="n">N</span> <span class="o">=</span> <span class="n">get_surface_normals</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="TrimeshShapeModel.__init__-1234"><a href="#TrimeshShapeModel.__init__-1234"><span class="linenos">1234</span></a>
</span><span id="TrimeshShapeModel.__init__-1235"><a href="#TrimeshShapeModel.__init__-1235"><span class="linenos">1235</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">P</span> <span class="o">=</span> <span class="n">get_centroids</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="TrimeshShapeModel.__init__-1236"><a href="#TrimeshShapeModel.__init__-1236"><span class="linenos">1236</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">N</span>
</span><span id="TrimeshShapeModel.__init__-1237"><a href="#TrimeshShapeModel.__init__-1237"><span class="linenos">1237</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">A</span>
</span><span id="TrimeshShapeModel.__init__-1238"><a href="#TrimeshShapeModel.__init__-1238"><span class="linenos">1238</span></a>
</span><span id="TrimeshShapeModel.__init__-1239"><a href="#TrimeshShapeModel.__init__-1239"><span class="linenos">1239</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="TrimeshShapeModel.__init__-1240"><a href="#TrimeshShapeModel.__init__-1240"><span class="linenos">1240</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="TrimeshShapeModel.__init__-1241"><a href="#TrimeshShapeModel.__init__-1241"><span class="linenos">1241</span></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
</span><span id="TrimeshShapeModel.__init__-1242"><a href="#TrimeshShapeModel.__init__-1242"><span class="linenos">1242</span></a>
</span><span id="TrimeshShapeModel.__init__-1243"><a href="#TrimeshShapeModel.__init__-1243"><span class="linenos">1243</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_make_scene</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialize a triangle mesh shape model. No assumption is made about
the way vertices or faces are stored when building the shape
model except that V[F] yields the faces of the mesh. Vertices
may be repeated or not.</p>

<h2 id="parameters">Parameters</h2>

<p>V : array_like
    An array with shape (num_verts, 3) whose rows correspond to the
    vertices of the triangle mesh
F : array_like
    An array with shape (num_faces, 3) whose rows index the faces
    of the triangle mesh (i.e., V[F] returns an array with shape
    (num_faces, 3, 3) such that V[F][i] is a 3x3 matrix whose rows
    are the vertices of the ith face.
N : array_like, optional
    An array with shape (num_faces, 3) consisting of the triangle
    mesh face normals. Can be passed to specify the face normals.
    Otherwise, the face normals will be computed from the cross products
    of the face edges (i.e. np.cross(vi1 - vi0, vi2 - vi0) normalized).
P : array_like, optional
    An array with shape (num_faces, 3) consisting of the triangle
    centroids. Can be optionally passed to avoid recomputing.
A : array_like, optional
    An array of shape (num_faces,) containing the triangle areas. Can
    be optionally passed to avoid recomputing.</p>
</div>


                            </div>
                            <div id="TrimeshShapeModel.dtype" class="classattr">
                                <div class="attr variable">
            <span class="name">dtype</span>

        
    </div>
    <a class="headerlink" href="#TrimeshShapeModel.dtype"></a>
    
    

                            </div>
                            <div id="TrimeshShapeModel.V" class="classattr">
                                <div class="attr variable">
            <span class="name">V</span>

        
    </div>
    <a class="headerlink" href="#TrimeshShapeModel.V"></a>
    
    

                            </div>
                            <div id="TrimeshShapeModel.F" class="classattr">
                                <div class="attr variable">
            <span class="name">F</span>

        
    </div>
    <a class="headerlink" href="#TrimeshShapeModel.F"></a>
    
    

                            </div>
                            <div id="TrimeshShapeModel.P" class="classattr">
                                <div class="attr variable">
            <span class="name">P</span>

        
    </div>
    <a class="headerlink" href="#TrimeshShapeModel.P"></a>
    
    

                            </div>
                            <div id="TrimeshShapeModel.N" class="classattr">
                                <div class="attr variable">
            <span class="name">N</span>

        
    </div>
    <a class="headerlink" href="#TrimeshShapeModel.N"></a>
    
    

                            </div>
                            <div id="TrimeshShapeModel.A" class="classattr">
                                <div class="attr variable">
            <span class="name">A</span>

        
    </div>
    <a class="headerlink" href="#TrimeshShapeModel.A"></a>
    
    

                            </div>
                            <div id="TrimeshShapeModel.num_faces" class="classattr">
                                        <input id="TrimeshShapeModel.num_faces-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">num_faces</span>

                <label class="view-source-button" for="TrimeshShapeModel.num_faces-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TrimeshShapeModel.num_faces"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TrimeshShapeModel.num_faces-1252"><a href="#TrimeshShapeModel.num_faces-1252"><span class="linenos">1252</span></a>    <span class="nd">@property</span>
</span><span id="TrimeshShapeModel.num_faces-1253"><a href="#TrimeshShapeModel.num_faces-1253"><span class="linenos">1253</span></a>    <span class="k">def</span> <span class="nf">num_faces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TrimeshShapeModel.num_faces-1254"><a href="#TrimeshShapeModel.num_faces-1254"><span class="linenos">1254</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">P</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


    

                            </div>
                            <div id="TrimeshShapeModel.num_verts" class="classattr">
                                        <input id="TrimeshShapeModel.num_verts-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">num_verts</span>

                <label class="view-source-button" for="TrimeshShapeModel.num_verts-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TrimeshShapeModel.num_verts"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TrimeshShapeModel.num_verts-1256"><a href="#TrimeshShapeModel.num_verts-1256"><span class="linenos">1256</span></a>    <span class="nd">@property</span>
</span><span id="TrimeshShapeModel.num_verts-1257"><a href="#TrimeshShapeModel.num_verts-1257"><span class="linenos">1257</span></a>    <span class="k">def</span> <span class="nf">num_verts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="TrimeshShapeModel.num_verts-1258"><a href="#TrimeshShapeModel.num_verts-1258"><span class="linenos">1258</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></pre></div>


    

                            </div>
                            <div id="TrimeshShapeModel.intersect1" class="classattr">
                                        <input id="TrimeshShapeModel.intersect1-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">intersect1</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">x</span>, </span><span class="param"><span class="n">d</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TrimeshShapeModel.intersect1-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TrimeshShapeModel.intersect1"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TrimeshShapeModel.intersect1-1260"><a href="#TrimeshShapeModel.intersect1-1260"><span class="linenos">1260</span></a>    <span class="k">def</span> <span class="nf">intersect1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
</span><span id="TrimeshShapeModel.intersect1-1261"><a href="#TrimeshShapeModel.intersect1-1261"><span class="linenos">1261</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Trace a single ray starting from `x` and in the direction `d`.  If</span>
</span><span id="TrimeshShapeModel.intersect1-1262"><a href="#TrimeshShapeModel.intersect1-1262"><span class="linenos">1262</span></a><span class="sd">        there is a hit, return the index (`i`) of the hit and a</span>
</span><span id="TrimeshShapeModel.intersect1-1263"><a href="#TrimeshShapeModel.intersect1-1263"><span class="linenos">1263</span></a><span class="sd">        parameter `t` such that the hit point is given by `x(t) = x +</span>
</span><span id="TrimeshShapeModel.intersect1-1264"><a href="#TrimeshShapeModel.intersect1-1264"><span class="linenos">1264</span></a><span class="sd">        t*d`.</span>
</span><span id="TrimeshShapeModel.intersect1-1265"><a href="#TrimeshShapeModel.intersect1-1265"><span class="linenos">1265</span></a>
</span><span id="TrimeshShapeModel.intersect1-1266"><a href="#TrimeshShapeModel.intersect1-1266"><span class="linenos">1266</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="TrimeshShapeModel.intersect1-1267"><a href="#TrimeshShapeModel.intersect1-1267"><span class="linenos">1267</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intersect1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Trace a single ray starting from <code>x</code> and in the direction <code>d</code>.  If
there is a hit, return the index (<code>i</code>) of the hit and a
parameter <code>t</code> such that the hit point is given by <code>x(t) = x +
t*d</code>.</p>
</div>


                            </div>
                            <div id="TrimeshShapeModel.intersect1_2d_with_coords" class="classattr">
                                        <input id="TrimeshShapeModel.intersect1_2d_with_coords-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">intersect1_2d_with_coords</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">X</span>, </span><span class="param"><span class="n">D</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TrimeshShapeModel.intersect1_2d_with_coords-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TrimeshShapeModel.intersect1_2d_with_coords"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TrimeshShapeModel.intersect1_2d_with_coords-1269"><a href="#TrimeshShapeModel.intersect1_2d_with_coords-1269"><span class="linenos">1269</span></a>    <span class="k">def</span> <span class="nf">intersect1_2d_with_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
</span><span id="TrimeshShapeModel.intersect1_2d_with_coords-1270"><a href="#TrimeshShapeModel.intersect1_2d_with_coords-1270"><span class="linenos">1270</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Trace a single ray starting from `X` and in the direction `D`.  If</span>
</span><span id="TrimeshShapeModel.intersect1_2d_with_coords-1271"><a href="#TrimeshShapeModel.intersect1_2d_with_coords-1271"><span class="linenos">1271</span></a><span class="sd">        there is a hit, return the index (`i`) of the hit and the coordinates of</span>
</span><span id="TrimeshShapeModel.intersect1_2d_with_coords-1272"><a href="#TrimeshShapeModel.intersect1_2d_with_coords-1272"><span class="linenos">1272</span></a><span class="sd">        the centroid of the hit triangle `X(t) = X + t*D`.</span>
</span><span id="TrimeshShapeModel.intersect1_2d_with_coords-1273"><a href="#TrimeshShapeModel.intersect1_2d_with_coords-1273"><span class="linenos">1273</span></a>
</span><span id="TrimeshShapeModel.intersect1_2d_with_coords-1274"><a href="#TrimeshShapeModel.intersect1_2d_with_coords-1274"><span class="linenos">1274</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="TrimeshShapeModel.intersect1_2d_with_coords-1275"><a href="#TrimeshShapeModel.intersect1_2d_with_coords-1275"><span class="linenos">1275</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intersect1_2d_with_coords</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Trace a single ray starting from <code>X</code> and in the direction <code>D</code>.  If
there is a hit, return the index (<code>i</code>) of the hit and the coordinates of
the centroid of the hit triangle <code>X(t) = X + t*D</code>.</p>
</div>


                            </div>
                            <div id="TrimeshShapeModel.intersect1_2d" class="classattr">
                                        <input id="TrimeshShapeModel.intersect1_2d-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">intersect1_2d</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">X</span>, </span><span class="param"><span class="n">D</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="TrimeshShapeModel.intersect1_2d-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#TrimeshShapeModel.intersect1_2d"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="TrimeshShapeModel.intersect1_2d-1277"><a href="#TrimeshShapeModel.intersect1_2d-1277"><span class="linenos">1277</span></a>    <span class="k">def</span> <span class="nf">intersect1_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
</span><span id="TrimeshShapeModel.intersect1_2d-1278"><a href="#TrimeshShapeModel.intersect1_2d-1278"><span class="linenos">1278</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Trace a single ray starting from `X` and in the direction `D`.  If</span>
</span><span id="TrimeshShapeModel.intersect1_2d-1279"><a href="#TrimeshShapeModel.intersect1_2d-1279"><span class="linenos">1279</span></a><span class="sd">        there is a hit, return the index (`i`).</span>
</span><span id="TrimeshShapeModel.intersect1_2d-1280"><a href="#TrimeshShapeModel.intersect1_2d-1280"><span class="linenos">1280</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="TrimeshShapeModel.intersect1_2d-1281"><a href="#TrimeshShapeModel.intersect1_2d-1281"><span class="linenos">1281</span></a>
</span><span id="TrimeshShapeModel.intersect1_2d-1282"><a href="#TrimeshShapeModel.intersect1_2d-1282"><span class="linenos">1282</span></a>        <span class="n">fint</span><span class="p">,</span> <span class="n">xta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">intersect1_2d_with_coords</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span id="TrimeshShapeModel.intersect1_2d-1283"><a href="#TrimeshShapeModel.intersect1_2d-1283"><span class="linenos">1283</span></a>
</span><span id="TrimeshShapeModel.intersect1_2d-1284"><a href="#TrimeshShapeModel.intersect1_2d-1284"><span class="linenos">1284</span></a>        <span class="k">return</span> <span class="n">fint</span>
</span></pre></div>


            <div class="docstring"><p>Trace a single ray starting from <code>X</code> and in the direction <code>D</code>.  If
there is a hit, return the index (<code>i</code>).</p>
</div>


                            </div>
                </section>
                <section id="CgalTrimeshShapeModel">
                            <input id="CgalTrimeshShapeModel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CgalTrimeshShapeModel</span><wbr>(<span class="base"><a href="#TrimeshShapeModel">TrimeshShapeModel</a></span>):

                <label class="view-source-button" for="CgalTrimeshShapeModel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CgalTrimeshShapeModel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CgalTrimeshShapeModel-1286"><a href="#CgalTrimeshShapeModel-1286"><span class="linenos">1286</span></a><span class="k">class</span> <span class="nc">CgalTrimeshShapeModel</span><span class="p">(</span><span class="n">TrimeshShapeModel</span><span class="p">):</span>
</span><span id="CgalTrimeshShapeModel-1287"><a href="#CgalTrimeshShapeModel-1287"><span class="linenos">1287</span></a>    <span class="k">def</span> <span class="nf">_make_scene</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="CgalTrimeshShapeModel-1288"><a href="#CgalTrimeshShapeModel-1288"><span class="linenos">1288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">aabb</span> <span class="o">=</span> <span class="n">AABB</span><span class="o">.</span><span class="n">from_trimesh</span><span class="p">(</span>
</span><span id="CgalTrimeshShapeModel-1289"><a href="#CgalTrimeshShapeModel-1289"><span class="linenos">1289</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uintp</span><span class="p">))</span>
</span><span id="CgalTrimeshShapeModel-1290"><a href="#CgalTrimeshShapeModel-1290"><span class="linenos">1290</span></a>
</span><span id="CgalTrimeshShapeModel-1291"><a href="#CgalTrimeshShapeModel-1291"><span class="linenos">1291</span></a>    <span class="k">def</span> <span class="nf">_intersect1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
</span><span id="CgalTrimeshShapeModel-1292"><a href="#CgalTrimeshShapeModel-1292"><span class="linenos">1292</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aabb</span><span class="o">.</span><span class="n">intersect1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span id="CgalTrimeshShapeModel-1293"><a href="#CgalTrimeshShapeModel-1293"><span class="linenos">1293</span></a>
</span><span id="CgalTrimeshShapeModel-1294"><a href="#CgalTrimeshShapeModel-1294"><span class="linenos">1294</span></a>    <span class="k">def</span> <span class="nf">_intersect1_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
</span><span id="CgalTrimeshShapeModel-1295"><a href="#CgalTrimeshShapeModel-1295"><span class="linenos">1295</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aabb</span><span class="o">.</span><span class="n">intersect1_2d</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span><span id="CgalTrimeshShapeModel-1296"><a href="#CgalTrimeshShapeModel-1296"><span class="linenos">1296</span></a>
</span><span id="CgalTrimeshShapeModel-1297"><a href="#CgalTrimeshShapeModel-1297"><span class="linenos">1297</span></a>    <span class="k">def</span> <span class="nf">_intersect1_2d_with_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">):</span>
</span><span id="CgalTrimeshShapeModel-1298"><a href="#CgalTrimeshShapeModel-1298"><span class="linenos">1298</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">aabb</span><span class="o">.</span><span class="n">intersect1_2d_with_coords</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A shape model consisting of a single triangle mesh.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#TrimeshShapeModel">TrimeshShapeModel</a></dt>
                                <dd id="CgalTrimeshShapeModel.__init__" class="function"><a href="#TrimeshShapeModel.__init__">TrimeshShapeModel</a></dd>
                <dd id="CgalTrimeshShapeModel.dtype" class="variable"><a href="#TrimeshShapeModel.dtype">dtype</a></dd>
                <dd id="CgalTrimeshShapeModel.V" class="variable"><a href="#TrimeshShapeModel.V">V</a></dd>
                <dd id="CgalTrimeshShapeModel.F" class="variable"><a href="#TrimeshShapeModel.F">F</a></dd>
                <dd id="CgalTrimeshShapeModel.P" class="variable"><a href="#TrimeshShapeModel.P">P</a></dd>
                <dd id="CgalTrimeshShapeModel.N" class="variable"><a href="#TrimeshShapeModel.N">N</a></dd>
                <dd id="CgalTrimeshShapeModel.A" class="variable"><a href="#TrimeshShapeModel.A">A</a></dd>
                <dd id="CgalTrimeshShapeModel.num_faces" class="variable"><a href="#TrimeshShapeModel.num_faces">num_faces</a></dd>
                <dd id="CgalTrimeshShapeModel.num_verts" class="variable"><a href="#TrimeshShapeModel.num_verts">num_verts</a></dd>
                <dd id="CgalTrimeshShapeModel.intersect1" class="function"><a href="#TrimeshShapeModel.intersect1">intersect1</a></dd>
                <dd id="CgalTrimeshShapeModel.intersect1_2d_with_coords" class="function"><a href="#TrimeshShapeModel.intersect1_2d_with_coords">intersect1_2d_with_coords</a></dd>
                <dd id="CgalTrimeshShapeModel.intersect1_2d" class="function"><a href="#TrimeshShapeModel.intersect1_2d">intersect1_2d</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="EmbreeTrimeshShapeModel">
                            <input id="EmbreeTrimeshShapeModel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">EmbreeTrimeshShapeModel</span><wbr>(<span class="base"><a href="#TrimeshShapeModel">TrimeshShapeModel</a></span>):

                <label class="view-source-button" for="EmbreeTrimeshShapeModel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EmbreeTrimeshShapeModel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EmbreeTrimeshShapeModel-1300"><a href="#EmbreeTrimeshShapeModel-1300"><span class="linenos">1300</span></a><span class="k">class</span> <span class="nc">EmbreeTrimeshShapeModel</span><span class="p">(</span><span class="n">TrimeshShapeModel</span><span class="p">):</span>
</span><span id="EmbreeTrimeshShapeModel-1301"><a href="#EmbreeTrimeshShapeModel-1301"><span class="linenos">1301</span></a>    <span class="k">def</span> <span class="nf">_make_scene</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="EmbreeTrimeshShapeModel-1302"><a href="#EmbreeTrimeshShapeModel-1302"><span class="linenos">1302</span></a><span class="w">        </span><span class="sd">&#39;&#39;&#39;Set up an Embree scene. This function allocates some memory that</span>
</span><span id="EmbreeTrimeshShapeModel-1303"><a href="#EmbreeTrimeshShapeModel-1303"><span class="linenos">1303</span></a><span class="sd">        Embree manages, and loads vertices and index lists for the</span>
</span><span id="EmbreeTrimeshShapeModel-1304"><a href="#EmbreeTrimeshShapeModel-1304"><span class="linenos">1304</span></a><span class="sd">        faces. In Embree parlance, this function creates a &quot;device&quot;,</span>
</span><span id="EmbreeTrimeshShapeModel-1305"><a href="#EmbreeTrimeshShapeModel-1305"><span class="linenos">1305</span></a><span class="sd">        which manages a &quot;scene&quot;, which has one &quot;geometry&quot; in it, which</span>
</span><span id="EmbreeTrimeshShapeModel-1306"><a href="#EmbreeTrimeshShapeModel-1306"><span class="linenos">1306</span></a><span class="sd">        is our mesh.</span>
</span><span id="EmbreeTrimeshShapeModel-1307"><a href="#EmbreeTrimeshShapeModel-1307"><span class="linenos">1307</span></a>
</span><span id="EmbreeTrimeshShapeModel-1308"><a href="#EmbreeTrimeshShapeModel-1308"><span class="linenos">1308</span></a><span class="sd">        &#39;&#39;&#39;</span>
</span><span id="EmbreeTrimeshShapeModel-1309"><a href="#EmbreeTrimeshShapeModel-1309"><span class="linenos">1309</span></a>        <span class="n">device</span> <span class="o">=</span> <span class="n">embree</span><span class="o">.</span><span class="n">Device</span><span class="p">()</span>
</span><span id="EmbreeTrimeshShapeModel-1310"><a href="#EmbreeTrimeshShapeModel-1310"><span class="linenos">1310</span></a>        <span class="n">geometry</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">make_geometry</span><span class="p">(</span><span class="n">embree</span><span class="o">.</span><span class="n">GeometryType</span><span class="o">.</span><span class="n">Triangle</span><span class="p">)</span>
</span><span id="EmbreeTrimeshShapeModel-1311"><a href="#EmbreeTrimeshShapeModel-1311"><span class="linenos">1311</span></a>        <span class="c1"># geometry.set_build_quality(embree.BuildQuality.High)</span>
</span><span id="EmbreeTrimeshShapeModel-1312"><a href="#EmbreeTrimeshShapeModel-1312"><span class="linenos">1312</span></a>
</span><span id="EmbreeTrimeshShapeModel-1313"><a href="#EmbreeTrimeshShapeModel-1313"><span class="linenos">1313</span></a>        <span class="n">scene</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">make_scene</span><span class="p">()</span>
</span><span id="EmbreeTrimeshShapeModel-1314"><a href="#EmbreeTrimeshShapeModel-1314"><span class="linenos">1314</span></a>        <span class="c1"># scene.set_build_quality(embree.BuildQuality.High)</span>
</span><span id="EmbreeTrimeshShapeModel-1315"><a href="#EmbreeTrimeshShapeModel-1315"><span class="linenos">1315</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">set_flags</span><span class="p">(</span><span class="n">embree</span><span class="o">.</span><span class="n">SceneFlags</span><span class="o">.</span><span class="n">Robust</span><span class="p">)</span>
</span><span id="EmbreeTrimeshShapeModel-1316"><a href="#EmbreeTrimeshShapeModel-1316"><span class="linenos">1316</span></a>
</span><span id="EmbreeTrimeshShapeModel-1317"><a href="#EmbreeTrimeshShapeModel-1317"><span class="linenos">1317</span></a>        <span class="n">vertex_buffer</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">set_new_buffer</span><span class="p">(</span>
</span><span id="EmbreeTrimeshShapeModel-1318"><a href="#EmbreeTrimeshShapeModel-1318"><span class="linenos">1318</span></a>            <span class="n">embree</span><span class="o">.</span><span class="n">BufferType</span><span class="o">.</span><span class="n">Vertex</span><span class="p">,</span>  <span class="c1"># buf_type</span>
</span><span id="EmbreeTrimeshShapeModel-1319"><a href="#EmbreeTrimeshShapeModel-1319"><span class="linenos">1319</span></a>            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># slot</span>
</span><span id="EmbreeTrimeshShapeModel-1320"><a href="#EmbreeTrimeshShapeModel-1320"><span class="linenos">1320</span></a>            <span class="n">embree</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">Float3</span><span class="p">,</span>  <span class="c1"># fmt</span>
</span><span id="EmbreeTrimeshShapeModel-1321"><a href="#EmbreeTrimeshShapeModel-1321"><span class="linenos">1321</span></a>            <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;float32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span>  <span class="c1"># byte_stride</span>
</span><span id="EmbreeTrimeshShapeModel-1322"><a href="#EmbreeTrimeshShapeModel-1322"><span class="linenos">1322</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="c1"># item_count</span>
</span><span id="EmbreeTrimeshShapeModel-1323"><a href="#EmbreeTrimeshShapeModel-1323"><span class="linenos">1323</span></a>        <span class="p">)</span>
</span><span id="EmbreeTrimeshShapeModel-1324"><a href="#EmbreeTrimeshShapeModel-1324"><span class="linenos">1324</span></a>        <span class="n">vertex_buffer</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">[:]</span>
</span><span id="EmbreeTrimeshShapeModel-1325"><a href="#EmbreeTrimeshShapeModel-1325"><span class="linenos">1325</span></a>        <span class="c1">#</span>
</span><span id="EmbreeTrimeshShapeModel-1326"><a href="#EmbreeTrimeshShapeModel-1326"><span class="linenos">1326</span></a>        <span class="n">index_buffer</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">set_new_buffer</span><span class="p">(</span>
</span><span id="EmbreeTrimeshShapeModel-1327"><a href="#EmbreeTrimeshShapeModel-1327"><span class="linenos">1327</span></a>            <span class="n">embree</span><span class="o">.</span><span class="n">BufferType</span><span class="o">.</span><span class="n">Index</span><span class="p">,</span>  <span class="c1"># buf_type</span>
</span><span id="EmbreeTrimeshShapeModel-1328"><a href="#EmbreeTrimeshShapeModel-1328"><span class="linenos">1328</span></a>            <span class="mi">0</span><span class="p">,</span>  <span class="c1"># slot</span>
</span><span id="EmbreeTrimeshShapeModel-1329"><a href="#EmbreeTrimeshShapeModel-1329"><span class="linenos">1329</span></a>            <span class="n">embree</span><span class="o">.</span><span class="n">Format</span><span class="o">.</span><span class="n">Uint3</span><span class="p">,</span>  <span class="c1"># fmt</span>
</span><span id="EmbreeTrimeshShapeModel-1330"><a href="#EmbreeTrimeshShapeModel-1330"><span class="linenos">1330</span></a>            <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;uint32&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">itemsize</span><span class="p">,</span>  <span class="c1"># byte_stride,</span>
</span><span id="EmbreeTrimeshShapeModel-1331"><a href="#EmbreeTrimeshShapeModel-1331"><span class="linenos">1331</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="EmbreeTrimeshShapeModel-1332"><a href="#EmbreeTrimeshShapeModel-1332"><span class="linenos">1332</span></a>        <span class="p">)</span>
</span><span id="EmbreeTrimeshShapeModel-1333"><a href="#EmbreeTrimeshShapeModel-1333"><span class="linenos">1333</span></a>        <span class="n">index_buffer</span><span class="p">[:]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">[:]</span>
</span><span id="EmbreeTrimeshShapeModel-1334"><a href="#EmbreeTrimeshShapeModel-1334"><span class="linenos">1334</span></a>
</span><span id="EmbreeTrimeshShapeModel-1335"><a href="#EmbreeTrimeshShapeModel-1335"><span class="linenos">1335</span></a>        <span class="n">geometry</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="EmbreeTrimeshShapeModel-1336"><a href="#EmbreeTrimeshShapeModel-1336"><span class="linenos">1336</span></a>
</span><span id="EmbreeTrimeshShapeModel-1337"><a href="#EmbreeTrimeshShapeModel-1337"><span class="linenos">1337</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">attach_geometry</span><span class="p">(</span><span class="n">geometry</span><span class="p">)</span>
</span><span id="EmbreeTrimeshShapeModel-1338"><a href="#EmbreeTrimeshShapeModel-1338"><span class="linenos">1338</span></a>
</span><span id="EmbreeTrimeshShapeModel-1339"><a href="#EmbreeTrimeshShapeModel-1339"><span class="linenos">1339</span></a>        <span class="n">geometry</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span><span id="EmbreeTrimeshShapeModel-1340"><a href="#EmbreeTrimeshShapeModel-1340"><span class="linenos">1340</span></a>
</span><span id="EmbreeTrimeshShapeModel-1341"><a href="#EmbreeTrimeshShapeModel-1341"><span class="linenos">1341</span></a>        <span class="n">scene</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span><span id="EmbreeTrimeshShapeModel-1342"><a href="#EmbreeTrimeshShapeModel-1342"><span class="linenos">1342</span></a>
</span><span id="EmbreeTrimeshShapeModel-1343"><a href="#EmbreeTrimeshShapeModel-1343"><span class="linenos">1343</span></a>        <span class="c1"># This is the only variable we need to retain a reference to</span>
</span><span id="EmbreeTrimeshShapeModel-1344"><a href="#EmbreeTrimeshShapeModel-1344"><span class="linenos">1344</span></a>        <span class="c1"># (I think)</span>
</span><span id="EmbreeTrimeshShapeModel-1345"><a href="#EmbreeTrimeshShapeModel-1345"><span class="linenos">1345</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">scene</span> <span class="o">=</span> <span class="n">scene</span>
</span><span id="EmbreeTrimeshShapeModel-1346"><a href="#EmbreeTrimeshShapeModel-1346"><span class="linenos">1346</span></a>        <span class="n">device</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span><span id="EmbreeTrimeshShapeModel-1347"><a href="#EmbreeTrimeshShapeModel-1347"><span class="linenos">1347</span></a>
</span><span id="EmbreeTrimeshShapeModel-1348"><a href="#EmbreeTrimeshShapeModel-1348"><span class="linenos">1348</span></a>
</span><span id="EmbreeTrimeshShapeModel-1349"><a href="#EmbreeTrimeshShapeModel-1349"><span class="linenos">1349</span></a>    <span class="k">def</span> <span class="nf">_intersect1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
</span><span id="EmbreeTrimeshShapeModel-1350"><a href="#EmbreeTrimeshShapeModel-1350"><span class="linenos">1350</span></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;intersect1 no implemented for EmbreeTrimeshShapeModel&#39;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A shape model consisting of a single triangle mesh.</p>
</div>


                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt><a href="#TrimeshShapeModel">TrimeshShapeModel</a></dt>
                                <dd id="EmbreeTrimeshShapeModel.__init__" class="function"><a href="#TrimeshShapeModel.__init__">TrimeshShapeModel</a></dd>
                <dd id="EmbreeTrimeshShapeModel.dtype" class="variable"><a href="#TrimeshShapeModel.dtype">dtype</a></dd>
                <dd id="EmbreeTrimeshShapeModel.V" class="variable"><a href="#TrimeshShapeModel.V">V</a></dd>
                <dd id="EmbreeTrimeshShapeModel.F" class="variable"><a href="#TrimeshShapeModel.F">F</a></dd>
                <dd id="EmbreeTrimeshShapeModel.P" class="variable"><a href="#TrimeshShapeModel.P">P</a></dd>
                <dd id="EmbreeTrimeshShapeModel.N" class="variable"><a href="#TrimeshShapeModel.N">N</a></dd>
                <dd id="EmbreeTrimeshShapeModel.A" class="variable"><a href="#TrimeshShapeModel.A">A</a></dd>
                <dd id="EmbreeTrimeshShapeModel.num_faces" class="variable"><a href="#TrimeshShapeModel.num_faces">num_faces</a></dd>
                <dd id="EmbreeTrimeshShapeModel.num_verts" class="variable"><a href="#TrimeshShapeModel.num_verts">num_verts</a></dd>
                <dd id="EmbreeTrimeshShapeModel.intersect1" class="function"><a href="#TrimeshShapeModel.intersect1">intersect1</a></dd>
                <dd id="EmbreeTrimeshShapeModel.intersect1_2d_with_coords" class="function"><a href="#TrimeshShapeModel.intersect1_2d_with_coords">intersect1_2d_with_coords</a></dd>
                <dd id="EmbreeTrimeshShapeModel.intersect1_2d" class="function"><a href="#TrimeshShapeModel.intersect1_2d">intersect1_2d</a></dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="trimesh_shape_models">
                    <div class="attr variable">
            <span class="name">trimesh_shape_models</span>        =
<input id="trimesh_shape_models-view-value" class="view-value-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
            <label class="view-value-button pdoc-button" for="trimesh_shape_models-view-value"></label><span class="default_value">[&lt;class &#39;<a href="#CgalTrimeshShapeModel">CgalTrimeshShapeModel</a>&#39;&gt;, &lt;class &#39;<a href="#EmbreeTrimeshShapeModel">EmbreeTrimeshShapeModel</a>&#39;&gt;]</span>

        
    </div>
    <a class="headerlink" href="#trimesh_shape_models"></a>
    
    

                </section>
                <section id="RTXkernel">
                            <input id="RTXkernel-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">RTXkernel</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">mesh_obj</span>,</span><span class="param">	<span class="n">ray_origins</span>,</span><span class="param">	<span class="n">ray_directions</span>,</span><span class="param">	<span class="n">bounces</span><span class="o">=</span><span class="mi">1</span>,</span><span class="param">	<span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;Embree3&#39;</span>,</span><span class="param">	<span class="n">diffusion</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">num_diffuse</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">errorMsg</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="RTXkernel-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#RTXkernel"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="RTXkernel-1362"><a href="#RTXkernel-1362"><span class="linenos">1362</span></a><span class="k">def</span> <span class="nf">RTXkernel</span><span class="p">(</span><span class="n">mesh_obj</span><span class="p">,</span> <span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">,</span> <span class="n">bounces</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;Embree3&#39;</span><span class="p">,</span> <span class="n">diffusion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_diffuse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="RTXkernel-1363"><a href="#RTXkernel-1363"><span class="linenos">1363</span></a>              <span class="n">errorMsg</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</span><span id="RTXkernel-1364"><a href="#RTXkernel-1364"><span class="linenos">1364</span></a>
</span><span id="RTXkernel-1365"><a href="#RTXkernel-1365"><span class="linenos">1365</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="RTXkernel-1366"><a href="#RTXkernel-1366"><span class="linenos">1366</span></a><span class="sd">    Main ray tracing kernel wrapper supporting multiple ray tracing backends and</span>
</span><span id="RTXkernel-1367"><a href="#RTXkernel-1367"><span class="linenos">1367</span></a><span class="sd">    multi-bounce simulations.</span>
</span><span id="RTXkernel-1368"><a href="#RTXkernel-1368"><span class="linenos">1368</span></a><span class="sd">    </span>
</span><span id="RTXkernel-1369"><a href="#RTXkernel-1369"><span class="linenos">1369</span></a><span class="sd">    This is the primary interface for performing ray tracing operations in pyRTX.</span>
</span><span id="RTXkernel-1370"><a href="#RTXkernel-1370"><span class="linenos">1370</span></a><span class="sd">    It supports various ray tracing kernels (Embree, CGAL, Native), multiple</span>
</span><span id="RTXkernel-1371"><a href="#RTXkernel-1371"><span class="linenos">1371</span></a><span class="sd">    reflection bounces, and optional diffuse scattering for realistic radiation</span>
</span><span id="RTXkernel-1372"><a href="#RTXkernel-1372"><span class="linenos">1372</span></a><span class="sd">    momentum exchange calculatons.</span>
</span><span id="RTXkernel-1373"><a href="#RTXkernel-1373"><span class="linenos">1373</span></a><span class="sd">    </span>
</span><span id="RTXkernel-1374"><a href="#RTXkernel-1374"><span class="linenos">1374</span></a><span class="sd">    Parameters</span>
</span><span id="RTXkernel-1375"><a href="#RTXkernel-1375"><span class="linenos">1375</span></a><span class="sd">    ----------</span>
</span><span id="RTXkernel-1376"><a href="#RTXkernel-1376"><span class="linenos">1376</span></a><span class="sd">    mesh_obj : trimesh.Trimesh</span>
</span><span id="RTXkernel-1377"><a href="#RTXkernel-1377"><span class="linenos">1377</span></a><span class="sd">        The mesh geometry to ray trace against. Must be a valid triangular mesh.</span>
</span><span id="RTXkernel-1378"><a href="#RTXkernel-1378"><span class="linenos">1378</span></a><span class="sd">    ray_origins : ndarray, shape (N_rays, 3)</span>
</span><span id="RTXkernel-1379"><a href="#RTXkernel-1379"><span class="linenos">1379</span></a><span class="sd">        Starting positions of rays in 3D space (in same coordinate system as mesh).</span>
</span><span id="RTXkernel-1380"><a href="#RTXkernel-1380"><span class="linenos">1380</span></a><span class="sd">    ray_directions : ndarray, shape (N_rays, 3)</span>
</span><span id="RTXkernel-1381"><a href="#RTXkernel-1381"><span class="linenos">1381</span></a><span class="sd">        Direction vectors of rays. Do not need to be normalized.</span>
</span><span id="RTXkernel-1382"><a href="#RTXkernel-1382"><span class="linenos">1382</span></a><span class="sd">    bounces : int, default=1</span>
</span><span id="RTXkernel-1383"><a href="#RTXkernel-1383"><span class="linenos">1383</span></a><span class="sd">        Number of reflection bounces to simulate. bounces=1 means direct</span>
</span><span id="RTXkernel-1384"><a href="#RTXkernel-1384"><span class="linenos">1384</span></a><span class="sd">        illumination only, bounces=2 includes one reflection, etc.</span>
</span><span id="RTXkernel-1385"><a href="#RTXkernel-1385"><span class="linenos">1385</span></a><span class="sd">    kernel : str, default=&#39;Embree&#39;</span>
</span><span id="RTXkernel-1386"><a href="#RTXkernel-1386"><span class="linenos">1386</span></a><span class="sd">        Ray tracing backend to use:</span>
</span><span id="RTXkernel-1387"><a href="#RTXkernel-1387"><span class="linenos">1387</span></a><span class="sd">        - &#39;Embree3&#39;: Intel Embree library (fastest, recommended)</span>
</span><span id="RTXkernel-1388"><a href="#RTXkernel-1388"><span class="linenos">1388</span></a><span class="sd">        - &#39;Embree&#39; : Intel Embree library (Version 2, slower than 3)</span>
</span><span id="RTXkernel-1389"><a href="#RTXkernel-1389"><span class="linenos">1389</span></a><span class="sd">        - &#39;CGAL&#39;: CGAL AABB tree implementation (robust, slower)</span>
</span><span id="RTXkernel-1390"><a href="#RTXkernel-1390"><span class="linenos">1390</span></a><span class="sd">        - &#39;Native&#39;: Pure Python implementation (very slow, for reference only)</span>
</span><span id="RTXkernel-1391"><a href="#RTXkernel-1391"><span class="linenos">1391</span></a><span class="sd">    diffusion : bool, default=False</span>
</span><span id="RTXkernel-1392"><a href="#RTXkernel-1392"><span class="linenos">1392</span></a><span class="sd">        If True, compute diffuse (Lambertian) reflections in addition to</span>
</span><span id="RTXkernel-1393"><a href="#RTXkernel-1393"><span class="linenos">1393</span></a><span class="sd">        specular reflections. Only applied to the first bounce. Enables</span>
</span><span id="RTXkernel-1394"><a href="#RTXkernel-1394"><span class="linenos">1394</span></a><span class="sd">        realistic modeling of rough surfaces.</span>
</span><span id="RTXkernel-1395"><a href="#RTXkernel-1395"><span class="linenos">1395</span></a><span class="sd">    num_diffuse : int or None, default=None</span>
</span><span id="RTXkernel-1396"><a href="#RTXkernel-1396"><span class="linenos">1396</span></a><span class="sd">        Number of diffuse samples per intersection point. Required if</span>
</span><span id="RTXkernel-1397"><a href="#RTXkernel-1397"><span class="linenos">1397</span></a><span class="sd">        diffusion=True. Typical values: 10-100 depending on accuracy needs.</span>
</span><span id="RTXkernel-1398"><a href="#RTXkernel-1398"><span class="linenos">1398</span></a><span class="sd">    errorMsg : bool, default=True</span>
</span><span id="RTXkernel-1399"><a href="#RTXkernel-1399"><span class="linenos">1399</span></a><span class="sd">        If True, print warning messages when no intersections are found for</span>
</span><span id="RTXkernel-1400"><a href="#RTXkernel-1400"><span class="linenos">1400</span></a><span class="sd">        a bounce. Set to False to suppress warnings in batch processing.</span>
</span><span id="RTXkernel-1401"><a href="#RTXkernel-1401"><span class="linenos">1401</span></a><span class="sd">    </span>
</span><span id="RTXkernel-1402"><a href="#RTXkernel-1402"><span class="linenos">1402</span></a><span class="sd">    Returns</span>
</span><span id="RTXkernel-1403"><a href="#RTXkernel-1403"><span class="linenos">1403</span></a><span class="sd">    -------</span>
</span><span id="RTXkernel-1404"><a href="#RTXkernel-1404"><span class="linenos">1404</span></a><span class="sd">    index_tri_container : list of ndarrays</span>
</span><span id="RTXkernel-1405"><a href="#RTXkernel-1405"><span class="linenos">1405</span></a><span class="sd">        List containing triangle indices for each bounce. Each element is an</span>
</span><span id="RTXkernel-1406"><a href="#RTXkernel-1406"><span class="linenos">1406</span></a><span class="sd">        array of shape (N_hits_i,) containing indices of faces hit at bounce i.</span>
</span><span id="RTXkernel-1407"><a href="#RTXkernel-1407"><span class="linenos">1407</span></a><span class="sd">        Length equals number of computed bounces ( bounces parameter).</span>
</span><span id="RTXkernel-1408"><a href="#RTXkernel-1408"><span class="linenos">1408</span></a><span class="sd">    index_ray_container : list of ndarrays</span>
</span><span id="RTXkernel-1409"><a href="#RTXkernel-1409"><span class="linenos">1409</span></a><span class="sd">        List containing ray indices for each bounce. index_ray_container[i]</span>
</span><span id="RTXkernel-1410"><a href="#RTXkernel-1410"><span class="linenos">1410</span></a><span class="sd">        maps from the original ray array to rays that hit at bounce i.</span>
</span><span id="RTXkernel-1411"><a href="#RTXkernel-1411"><span class="linenos">1411</span></a><span class="sd">    locations_container : list of ndarrays</span>
</span><span id="RTXkernel-1412"><a href="#RTXkernel-1412"><span class="linenos">1412</span></a><span class="sd">        List of intersection point coordinates for each bounce. Each element</span>
</span><span id="RTXkernel-1413"><a href="#RTXkernel-1413"><span class="linenos">1413</span></a><span class="sd">        has shape (N_hits_i, 3).</span>
</span><span id="RTXkernel-1414"><a href="#RTXkernel-1414"><span class="linenos">1414</span></a><span class="sd">    ray_origins_container : list of ndarrays</span>
</span><span id="RTXkernel-1415"><a href="#RTXkernel-1415"><span class="linenos">1415</span></a><span class="sd">        List of ray origin positions for each bounce. Note that</span>
</span><span id="RTXkernel-1416"><a href="#RTXkernel-1416"><span class="linenos">1416</span></a><span class="sd">        ray_origins_container[0] equals the input ray_origins parameter.</span>
</span><span id="RTXkernel-1417"><a href="#RTXkernel-1417"><span class="linenos">1417</span></a><span class="sd">    ray_directions_container : list of ndarrays</span>
</span><span id="RTXkernel-1418"><a href="#RTXkernel-1418"><span class="linenos">1418</span></a><span class="sd">        List of ray direction vectors for each bounce. Element [0] contains</span>
</span><span id="RTXkernel-1419"><a href="#RTXkernel-1419"><span class="linenos">1419</span></a><span class="sd">        input directions, subsequent elements contain reflected directions.</span>
</span><span id="RTXkernel-1420"><a href="#RTXkernel-1420"><span class="linenos">1420</span></a><span class="sd">    diffusion_pack : list or None</span>
</span><span id="RTXkernel-1421"><a href="#RTXkernel-1421"><span class="linenos">1421</span></a><span class="sd">        If diffusion=True, contains diffuse ray tracing results:</span>
</span><span id="RTXkernel-1422"><a href="#RTXkernel-1422"><span class="linenos">1422</span></a><span class="sd">        [index_tri_diffusion, index_ray_diffusion, ray_directions_diffusion,</span>
</span><span id="RTXkernel-1423"><a href="#RTXkernel-1423"><span class="linenos">1423</span></a><span class="sd">         location_diffusion]. If diffusion=False, returns None.</span>
</span><span id="RTXkernel-1424"><a href="#RTXkernel-1424"><span class="linenos">1424</span></a><span class="sd">    </span>
</span><span id="RTXkernel-1425"><a href="#RTXkernel-1425"><span class="linenos">1425</span></a><span class="sd">    Notes</span>
</span><span id="RTXkernel-1426"><a href="#RTXkernel-1426"><span class="linenos">1426</span></a><span class="sd">    -----</span>
</span><span id="RTXkernel-1427"><a href="#RTXkernel-1427"><span class="linenos">1427</span></a><span class="sd">    Algorithm Overview:</span>
</span><span id="RTXkernel-1428"><a href="#RTXkernel-1428"><span class="linenos">1428</span></a><span class="sd">    1. Initialize ray tracing kernel (Embree, CGAL, or Native)</span>
</span><span id="RTXkernel-1429"><a href="#RTXkernel-1429"><span class="linenos">1429</span></a><span class="sd">    2. For each bounce:</span>
</span><span id="RTXkernel-1430"><a href="#RTXkernel-1430"><span class="linenos">1430</span></a><span class="sd">       a. Add small offset to ray origins (avoids self-intersection)</span>
</span><span id="RTXkernel-1431"><a href="#RTXkernel-1431"><span class="linenos">1431</span></a><span class="sd">       b. Trace rays to find intersections</span>
</span><span id="RTXkernel-1432"><a href="#RTXkernel-1432"><span class="linenos">1432</span></a><span class="sd">       c. If no hits found, terminate and return results up to current bounce</span>
</span><span id="RTXkernel-1433"><a href="#RTXkernel-1433"><span class="linenos">1433</span></a><span class="sd">       d. Compute specular reflection directions for next bounce</span>
</span><span id="RTXkernel-1434"><a href="#RTXkernel-1434"><span class="linenos">1434</span></a><span class="sd">       e. If diffusion enabled and bounce==1, also compute diffuse reflections</span>
</span><span id="RTXkernel-1435"><a href="#RTXkernel-1435"><span class="linenos">1435</span></a><span class="sd">    3. Return accumulated results for all bounces</span>
</span><span id="RTXkernel-1436"><a href="#RTXkernel-1436"><span class="linenos">1436</span></a><span class="sd">    </span>
</span><span id="RTXkernel-1437"><a href="#RTXkernel-1437"><span class="linenos">1437</span></a><span class="sd">    Performance Notes:</span>
</span><span id="RTXkernel-1438"><a href="#RTXkernel-1438"><span class="linenos">1438</span></a><span class="sd">    - Embree is typically 10-100 faster than Native for large meshes</span>
</span><span id="RTXkernel-1439"><a href="#RTXkernel-1439"><span class="linenos">1439</span></a><span class="sd">    - CGAL offers good robustness for edge cases but slower than Embree</span>
</span><span id="RTXkernel-1440"><a href="#RTXkernel-1440"><span class="linenos">1440</span></a><span class="sd">    - Diffusion increases computation by factor of num_diffuse</span>
</span><span id="RTXkernel-1441"><a href="#RTXkernel-1441"><span class="linenos">1441</span></a><span class="sd">    - Memory usage scales linearly with bounces and num_diffuse</span>
</span><span id="RTXkernel-1442"><a href="#RTXkernel-1442"><span class="linenos">1442</span></a><span class="sd">    </span>
</span><span id="RTXkernel-1443"><a href="#RTXkernel-1443"><span class="linenos">1443</span></a><span class="sd">    Kernel-Specific Details:</span>
</span><span id="RTXkernel-1444"><a href="#RTXkernel-1444"><span class="linenos">1444</span></a><span class="sd">    - Embree/Embree3: Uses BVH acceleration, highly optimized for x86 CPUs</span>
</span><span id="RTXkernel-1445"><a href="#RTXkernel-1445"><span class="linenos">1445</span></a><span class="sd">    - CGAL: Uses AABB tree, more robust numerical handling</span>
</span><span id="RTXkernel-1446"><a href="#RTXkernel-1446"><span class="linenos">1446</span></a><span class="sd">    - Native: Pure Python/Trimesh, no special acceleration</span>
</span><span id="RTXkernel-1447"><a href="#RTXkernel-1447"><span class="linenos">1447</span></a><span class="sd">    </span>
</span><span id="RTXkernel-1448"><a href="#RTXkernel-1448"><span class="linenos">1448</span></a><span class="sd">    The 1e-3 offset added to ray origins prevents numerical precision issues</span>
</span><span id="RTXkernel-1449"><a href="#RTXkernel-1449"><span class="linenos">1449</span></a><span class="sd">    where a reflected ray might re-intersect the same surface it just bounced</span>
</span><span id="RTXkernel-1450"><a href="#RTXkernel-1450"><span class="linenos">1450</span></a><span class="sd">    from (self-intersection artifact).</span>
</span><span id="RTXkernel-1451"><a href="#RTXkernel-1451"><span class="linenos">1451</span></a><span class="sd">    </span>
</span><span id="RTXkernel-1452"><a href="#RTXkernel-1452"><span class="linenos">1452</span></a><span class="sd">    Examples</span>
</span><span id="RTXkernel-1453"><a href="#RTXkernel-1453"><span class="linenos">1453</span></a><span class="sd">    --------</span>
</span><span id="RTXkernel-1454"><a href="#RTXkernel-1454"><span class="linenos">1454</span></a><span class="sd">    &gt;&gt;&gt; # Simple direct illumination</span>
</span><span id="RTXkernel-1455"><a href="#RTXkernel-1455"><span class="linenos">1455</span></a><span class="sd">    &gt;&gt;&gt; results = RTXkernel(mesh, origins, directions, bounces=1, kernel=&#39;Embree&#39;)</span>
</span><span id="RTXkernel-1456"><a href="#RTXkernel-1456"><span class="linenos">1456</span></a><span class="sd">    &gt;&gt;&gt; hits, ray_ids, locations, _, _, _ = results</span>
</span><span id="RTXkernel-1457"><a href="#RTXkernel-1457"><span class="linenos">1457</span></a><span class="sd">    &gt;&gt;&gt; </span>
</span><span id="RTXkernel-1458"><a href="#RTXkernel-1458"><span class="linenos">1458</span></a><span class="sd">    &gt;&gt;&gt; # Multi-bounce with diffuse scattering</span>
</span><span id="RTXkernel-1459"><a href="#RTXkernel-1459"><span class="linenos">1459</span></a><span class="sd">    &gt;&gt;&gt; results = RTXkernel(mesh, origins, directions, bounces=3, </span>
</span><span id="RTXkernel-1460"><a href="#RTXkernel-1460"><span class="linenos">1460</span></a><span class="sd">    ...                     kernel=&#39;Embree&#39;, diffusion=True, num_diffuse=50)</span>
</span><span id="RTXkernel-1461"><a href="#RTXkernel-1461"><span class="linenos">1461</span></a><span class="sd">    &gt;&gt;&gt; hits, ray_ids, locs, origins, dirs, diffuse_data = results</span>
</span><span id="RTXkernel-1462"><a href="#RTXkernel-1462"><span class="linenos">1462</span></a><span class="sd">    </span>
</span><span id="RTXkernel-1463"><a href="#RTXkernel-1463"><span class="linenos">1463</span></a><span class="sd">    See Also</span>
</span><span id="RTXkernel-1464"><a href="#RTXkernel-1464"><span class="linenos">1464</span></a><span class="sd">    --------</span>
</span><span id="RTXkernel-1465"><a href="#RTXkernel-1465"><span class="linenos">1465</span></a><span class="sd">    pixel_plane_opt : Generate ray grids for illumination sources</span>
</span><span id="RTXkernel-1466"><a href="#RTXkernel-1466"><span class="linenos">1466</span></a><span class="sd">    compute_secondary_bounce : Compute reflection directions</span>
</span><span id="RTXkernel-1467"><a href="#RTXkernel-1467"><span class="linenos">1467</span></a><span class="sd">    diffuse : Generate diffuse reflection samples</span>
</span><span id="RTXkernel-1468"><a href="#RTXkernel-1468"><span class="linenos">1468</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="RTXkernel-1469"><a href="#RTXkernel-1469"><span class="linenos">1469</span></a>
</span><span id="RTXkernel-1470"><a href="#RTXkernel-1470"><span class="linenos">1470</span></a>
</span><span id="RTXkernel-1471"><a href="#RTXkernel-1471"><span class="linenos">1471</span></a>
</span><span id="RTXkernel-1472"><a href="#RTXkernel-1472"><span class="linenos">1472</span></a>    <span class="n">ray_origins_container</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="RTXkernel-1473"><a href="#RTXkernel-1473"><span class="linenos">1473</span></a>    <span class="n">ray_directions_container</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="RTXkernel-1474"><a href="#RTXkernel-1474"><span class="linenos">1474</span></a>    <span class="n">locations_container</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="RTXkernel-1475"><a href="#RTXkernel-1475"><span class="linenos">1475</span></a>    <span class="n">index_tri_container</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="RTXkernel-1476"><a href="#RTXkernel-1476"><span class="linenos">1476</span></a>    <span class="n">index_ray_container</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="RTXkernel-1477"><a href="#RTXkernel-1477"><span class="linenos">1477</span></a>
</span><span id="RTXkernel-1478"><a href="#RTXkernel-1478"><span class="linenos">1478</span></a>    <span class="c1"># Set variables for diffusion computation</span>
</span><span id="RTXkernel-1479"><a href="#RTXkernel-1479"><span class="linenos">1479</span></a>    <span class="n">diffusion_directions</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="RTXkernel-1480"><a href="#RTXkernel-1480"><span class="linenos">1480</span></a>    <span class="n">diffusion_pack</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="RTXkernel-1481"><a href="#RTXkernel-1481"><span class="linenos">1481</span></a>    <span class="n">diffusion_control</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="RTXkernel-1482"><a href="#RTXkernel-1482"><span class="linenos">1482</span></a>
</span><span id="RTXkernel-1483"><a href="#RTXkernel-1483"><span class="linenos">1483</span></a>    <span class="c1"># Select the kernel</span>
</span><span id="RTXkernel-1484"><a href="#RTXkernel-1484"><span class="linenos">1484</span></a>    <span class="k">if</span> <span class="n">kernel</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Embree&#39;</span><span class="p">,</span> <span class="s1">&#39;Native&#39;</span><span class="p">]:</span>
</span><span id="RTXkernel-1485"><a href="#RTXkernel-1485"><span class="linenos">1485</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bounces</span><span class="p">):</span>
</span><span id="RTXkernel-1486"><a href="#RTXkernel-1486"><span class="linenos">1486</span></a>
</span><span id="RTXkernel-1487"><a href="#RTXkernel-1487"><span class="linenos">1487</span></a>            <span class="n">ray_origins_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">)</span>
</span><span id="RTXkernel-1488"><a href="#RTXkernel-1488"><span class="linenos">1488</span></a>
</span><span id="RTXkernel-1489"><a href="#RTXkernel-1489"><span class="linenos">1489</span></a>            <span class="k">if</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s1">&#39;Embree&#39;</span><span class="p">:</span>
</span><span id="RTXkernel-1490"><a href="#RTXkernel-1490"><span class="linenos">1490</span></a>                <span class="n">intersector</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">ray_pyembree</span><span class="o">.</span><span class="n">RayMeshIntersector</span><span class="p">(</span><span class="n">mesh_obj</span><span class="p">)</span>
</span><span id="RTXkernel-1491"><a href="#RTXkernel-1491"><span class="linenos">1491</span></a>
</span><span id="RTXkernel-1492"><a href="#RTXkernel-1492"><span class="linenos">1492</span></a>            <span class="k">elif</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s1">&#39;Native&#39;</span><span class="p">:</span>
</span><span id="RTXkernel-1493"><a href="#RTXkernel-1493"><span class="linenos">1493</span></a>                <span class="n">intersector</span> <span class="o">=</span> <span class="n">trimesh</span><span class="o">.</span><span class="n">ray</span><span class="o">.</span><span class="n">ray_triangle</span><span class="o">.</span><span class="n">RayMeshIntersector</span><span class="p">(</span><span class="n">mesh_obj</span><span class="p">)</span>
</span><span id="RTXkernel-1494"><a href="#RTXkernel-1494"><span class="linenos">1494</span></a>
</span><span id="RTXkernel-1495"><a href="#RTXkernel-1495"><span class="linenos">1495</span></a>            <span class="c1"># Avoid numerical problems</span>
</span><span id="RTXkernel-1496"><a href="#RTXkernel-1496"><span class="linenos">1496</span></a>            <span class="n">ray_origins</span> <span class="o">=</span> <span class="n">ray_origins</span> <span class="o">+</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">ray_directions</span>
</span><span id="RTXkernel-1497"><a href="#RTXkernel-1497"><span class="linenos">1497</span></a>
</span><span id="RTXkernel-1498"><a href="#RTXkernel-1498"><span class="linenos">1498</span></a>            <span class="c1"># If computing bounce number 1 and the diffusion computation has been requested</span>
</span><span id="RTXkernel-1499"><a href="#RTXkernel-1499"><span class="linenos">1499</span></a>            <span class="c1"># do a separate raytracing also for the diffused rays</span>
</span><span id="RTXkernel-1500"><a href="#RTXkernel-1500"><span class="linenos">1500</span></a>            <span class="c1"># and pack results in the variable: diffusion pack</span>
</span><span id="RTXkernel-1501"><a href="#RTXkernel-1501"><span class="linenos">1501</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">diffusion</span><span class="p">:</span>
</span><span id="RTXkernel-1502"><a href="#RTXkernel-1502"><span class="linenos">1502</span></a>                <span class="n">ray_origins_diffusion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">,</span> <span class="n">num_diffuse</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># this should be correct</span>
</span><span id="RTXkernel-1503"><a href="#RTXkernel-1503"><span class="linenos">1503</span></a>                <span class="n">ray_directions_diffusion</span> <span class="o">=</span> <span class="n">diffuse_directions</span>
</span><span id="RTXkernel-1504"><a href="#RTXkernel-1504"><span class="linenos">1504</span></a>
</span><span id="RTXkernel-1505"><a href="#RTXkernel-1505"><span class="linenos">1505</span></a>                <span class="n">index_tri_diffusion</span><span class="p">,</span> <span class="n">index_ray_diffusion</span><span class="p">,</span> <span class="n">location_diffusion</span> <span class="o">=</span> <span class="n">intersector</span><span class="o">.</span><span class="n">intersects_id</span><span class="p">(</span>
</span><span id="RTXkernel-1506"><a href="#RTXkernel-1506"><span class="linenos">1506</span></a>                    <span class="n">ray_origins</span><span class="o">=</span><span class="n">ray_origins_diffusion</span><span class="p">,</span>
</span><span id="RTXkernel-1507"><a href="#RTXkernel-1507"><span class="linenos">1507</span></a>                    <span class="n">ray_directions</span><span class="o">=</span><span class="n">ray_directions_diffusion</span><span class="p">,</span>
</span><span id="RTXkernel-1508"><a href="#RTXkernel-1508"><span class="linenos">1508</span></a>                    <span class="n">multiple_hits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="RTXkernel-1509"><a href="#RTXkernel-1509"><span class="linenos">1509</span></a>                    <span class="n">return_locations</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="RTXkernel-1510"><a href="#RTXkernel-1510"><span class="linenos">1510</span></a>                <span class="n">diffusion_pack</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_tri_diffusion</span><span class="p">,</span> <span class="n">index_ray_diffusion</span><span class="p">,</span> <span class="n">ray_directions_diffusion</span><span class="p">,</span>
</span><span id="RTXkernel-1511"><a href="#RTXkernel-1511"><span class="linenos">1511</span></a>                                  <span class="n">location_diffusion</span><span class="p">]</span>
</span><span id="RTXkernel-1512"><a href="#RTXkernel-1512"><span class="linenos">1512</span></a>
</span><span id="RTXkernel-1513"><a href="#RTXkernel-1513"><span class="linenos">1513</span></a>            <span class="c1"># Main Raytracer</span>
</span><span id="RTXkernel-1514"><a href="#RTXkernel-1514"><span class="linenos">1514</span></a>            <span class="n">index_tri</span><span class="p">,</span> <span class="n">index_ray</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="n">intersector</span><span class="o">.</span><span class="n">intersects_id</span><span class="p">(</span>
</span><span id="RTXkernel-1515"><a href="#RTXkernel-1515"><span class="linenos">1515</span></a>                <span class="n">ray_origins</span><span class="o">=</span><span class="n">ray_origins</span><span class="p">,</span>
</span><span id="RTXkernel-1516"><a href="#RTXkernel-1516"><span class="linenos">1516</span></a>                <span class="n">ray_directions</span><span class="o">=</span><span class="n">ray_directions</span><span class="p">,</span>
</span><span id="RTXkernel-1517"><a href="#RTXkernel-1517"><span class="linenos">1517</span></a>                <span class="n">multiple_hits</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="RTXkernel-1518"><a href="#RTXkernel-1518"><span class="linenos">1518</span></a>                <span class="n">return_locations</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="RTXkernel-1519"><a href="#RTXkernel-1519"><span class="linenos">1519</span></a>            <span class="c1"># Get the number of hits</span>
</span><span id="RTXkernel-1520"><a href="#RTXkernel-1520"><span class="linenos">1520</span></a>            <span class="n">n_hits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_tri</span><span class="p">)</span>
</span><span id="RTXkernel-1521"><a href="#RTXkernel-1521"><span class="linenos">1521</span></a>
</span><span id="RTXkernel-1522"><a href="#RTXkernel-1522"><span class="linenos">1522</span></a>            <span class="c1"># Manage the possibility of no hits</span>
</span><span id="RTXkernel-1523"><a href="#RTXkernel-1523"><span class="linenos">1523</span></a>            <span class="k">if</span> <span class="n">n_hits</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">errorMsg</span><span class="p">:</span>
</span><span id="RTXkernel-1524"><a href="#RTXkernel-1524"><span class="linenos">1524</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No intersections found for bounce </span><span class="si">{}</span><span class="s1">. Results provided up to bounce </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
</span><span id="RTXkernel-1525"><a href="#RTXkernel-1525"><span class="linenos">1525</span></a>                <span class="k">break</span>
</span><span id="RTXkernel-1526"><a href="#RTXkernel-1526"><span class="linenos">1526</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="RTXkernel-1527"><a href="#RTXkernel-1527"><span class="linenos">1527</span></a>                <span class="n">locations_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
</span><span id="RTXkernel-1528"><a href="#RTXkernel-1528"><span class="linenos">1528</span></a>                <span class="n">index_tri_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_tri</span><span class="p">)</span>
</span><span id="RTXkernel-1529"><a href="#RTXkernel-1529"><span class="linenos">1529</span></a>                <span class="n">index_ray_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_ray</span><span class="p">)</span>
</span><span id="RTXkernel-1530"><a href="#RTXkernel-1530"><span class="linenos">1530</span></a>                <span class="n">ray_directions_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_directions</span><span class="p">)</span>
</span><span id="RTXkernel-1531"><a href="#RTXkernel-1531"><span class="linenos">1531</span></a>
</span><span id="RTXkernel-1532"><a href="#RTXkernel-1532"><span class="linenos">1532</span></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">bounces</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="RTXkernel-1533"><a href="#RTXkernel-1533"><span class="linenos">1533</span></a>                    <span class="c1"># If at bounce number 1 compute the diffused directions:</span>
</span><span id="RTXkernel-1534"><a href="#RTXkernel-1534"><span class="linenos">1534</span></a>                    <span class="k">if</span> <span class="n">diffusion</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="RTXkernel-1535"><a href="#RTXkernel-1535"><span class="linenos">1535</span></a>                        <span class="n">diffusion_control</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="RTXkernel-1536"><a href="#RTXkernel-1536"><span class="linenos">1536</span></a>
</span><span id="RTXkernel-1537"><a href="#RTXkernel-1537"><span class="linenos">1537</span></a>                    <span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">,</span> <span class="n">diffuse_directions</span> <span class="o">=</span> <span class="n">compute_secondary_bounce</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">index_tri</span><span class="p">,</span>
</span><span id="RTXkernel-1538"><a href="#RTXkernel-1538"><span class="linenos">1538</span></a>                                                                                               <span class="n">mesh_obj</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">,</span>
</span><span id="RTXkernel-1539"><a href="#RTXkernel-1539"><span class="linenos">1539</span></a>                                                                                               <span class="n">index_ray</span><span class="p">,</span>
</span><span id="RTXkernel-1540"><a href="#RTXkernel-1540"><span class="linenos">1540</span></a>                                                                                               <span class="n">diffusion</span><span class="o">=</span><span class="n">diffusion_control</span><span class="p">,</span>
</span><span id="RTXkernel-1541"><a href="#RTXkernel-1541"><span class="linenos">1541</span></a>                                                                                               <span class="n">num_diffuse</span><span class="o">=</span><span class="n">num_diffuse</span><span class="p">)</span>
</span><span id="RTXkernel-1542"><a href="#RTXkernel-1542"><span class="linenos">1542</span></a>
</span><span id="RTXkernel-1543"><a href="#RTXkernel-1543"><span class="linenos">1543</span></a>                    <span class="c1"># Set back to false the diffusion computation control flag</span>
</span><span id="RTXkernel-1544"><a href="#RTXkernel-1544"><span class="linenos">1544</span></a>                    <span class="n">diffusion_control</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="RTXkernel-1545"><a href="#RTXkernel-1545"><span class="linenos">1545</span></a>
</span><span id="RTXkernel-1546"><a href="#RTXkernel-1546"><span class="linenos">1546</span></a>
</span><span id="RTXkernel-1547"><a href="#RTXkernel-1547"><span class="linenos">1547</span></a>
</span><span id="RTXkernel-1548"><a href="#RTXkernel-1548"><span class="linenos">1548</span></a>
</span><span id="RTXkernel-1549"><a href="#RTXkernel-1549"><span class="linenos">1549</span></a>    <span class="k">elif</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s1">&#39;Embree3&#39;</span><span class="p">:</span>
</span><span id="RTXkernel-1550"><a href="#RTXkernel-1550"><span class="linenos">1550</span></a>
</span><span id="RTXkernel-1551"><a href="#RTXkernel-1551"><span class="linenos">1551</span></a>        <span class="c1"># Initialize the geometry</span>
</span><span id="RTXkernel-1552"><a href="#RTXkernel-1552"><span class="linenos">1552</span></a>        <span class="n">shape_model</span> <span class="o">=</span> <span class="n">Embree3_init_geometry</span><span class="p">(</span><span class="n">mesh_obj</span><span class="p">)</span>
</span><span id="RTXkernel-1553"><a href="#RTXkernel-1553"><span class="linenos">1553</span></a>        <span class="n">context</span> <span class="o">=</span> <span class="n">embree</span><span class="o">.</span><span class="n">IntersectContext</span><span class="p">()</span>
</span><span id="RTXkernel-1554"><a href="#RTXkernel-1554"><span class="linenos">1554</span></a>
</span><span id="RTXkernel-1555"><a href="#RTXkernel-1555"><span class="linenos">1555</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bounces</span><span class="p">):</span>
</span><span id="RTXkernel-1556"><a href="#RTXkernel-1556"><span class="linenos">1556</span></a>            <span class="n">ray_origins_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">)</span>
</span><span id="RTXkernel-1557"><a href="#RTXkernel-1557"><span class="linenos">1557</span></a>
</span><span id="RTXkernel-1558"><a href="#RTXkernel-1558"><span class="linenos">1558</span></a>            <span class="c1"># Initialize the rayhit object</span>
</span><span id="RTXkernel-1559"><a href="#RTXkernel-1559"><span class="linenos">1559</span></a>            <span class="n">ray_origins</span> <span class="o">=</span> <span class="n">ray_origins</span> <span class="o">+</span> <span class="mf">1e-3</span> <span class="o">*</span> <span class="n">ray_directions</span>
</span><span id="RTXkernel-1560"><a href="#RTXkernel-1560"><span class="linenos">1560</span></a>            <span class="n">rayhit</span> <span class="o">=</span> <span class="n">Embree3_init_rayhit</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">)</span>
</span><span id="RTXkernel-1561"><a href="#RTXkernel-1561"><span class="linenos">1561</span></a>
</span><span id="RTXkernel-1562"><a href="#RTXkernel-1562"><span class="linenos">1562</span></a>            <span class="c1"># Run the intersector</span>
</span><span id="RTXkernel-1563"><a href="#RTXkernel-1563"><span class="linenos">1563</span></a>            <span class="n">shape_model</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">intersect1M</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">rayhit</span><span class="p">)</span>
</span><span id="RTXkernel-1564"><a href="#RTXkernel-1564"><span class="linenos">1564</span></a>
</span><span id="RTXkernel-1565"><a href="#RTXkernel-1565"><span class="linenos">1565</span></a>            <span class="c1"># Post-process the results</span>
</span><span id="RTXkernel-1566"><a href="#RTXkernel-1566"><span class="linenos">1566</span></a>            <span class="n">index_tri</span><span class="p">,</span> <span class="n">n_hits</span><span class="p">,</span> <span class="n">index_ray</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="n">Embree3_dump_solution</span><span class="p">(</span><span class="n">rayhit</span><span class="p">,</span> <span class="n">shape_model</span><span class="o">.</span><span class="n">V</span><span class="p">,</span> <span class="n">shape_model</span><span class="o">.</span><span class="n">F</span><span class="p">)</span>
</span><span id="RTXkernel-1567"><a href="#RTXkernel-1567"><span class="linenos">1567</span></a>
</span><span id="RTXkernel-1568"><a href="#RTXkernel-1568"><span class="linenos">1568</span></a>            <span class="c1"># embree.Device().release()</span>
</span><span id="RTXkernel-1569"><a href="#RTXkernel-1569"><span class="linenos">1569</span></a>            <span class="c1"># Handle: not bounces found</span>
</span><span id="RTXkernel-1570"><a href="#RTXkernel-1570"><span class="linenos">1570</span></a>            <span class="k">if</span> <span class="n">n_hits</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="RTXkernel-1571"><a href="#RTXkernel-1571"><span class="linenos">1571</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No intersections found for bounce </span><span class="si">{}</span><span class="s1">. Results provided up to bounce </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
</span><span id="RTXkernel-1572"><a href="#RTXkernel-1572"><span class="linenos">1572</span></a>                <span class="k">break</span>
</span><span id="RTXkernel-1573"><a href="#RTXkernel-1573"><span class="linenos">1573</span></a>
</span><span id="RTXkernel-1574"><a href="#RTXkernel-1574"><span class="linenos">1574</span></a>
</span><span id="RTXkernel-1575"><a href="#RTXkernel-1575"><span class="linenos">1575</span></a>            <span class="c1"># Otherwise append results and proceed with next bounce</span>
</span><span id="RTXkernel-1576"><a href="#RTXkernel-1576"><span class="linenos">1576</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="RTXkernel-1577"><a href="#RTXkernel-1577"><span class="linenos">1577</span></a>                <span class="n">locations_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
</span><span id="RTXkernel-1578"><a href="#RTXkernel-1578"><span class="linenos">1578</span></a>                <span class="n">index_tri_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_tri</span><span class="p">)</span>
</span><span id="RTXkernel-1579"><a href="#RTXkernel-1579"><span class="linenos">1579</span></a>                <span class="n">index_ray_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_ray</span><span class="p">)</span>
</span><span id="RTXkernel-1580"><a href="#RTXkernel-1580"><span class="linenos">1580</span></a>                <span class="n">ray_directions_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_directions</span><span class="p">)</span>
</span><span id="RTXkernel-1581"><a href="#RTXkernel-1581"><span class="linenos">1581</span></a>
</span><span id="RTXkernel-1582"><a href="#RTXkernel-1582"><span class="linenos">1582</span></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">bounces</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="RTXkernel-1583"><a href="#RTXkernel-1583"><span class="linenos">1583</span></a>                    <span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_secondary_bounce</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">index_tri</span><span class="p">,</span> <span class="n">mesh_obj</span><span class="p">,</span>
</span><span id="RTXkernel-1584"><a href="#RTXkernel-1584"><span class="linenos">1584</span></a>                                                                              <span class="n">ray_directions</span><span class="p">,</span> <span class="n">index_ray</span><span class="p">)</span>
</span><span id="RTXkernel-1585"><a href="#RTXkernel-1585"><span class="linenos">1585</span></a>        <span class="c1"># # release memory</span>
</span><span id="RTXkernel-1586"><a href="#RTXkernel-1586"><span class="linenos">1586</span></a>        <span class="c1"># scene.release()</span>
</span><span id="RTXkernel-1587"><a href="#RTXkernel-1587"><span class="linenos">1587</span></a>        <span class="n">shape_model</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</span><span id="RTXkernel-1588"><a href="#RTXkernel-1588"><span class="linenos">1588</span></a>
</span><span id="RTXkernel-1589"><a href="#RTXkernel-1589"><span class="linenos">1589</span></a>    <span class="k">elif</span> <span class="n">kernel</span> <span class="o">==</span> <span class="s1">&#39;CGAL&#39;</span><span class="p">:</span>
</span><span id="RTXkernel-1590"><a href="#RTXkernel-1590"><span class="linenos">1590</span></a>
</span><span id="RTXkernel-1591"><a href="#RTXkernel-1591"><span class="linenos">1591</span></a>        <span class="c1"># Initialize the geometry</span>
</span><span id="RTXkernel-1592"><a href="#RTXkernel-1592"><span class="linenos">1592</span></a>        <span class="n">shape_model</span> <span class="o">=</span> <span class="n">cgal_init_geometry</span><span class="p">(</span><span class="n">mesh_obj</span><span class="p">)</span>
</span><span id="RTXkernel-1593"><a href="#RTXkernel-1593"><span class="linenos">1593</span></a>
</span><span id="RTXkernel-1594"><a href="#RTXkernel-1594"><span class="linenos">1594</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bounces</span><span class="p">):</span>
</span><span id="RTXkernel-1595"><a href="#RTXkernel-1595"><span class="linenos">1595</span></a>            <span class="n">ray_origins_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">)</span>
</span><span id="RTXkernel-1596"><a href="#RTXkernel-1596"><span class="linenos">1596</span></a>
</span><span id="RTXkernel-1597"><a href="#RTXkernel-1597"><span class="linenos">1597</span></a>            <span class="c1"># Initialize the rayhit object</span>
</span><span id="RTXkernel-1598"><a href="#RTXkernel-1598"><span class="linenos">1598</span></a>            <span class="c1"># ray_origins = ray_origins + 1e-3 * ray_directions</span>
</span><span id="RTXkernel-1599"><a href="#RTXkernel-1599"><span class="linenos">1599</span></a>
</span><span id="RTXkernel-1600"><a href="#RTXkernel-1600"><span class="linenos">1600</span></a>            <span class="n">index_tri</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="n">shape_model</span><span class="o">.</span><span class="n">intersect1_2d_with_coords</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">)</span>
</span><span id="RTXkernel-1601"><a href="#RTXkernel-1601"><span class="linenos">1601</span></a>
</span><span id="RTXkernel-1602"><a href="#RTXkernel-1602"><span class="linenos">1602</span></a>            <span class="n">index_ray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ray_origins</span><span class="p">))</span>
</span><span id="RTXkernel-1603"><a href="#RTXkernel-1603"><span class="linenos">1603</span></a>            <span class="n">n_hits</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index_tri</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span id="RTXkernel-1604"><a href="#RTXkernel-1604"><span class="linenos">1604</span></a>
</span><span id="RTXkernel-1605"><a href="#RTXkernel-1605"><span class="linenos">1605</span></a>            <span class="n">index_ray</span> <span class="o">=</span> <span class="n">index_ray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index_tri</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="RTXkernel-1606"><a href="#RTXkernel-1606"><span class="linenos">1606</span></a>            <span class="n">location</span> <span class="o">=</span> <span class="n">location</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index_tri</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="RTXkernel-1607"><a href="#RTXkernel-1607"><span class="linenos">1607</span></a>            <span class="n">index_tri</span> <span class="o">=</span> <span class="n">index_tri</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">index_tri</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
</span><span id="RTXkernel-1608"><a href="#RTXkernel-1608"><span class="linenos">1608</span></a>
</span><span id="RTXkernel-1609"><a href="#RTXkernel-1609"><span class="linenos">1609</span></a>            <span class="c1"># print(index_tri, n_hits, index_ray, location)</span>
</span><span id="RTXkernel-1610"><a href="#RTXkernel-1610"><span class="linenos">1610</span></a>
</span><span id="RTXkernel-1611"><a href="#RTXkernel-1611"><span class="linenos">1611</span></a>            <span class="c1"># Handle: not bounces found</span>
</span><span id="RTXkernel-1612"><a href="#RTXkernel-1612"><span class="linenos">1612</span></a>            <span class="k">if</span> <span class="n">n_hits</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="RTXkernel-1613"><a href="#RTXkernel-1613"><span class="linenos">1613</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No intersections found for bounce </span><span class="si">{}</span><span class="s1">. Results provided up to bounce </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
</span><span id="RTXkernel-1614"><a href="#RTXkernel-1614"><span class="linenos">1614</span></a>                <span class="k">break</span>
</span><span id="RTXkernel-1615"><a href="#RTXkernel-1615"><span class="linenos">1615</span></a>
</span><span id="RTXkernel-1616"><a href="#RTXkernel-1616"><span class="linenos">1616</span></a>
</span><span id="RTXkernel-1617"><a href="#RTXkernel-1617"><span class="linenos">1617</span></a>            <span class="c1"># Otherwise append results and proceed with next bounce</span>
</span><span id="RTXkernel-1618"><a href="#RTXkernel-1618"><span class="linenos">1618</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="RTXkernel-1619"><a href="#RTXkernel-1619"><span class="linenos">1619</span></a>                <span class="n">locations_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
</span><span id="RTXkernel-1620"><a href="#RTXkernel-1620"><span class="linenos">1620</span></a>                <span class="n">index_tri_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_tri</span><span class="p">)</span>
</span><span id="RTXkernel-1621"><a href="#RTXkernel-1621"><span class="linenos">1621</span></a>                <span class="n">index_ray_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_ray</span><span class="p">)</span>
</span><span id="RTXkernel-1622"><a href="#RTXkernel-1622"><span class="linenos">1622</span></a>                <span class="n">ray_directions_container</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ray_directions</span><span class="p">)</span>
</span><span id="RTXkernel-1623"><a href="#RTXkernel-1623"><span class="linenos">1623</span></a>
</span><span id="RTXkernel-1624"><a href="#RTXkernel-1624"><span class="linenos">1624</span></a>                <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">bounces</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="RTXkernel-1625"><a href="#RTXkernel-1625"><span class="linenos">1625</span></a>                    <span class="n">ray_origins</span><span class="p">,</span> <span class="n">ray_directions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">compute_secondary_bounce</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">index_tri</span><span class="p">,</span> <span class="n">mesh_obj</span><span class="p">,</span>
</span><span id="RTXkernel-1626"><a href="#RTXkernel-1626"><span class="linenos">1626</span></a>                                                                              <span class="n">ray_directions</span><span class="p">,</span> <span class="n">index_ray</span><span class="p">)</span>
</span><span id="RTXkernel-1627"><a href="#RTXkernel-1627"><span class="linenos">1627</span></a>
</span><span id="RTXkernel-1628"><a href="#RTXkernel-1628"><span class="linenos">1628</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="RTXkernel-1629"><a href="#RTXkernel-1629"><span class="linenos">1629</span></a>        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No Recognized kernel&#39;</span><span class="p">)</span>
</span><span id="RTXkernel-1630"><a href="#RTXkernel-1630"><span class="linenos">1630</span></a>
</span><span id="RTXkernel-1631"><a href="#RTXkernel-1631"><span class="linenos">1631</span></a>    <span class="c1"># Manage output variables</span>
</span><span id="RTXkernel-1632"><a href="#RTXkernel-1632"><span class="linenos">1632</span></a>    <span class="k">if</span> <span class="n">diffusion</span><span class="p">:</span>
</span><span id="RTXkernel-1633"><a href="#RTXkernel-1633"><span class="linenos">1633</span></a>        <span class="k">return</span> <span class="n">index_tri_container</span><span class="p">,</span> <span class="n">index_ray_container</span><span class="p">,</span> <span class="n">locations_container</span><span class="p">,</span> <span class="n">ray_origins_container</span><span class="p">,</span> <span class="n">ray_directions_container</span><span class="p">,</span> <span class="n">diffusion_pack</span>
</span><span id="RTXkernel-1634"><a href="#RTXkernel-1634"><span class="linenos">1634</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="RTXkernel-1635"><a href="#RTXkernel-1635"><span class="linenos">1635</span></a>        <span class="k">return</span> <span class="n">index_tri_container</span><span class="p">,</span> <span class="n">index_ray_container</span><span class="p">,</span> <span class="n">locations_container</span><span class="p">,</span> <span class="n">ray_origins_container</span><span class="p">,</span> <span class="n">ray_directions_container</span><span class="p">,</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Main ray tracing kernel wrapper supporting multiple ray tracing backends and
multi-bounce simulations.</p>

<p>This is the primary interface for performing ray tracing operations in pyRTX.
It supports various ray tracing kernels (Embree, CGAL, Native), multiple
reflection bounces, and optional diffuse scattering for realistic radiation
momentum exchange calculatons.</p>

<h2 id="parameters">Parameters</h2>

<p>mesh_obj : trimesh.Trimesh
    The mesh geometry to ray trace against. Must be a valid triangular mesh.
ray_origins : ndarray, shape (N_rays, 3)
    Starting positions of rays in 3D space (in same coordinate system as mesh).
ray_directions : ndarray, shape (N_rays, 3)
    Direction vectors of rays. Do not need to be normalized.
bounces : int, default=1
    Number of reflection bounces to simulate. bounces=1 means direct
    illumination only, bounces=2 includes one reflection, etc.
kernel : str, default='Embree'
    Ray tracing backend to use:
    - 'Embree3': Intel Embree library (fastest, recommended)
    - 'Embree' : Intel Embree library (Version 2, slower than 3)
    - 'CGAL': CGAL AABB tree implementation (robust, slower)
    - 'Native': Pure Python implementation (very slow, for reference only)
diffusion : bool, default=False
    If True, compute diffuse (Lambertian) reflections in addition to
    specular reflections. Only applied to the first bounce. Enables
    realistic modeling of rough surfaces.
num_diffuse : int or None, default=None
    Number of diffuse samples per intersection point. Required if
    diffusion=True. Typical values: 10-100 depending on accuracy needs.
errorMsg : bool, default=True
    If True, print warning messages when no intersections are found for
    a bounce. Set to False to suppress warnings in batch processing.</p>

<h2 id="returns">Returns</h2>

<p>index_tri_container : list of ndarrays
    List containing triangle indices for each bounce. Each element is an
    array of shape (N_hits_i,) containing indices of faces hit at bounce i.
    Length equals number of computed bounces ( bounces parameter).
index_ray_container : list of ndarrays
    List containing ray indices for each bounce. index_ray_container[i]
    maps from the original ray array to rays that hit at bounce i.
locations_container : list of ndarrays
    List of intersection point coordinates for each bounce. Each element
    has shape (N_hits_i, 3).
ray_origins_container : list of ndarrays
    List of ray origin positions for each bounce. Note that
    ray_origins_container[0] equals the input ray_origins parameter.
ray_directions_container : list of ndarrays
    List of ray direction vectors for each bounce. Element [0] contains
    input directions, subsequent elements contain reflected directions.
diffusion_pack : list or None
    If diffusion=True, contains diffuse ray tracing results:
    [index_tri_diffusion, index_ray_diffusion, ray_directions_diffusion,
     location_diffusion]. If diffusion=False, returns None.</p>

<h2 id="notes">Notes</h2>

<p>Algorithm Overview:</p>

<ol>
<li>Initialize ray tracing kernel (Embree, CGAL, or Native)</li>
<li>For each bounce:
a. Add small offset to ray origins (avoids self-intersection)
b. Trace rays to find intersections
c. If no hits found, terminate and return results up to current bounce
d. Compute specular reflection directions for next bounce
e. If diffusion enabled and bounce==1, also compute diffuse reflections</li>
<li>Return accumulated results for all bounces</li>
</ol>

<p>Performance Notes:</p>

<ul>
<li>Embree is typically 10-100 faster than Native for large meshes</li>
<li>CGAL offers good robustness for edge cases but slower than Embree</li>
<li>Diffusion increases computation by factor of num_diffuse</li>
<li>Memory usage scales linearly with bounces and num_diffuse</li>
</ul>

<p>Kernel-Specific Details:</p>

<ul>
<li>Embree/Embree3: Uses BVH acceleration, highly optimized for x86 CPUs</li>
<li>CGAL: Uses AABB tree, more robust numerical handling</li>
<li>Native: Pure Python/Trimesh, no special acceleration</li>
</ul>

<p>The 1e-3 offset added to ray origins prevents numerical precision issues
where a reflected ray might re-intersect the same surface it just bounced
from (self-intersection artifact).</p>

<h2 id="examples">Examples</h2>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="c1"># Simple direct illumination</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span> <span class="o">=</span> <span class="n">RTXkernel</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">origins</span><span class="p">,</span> <span class="n">directions</span><span class="p">,</span> <span class="n">bounces</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;Embree&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hits</span><span class="p">,</span> <span class="n">ray_ids</span><span class="p">,</span> <span class="n">locations</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">results</span>
<span class="gp">&gt;&gt;&gt; </span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># Multi-bounce with diffuse scattering</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">results</span> <span class="o">=</span> <span class="n">RTXkernel</span><span class="p">(</span><span class="n">mesh</span><span class="p">,</span> <span class="n">origins</span><span class="p">,</span> <span class="n">directions</span><span class="p">,</span> <span class="n">bounces</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
<span class="gp">... </span>                    <span class="n">kernel</span><span class="o">=</span><span class="s1">&#39;Embree&#39;</span><span class="p">,</span> <span class="n">diffusion</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_diffuse</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">hits</span><span class="p">,</span> <span class="n">ray_ids</span><span class="p">,</span> <span class="n">locs</span><span class="p">,</span> <span class="n">origins</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">diffuse_data</span> <span class="o">=</span> <span class="n">results</span>
</code></pre>
</div>

<h2 id="see-also">See Also</h2>

<p>pixel_plane_opt : Generate ray grids for illumination sources
compute_secondary_bounce : Compute reflection directions
diffuse : Generate diffuse reflection samples</p>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.kind) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value"> = ${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.kind}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>